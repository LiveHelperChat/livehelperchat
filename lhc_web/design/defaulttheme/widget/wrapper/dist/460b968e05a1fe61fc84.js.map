{"version":3,"file":"460b968e05a1fe61fc84.js","mappings":"2iCAAuD,IAEjDA,EAAW,WAMZ,OAAAC,EAAAA,EAAAA,IAJD,SAAAD,KAAcE,EAAAA,EAAAA,GAAA,KAAAF,GACVG,KAAKC,OAAS,CAAC,EACfD,KAAKE,WAAa,KAClBF,KAAKG,WAAa,IACtB,GAAC,EAAAC,IAAA,YAAAC,OAAAC,GAAAC,EAAAA,EAAAA,GAAAC,IAAAA,MAED,SAAAC,EAAgBR,EAAQC,EAAYC,GAAU,IAAAO,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAkDjCC,EAWMC,EAAkBC,EAAA,OAAAjB,IAAAA,MAAC,SAADkB,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,OA9BX,OA8BWH,EAAA,WAmGhC,OAnGgCA,GAAAlB,EAAAA,EAAAA,GAAAC,IAAAA,MAAjC,SAAAqB,IAAA,IAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAA/B,IAAAA,MAAA,SAAAgC,GAAA,cAAAA,EAAAb,KAAAa,EAAAZ,MAAA,OAEkD,GAD1CE,EAA4B,MAAjBd,EAAuBe,GAAa,EAAOC,EAAe,KACzEhB,EAAgBH,EAAO4B,UAAU,MAAQ/B,GACzB,GAAZoB,EAAgB,CAAAU,EAAAZ,KAAA,SAChB,IAEuB,SAAnB1B,EAAWwC,OAAoBxC,EAAWyC,aAAatC,OAASQ,EAAO+B,gBAAgB,MAAQlC,EAAK,CAAC4B,GAAI,YAAa,SAAatB,EAAc6B,OAAOC,WAG7H,OAAvB5C,EAAW6C,UACXlC,EAAO+B,gBAAgB,MAAQlC,EAAK,CAAE,SAAaM,EAAc6B,OAAOC,SAAUR,GAAI,aAAc,MAAO,EAAO,QAAWpC,EAAW6C,UACxI7C,EAAW8C,aAAaC,YAAY,iBAAiB,YAClC,IAAfhC,IAAkD,IAA1Bf,EAAWe,YAAwBJ,EAAO+B,gBAAgB,MAAQlC,EAAK,CAAC,SAAaM,EAAc6B,OAAOC,SAAUR,GAAG,eAAgB,MAAO,EAAO,QAAWpC,EAAW6C,UACnM9B,GAAa,CACjB,KAIe,SAAnBf,EAAWwC,MAAmBxC,EAAWyC,aAAaF,WAAU,SAACS,GAC7D,GAAkB,GAAdnB,EAKA,OAJAoB,aAAanB,QACbA,EAAeoB,YAAW,WACtBrB,GAAa,CACjB,GAAG,MAGPlB,EAAO+B,gBAAgB,MAAQlC,EAAK,CAAC4B,GAAI,UAAWe,OAAQH,EAAM,SAAalC,EAAc6B,OAAOC,UACxG,IAAG,GAGH5C,EAAW8C,aAAaC,YAAY,eAAe,SAAUC,EAAMR,GAClD,UAATA,IAAuC,IAAnBxC,EAAWoD,KAC/BzC,EAAO+B,gBAAgB,MAAQlC,EAAK,CAAC4B,GAAI,eAAgBY,KAAMA,EAAM,SAAalC,EAAc6B,OAAOC,UAE/G,GACJ,CAAE,MAAOS,GACLC,QAAQC,IAAIF,EAChB,CAACf,EAAAb,KAAA,EAAAM,GAAA,EAAAC,GAAA,EAAAM,EAAAb,KAAA,EAAAS,EAAAsB,EAEwB1C,GAAa,cAAAwB,EAAAZ,KAAA,GAAAQ,EAAAR,OAAA,aAAAK,IAAAI,EAAAG,EAAAmB,MAAAC,MAAA,CAAApB,EAAAZ,KAAA,SAC9B,GAAa,kBADFU,EAAED,EAAAhC,OACNiC,GACHpC,EAAW8C,aAAaa,UAAU,6BAC/B,GAAa,aAATvB,EAAGA,GACVzB,EAAO+B,gBAAgB,OAAO7B,EAAY,CAACuB,GAAG,YAAae,QAAQ,EAAM3C,IAAKA,SAC3E,GAAa,gBAAT4B,EAAGA,GACV,IACsC,OAA9BpC,EAAW4D,YAAYC,IAAezB,EAAGY,KAAKa,IAAM/C,EAAc6B,OAAOC,UAAYR,EAAGQ,UACxF3C,EAAW6D,eAAe,qBAAsB,CAAC,CAC7C,GAAM1B,EAAGY,KAAKa,GACd,KAAQzB,EAAGY,KAAKe,OAG5B,CAAE,MAAOV,GACLC,QAAQC,IAAIF,EAChB,MACG,GAAa,aAATjB,EAAGA,GACV,IAC2B,SAAnBpC,EAAWwC,MAAmBxC,EAAWyC,aAAatC,OAASW,EAAc6B,OAAOC,UAAYR,EAAGQ,UACnGjC,EAAO+B,gBAAgB,MAAMlC,EAAI,CAAC4B,GAAG,UAAWe,QAAQ,GAEhE,CAAE,MAAOE,GACLC,QAAQC,IAAIF,EAChB,MAEG,GAAa,WAATjB,EAAGA,GACV,IAC2B,SAAnBpC,EAAWwC,MAAmBJ,EAAGe,QAAUnD,EAAWyC,aAAatC,OAASW,EAAc6B,OAAOC,UAAYR,EAAGQ,WAChHf,GAAa,EACb7B,EAAWyC,aAAaf,KAAKU,EAAGe,QAExC,CAAE,MAAOE,GACLC,QAAQC,IAAIF,EAChB,MACG,GAAa,gBAATjB,EAAGA,IAAiC,cAATA,EAAGA,GACrC,IACI,GAAItB,EAAc6B,OAAOC,UAAYR,EAAGQ,SAAS,CAC7C,GAAIR,EAAGS,SAAkC,OAAvB7C,EAAW6C,QAAkB,CAG3C,IAASR,KAFTtB,GAAa,EACbf,EAAWe,YAAa,EACNqB,EAAGS,aACyB,IAA9B7C,EAAW6C,QAAQR,IAAwD,KAA9BrC,EAAW6C,QAAQR,KAA6B,IAAZD,EAAG4B,MAAyC,KAAtB5B,EAAGS,QAAQR,IAAiBrC,EAAW6C,QAAQR,KAAWD,EAAGS,QAAQR,KACpLrC,EAAW6C,QAAQR,GAASD,EAAGS,QAAQR,IAG/CrC,EAAWe,YAAa,CAC5B,CACa,cAATqB,EAAGA,IACoB,OAAvBpC,EAAW6C,SAAoBlC,EAAO+B,gBAAgB,MAAMlC,EAAI,CAAC,SAAaM,EAAc6B,OAAOC,SAAUR,GAAG,eAAgB,MAAO,EAAM,QAAWpC,EAAW6C,SAE3K,CACJ,CAAE,MAAOQ,GACLC,QAAQC,IAAIF,EAChB,CACH,QAAAtB,GAAA,EAAAO,EAAAZ,KAAA,gBAAAY,EAAAZ,KAAA,iBAAAY,EAAAb,KAAA,GAAAa,EAAA2B,GAAA3B,EAAA,SAAAN,GAAA,EAAAC,EAAAK,EAAA2B,GAAA,WAAA3B,EAAAb,KAAA,GAAAa,EAAAb,KAAA,IAAAM,GAAA,MAAAG,EAAAgC,OAAA,CAAA5B,EAAAZ,KAAA,gBAAAY,EAAAZ,KAAA,GAAAQ,EAAAgC,SAAA,WAAA5B,EAAAb,KAAA,IAAAO,EAAA,CAAAM,EAAAZ,KAAA,eAAAO,EAAA,eAAAK,EAAA6B,OAAA,mBAAA7B,EAAA6B,OAAA,YAAA7B,EAAAZ,KAAA,iBAAAY,EAAAb,KAAA,GAAAa,EAAA8B,GAAA9B,EAAA,kCAAAA,EAAA+B,OAAA,GAAA1C,EAAA,6CAMhB2C,MAAA,KAAAC,UAAA,EAnGcjD,EAAkB,kBAAAC,EAAA+C,MAAC,KAADC,UAAA,EAXxBlD,EAAc,WACnBmD,EAAAA,EAAgBC,YAAYzE,EAAW0E,QAAQC,KAAKC,aAAe5E,EAAiB,KAAI,4BAA6B,CAAED,OAAQ,CAAC8E,IAAK,IAAIC,MAAQC,YAAW,eAAAC,GAAA3E,EAAAA,EAAAA,GAAAC,IAAAA,MAAE,SAAA2E,EAAOjC,GAAI,OAAA1C,IAAAA,MAAA,SAAA4E,GAAA,cAAAA,EAAAzD,KAAAyD,EAAAxD,MAAA,OACtI,OAA/Bb,EAAcmC,EAAKnC,YAAYqE,EAAAxD,KAAA,EACzByD,QAAQC,IAAI,CACdzE,EAAO0E,OAAO,QAAQ,CAACtB,KAAMf,EAAKe,KAAMnD,WAAYA,EAAYC,YAAamC,EAAKnC,cAClFF,EAAO2E,SAAS,gBAAgBC,SAClC,OACFjE,IAAqB,wBAAA4D,EAAAb,OAAA,GAAAY,EAAA,KACxB,gBAAAO,GAAA,OAAAR,EAAAV,MAAA,KAAAC,UAAA,EAP2J,GAQhK,EA1DAzE,KAAKC,OAASA,EACdD,KAAKE,WAAaA,EAClBF,KAAKG,WAAaA,EAEZO,EAAMV,KAAKE,WAAW4D,YAAY6B,SAEpChF,EAAgB,CAChBiF,gBAAiB,EACjBC,SAAU5F,EAAO4F,SACjBC,KAAM7F,EAAO6F,KACbC,oBAAoB,EACpBC,cAAe,8BAGA,IAAf/F,EAAOgG,OACPtF,EAAcsF,KAAOC,SAASjG,EAAOgG,OAGpB,GAAjBhG,EAAOkG,SACPxF,EAAcwF,QAAS,GAGvBvF,EAAgBwF,EAAQ,MAExBvF,EAASD,EAAcyF,OAAO1F,GAE9BG,EAAa,MAAQJ,EACrBK,EAAcf,KAAKE,WAAWa,YAC9BC,EAAgB,KAEhBC,GAAa,EAAKS,EAAAE,KAAA,GAEHf,EAAO2E,SAAS,WAAWC,OAAM,QAA1C/D,EAAAiC,KACC2C,iBACP9E,IACAtB,EAAW0E,QAAQC,KAAK0B,gBAAiB,GAEzChF,IACHG,EAAAC,KAAA,GAAAT,GAAA,EAAAC,GAAA,EAAAO,EAAAC,KAAA,GAAAN,EAAAqC,EAG2B7C,EAAO2E,SAAS,mBAAiB,eAAA9D,EAAAE,KAAA,GAAAP,EAAAO,OAAA,aAAAV,IAAAI,EAAAI,EAAAiC,MAAAC,MAAA,CAAAlC,EAAAE,KAAA,SAArCN,EAAAjB,MAChBkB,IAAiB,QAAAL,GAAA,EAAAQ,EAAAE,KAAA,iBAAAF,EAAAE,KAAA,iBAAAF,EAAAC,KAAA,GAAAD,EAAAyC,GAAAzC,EAAA,UAAAP,GAAA,EAAAC,EAAAM,EAAAyC,GAAA,WAAAzC,EAAAC,KAAA,GAAAD,EAAAC,KAAA,IAAAT,GAAA,MAAAG,EAAA+C,OAAA,CAAA1C,EAAAE,KAAA,gBAAAF,EAAAE,KAAA,GAAAP,EAAA+C,SAAA,WAAA1C,EAAAC,KAAA,IAAAR,EAAA,CAAAO,EAAAE,KAAA,eAAAR,EAAA,eAAAM,EAAA2C,OAAA,mBAAA3C,EAAA2C,OAAA,YAAA3C,EAAAE,KAAA,iBAAAF,EAAAC,KAAA,GAAAD,EAAA4C,GAAA5C,EAAA,mCAAAA,EAAA6C,OAAA,GAAA9D,EAAA,8CAuH5B,SAlKc+F,EAAAC,EAAAC,GAAA,OAAApG,EAAAkE,MAAC,KAADC,UAAA,MAFd,IAAAnE,CAEc,CARF,GA6KXqG,EAAa,IAAI9G,C","sources":["webpack://LiveHelperChat/./src/util/nodeJSChat.js"],"sourcesContent":["import {helperFunctions} from '../lib/helperFunctions';\n\nclass _nodeJSChat {\n\n    constructor() {\n        this.params = {};\n        this.attributes = null;\n        this.chatEvents = null;\n    }\n\n    async setParams(params, attributes, chatEvents) {\n        this.params = params;\n        this.attributes = attributes;\n        this.chatEvents = chatEvents;\n\n        const vid = this.attributes.userSession.getVID();\n\n        var socketOptions = {\n            protocolVersion: 1,\n            hostname: params.hostname,\n            path: params.path,\n            disconnectOnUnload: false,\n            authTokenName: 'socketCluster.authToken_vi'\n        }\n\n        if (params.port != '') {\n            socketOptions.port = parseInt(params.port);\n        }\n\n        if (params.secure == 1) {\n            socketOptions.secure = true;\n        }\n\n        var socketCluster = require(\"socketcluster-client\");\n\n        var socket = socketCluster.create(socketOptions);\n\n        var chanelName = 'uo_' + vid;\n        var instance_id = this.attributes.instance_id;\n        var sampleChannel = null;\n        // Do not update vars while we are updating it from other browser tabs\n        var ignoreVars = false;\n\n        let status = await socket.listener('connect').once();\n        if (status.isAuthenticated) {\n            connectSiteVisitor();\n            attributes.LHC_API.args.check_messages = false;\n        } else {\n            authentificate();\n        }\n\n        try {\n            for await (let event of socket.listener('deauthenticate')) {\n                authentificate();\n            }\n        } catch (e) {\n            // shut up old browers\n        }\n\n\n        function authentificate() {\n            helperFunctions.makeRequest(attributes.LHC_API.args.lhc_base_url + attributes['lang'] + \"nodejshelper/tokenvisitor\", { params: {ts: (new Date()).getTime()}}, async (data) => {\n                instance_id = data.instance_id;\n                await Promise.all([\n                    socket.invoke('login',{hash: data.hash, chanelName: chanelName, instance_id: data.instance_id}),\n                    socket.listener('authenticate').once()\n                ]);\n                connectSiteVisitor();\n            })\n        }\n\n        async function connectSiteVisitor() {\n            var firstRun = sampleChannel == null, ignoreNext = false, timeoutClear = null;\n            sampleChannel = socket.subscribe('uo_' + vid);\n            if (firstRun == true) {\n                try {\n                    // We want to receive signal is widget open in any of the windows\n                    attributes.mode != 'embed' && !attributes.widgetStatus.value && socket.transmitPublish('uo_' + vid, {op: 'ws_isopen', 'clientId' : sampleChannel.client.clientId});\n\n                    // We want to publish request to receive all the vars other instances has\n                    if (attributes.lhc_var !== null) {\n                        socket.transmitPublish('uo_' + vid, { 'clientId' : sampleChannel.client.clientId, op: 'check_vars', 'init':false, 'lhc_var': attributes.lhc_var});\n                        attributes.eventEmitter.addListener('jsVarsUpdated', function () {\n                            ignoreVars === false && attributes.ignoreVars === false && socket.transmitPublish('uo_' + vid, {'clientId' : sampleChannel.client.clientId, op:'current_vars', 'init':false, 'lhc_var': attributes.lhc_var});\n                            ignoreVars = false;\n                        });\n                    }\n\n                    // Subscribe to widget status, just ignore initial status\n                    attributes.mode != 'embed' && attributes.widgetStatus.subscribe((data) => {\n                        if (ignoreNext == true) {\n                            clearTimeout(timeoutClear);\n                            timeoutClear = setTimeout(() => {\n                                ignoreNext = false;\n                            }, 1000);\n                            return;\n                        }\n                        socket.transmitPublish('uo_' + vid, {op: 'wstatus', status: data, 'clientId' : sampleChannel.client.clientId,});\n                    }, true);\n\n                    // Listen for chat started event and dispatch to other windows\n                    attributes.eventEmitter.addListener('chatStarted', function (data, mode) {\n                        if (mode !== 'popup' || attributes.kcw === true) {\n                            socket.transmitPublish('uo_' + vid, {op: 'chat_started', data: data, 'clientId' : sampleChannel.client.clientId,});\n                        }\n                    });\n                } catch (e) {\n                    console.log(e);\n                }\n                try {\n                    for await (let op of sampleChannel) {\n                        if (op.op == 'check_message') {\n                            attributes.eventEmitter.emitEvent('checkMessageOperator');\n                        } else if (op.op == 'is_online') {\n                            socket.transmitPublish('ous_'+instance_id,{op:'vi_online', status: true, vid: vid});\n                        } else if (op.op == 'chat_started') {\n                            try {\n                                if (attributes.userSession.id === null && op.data.id && sampleChannel.client.clientId != op.clientId) {\n                                    chatEvents.sendChildEvent('reopenNotification', [{\n                                        'id': op.data.id,\n                                        'hash': op.data.hash\n                                    }]);\n                                }\n                            } catch (e) {\n                                console.log(e);\n                            }\n                        } else if (op.op == 'ws_isopen') {\n                            try {\n                                if (attributes.mode != 'embed' && attributes.widgetStatus.value && sampleChannel.client.clientId != op.clientId) {\n                                    socket.transmitPublish('uo_'+vid,{op:'wstatus', status: true});\n                                }\n                            } catch (e) {\n                                console.log(e);\n                            }\n\n                        } else if (op.op == 'wstatus') {\n                            try {\n                                if (attributes.mode != 'embed' && op.status != attributes.widgetStatus.value && sampleChannel.client.clientId != op.clientId) {\n                                    ignoreNext = true;\n                                    attributes.widgetStatus.next(op.status);\n                                }\n                            } catch (e) {\n                                console.log(e);\n                            }\n                        } else if (op.op == 'current_vars' || op.op == 'check_vars') {\n                            try {\n                                if (sampleChannel.client.clientId != op.clientId){\n                                    if (op.lhc_var && attributes.lhc_var !== null) {\n                                        ignoreVars = true;\n                                        attributes.ignoreVars = true;\n                                        for (var index in op.lhc_var) {\n                                            if ((typeof attributes.lhc_var[index] === 'undefined' || attributes.lhc_var[index] === '' || op.init === false) && op.lhc_var[index] !== '' && attributes.lhc_var[index] !== op.lhc_var[index]) {\n                                                attributes.lhc_var[index] = op.lhc_var[index];\n                                            }\n                                        }\n                                        attributes.ignoreVars = false;\n                                    }\n                                    if (op.op == 'check_vars') {\n                                        attributes.lhc_var !== null && socket.transmitPublish('uo_'+vid,{'clientId' : sampleChannel.client.clientId, op:'current_vars', 'init':true, 'lhc_var': attributes.lhc_var});\n                                    }\n                                }\n                            } catch (e) {\n                                console.log(e);\n                            }\n                        }\n                    }\n                } catch (e) {\n                    // shut up old browsers\n                }\n            }\n        }\n\n    }\n}\n\nconst nodeJSChat = new _nodeJSChat();\nexport {nodeJSChat};\n\n"],"names":["_nodeJSChat","_createClass","_classCallCheck","this","params","attributes","chatEvents","key","value","_setParams","_asyncToGenerator","_regeneratorRuntime","_callee3","vid","socketOptions","socketCluster","socket","chanelName","instance_id","sampleChannel","ignoreVars","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","authentificate","connectSiteVisitor","_connectSiteVisitor","_context3","prev","next","_callee2","firstRun","ignoreNext","timeoutClear","_iteratorAbruptCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","op","index","_context2","subscribe","mode","widgetStatus","transmitPublish","client","clientId","lhc_var","eventEmitter","addListener","data","clearTimeout","setTimeout","status","kcw","e","console","log","_asyncIterator","sent","done","emitEvent","userSession","id","sendChildEvent","hash","init","t0","return","finish","t1","stop","apply","arguments","helperFunctions","makeRequest","LHC_API","args","lhc_base_url","ts","Date","getTime","_ref","_callee","_context","Promise","all","invoke","listener","once","_x4","getVID","protocolVersion","hostname","path","disconnectOnUnload","authTokenName","port","parseInt","secure","require","create","isAuthenticated","check_messages","_x","_x2","_x3","nodeJSChat"],"sourceRoot":""}