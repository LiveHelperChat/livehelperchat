var lhcError={log:function(t,e,a,i,s){var n;(n={}).message=t||"",n.location=location&&location.href?location.href:"",n.message+="\n"+window.navigator.userAgent,n.file=e||"",n.line=a||"",n.column=s||"",n.stack=i?JSON.stringify(i):"",n.stack=n.stack.replace(/(\r\n|\n|\r)/gm,"");var o=new XMLHttpRequest;o.open("POST",WWW_DIR_JAVASCRIPT+"/audit/logjserror",!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send("data="+encodeURIComponent(JSON.stringify(n)))}};window.addEventListener("error",(function(t){!lhcError||-1===t.filename.indexOf("js_static")&&-1===t.filename.indexOf("compiledtemplates")&&-1===t.filename.indexOf("defaulttheme")||lhcError.log(t.message,t.filename,t.lineNumber||t.lineno,t.error.stack,t.colno)}));try{function csrfSafeMethod(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}$.ajaxSetup({crossDomain:!1,cache:!1,beforeSend:function(t,e){csrfSafeMethod(e.type)||t.setRequestHeader("X-CSRFToken",confLH.csrf_token)}}),$.postJSON=function(t,e,a){return $.post(t,e,a,"json")};var LHCCallbacks={};function lh(){this.wwwDir=WWW_DIR_JAVASCRIPT,this.addmsgurl="chat/addmsgadmin/",this.syncadmin="chat/syncadmin/",this.closechatadmin="chat/closechatadmin/",this.deletechatadmin="chat/deletechatadmin/",this.syncadmininterfaceurl="chat/syncadmininterface/",this.accepttransfer="chat/accepttransfer/",this.trasnsferuser="chat/transferuser/",this.channel=null,this.disableremember=!1,this.operatorTyping=!1,this.forceBottomScroll=!1,this.appendSyncArgument="",this.nodeJsMode=!1,this.previous_chat_id=0,this.gmaps_loaded=!1,this.disableSync=!1,this.chat_id=null,this.hash=null,this.soundIsPlaying=!1,this.soundPlayedTimes=0,this.last_message_id=0,this.isSinchronizing=!1,this.isWidgetMode=!1,this.isEmbedMode=!1,this.syncroRequestSend=!1,this.currentMessageText="",this.setSynchronizationRequestSend=function(t){this.syncroRequestSend=t},this.chatsSynchronising=[],this.chatsSynchronisingMsg=[],this.notificationsArray=[],this.speechHandler=!1,this.underMessageAdd=!1,this.closeWindowOnChatCloseDelete=!1,this.userTimeout=!1,this.lastOnlineSyncTimeout=!1,this.setwwwDir=function(t){this.wwwDir=t},this.setDisableRemember=function(t){this.disableremember=t},this.setSynchronizationStatus=function(t){this.underMessageAdd=t},this.startCoBrowse=function(t){return popupWindow=window.open(this.wwwDir+"cobrowse/browse/"+t,"chatwindow-cobrowse-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650"),null!==popupWindow&&popupWindow.focus(),!1},this.tabIconContent="face",this.tabIconClass="icon-user-status material-icons icon-user-online",this.audio=void 0!==window.Audio?new Audio:null,null!==this.audio&&(this.audio.autoplay="autoplay"),this.reloadTab=function(t,e,a,i){$("#ntab-chat-"+t).text(a),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),this.removeSynchroChat(t,!0),this.removeBackgroundChat(t),this.hideNotification(t);var s=this;$.get(this.wwwDir+"chat/adminchat/"+t+"/(remember)/true",(function(e){$("#chat-id-"+t).html(e),$("#CSChatMessage-"+t).focus(),s.rememberTab(t),s.addQuateHandler(t),s.loadMainData(t),ee.emitEvent("chatTabLoaded",[t]),ee.emitEvent("chatStartTab",[t,{name:a,focus:!0}]),!i&&s.channel&&s.channel.postMessage({action:"reload_chat",args:{nick:a,chat_id:parseInt(t)}})}))},this.loadMainData=function(t){var e=this;$.getJSON(this.wwwDir+"chat/loadmaindata/"+t,{},(function(a){$.each(a.items,(function(a,i){var s=$(i.selector);void 0!==i.attr&&$.each(i.attr,(function(t,e){"text"==t?s.text(e):s.attr(t,e)})),void 0!==i.action&&("hide"==i.action?s.hide():"keyup"==i.action?s.bind("keyup",i.event_data.a+"+"+i.event_data.b,(function(){var a={msg:"!"+i.event_data.cmd};$.postJSON(e.wwwDir+e.addmsgurl+t,a,(function(a){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),""!=a.r&&$("#messagesBlock-"+t).append(a.r).scrollTop($("#messagesBlock-"+t).prop("scrollHeight")).find(".pending-storage").remove(),!0===a.hold_removed?$("#hold-action-"+t).removeClass("btn-outline-info"):!0===a.hold_added&&$("#hold-action-"+t).addClass("btn-outline-info"),!0===a.update_status&&e.updateVoteStatus(t),e.syncadmincall(),!0}))})):"show"==i.action?s.show():"remove"==i.action?s.remove():"event"==i.action?ee.emitEvent(i.event_name,i.event_value):"click"==i.action&&(1!==confLH.no_scroll_bottom&&s.attr("auto-scroll",1),s.click()))})),ee.emitEvent("mainChatDataLoaded",[t,a])})).fail((function(){}))},this.getSelectedText=function(){var t,e="";return window.getSelection?e=(t=window.getSelection()).toString():document.selection&&"Control"!==document.selection.type&&(e=(t=document.selection.createRange()).text),{selection:t,text:e}},this.popoverShown=!1,this.popoverShownNow=!1,this.selection=null,this.mouseContextMenu=function(t){if(3==t.which&&void 0!==$(this).attr("id")){$(".popover-copy").popover("dispose");var e=t.data.that.getSelectedText(),a=!1;!e.text.length||null!==t.data.that.selection&&t.data.that.selection.text===e.text||(a=!0,t.data.that.selection=e);var i=$(this).attr("id").replace("msg-",""),s="true"!==$("#CSChatMessage-"+t.data.chat_id).attr("disable-edit")&&($(this).attr("data-op-id")==confLH.user_id||"true"===$("#CSChatMessage-"+t.data.chat_id).attr("edit-op")&&parseInt($(this).attr("data-op-id"))>0||"true"===$("#CSChatMessage-"+t.data.chat_id).attr("edit-vis")&&0===parseInt($(this).attr("data-op-id"))),n={placement:"right",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+t.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body"></div></div>',content:function(){return'<a href="#" id="copy-popover-'+t.data.chat_id+'" ><i class="material-icons">&#xE244;</i>'+confLH.transLation.quote+"</a>"+(s?'<br/><a href="#" id="edit-popover-'+t.data.chat_id+'" ><i class="material-icons">edit</i>'+confLH.transLation.edit+"</a>":"")+'<br/><a href="#" id="ask-help-popover-'+t.data.chat_id+'" ><i class="material-icons">supervisor_account</i>'+confLH.transLation.ask_help+"</a>"+(a?'<br/><a href="#" id="copy-text-popover-'+t.data.chat_id+'" ><i class="material-icons">content_copy</i>'+confLH.transLation.copy+" (Ctrl+C)</a>":"")+(a?"":'<br/><a href="#" id="copy-all-text-popover-'+t.data.chat_id+'" ><i class="material-icons">content_copy</i>'+confLH.transLation.copy+' (Ctrl+C)</a><br/><a href="#" id="copy-group-text-popover-'+t.data.chat_id+'" ><i class="material-icons">content_copy</i>'+confLH.transLation.copy_group+"</a>")+(a?"":'<br/><a href="#" id="translate-msg-'+t.data.chat_id+'" ><i class="material-icons">language</i>'+confLH.transLation.translate+"</a>")}},o=$("#messagesBlock-"+t.data.chat_id+" > #msg-"+i+" > .msg-body");if(0==o.length)return;return ee.emitEvent("quoteActionRight",[n,t.data.chat_id,i]),o.popover(n).popover("show").addClass("popover-copy"),$("#copy-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/quotemessage/"+i,(function(e){e.msg&&t.data.that.insertTextToMessageArea(t.data.chat_id,e.msg),t.data.that.hidePopover()}))})),$("#ask-help-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/quotemessage/"+i,(function(e){$("#private-chat-tab-link-"+t.data.chat_id).attr("private-loaded")?($("#private-chat-tab-link-"+t.data.chat_id).attr("private-loaded",!0).click(),new bootstrap.Tab(document.querySelector("#private-chat-tab-link-"+t.data.chat_id)).show(),ee.emitEvent("groupChatPrefillMessage",[t.data.chat_id,e.msg])):($("#private-chat-tab-link-"+t.data.chat_id).attr("private-loaded",!0).click(),new bootstrap.Tab(document.querySelector("#private-chat-tab-link-"+t.data.chat_id)).show(),ee.emitEvent("privateChatStart",[t.data.chat_id,{default_message:e.msg}])),t.data.that.hidePopover()}))})),!a&&$("#translate-msg-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),lhc.methodCall("lhc.translation","translateMessageVisitor",{msg_id:i,chat_id:t.data.chat_id}),t.data.that.hidePopover()})),!a&&$("#copy-all-text-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/quotemessage/"+i,(function(e){var a=$("#CSChatMessage-"+t.data.chat_id),i=a.val();a.val(e.msg),a.select(),document.execCommand("copy"),a.val(i),t.data.that.hidePopover()}))})),!a&&$("#copy-group-text-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/quotemessage/"+i+"/(type)/group",(function(e){var a=$("#CSChatMessage-"+t.data.chat_id),i=a.val();a.val(e.msg),a.select(),document.execCommand("copy"),a.val(i),t.data.that.hidePopover()}))})),s&&$("#edit-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/editprevious/"+t.data.chat_id+"/"+i,(function(e){if("f"==e.error){var a=$("#CSChatMessage-"+t.data.chat_id);a.val(e.msg).attr("data-msgid",e.id).addClass("edit-mode"),$("#msg-"+e.id).addClass("edit-mode"),a.focus()}else alert(e.error)})),t.data.that.hidePopover()})),a&&$("#copy-text-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault();var a=t.data.that.getSelectedTextPlain(),i=$("#CSChatMessage-"+t.data.chat_id),s=i.val();i.val(a),i.select(),document.execCommand("copy"),i.val(s),t.data.that.hidePopover()})),t.data.that.popoverShown=!0,t.data.that.popoverShownNow=!1,!1}},this.insertTextToMessageArea=function(t,e){var a=$("#CSChatMessage-"+t),i=a.val().replace(/^\s*\n/g,"");a.val((""!=i?i+"[quote]"+e+"[/quote]":"[quote]"+e+"[/quote]")+"\n").focus();var s=a[0];for(s.clientHeight,s.rows;s.scrollHeight>s.clientHeight&&!window.opera&&s.rows<30;)s.style.overflow="hidden",s.rows+=1;s.scrollHeight>s.clientHeight&&(s.style.overflow="auto")},this.mouseClicked=function(t){if(selected=t.data.that.getSelectedText(),$(".popover-copy").popover("dispose"),!selected.text.length||null!==t.data.that.selection&&t.data.that.selection.text===selected.text)t.data.that.selection=null;else{t.data.that.selection=selected;var e={placement:"right",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+t.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body"></div></div>',content:function(){return'<a href="#" id="copy-popover-'+t.data.chat_id+'" ><i class="material-icons">&#xE244;</i>'+confLH.transLation.quote+"</a>"}},a=void 0!==$(this).attr("id")?"#messagesBlock-"+t.data.chat_id+" > #msg-"+$(this).attr("id").replace("msg-","")+" > .msg-body":this,i=$(a);if(0==i.length)return;ee.emitEvent("quoteAction",[e,t.data.chat_id]),i.popover(e).popover("show").addClass("popover-copy"),$("#copy-popover-"+t.data.chat_id).click((function(){lhinst.quateSelection(t.data.chat_id)})),t.data.that.popoverShown=!0,t.data.that.popoverShownNow=!0}},this.addQuateHandler=function(t){this.popoverShown=!1,$("#messagesBlock-"+t+" > .message-row:not([qt])").on("mouseup",{chat_id:t,that:this},lhinst.mouseClicked).on("contextmenu",{chat_id:t,that:this},lhinst.mouseContextMenu).attr("qt",1)},this.getSelectedTextPlain=function(){var t=this.selection.text.replace(/[\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA]/g,"");return t=(t=(t=(t=t.replace(/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,"")).replace(/^[0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,"")).replace(/^\s*\n/gm,"")).replace(/^ /gm,"")},this.quateSelection=function(t){$(".popover-copy").popover("dispose");var e=this.getSelectedTextPlain();window.textreplace=e,this.insertTextToMessageArea(t,e),this.popoverShown=!1},this.hidePopover=function(){!0===this.popoverShownNow?this.popoverShownNow=!1:!0===this.popoverShown&&(this.popoverShown=!1,$(".popover-copy").popover("dispose"))},this.logOpenTrace=[],this.addOpenTrace=function(t){this.logOpenTrace.push(t)},this.addTab=function(t,e,a,i,s,n){if(t.find("#chat-tab-link-"+i).length>0)lhinst.logOpenTrace=[];else{var o=confLH.new_dashboard&&confLH.hide_tabs&&null!==document.getElementById("tabs-dashboard")?" d-none":"",r='<li role="presentation" id="chat-tab-li-'+i+'" class="nav-item'+o+'"><a class="nav-link chat-nav-item" href="#chat-id-'+i+'" id="chat-tab-link-'+i+'" aria-controls="chat-id-'+i+'" role="tab" data-bs-toggle="tab"><i id="msg-send-status-'+i+'" class="material-icons send-status-icon icon-user-online">send</i><i id="user-chat-status-'+i+'" class="chat-tab-content '+this.tabIconClass+'">'+this.tabIconContent+'</i><span class="ntab" id="ntab-chat-'+i+'">'+a.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</span><span onclick="return lhinst.removeDialogTab('+i+',$(\'#tabs\'),true)" class="material-icons icon-close-chat">close</span></a></li>';void 0===n||0==parseInt(n)?t.find("> ul").append(r):t.find("> ul > li:eq("+(n-1)+")").after(r),$("#chat-tab-link-"+i).click((function(){lhinst.previous_chat_id>0&&$("#unread-separator-"+lhinst.previous_chat_id).remove(),lhinst.previous_chat_id=i,setTimeout((function(){$("#CSChatMessage-"+i).focus()}),2);var t=$(this);setTimeout((function(){t.find(".msg-nm").remove();var e=!1;t.hasClass("has-pm")&&(e=!0,t.removeClass("has-pm")),1==e&&$("#messagesBlock-"+i).prop("scrollTop",$("#messagesBlock-"+i).prop("scrollHeight"))}),500),ee.emitEvent("chatTabClicked",[i,t])}));var c=window.location.hash.replace("#/","#"),l=this,d="";lhinst.logOpenTrace.length>0&&(d="/(ol)/"+lhinst.logOpenTrace.join("/"),lhinst.logOpenTrace=[]),$.get(e+d,(function(e){""!=e?(void 0===s||!0===s||c=="#chat-id-"+i?(t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+i+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active chat-tab-pane" id="chat-id-'+i+'"></div>'),window.location.hash="#/chat-id-"+i,t.addClass("chat-tab-selected")):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane chat-tab-pane" id="chat-id-'+i+'"></div>'),$("#chat-id-"+i).html(e),void 0!==s&&!0!==s&&c!="#chat-id-"+i||$("#CSChatMessage-"+i).focus(),0==l.disableremember&&l.rememberTab(i),l.addQuateHandler(i),l.loadMainData(i),ee.emitEvent("chatTabLoaded",[i])):l.removeDialogTab(i,t,!0)}))}},this.rememberTab=function(t){if(localStorage)try{t=parseInt(t);var e=localStorage.getItem("achat_id"),a=new Array;if(null!==e)a=e.split(",").map(Number);-1===a.indexOf(t)&&a.push(t),localStorage.setItem("achat_id",a.join(","))}catch(t){console.log(t)}},this.forgetChat=function(t,e){if(localStorage)try{t=parseInt(t);var a=localStorage.getItem(e),i=new Array;null!==a&&(i=a.split(",").map(Number)),-1!==i.indexOf(t)&&i.splice(i.indexOf(t),1),localStorage.setItem(e,i.join(","))}catch(t){console.log(t)}},this.attachTabNavigator=function(){$("#tabs > ul.nav > li > a").click((function(){$(this).find(".msg-nm").remove(),$(this).removeClass("has-pm")}))},this.holdAction=function(t,e){if(!$("#CSChatMessage-"+t).is("[readonly]")){var a=this;$.postJSON(this.wwwDir+"chat/holdaction/"+t,{sel:e.hasClass("btn-outline-info"),op:e.attr("data-type")},(function(i){0==i.error?(1==i.hold?(e.addClass("btn-outline-info"),"usr"==e.attr("data-type")?$("#hold-action-"+t).removeClass("btn-outline-info"):$("#hold-action-usr-"+t).removeClass("btn-outline-info")):e.removeClass("btn-outline-info"),""!=i.msg&&$("#messagesBlock-"+t).append(i.msg).scrollTop($("#messagesBlock-"+t).prop("scrollHeight")),a.syncadmincall()):alert(i.msg)}))}},this.copyContent=function(t){var e=document.createElement("textarea");e.value=t.attr("data-copy"),e.style.top="0",e.style.left="0",e.style.position="fixed",document.body.appendChild(e),e.focus(),e.select();try{document.execCommand("copy")}catch(t){alert("Oops, unable to copy")}document.body.removeChild(e);var a=new bootstrap.Tooltip(t,{trigger:"click",placement:"top"});a.show(),setTimeout((function(){a.dispose()}),1e3)},this.copyMessages=function(t){var e;return $("#chat-copy-messages").select(),document.execCommand("copy"),t.tooltip({trigger:"click",placement:"top"}),e=t.attr("data-success"),t.tooltip("hide").attr("data-original-title",e).tooltip("show"),setTimeout((function(){t.tooltip("hide")}),3e3),!1},this.removeDialogTabGroup=function(t,e){ee.emitEvent("unloadGroupChat",[t]);this.smartTabFocus(e,t)},this.addGroupTab=function(t,e,a,i){if(t.find("#chat-tab-link-"+a).length>0)return t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > li#chat-tab-li-"+a+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content > #chat-id-"+a).addClass("active"),void ee.emitEvent("groupChatTabClicked",[a]);var s='<li role="presentation" id="chat-tab-li-'+a+'" class="nav-item"><a class="nav-link" href="#chat-id-'+a+'" id="chat-tab-link-'+a+'" aria-controls="chat-id-'+a+'" role="tab" data-bs-toggle="tab"><i id="msg-send-status-'+a+'" class="material-icons send-status-icon icon-user-online">send</i><i class="whatshot blink-ani d-none text-warning material-icons">whatshot</i><i id="user-chat-status-'+a+'" class="'+this.tabIconClass+'">group</i><span class="ntab" id="ntab-chat-'+a+'">'+e.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</span><span onclick=\"return lhinst.removeDialogTabGroup('"+a+"',$('#tabs'),true)\" class=\"material-icons icon-close-chat\">close</span></a></li>";t.find("> ul").append(s);window.location.hash.replace("#/","#");!0!==i?(t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+a+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane chat-tab-pane active" id="chat-id-'+a+'"></div>')):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane chat-tab-pane" id="chat-id-'+a+'"></div>'),ee.emitEvent("groupChatTabLoaded",[a]),$("#chat-tab-link-"+a).click((function(){ee.emitEvent("groupChatTabClicked",[a.replace("gc","")])}))},this.startGroupChat=function(t,e,a,i){this.addGroupTab(e,a,"gc"+t,i)},this.hideShowAction=function(t){var e=$("#messagesBlock-"+t.chat_id),a=e.prop("scrollTop")+e.height()+30>e.prop("scrollHeight"),i=$("#message-more-"+t.id);i.hasClass("hide")?(i.removeClass("hide"),0==t.hide_show?$("#hide-show-action-"+t.id).remove():$("#hide-show-action-"+t.id).text(t.hide_text)):(i.addClass("hide"),1==t.hide_show&&$("#hide-show-action-"+t.id).text(t.show_text)),a&&e.scrollTop(e.prop("scrollHeight"))},this.buttonAction=function(t,e){var a=t.closest(".message-row");$.getJSON(this.wwwDir+"chat/abstractclick/"+a.attr("id").replace("msg-","")+"/"+e,(function(t){if(t.error)alert(t.error);else if(t.replace_id&&t.html){var e=$("#messagesBlock-"+t.chat_id),a=e.prop("scrollTop")+e.height()+30>e.prop("scrollHeight");$(t.replace_id).replaceWith(t.html),lhinst.addQuateHandler(t.chat_id),a&&e.scrollTop(e.prop("scrollHeight"))}else t.modal&&lhc.revealModal({url:WWW_DIR_JAVASCRIPT+t.modal})}))},this.startChat=function(t,e,a,i,s){if(this.removeBackgroundChat(t),this.hideNotification(t),$("#sub-tabs").length>0&&$("#sub-tabs a[href='#sub-tabs-open']").tab("show"),0==this.chatUnderSynchronization(t)){var n=void 0===i||i,o=0==this.disableremember?"/(remember)/true":"";this.addTab(e,this.wwwDir+"chat/adminchat/"+t+o,a,t,n,s);var r=this;setTimeout((function(){r.syncadmininterfacestatic()}),1e3)}else e.find("> ul > li > a.active").removeClass("active"),e.find("> ul > li#chat-tab-li-"+t+" > a").addClass("active"),e.find("> div.tab-content > div.active").removeClass("active"),e.find("> div.tab-content > #chat-id-"+t).addClass("active"),window.location.hash="#/chat-id-"+t;ee.emitEvent("chatStartTab",[t,{name:a,focus:void 0===i||i,position:s}])},this.backgroundChats=[],this.startChatBackground=function(t,e,a,i){if(0==this.chatUnderSynchronization(t)){this.backgroundChats.push(parseInt(t));var s=0==this.disableremember?"/(remember)/true":"";return i||(i="background"),this.addTab(e,this.wwwDir+"chat/adminchat/"+t+s+"/(arg)/"+i,a,t,!1),ee.emitEvent("chatStartBackground",[t,{name:a}]),!0}return!1},this.protectCSFR=function(){$("a.csfr-required").click((function(t){var e=$(this);e.attr("data-secured")||(e.attr("href",e.attr("href")+"/(csfr)/"+confLH.csrf_token),e.attr("data-secured",1)),e.hasClass("csfr-post")&&!e.hasClass("csfr-post-executed")&&(t.preventDefault(),t.stopPropagation(),e.addClass("csfr-post-executed"),!e.attr("data-trans")||confirm(confLH.transLation[e.attr("data-trans")])?$.post(e.attr("href"),(function(){document.location.reload()})).fail((function(){document.location.reload()})):setTimeout((function(){e.removeClass("csfr-post-executed")}),500))}))},this.addSynchroChat=function(t,e){this.chatsSynchronising.push(t),this.chatsSynchronisingMsg.push(t+","+e),LHCCallbacks.addSynchroChat&&LHCCallbacks.addSynchroChat(t,e)},this.removeSynchroChat=function(t,e){for(var a=0;a<this.chatsSynchronising.length;)this.chatsSynchronising[a]==t?(this.chatsSynchronising.splice(a,1),this.chatsSynchronisingMsg.splice(a,1)):a++;this.forgetChat(t,"achat_id"),!0!==e&&ee.emitEvent("removeSynchroChat",[t]),LHCCallbacks.removeSynchroChat&&LHCCallbacks.removeSynchroChat(t)},this.is_typing=!1,this.typing_timeout=null,this.operatorTypingCallback=function(t){var e=this.wwwDir,a=this;0==a.is_typing?(a.is_typing=!0,clearTimeout(a.typing_timeout),1==a.nodeJsMode?(a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3),ee.emitEvent("operatorTyping",[{chat_id:t,status:!0}])):$.getJSON(e+"chat/operatortyping/"+t+"/true",{},(function(e){a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3),LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0)})).fail((function(){a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3)}))):(clearTimeout(a.typing_timeout),a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3))},this.initTypingMonitoringAdmin=function(t){var e=this;jQuery("#CSChatMessage-"+t).bind("keyup",(function(a){e.operatorTypingCallback(t)}))},this.remarksTimeout=null,this.saveRemarks=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-"+t).addClass("text-warning"),$("#main-user-info-remarks-"+t+" .alert").remove();var e=this;this.remarksTimeout=setTimeout((function(){$.postJSON(e.wwwDir+"chat/saveremarks/"+t,{data:$("#ChatRemarks-"+t).val()},(function(e){"false"==e.error?$("#remarks-status-"+t).removeClass("text-warning"):$("#main-user-info-remarks-"+t).prepend(e.result)}))}),500)},this.reaction=function(t){$.postJSON(this.wwwDir+"chat/reaction/"+t.attr("data-msg-id"),{identifier:t.attr("data-identifier"),data:+t.attr("data-value")},(function(e){"false"==e.error?($("#reaction-message-info-"+t.attr("data-msg-id")).remove(),$("#reaction-message-"+t.attr("data-msg-id")).replaceWith(e.result)):alert(e.result)}))},this.saveNotes=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-online-"+t).addClass("text-warning");var e=this;this.remarksTimeout=setTimeout((function(){$.postJSON(e.wwwDir+"chat/saveonlinenotes/"+t,{data:$("#OnlineRemarks-"+t).val()},(function(e){$("#remarks-status-online-"+t).removeClass("text-warning")}))}),500)},this.surveyShowed=!1,this.typingStoppedOperator=function(t){var e=this;1==e.is_typing&&(1==lhinst.nodeJsMode?(e.is_typing=!1,ee.emitEvent("operatorTyping",[{chat_id:t,status:!1}])):$.getJSON(this.wwwDir+"chat/operatortyping/"+t+"/false",{},(function(a){e.is_typing=!1,LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!1)})).fail((function(){e.is_typing=!1})))},this.refreshFootPrint=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/chatfootprint/"+t.attr("rel"),{},(function(e){$("#footprint-"+t.attr("rel")).html(e),t.removeClass("disabled")}))},this.makeAbstractRequest=function(t,e){return $.get(e.attr("href"),(function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedSurvey&&LHCCallbacks.userRedirectedSurvey(t)})),!1},this.refreshOnlineUserInfo=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/refreshonlineinfo/"+t.attr("rel"),{},(function(e){$("#online-user-info-"+t.attr("rel")).html(e),t.removeClass("disabled")}))},this.processCollapse=function(t){if("chevron_right"==$("#chat-main-column-"+t+" .collapse-right").text()){$("#chat-right-column-"+t).hide(),$("#chat-main-column-"+t).removeClass("col-md-8").addClass("col-md-12"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_left");try{localStorage&&localStorage.setItem("lhc_rch",1)}catch(t){}}else{$("#chat-right-column-"+t).show(),$("#chat-main-column-"+t).removeClass("col-md-12").addClass("col-md-8"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_right");try{localStorage&&localStorage.removeItem("lhc_rch")}catch(t){}}},this.chatUnderSynchronization=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return!0;e++}return!1},this.getChatIndex=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return e;e++}return!1},this.closeActiveChatDialog=function(t,e,a){if(ee.emitEvent("angularSyncDisabled",[!0]),$.postJSON(this.wwwDir+this.closechatadmin+t,(function(e){ee.emitEvent("angularSyncDisabled",[!1]),0==e.error?ee.emitEvent("angularLoadChatList"):(alert(e.result),ee.emitEvent("angularStartChatbyId",[t]))})).fail((function(e,a,i){ee.emitEvent("angularSyncDisabled",[!1]),alert("There was an error processing your request: ["+e.status+"] ["+e.statusText+"] ["+e.responseText+"] "+i),ee.emitEvent("angularStartChatbyId",[t])})),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),window.postMessage&&window.opener&&window.opener.postMessage("lhc_ch:chatclosed:"+t,"*"),this.channel&&this.channel.postMessage({action:"close_chat",args:{chat_id:t}}),this.removeSynchroChat(t),1==a){var i=this.smartTabFocus(e,t);setTimeout((function(){window.location.hash=i}),500),1==this.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatClosedCallback&&LHCCallbacks.chatClosedCallback(t)},this.smartTabFocus=function(t,e,a){var i=t.find("> ul > #chat-tab-li-"+e).index();a||(a={});var s=1==a.up||void 0===a.up?1:-1;a.keep?t.find("> ul > li > a.active").removeClass("active"):(t.find("> ul > #chat-tab-li-"+e).remove(),t.find("#chat-id-"+e).remove());var n=t.find("> ul > li:eq("+(i-s)+")");if(void 0!==n.attr("id"))var o=n.find("> a");else if(linkTabRight=t.find("> ul > li:eq("+i+")"),linkTabRight.length>0)o=linkTabRight.find("> a");else o=n.find("> a");if(!t.find("> ul > li > a.active").length){for(var r=!0;r;)if(o.hasClass("non-focus")){r=!0;var c=o.parent().prev();c.find(" > a").length&&(o=c.find(" > a"))}else r=!1;if(o.tab("show"),void 0!==o.attr("id")){var l=o.attr("href").replace("#chat-id-","");this.removeBackgroundChat(l),this.hideNotification(l),a.keep||ee.emitEvent("chatTabFocused",[l])}}return void 0!==o.attr("href")?o.attr("href").replace("#","#/"):"#"},this.startChatCloseTabNewWindow=function(t,e,a){return window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650"),this.smartTabFocus(e,t),1==this.closeWindowOnChatCloseDelete&&window.close(),this.removeSynchroChat(t),this.syncadmininterfacestatic(),!1},this.removeDialogTab=function(t,e,a){if(this.channel&&!0===this.chatUnderSynchronization(t)&&this.channel.postMessage({action:"close_chat",args:{chat_id:t}}),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),this.removeSynchroChat(t),1==a){var i=this.smartTabFocus(e,t);setTimeout((function(){window.location.hash=i}),500),1==this.closeWindowOnChatCloseDelete&&window.close()}this.syncadmininterfacestatic()},this.removeActiveDialogTag=function(t){1==this.closeWindowOnChatCloseDelete&&window.close()},this.deleteChat=function(t,e,a){if(confirm(confLH.transLation.delete_confirm)){var i=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,(function(s){if(1==s.error)alert(s.result);else{if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),i.removeSynchroChat(t),1==a){var n=i.smartTabFocus(e,t);setTimeout((function(){window.location.hash=n}),500),1==i.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatDeletedCallback&&LHCCallbacks.chatDeletedCallback(t),i.syncadmininterfacestatic()}})).fail((function(t,e,a){console.dir(t),alert("getJSON request failed! "+e+":"+a+":"+t.responseText)}))}},this.rejectPendingChat=function(t,e){var a=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,{},(function(t){a.syncadmininterfacestatic()})).fail((function(t,e,a){console.dir(t),alert("getJSON request failed! "+e+":"+a+":"+t.responseText)}))},this.startChatNewWindowArchive=function(t,e,a){var i=window.open(this.wwwDir+"chatarchive/viewarchivedchat/"+t+"/"+e+"/(mode)/popup","chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650");null!==i&&(i.focus(),ee.emitEvent("chatStartOpenWindowArchive",[t,e]))},this.speechToText=function(t){0==this.speechHandler&&(this.speechHandler=new LHCSpeechToText),this.speechHandler.listen({chat_id:t})},this.startChatTransfer=function(t,e,a,i,s){var n=this;$.getJSON(this.wwwDir+this.accepttransfer+i,{},(function(i){0==$("#chat-tab-link-"+t).length?s?(n.removeSynchroChat(t),n.startChatBackground(t,e,a)):n.startChat(t,e,a):n.updateVoteStatus(t),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)})).fail((function(){n.startChat(t,e,a)}))},this.startChatNewWindowTransfer=function(t,e,a){return $.getJSON(this.wwwDir+this.accepttransfer+a,{},(function(e){LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)})),this.startChatNewWindow(t,e)},this.startChatNewWindowTransferByTransfer=function(t,e,a){var i=this;return $.ajax({type:"GET",url:this.wwwDir+this.accepttransfer+t+"/(mode)/chat",cache:!1,dataType:"json"}).done((function(t){$("#tabs").length>0?void 0!==a&&!0===a?(i.addOpenTrace("transfer_open_background"),i.startChatBackground(t.chat_id,$("#tabs"),e)):(window.focus(),i.addOpenTrace("transfer_open"),i.startChat(t.chat_id,$("#tabs"),e)):i.startChatNewWindow(t.chat_id,""),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t.chat_id)})),this.syncadmininterfacestatic(),!1},this.switchLang=function(t,e){var a='<input type="hidden" value="'+e+'" name="switchLang" />';return t.append(a),t.submit(),!1},this.sendLinkToMail=function(t,e){var a=window.parent.$("#MailMessage").val();window.parent.$("#MailMessage").val((""!=a?a+"\n":a)+t),$("#embed-button-"+e).addClass("btn-success")},this.sendLinkToEditor=function(t,e,a){var i=window.parent.$("#CSChatMessage-"+t).val();window.parent.$("#CSChatMessage-"+t).val((""!=i?i+"\n":i)+e),$("#embed-button-"+a).addClass("btn-success")},this.sendLinkToGeneralEditor=function(t,e,a){var i=window.parent.$(".embed-into");if(0==i.length&&(i=window.opener.$(".embed-into")),void 0!==a&&void 0!==a.replace&&1==a.replace)i.val(t);else{var s=i.val();i.val((""!=s?s+"\n":s)+t)}$("#embed-button-"+e).addClass("btn-success")},this.hideOnTransferHappen=function(t){var e=this,a=setInterval((function(){parseInt(confLH.user_id)!=parseInt($("#chat-owner-"+t).attr("user-id"))&&($("#tabs").length>0&&(e.removeDialogTab(t,$("#tabs"),!0),e.channel&&e.channel.postMessage({action:"close_chat",args:{chat_id:parseInt(t)}})),clearInterval(a))}),1e3)},this.hideTransferModal=function(t){var e=this;setTimeout((function(){$("#myModal").modal("hide"),$("#tabs").length>0&&e.hideOnTransferHappen(t)}),1e3)},this.transferChat=function(t){var e=this,a=$("[name=TransferTo"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+a,{type:"user"},(function(a){"false"==a.error&&($("#transfer-block-"+a.chat_id).html(a.result),e.hideTransferModal(t))}))},this.changeOwner=function(t){var e=this,a=$("#id_new_user_id").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+a,{type:"change_owner"},(function(a){"false"==a.error&&($("#transfer-block-"+a.chat_id).html(a.result),e.hideTransferModal(t))}))},this.changeDep=function(t){var e=this,a=$("#id_new_dep_id").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+a,{type:"change_dep"},(function(a){"false"==a.error&&($("#transfer-block-"+a.chat_id).html(a.result),$("#myModal").modal("hide"),e.updateVoteStatus(t))}))},this.chooseSurvey=function(t){var e=$("[name=SurveyItem"+t+"]:checked").val();$.postJSON(this.wwwDir+"survey/choosesurvey/"+t+"/"+e,(function(t){"false"==t.error&&$("#survey-block-"+t.chat_id).html(t.result)}))},this.redirectContact=function(t,e){(void 0===e||confirm(e))&&$.postJSON(this.wwwDir+"chat/redirectcontact/"+t,(function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedContact&&LHCCallbacks.userRedirectedContact(t)}))},this.redirectToURL=function(t){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/singleaction/"+t+"/redirecttourl"})},this.redirectToURLOnline=function(t,e){var a=prompt(e,"");null!=a&&(lhinst.addRemoteOnlineCommand(t,"lhc_chat_redirect:"+a.replace(new RegExp(":","g"),"__SPLIT__")),lhinst.addExecutionCommand(t,"lhc_cobrowse_multi_command__lhc_chat_redirect:"+a.replace(new RegExp(":","g"),"__SPLIT__")))},this.transferChatDep=function(t){var e=this,a=$("[name=DepartamentID"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+a,{type:"dep"},(function(a){"false"==a.error&&($("#transfer-block-"+a.chat_id).html(a.result),e.hideTransferModal(t))}))},this.chatTabsOpen=function(){return window.open(this.wwwDir+"chat/chattabs/","chatwindows","menubar=1,resizable=1,width=800,height=650"),!1},this.explicitClose=!1,this.sendCannedMessage=function(t,e){if($("#id_CannedMessage-"+t).val()>0){e.addClass("secondary");var a=1e3*parseInt($("#id_CannedMessage-"+t).find(":selected").attr("data-delay")),i=this.wwwDir,s=this;if(0==s.is_typing?(s.is_typing=!0,clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform&&LHCCallbacks.initTypingMonitoringAdminInform({chat_id:t,status:!0}),$.getJSON(i+"chat/operatortyping/"+t+"/true",{},(function(i){LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0),s.typing_timeout=setTimeout((function(){s.typingStoppedOperator(t),e.removeClass("secondary")}),a>3e3?a:3e3)})).fail((function(){s.typing_timeout=setTimeout((function(){s.typingStoppedOperator(t)}),3e3)}))):(clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout((function(){s.typingStoppedOperator(t)}),3e3),e.removeClass("secondary")),a>0)setTimeout((function(){var e={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).attr("mode-write")&&(e.mode_write=$("#CSChatMessage-"+t).attr("mode-write")),$("#CSChatMessage-"+t).val(""),$.postJSON(i+s.addmsgurl+t,e,(function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0}))}),a);else{var n={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).attr("mode-write")&&(n.mode_write=$("#CSChatMessage-"+t).attr("mode-write")),$("#CSChatMessage-"+t).val(""),$.postJSON(this.wwwDir+this.addmsgurl+t,n,(function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0}))}}return!1},this.theme=null,this.chatStatus=null,this.survey=null,this.isBlinking=!1,this.startBlinking=function(){if(0==this.isBlinking){var t=this;(a=document.title,i="!!! "+document.title,s=function(){document.title=document.title==i?" ":i},n=function(){clearInterval(e),document.title=a,window.onmousemove=null,e=null,t.isBlinking=!1},function(){e||(e=setInterval(s,1e3),window.onmousemove=n)})(),this.isBlinking=!0}var e,a,i,s,n},this.playNewMessageSound=function(){Modernizr.audio&&null!==this.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_message.ogg?v=3":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_message.mp3?v=3":WWW_DIR_JAVASCRIPT_FILES+"/new_message.wav?v=3",this.audio.load()),$("textarea[name=ChatMessage]").is(":focus")||this.startBlinking()},this.playInvitationSound=function(){Modernizr.audio&&null!==this.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/invitation.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/invitation.mp3":WWW_DIR_JAVASCRIPT_FILES+"/invitation.wav",this.audio.load())},this.playPreloadSound=function(){Modernizr.audio&&null!==this.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/silence.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/silence.mp3":WWW_DIR_JAVASCRIPT_FILES+"/silence.wav",this.audio.load())},this.scrollLoading=!1,this.scrollPending=!1,this.loadPreviousMessages=function(t,e){if(0==this.scrollLoading){this.scrollLoading=!0;var a=this;$.getJSON(this.wwwDir+"chat/loadpreviousmessages/"+t.attr("chat-id")+"/"+t.attr("message-id")+"/(initial)/"+t.attr("data-initial")+"/(original)/"+t.attr("chat-original-id"),(function(i){if(0==i.error){t.attr("data-initial",0);var s=$("#messagesBlock-"+t.attr("chat-original-id"));if(s.prepend(i.result),1==t.attr("auto-scroll"))t.attr("auto-scroll",0),s.scrollTop(s.prop("scrollHeight"));else if(!e){var n=document.getElementById("scroll-to-chat-"+t.attr("chat-id")+"-"+t.attr("message-id"));n&&(s[0].scrollTop=n.offsetTop)}1==i.has_messages?(t.attr("message-id",i.message_id),t.attr("chat-id",i.chat_id),a.scrollLoading=!1,1==a.scrollPending&&(a.scrollPending=!1,a.loadPreviousMessages(t,e))):(t.remove(),a.scrollLoading=!1,a.scrollPending=!1)}else a.scrollLoading=!1,a.scrollPending=!1}))}else this.scrollPending=!0},this.hidenicknamesstatus=null,this.onScrollAdmin=function(t){var e=$("#messagesBlock-"+t),a=e.prop("scrollHeight");Math.abs(a-e.prop("scrollTop")-e.prop("clientHeight"))>20?$("#scroll-button-admin-"+t).removeClass("d-none"):$("#scroll-button-admin-"+t).addClass("d-none").find("> button").text($("#scroll-button-admin-"+t+" > button").attr("data-default"))},this.scrollToTheBottomMessage=function(t){var e=$("#unread-separator-"+t);if(e.length>0)e[0].scrollIntoView(),setTimeout((function(){e.remove()}),1e3);else{var a=$("#messagesBlock-"+t);a.scrollTop(a.prop("scrollHeight"))}},this.syncadmincall=function(){this.chatsSynchronising.length>0?0==this.underMessageAdd&&0==this.syncroRequestSend?(this.syncroRequestSend=!0,$.postJSON(this.wwwDir+this.syncadmin,{"chats[]":this.chatsSynchronisingMsg},(function(t){void 0!==t.error_url&&document.location.replace(t.error_url);try{if("false"==t.error){if("false"!=t.result){var e=!1;$.each(t.result,(function(a,i){var s=$("#messagesBlock-"+i.chat_id),n=s.prop("scrollHeight"),o=Math.abs(n-s.prop("scrollTop")-s.prop("clientHeight"));s.find(".pending-storage").slice(0,i.mn).remove();var r=$("#chat-tab-link-"+i.chat_id),c=!focused;if(!r.hasClass("active"))if(r.find("span.msg-nm").length>0){var l=parseInt(r.find("span.msg-nm").attr("rel"))+i.mn;r.find("span.msg-nm").html(" ("+l+")").attr("rel",l)}else c=!0,r.append('<span rel="'+i.mn+'" class="msg-nm"> ('+i.mn+")</span>"),r.addClass("has-pm");o>20&&(c=!0,$("#scroll-button-admin-"+i.chat_id+" > button").text($("#scroll-button-admin-"+i.chat_id+" > button").attr("data-new"))),1==c&&null===document.getElementById("unread-separator-"+i.chat_id)&&(i.content=i.content.replace('<span class="usr-tit','<div id="unread-separator-'+i.chat_id+'" class="new-msg-holder border-bottom border-danger text-center"><span class="new-msg bg-danger text-white d-inline-block fs12 rounded-top">'+confLH.transLation.new+'</span></div><span class="usr-tit')),s.append(i.content),s.find(".pending-storage").appendTo(s),lhinst.addQuateHandler(i.chat_id),o<20&&s.scrollTop(n),lhinst.updateChatLastMessageID(i.chat_id,i.message_id),0!=e||"false"!=t.uw||void 0!==i.ignore&&!1!==typeof i.ignore||(e=!0),"false"==t.uw&&ee.emitEvent("angularActionHappened",[{type:"user_wrote",chat_id:i.chat_id,msg:i.msg,nick:i.nck}]),1!=confLH.new_message_browser_notification||"false"!=t.uw||void 0!==i.ignore&&!1!==typeof i.ignore||lhinst.showNewMessageNotification(i.chat_id,i.msg,i.nck),i.msfrom>0&&$("#msg-"+i.msfrom).attr("data-op-id")!=i.msop&&$("#msg-"+i.msfrom).next().addClass("operator-changes"),ee.emitEvent("eventSyncAdmin",[i,a])})),1==confLH.new_message_sound_admin_enabled&&"false"==t.uw&&1==e&&lhinst.playNewMessageSound()}if("false"!=t.result_status){var a=$("#group-chats-status").hasClass("chat-active");$.each(t.result_status,(function(t,e){var i=$("#user-is-typing-"+e.chat_id);"true"==e.tp?(0==lhinst.nodeJsMode&&i.html(e.tx),"hidden"==i.css("visibility")&&i.css("visibility","visible")):0==lhinst.nodeJsMode&&i.css("visibility","hidden"),$("#last-msg-chat-"+e.chat_id).text(e.lmsg);var s=$("#user-chat-status-"+e.chat_id),n=s.hasClass("icon-user-online");$("#chat-duration-"+e.chat_id).text(e.cdur),s.removeClass("icon-user-online icon-user-away icon-user-pageview"),$("#msg-send-status-"+e.chat_id).removeClass("icon-user-online icon-user-offline"),0==e.us?s.addClass("icon-user-online"):2==e.us?s.addClass("icon-user-away"):3==e.us&&s.addClass("icon-user-pageview"),1==a?1==n&&0!=e.us||lhinst.hidenicknamesstatus!=a&&0!=e.us?$("#ntab-chat-"+e.chat_id).hide():(0==n&&0==e.us||lhinst.hidenicknamesstatus!=a&&0==e.us)&&$("#ntab-chat-"+e.chat_id).show():lhinst.hidenicknamesstatus!=a&&$("#ntab-chat-"+e.chat_id).show();var o=$("#chat-id-"+e.chat_id+"-mds");if(o.attr("data-chat-status")==e.cs&&o.attr("data-chat-user")==e.co||lhinst.updateVoteStatus(e.chat_id),1==e.um?(o.addClass("chat-unread"),$("#msg-send-status-"+e.chat_id).addClass("icon-user-offline"),3==e.ssub&&$("#messagesBlock-"+e.chat_id).find(".msg-del-st-0,.msg-del-st-1").removeClass("msg-del-st-0 msg-del-st-1").addClass("msg-del-st-2").text("done_all")):($("#msg-send-status-"+e.chat_id).addClass("icon-user-online"),o.removeClass("chat-unread"),$("#messagesBlock-"+e.chat_id).find(".msg-del-st-0,.msg-del-st-1,.msg-del-st-2").remove()),!1!==e.lp?o.attr("title",e.lp+" s."):o.attr("title",""),void 0!==e.oad&&1==e.oad){$("#lhc_sync_operation").remove();var r=document.getElementsByTagName("head")[0],c=document.createElement("script");c.setAttribute("id","lhc_sync_operation"),c.setAttribute("type","text/javascript"),c.setAttribute("src",WWW_DIR_JAVASCRIPT+"chat/loadoperatorjs/(type)/chat/(id)/"+e.chat_id),r.appendChild(c)}}))}t.cg&&$.each(t.cg,(function(t,e){return lhinst.removeDialogTab(e,$("#tabs"),!0)})),lhinst.hidenicknamesstatus=a,clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),ee.emitEvent("chatAdminSync",[t])}}catch(t){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}lhinst.setSynchronizationRequestSend(!1),LHCCallbacks.syncadmincall&&LHCCallbacks.syncadmincall(lhinst,t)})).fail((function(){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),lhinst.setSynchronizationRequestSend(!1)}))):(clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)):this.isSinchronizing=!1},this.updateVoteStatus=function(t,e){var a=this;$.getJSON(this.wwwDir+"chat/updatechatstatus/"+t,{},(function(i){$("#main-user-info-tab-"+t).html(i.result),$("#messagesBlock-"+t+" span.vis-tit").each((function(t){var e=$(this).children();$(this).text(" "+i.nick).prepend(e)})),$("#ntab-chat-"+t).text(i.nick),ee.emitEvent("chatTabInfoReload",[t]),!e&&a.channel&&a.channel.postMessage({action:"update_chat",args:{chat_id:parseInt(t)}})}))},this.updateChatLastMessageID=function(t,e){this.chatsSynchronisingMsg[this.getChatIndex(t)]=t+","+e},this.requestNotificationPermission=function(){window.webkitNotifications?window.webkitNotifications.requestPermission():window.Notification?Notification.requestPermission((function(t){})):alert("Notification API in your browser is not supported.")},this.playNewChatAudio=function(t){if(clearTimeout(this.soundIsPlaying),this.soundPlayedTimes++,Modernizr.audio&&null!==this.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/"+t+".ogg?v=4":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/"+t+".mp3?v=4":WWW_DIR_JAVASCRIPT_FILES+"/"+t+".wav?v=4",this.audio.load(),confLH.repeat_sound>this.soundPlayedTimes)){var e=this;this.soundIsPlaying=setTimeout((function(){e.playNewChatAudio(t)}),1e3*confLH.repeat_sound_delay)}},this.focusChanged=function(t){if(1==confLH.new_message_browser_notification&&1==t&&(window.webkitNotifications||window.Notification)){var e=this;$.each(this.chatsSynchronising,(function(t,a){void 0!==e.notificationsArrayMessages[a]&&(window.webkitNotifications?e.notificationsArrayMessages[a].cancel():e.notificationsArrayMessages[a].close(),delete e.notificationsArrayMessages[a])}))}parseInt(this.chat_id)>0&&this.scheduleSync()},this.notificationsArrayMessages=[],this.showNewMessageNotification=function(t,e,a){try{if(window.Notification&&0==focused&&"granted"==window.Notification.permission){void 0!==this.notificationsArrayMessages[t]&&(this.notificationsArrayMessages[t].close(),delete this.notificationsArrayMessages[t]);var i=new Notification(a,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:e}),s=this;i.onclick=function(){window.focus(),i.close(),delete s.notificationsArrayMessages[t]},i.onclose=function(){void 0!==s.notificationsArrayMessages[t]&&delete s.notificationsArrayMessages[t]},this.notificationsArrayMessages[t]=i,this.scheduleNewMessageClose(i,t)}}catch(t){console.log(t)}},this.scheduleNewMessageClose=function(t,e){var a=this;setTimeout((function(){window.webkitNotifications?t.cancel():t.close(),void 0!==a.notificationsArrayMessages[e]&&delete a.notificationsArrayMessages[e]}),1e4)},this.playSoundNewAction=function(t,e,a,i,s){if(-1==this.backgroundChats.indexOf(parseInt(e))){ee.emitEvent("angularActionHappened",[{type:t,chat_id:e,msg:i,nick:a}]),1!=confLH.new_chat_sound_enabled||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"active_chats"!=t&&"bot_chats"!=t&&"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||(this.soundPlayedTimes=0,this.playNewChatAudio("active_chats"==t?"alert":"new_chat")),$("textarea[name=ChatMessage]").is(":focus")||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"subject_chats"!=t&&"active_chats"!=t&&"bot_chats"!=t&&"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||this.startBlinking(),"subject_chats"==t&&(this.soundPlayedTimes=0,this.playNewChatAudio("subject_chat"));var n=this;if(("subject_chats"==t||"active_chats"==t||"pending_chat"==t||"transfer_chat"==t||"unread_chat"==t||"bot_chats"==t||"pending_transfered"==t)&&(1==confLH.sn_off||"flash_on"==$("#online-offline-user").text())&&window.Notification&&"granted"==window.Notification.permission){var o=new Notification(a,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:i,requireInteraction:!0});o.onclick=function(){"subject_chats"==t||"active_chats"==t||"pending_chat"==t||"unread_chat"==t||"pending_transfered"==t||"bot_chats"==t?$("#tabs").length>0?(window.focus(),n.addOpenTrace("click_notification"),n.startChat(e,$("#tabs"),s)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,s),o.close()},"pending_transfered"!=t&&("undefined"!==this.notificationsArray[e]&&o.close(),this.notificationsArray[e]=o)}"transfer_chat"==t&&confLH.accept_chats?n.startChatNewWindowTransferByTransfer(e,s,!0):"transfer_chat"==t&&1==confLH.show_alert_transfer&&confirm(confLH.transLation.transfered+"\n\n"+i)&&n.startChatNewWindowTransferByTransfer(e,s),1==confLH.show_alert&&confirm(confLH.transLation.new_chat+"\n\n"+i)&&("pending_chat"==t||"unread_chat"==t||"pending_transfered"==t||"bot_chats"==t?$("#tabs").length>0?(window.focus(),n.addOpenTrace("alert_open"),n.startChat(e,$("#tabs"),s)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,s))}},this.syncadmininterfacestatic=function(){try{ee.emitEvent("angularLoadChatList")}catch(t){}},this.addingUserMessage=!1,this.addUserMessageQueue=[],this.addDelayedTimeout=null,this.addmsgadmin=function(t,e){$("#unread-separator-"+t).remove();var a=$("#CSChatMessage-"+t);if(!a.is("[readonly]")){var i={msg:e||a.val()};if(a.attr("meta-msg")&&(i.meta_msg=a.attr("meta-msg"),a.removeAttr("meta-msg")),a.attr("mode-write")&&(i.mode_write=a.attr("mode-write")),""!=i.msg){!1!==this.speechHandler&&this.speechHandler.messageSend(),e||a.val("");var s=a.attr("placeholder");if(a.attr("placeholder",confLH.transLation.sending||"Sending..."),a.hasClass("edit-mode"))i.msgid=a.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsg/"+t,i,(function(e){if(a.attr("placeholder",s),"f"==e.error)return a.removeClass("edit-mode"),a.removeAttr("data-msgid"),$("#msg-"+i.msgid).replaceWith(e.msg),LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.addQuateHandler(t),!0}));else{var n=this,o=$("#messagesBlock-"+t);if(e||o.append('<div class="message-row message-admin pending-storage"><div class="msg-body"><span class="material-icons lhc-spin">autorenew</span>'+$("<div>").text(i.msg).html()+"</div></div>"),o.scrollTop(o.prop("scrollHeight")),0==this.addingUserMessage){this.addingUserMessage=!0;var r=!1;a.attr("subjects_ids")&&(i.subjects_ids=a.attr("subjects_ids"),a.removeAttr("subjects_ids"),r=!0),a.attr("canned_id")&&(i.canned_id=a.attr("canned_id"),a.removeAttr("canned_id")),a.attr("whisper")&&(i.whisper=1),$.postJSON(this.wwwDir+this.addmsgurl+t,i,(function(e){if(a.removeAttr("readonly").attr("placeholder",s),"false"==e.error)LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),""!=e.r&&$("#messagesBlock-"+t).append(e.r).scrollTop($("#messagesBlock-"+t).prop("scrollHeight")).find(".pending-storage").remove(),!0===e.hold_removed?$("#hold-action-"+t).removeClass("btn-outline-info"):!0===e.hold_added&&$("#hold-action-"+t).addClass("btn-outline-info"),1!=r&&!0!==e.update_status||n.updateVoteStatus(t),lhinst.syncadmincall();else{void 0!==e.token&&(confLH.csrf_token=e.token),a.attr("placeholder",s).val((a.val()+" "+i.msg).trim()),$(".pending-storage").first().remove();var o='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text(e.r).html()+"</div>";$("#messagesBlock-"+t).append(o).scrollTop($("#messagesBlock-"+t).prop("scrollHeight"))}if(n.addingUserMessage=!1,n.addUserMessageQueue.length>0){var c=n.addUserMessageQueue.shift();n.addmsgadmin(c.chat_id,c.msg)}return!0})).fail((function(e){a.attr("placeholder",s).val(a.val()+" "+i.msg);var o='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("You have weak internet connection or the server has problems. Try to refresh the page or send the message again."+(void 0!==e.status?" Error code ["+e.status+"]":"")+(void 0!==e.responseText?e.responseText:"")).html()+"</div>";if($("#messagesBlock-"+t).append(o).scrollTop($("#messagesBlock-"+t).prop("scrollHeight")),$(".pending-storage").first().remove(),n.addingUserMessage=!1,n.addUserMessageQueue.length>0){var r=n.addUserMessageQueue.shift();n.addmsgadmin(r.chat_id,r.msg)}}))}else a.attr("placeholder",s),this.addUserMessageQueue.push({chat_id:t,msg:i.msg})}}}},this.editPrevious=function(t){var e=$("#CSChatMessage-"+t);""==e.val()&&"true"!==e.attr("disable-edit")&&$.getJSON(this.wwwDir+"chat/editprevious/"+t,(function(a){"f"==a.error&&(e.val(a.msg),e.attr("data-msgid",a.id),e.addClass("edit-mode"),$("#msg-"+a.id).addClass("edit-mode"),LHCCallbacks.editPrevious&&LHCCallbacks.editPrevious(t,a))}))},this.afterAdminChatInit=function(t){LHCCallbacks.afterAdminChatInit&&LHCCallbacks.afterAdminChatInit(t)},this.getInputSelection=function(t){return void 0!==t?(s=t[0].selectionStart,e=t[0].selectionEnd,t.val().substring(s,e)):""},this.handleBBCode=function(t){var e=$(t.attr("data-selector")).val(),a=$(t.attr("data-selector"));if(void 0!==a)var i=a[0].selectionStart,s=a[0].selectionEnd,n=e.substring(i,s);else n="";var o=void 0!==t.attr("data-bbcode-end")?t.attr("data-bbcode-end"):t.attr("data-bbcode");return n.length>0?$(t.attr("data-selector")).val(e.substr(0,i)+"["+t.attr("data-bbcode")+"]"+n+"[/"+o+"]"+e.substring(s)):$(t.attr("data-selector")).val(e+"["+t.attr("data-bbcode")+"][/"+o+"]"),!1},this.addAdminChatFinished=function(t,e,a){var i=this,s=jQuery("#CSChatMessage-"+t);new LHCCannedMessageAutoSuggest({chat_id:t,uppercase_enabled:confLH.auto_uppercase});if(null!==document.getElementById("color-picker-chat-"+t)){var n=new ColorPicker({dom:document.getElementById("color-picker-chat-"+t),value:"#0F0"});n.addEventListener("change",(function(e){$("#color-apply-"+t).attr("data-bbcode","color="+n.getValue("hex"))})),$(".downdown-menu-color-"+t).on("click",(function(t){if($(this).parent().is(".show")){var e=$(t.target);return!e.hasClass("keepopen")&&!e.parents(".keepopen").length}})),$(".downdown-menu-color-"+t+" .color-item").on("click",(function(){n.setValue($(this).attr("data-color"))}))}s.bind("click",(function(e){$(".dropdown-menu-main").removeClass("show").find("> .dropdown-menu").removeClass("show"),$("#CSChatMessage-"+t).focus(),$("#chat-tab-link-"+t).hasClass("active")||($("#chat-tab-link-"+t).click(),new bootstrap.Tab(document.querySelector("#chat-tab-link-"+t)).show())})),$("#dropdown-menu-main-action-"+t).click((function(){$(this).parent().toggleClass("show"),$(this).parent().find("> div.dropdown-menu").toggleClass("show")})),s.bind("keydown","return",(function(e){return i.addmsgadmin(t),ee.emitEvent("afterAdminMessageSent",[t]),s[0].rows=s.attr("data-rows-default"),!1})),s.bind("keyup","up",(function(e){i.editPrevious(t)})),s.bind("keyup",(function(e){if(""==s.val()&&(s.removeAttr("subjects_ids"),s.removeAttr("canned_id"),s.removeAttr("content_modified")),""!=s.val()||!e.altKey||38!=e.which&&40!=e.which){var a=s[0];(38==e.which||8==e.which||46==e.which)&&a.value.split(/\r\n|\r|\n/).length<=a.rows&&parseInt(s.attr("data-rows-default"))<=a.value.split(/\r\n|\r|\n/).length&&(a.rows=a.value.split(/\r\n|\r|\n/).length);for(a.clientHeight,a.rows;a.scrollHeight>a.clientHeight&&!window.opera&&a.rows<30;)a.style.overflow="hidden",a.rows+=1;a.scrollHeight>a.clientHeight&&(a.style.overflow="auto"),""!=s.val()&&s.attr("content_modified",!0)}else if(1==confLH.new_dashboard)ee.emitEvent("activateNextTab",[t,38==e.which]);else{if(38==e.which)var i=lhinst.smartTabFocus($("#tabs"),t,{keep:!0,up:!0});else i=lhinst.smartTabFocus($("#tabs"),t,{keep:!0,up:!1});var n=i.split("chat-id-");n[1]&&!isNaN(n[1])&&($("#chat-tab-link-"+n[1]).click(),new bootstrap.Tab(document.querySelector("#chat-tab-link-"+n[1])).show())}})),$messageBlock=$("#messagesBlock-"+t),$messageBlock.css("height",this.getLocalValue("lhc_mheight",confLH.defaultm_hegiht)),$messageBlock.data("resized",!1),$messageBlock.data("y",$messageBlock.outerHeight()),$messageBlock.bind("mouseup mousemove",(function(t){var e=jQuery(this);e.outerHeight()!=e.data("y")&&(0==e.data("resized")&&(e.css("height","1px"),e.data("resized",!0)),this.resize_timeout&&clearTimeout(this.resize_timeout),this.resize_timeout=setTimeout((function(){i.setLocalValue("lhc_mheight",e.outerHeight()),e.data("y",e.outerHeight())}),100))})),1==confLH.scroll_load&&($messageBlock[0].oldScrollTop=$messageBlock[0].scrollTop,$messageBlock.bind("scroll",(function(e){var a=jQuery(this);a[0].oldScrollTop>a[0].scrollTop&&a[0].scrollTop<300&&1==$("#load-prev-btn-"+t).length&&i.loadPreviousMessages($("#load-prev-btn-"+t),!0),a[0].oldScrollTop=a[0].scrollTop}))),this.initTypingMonitoringAdmin(t),this.afterAdminChatInit(t),this.addSynchroChat(t,e),1!==confLH.no_scroll_bottom&&$messageBlock.prop("scrollTop",$messageBlock.prop("scrollHeight")),this.startSyncAdmin(),null===a||"object"!=typeof a||-1===a.indexOf("background")?this.hideNotification(t):$("#chat-tab-link-"+t).click((function(){i.removeBackgroundChat(parseInt(t)),i.hideNotification(parseInt(t))}));try{localStorage&&1==localStorage.getItem("lhc_rch")&&this.processCollapse(t)}catch(t){}$("#chat-tab-items-"+t+" > li > a").click((function(){ee.emitEvent("adminChatTabSubtabClicked",[t,$(this)])})),$("#chat-write-button-"+t).click((function(){$("#CSChatMessage-"+t).show().focus().removeAttr("whisper").removeClass("bg-light").attr("placeholder",$(this).attr("data-plc")),$(this).removeClass("btn-outline-secondary").addClass("btn-outline-primary"),$("#chat-preview-button-"+t+",#chat-whisper-button-"+t).removeClass("btn-outline-primary").addClass("btn-outline-secondary"),$("#chat-preview-container-"+t).hide(),$("#chat-join-as-container-"+t).removeClass("hide")})),$("#chat-preview-button-"+t).click((function(){$("#chat-preview-container-"+t).html("...").show(),$("#CSChatMessage-"+t).hide(),$(this).removeClass("btn-outline-secondary").addClass("btn-outline-primary"),$("#chat-join-as-container-"+t).addClass("hide"),$("#chat-write-button-"+t+",#chat-whisper-button-"+t).removeClass("btn-outline-primary").addClass("btn-outline-secondary"),jQuery.post(WWW_DIR_JAVASCRIPT+"chat/previewmessage",{msg_body:!0,msg:$("#CSChatMessage-"+t).val()},(function(e){$("#chat-preview-container-"+t).html(e)}))})),$("#chat-whisper-button-"+t).click((function(){$("#CSChatMessage-"+t).show().focus().attr("whisper","1").addClass("bg-light").attr("placeholder",$(this).attr("data-plc")),$("#chat-preview-container-"+t).hide(),$(this).removeClass("btn-outline-secondary").addClass("btn-outline-primary"),$("#chat-write-button-"+t+",#chat-preview-button-"+t).removeClass("btn-outline-primary").addClass("btn-outline-secondary"),$("#chat-join-as-container-"+t).addClass("hide")})),$("#chat-join-as-"+t).click((function(){$("#chat-join-as-container-"+t).addClass("hide mode-chosen"),$("chat-write-button-"+t).attr("data-plc",$("#chat-mode-selected-"+t).find(":selected").attr("data-plc")),$("#CSChatMessage-"+t).attr("placeholder",$("#chat-mode-selected-"+t).find(":selected").attr("data-plc")),$("#CSChatMessage-"+t).attr("mode-write",$("#chat-mode-selected-"+t).val()).focus()})),$("#chat-impersonate-option-"+t).click((function(){$("#chat-write-button-"+t).click(),$("#chat-join-as-container-"+t).removeClass("hide mode-chosen")})),ee.emitEvent("adminChatLoaded",[t,e,a])},this.removeBackgroundChat=function(t){var e=this.backgroundChats.indexOf(parseInt(t));-1!==e&&delete this.backgroundChats[e]},this.getLocalValue=function(t,e){try{if(localStorage){var a=localStorage.getItem(t);return null!==a?a:e}}catch(t){}return e},this.setLocalValue=function(t,e){try{localStorage&&localStorage.setItem(t,e)}catch(t){}},this.hideNotification=function(t){t=parseInt(t),void 0!==this.notificationsArray[t]&&-1==this.backgroundChats.indexOf(t)&&(this.notificationsArray[t].close(),delete this.notificationsArray[t]),clearTimeout(this.soundIsPlaying)},this.showMyPermissions=function(t){$.get(this.wwwDir+"permission/getpermissionsummary/"+t,(function(t){$("#permissions-summary").html(t)}))},this.updateMessageRowAdmin=function(t,e){$.getJSON(this.wwwDir+"chat/getmessageadmin/"+t+"/"+e,(function(a){if("f"==a.error){var i=$("#messagesBlock-"+t),s=i.prop("scrollTop")+i.height()+30>i.prop("scrollHeight");$("#msg-"+e).replaceWith(a.msg),lhinst.addQuateHandler(t),$("#msg-"+e).addClass("msg-updated"),setTimeout((function(){$("#msg-"+e).removeClass("msg-updated")}),2e3),s&&i.scrollTop(i.prop("scrollHeight"))}}))},this.startSyncAdmin=function(){0==this.isSinchronizing&&(this.isSinchronizing=!0,this.syncadmincall())},this.disableChatSoundAdmin=function(t){return"I"!=t.prop("tagName")&&(t=t.find("> i.material-icons")),"volume_off"==t.text()?($.post(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_admin_enabled=1,t.text("volume_up")):($.post(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_admin_enabled=0,t.text("volume_off")),!1},this.disableNewChatSoundAdmin=function(t){return"I"!=t.prop("tagName")&&(t=t.find("> i.material-icons")),"volume_off"==t.text()?($.post(this.wwwDir+"user/setsettingajax/new_chat_sound/1"),confLH.new_chat_sound_enabled=1,t.text("volume_up")):($.post(this.wwwDir+"user/setsettingajax/new_chat_sound/0"),confLH.new_chat_sound_enabled=0,t.text("volume_off")),!1},this.changeUserSettings=function(t,e){$.post(this.wwwDir+"user/setsettingajax/"+t+"/"+e)},this.changeUserSettingsIndifferent=function(t,e){$.post(this.wwwDir+"user/setsettingajax/"+t+"/"+encodeURIComponent(""==e?"__empty__":e)+"/(indifferent)/true")},this.changeStatusAction=function(t,e){var a=this;return $.postJSON(t.attr("action"),t.serialize(),(function(t){"false"==t.error?($("#myModal").modal("hide"),a.updateVoteStatus(e),!0===t.is_owner&&($("#CSChatMessage-"+e).attr("placeholder",""),$("#CSChatMessage-"+e).focus())):alert(t.result)})),!1},this.submitModalForm=function(t,e){return $("#modal-in-progress").removeClass("hide"),$(".modal-submit-disable").addClass("disabled").attr("disabled","disabled"),$.ajax({url:t.attr("action"),type:t.attr("method"),data:new FormData(t[0]),processData:!1,contentType:!1,success:function(t,a){$("#modal-in-progress").addClass("hide"),$(".modal-submit-disable").removeClass("disabled").attr("disabled","disabled");var i=e?"#"+e:"#myModal";if(!e)var s=$("#myModal > .modal-dialog")[0].style.cssText;$(i).html(t),!e&&$("#myModal > .modal-dialog").length>0?$("#myModal > .modal-dialog")[0].style.cssText=s:$(i).html('<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-body">'+t+"</div></div></div>")},error:function(t,e,a){alert("An error has accoured! "+t.responseText)}}),!1},this.pendingMessagesToStore=[],this.setSubject=function(t,e){$("#subject-message-"+e).text("..."),$.postJSON(this.wwwDir+"chat/subject/"+e+"/(subject)/"+t.val()+"/(status)/"+t.is(":checked"),{update:!0},(function(t){lhinst.updateVoteStatus(e),$("#subject-message-"+e).text(t.message)}))},this.deleteChatfile=function(t){$.postJSON(this.wwwDir+"file/deletechatfile/"+t,(function(e){"false"==e.error?$("#file-id-"+t).remove():alert(e.result)}))},this.updateChatFiles=function(t){$.postJSON(this.wwwDir+"file/chatfileslist/"+t,(function(e){$("#chat-files-list-"+t).html(e.result)}))},this.updateOnlineFiles=function(t){$.postJSON(this.wwwDir+"file/onlinefileslist/"+t,(function(e){$("#online-user-files-list-"+t).html(e.result)}))},this.updateOnlineFilesUser=function(t){$.postJSON(this.wwwDir+"file/useronlinefileslist/"+t,(function(t){$("#user-online-files-list").html(t.result)}))},this.addFileUpload=function(t){$("#fileupload-"+t.chat_id).fileupload({url:this.wwwDir+"file/uploadfileadmin/"+t.chat_id,dataType:"json",add:function(e,a){var i=[],s=t.ft_op;s.test(a.originalFiles[0].type)||s.test(a.originalFiles[0].name)||i.push(t.ft_msg),a.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):a.submit()},done:function(e,a){var i=a.response();if(null!=i&&null!=i.result&&"true"==i.result.error&&null!=i.result.error_msg)alert(i.result.error_msg);else{lhinst.updateChatFiles(t.chat_id);var s=$("#CSChatMessage-"+t.chat_id),n=jQuery.trim(s.val());s.val(n+(""!=n?"\n":"")+i.result.msg+"\n")}LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(t.chat_id)},dropZone:$("#CSChatMessage-"+t.chat_id),pasteZone:$("#CSChatMessage-"+t.chat_id),progressall:function(e,a){var i=parseInt(a.loaded/a.total*100,10);$("#user-is-typing-"+t.chat_id).css("visibility","visible"),$("#user-is-typing-"+t.chat_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addExecutionCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addonlineoperation/"+t,{operation:e},(function(e){LHCCallbacks.addExecutionCommand&&LHCCallbacks.addExecutionCommand(t)})),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var a=this;setTimeout((function(){a.updateScreenshotOnline(t)}),15e3)}},this.addRemoteCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addoperation/"+t,{operation:e},(function(e){LHCCallbacks.addRemoteCommand&&LHCCallbacks.addRemoteCommand(t),"true"==e.error&&null!=e.errors&&alert(e.errors.join("\n"))})),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var a=this;setTimeout((function(){a.updateScreenshot(t)}),5e3)}},this.addRemoteOnlineCommand=function(t,e){$.postJSON(this.wwwDir+"chat/addonlineoperationiframe/"+t,{operation:e},(function(e){LHCCallbacks.addRemoteOnlineCommand&&LHCCallbacks.addRemoteOnlineCommand(t)}))},this.updateScreenshot=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshot/"+t,(function(e){$("#user-screenshot-container-"+t).html(e),$("#user-screenshot-container-"+t).removeClass("screenshot-pending")}))},this.updateScreenshotOnline=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshotonline/"+t,(function(e){$("#user-screenshot-container-"+t).html(e),$("#user-screenshot-container-"+t).removeClass("screenshot-pending")}))},this.delayQueue=[],this.delayed=!1,this.intervalPending=null,this.gmaps_loading=!1,this.queue_render=[],this.showMessageLocation=function(t,e,a){var i={lat:e,lng:a};if(1==this.gmaps_loaded){var s=new google.maps.Map(document.getElementById("msg-location-"+t),{zoom:13,center:i});new google.maps.Marker({position:i,map:s,title:e+","+a})}else if(0==this.gmaps_loading){this.gmaps_loading=!0;var n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://maps.googleapis.com/maps/api/js?key="+confLH.gmaps_api_key+"&callback=chatMapLoaded";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(n,o),lhinst.queue_render.push({id:t,lat:e,lon:a})}else lhinst.queue_render.push({id:t,lat:e,lon:a})},this.startChatNewWindow=function(t,e){var a=window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650");if(null!==a){a.focus();var i=this;setTimeout((function(){i.syncadmininterfacestatic(),history.pushState({},"","#chatlist"),document.location.hash="#chatlist"}),1e3),ee.emitEvent("chatStartOpenWindow",[t])}},this.setCloseWindowOnEvent=function(t){this.closeWindowOnChatCloseDelete=t},this.zoomImage=function(t){t.classList.contains("img-remote")?lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"file/downloadfile/0/0?modal=external&src="+t.src}):lhc.revealModal({url:t.src+"?modal=true"})}}function chatMapLoaded(){if(lhinst.queue_render.length>0){lhinst.gmaps_loaded=!0;var t=lhinst.queue_render.pop(),e={lat:t.lat,lng:t.lon},a=new google.maps.Map(document.getElementById("msg-location-"+t.id),{zoom:13,center:e});new google.maps.Marker({position:e,map:a,title:t.lat+","+t.lon});lhinst.queue_render.length>0&&chatMapLoaded()}}var lhinst=new lh;function preloadSound(){lhinst.playPreloadSound(),jQuery(document).off("click",preloadSound),jQuery(document).off("touchstart",preloadSound)}function gMapsCallback(){lhinst.gmaps_loaded=!0;var t=$("#map_canvas"),e=new google.maps.Map(t[0],{zoom:GeoLocationData.zoom,center:new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,options:{zoomControl:!0,scrollwheel:!0,streetViewControl:!0}}),a=!1,i=!1,s=!1,n=!1;google.maps.event.addListener(e,"idle",r);var o=$("#map-activator");function r(){0==i?o.hasClass("active")?(i=!0,$.ajax({url:WWW_DIR_JAVASCRIPT+"chat/jsononlineusers"+(parseInt($("#id_department_map_id").val())>0?"/(department)/"+parseInt($("#id_department_map_id").val()):"")+(parseInt($("#maxRows").val())>0?"/(maxrows)/"+parseInt($("#maxRows").val()):"")+(parseInt($("#userTimeout").val())>0?"/(timeout)/"+parseInt($("#userTimeout").val()):""),dataType:"json",error:function(){clearTimeout(n),n=setTimeout((function(){r()}),1e4)},success:function(t){$(t.result).each((function(t,a){if(-1==$.inArray(a.Id,c)){var i=new google.maps.LatLng(a.Latitude,a.Longitude),s=new google.maps.Marker({position:i,icon:a.icon,map:e});google.maps.event.addListener(s,"click",(function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/getonlineuserinfo/"+a.Id})})),s.setVisible(!0),s.setAnimation(google.maps.Animation.DROP),l[a.Id]=s,c.push(a.Id),clearTimeout(l[a.Id].timeOutMarker),l[a.Id].timeOutMarker=setTimeout((function(){c.splice($.inArray(a.Id,c),1),google.maps.event.clearInstanceListeners(l[a.Id]),l[a.Id].setMap(null),l[a.Id]=null}),1e3*parseInt($("#markerTimeout option:selected").val()))}else l[a.Id].setIcon(a.icon),clearTimeout(l[a.Id].timeOutMarker),l[a.Id].timeOutMarker=setTimeout((function(){c.splice($.inArray(a.Id,c),1),google.maps.event.clearInstanceListeners(l[a.Id]),l[a.Id].setMap(null),l[a.Id]=null}),1e3*parseInt($("#markerTimeout option:selected").val()))})),i=!1,clearTimeout(n),1==s?(s=!1,r()):n=setTimeout((function(){r()}),1e4)}})):n=setTimeout((function(){r()}),1e4):s=!0}var c=[],l=[];new google.maps.InfoWindow({content:"Loading..."});$("#id_department_map_id").change((function(){r(),lhinst.changeUserSettingsIndifferent("omap_depid",$(this).val())})),$("#markerTimeout").change((function(){r(),lhinst.changeUserSettingsIndifferent("omap_mtimeout",$(this).val())})),$("#map-activator").click((function(){setTimeout((function(){google.maps.event.trigger(e,"resize"),0==a&&(a=!0,e.setCenter(new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng)))}),500),r()}))}lhinst.playPreloadSound(),jQuery(document).on("click",preloadSound),jQuery(document).on("touchstart",preloadSound),jQuery(document).on("click",(function(){lhinst.hidePopover()}));var focused=!0;function chatsyncadmin(){lhinst.syncadmincall()}window.onfocus=window.onblur=function(t){focused="focus"===(t||event).type,lhinst.focusChanged(focused)},window.lhcSelector=null,$(document).ready((function(){lhinst.protectCSFR()}))}catch(t){if(!lhcError)throw Error("lhc : "+t.message);lhcError.log(t.message,"lh.js",t.lineNumber||t.line,t.stack)}