function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function lh(){this.wwwDir=WWW_DIR_JAVASCRIPT,this.addmsgurl="chat/addmsgadmin/",this.addmsgurluser="chat/addmsguser/",this.addmsgurluserchatbox="chatbox/addmsguser/",this.syncuser="chat/syncuser/",this.syncadmin="chat/syncadmin/",this.closechatadmin="chat/closechatadmin/",this.deletechatadmin="chat/deletechatadmin/",this.checkchatstatus="chat/checkchatstatus/",this.syncadmininterfaceurl="chat/syncadmininterface/",this.accepttransfer="chat/accepttransfer/",this.trasnsferuser="chat/transferuser/",this.userclosechaturl="chat/userclosechat/",this.disableremember=!1,this.operatorTyping=!1,this.forceBottomScroll=!1,this.appendSyncArgument="",this.nodeJsMode=!1,this.gmaps_loaded=!1,this.disableSync=!1,this.chat_id=null,this.hash=null,this.soundIsPlaying=!1,this.soundPlayedTimes=0,this.last_message_id=0,this.isSinchronizing=!1,this.isWidgetMode=!1,this.isEmbedMode=!1,this.syncroRequestSend=!1,this.currentMessageText="",this.setWidgetMode=function(e){this.isWidgetMode=e},this.setEmbedMode=function(e){this.isEmbedMode=e},this.setSynchronizationRequestSend=function(e){this.syncroRequestSend=e},this.setSyncUserURL=function(e){this.syncuser=e},this.chatsSynchronising=[],this.chatsSynchronisingMsg=[],this.notificationsArray=[],this.speechHandler=!1,this.underMessageAdd=!1,this.closeWindowOnChatCloseDelete=!1,this.userTimeout=!1,this.lastOnlineSyncTimeout=!1,this.setLastUserMessageID=function(e){this.last_message_id=e},this.setChatID=function(e){this.chat_id=e},this.setwwwDir=function(e){this.wwwDir=e},this.setCloseWindowOnEvent=function(e){this.closeWindowOnChatCloseDelete=e},this.setDisableRemember=function(e){this.disableremember=e},this.setSynchronizationStatus=function(e){this.underMessageAdd=e},this.tabIconContent="face",this.tabIconClass="icon-user-status material-icons icon-user-online",this.audio=new Audio,this.audio.autoplay="autoplay",this.reloadTab=function(e,t,s){$("#ntab-chat-"+e).text(s),0!=$("#CSChatMessage-"+e).length&&($("#CSChatMessage-"+e).unbind("keydown",function(){}),$("#CSChatMessage-"+e).unbind("keyup",function(){})),this.removeSynchroChat(e),this.removeBackgroundChat(e),this.hideNotification(e);var i=this;$.get(this.wwwDir+"chat/adminchat/"+e+"/(remember)/true",function(t){$("#chat-id-"+e).html(t),$("#CSChatMessage-"+e).focus(),i.rememberTab(e),i.addQuateHandler(e),i.loadMainData(e),ee.emitEvent("chatTabLoaded",[e])})},this.loadMainData=function(e){$.getJSON(this.wwwDir+"chat/loadmaindata/"+e,{},function(e){$.each(e.items,function(e,t){var s=$(t.selector);"undefined"!=typeof t.attr&&$.each(t.attr,function(e,t){s.attr(e,t)}),"undefined"!=typeof t.action&&("hide"==t.action?s.hide():"show"==t.action?s.show():"remove"==t.action?s.remove():"click"==t.action&&(s.attr("auto-scroll",1),s.click()))})}).fail(function(){})},this.getSelectedText=function(){var e,t="";return window.getSelection?(e=window.getSelection(),t=e.toString()):document.selection&&"Control"!==document.selection.type&&(e=document.selection.createRange(),t=e.text),{selection:e,text:t}},this.popoverShown=!1,this.popoverShownNow=!1,this.selection=null,this.mouseClicked=function(e){selected=e.data.that.getSelectedText(),$(".popover-copy").popover("destroy"),!selected.text.length||null!==e.data.that.selection&&e.data.that.selection.text===selected.text?e.data.that.selection=null:(e.data.that.selection=selected,$(this).popover({placement:"top",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+e.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-content popover-quote"></div></div>',content:'<a href="#" onclick="lhinst.quateSelection('+e.data.chat_id+')"><i class="material-icons">&#xE244;</i>quote</a>'}).popover("show"),$(this).addClass("popover-copy"),e.data.that.popoverShown=!0,e.data.that.popoverShownNow=!0)},this.addQuateHandler=function(e){this.popoverShown=!1,$("#messagesBlock-"+e+" .message-row").off("mouseup",lhinst.mouseClicked),$("#messagesBlock-"+e+" .message-row").on("mouseup",{chat_id:e,that:this},lhinst.mouseClicked)},this.quateSelection=function(e){$(".popover-copy").popover("destroy");var t=this.selection.text.replace(/[\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA]/g,"");t=t.replace(/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,""),t=t.replace(/^[0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,""),t=t.replace(/^\s*\n/gm,""),t=t.replace(/^ /gm,""),window.textreplace=t;var s=$("#CSChatMessage-"+e),i=s.val().replace(/^\s*\n/g,"");s.val((""!=i?i+"[quote]"+t+"[/quote]":"[quote]"+t+"[/quote]")+"\n").focus();var a=s[0],n=30;for(a.clientHeight/a.rows;a.scrollHeight>a.clientHeight&&!window.opera&&a.rows<n;)a.style.overflow="hidden",a.rows+=1;a.scrollHeight>a.clientHeight&&(a.style.overflow="auto"),this.popoverShown=!1},this.hidePopover=function(){this.popoverShownNow===!0?this.popoverShownNow=!1:this.popoverShown===!0&&(this.popoverShown=!1,$(".popover-copy").popover("destroy"))},this.addTab=function(e,t,s,i,a,n){if(!(e.find("#chat-tab-link-"+i).size()>0)){var o='<li role="presentation" id="chat-tab-li-'+i+'" ><a href="#chat-id-'+i+'" id="chat-tab-link-'+i+'" aria-controls="chat-id-'+i+'" role="tab" data-toggle="tab"><i id="msg-send-status-'+i+'" class="material-icons send-status-icon icon-user-online">send</i><i id="user-chat-status-'+i+'" class="'+this.tabIconClass+'">'+this.tabIconContent+'</i><span class="ntab" id="ntab-chat-'+i+'">'+s.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</span><span onclick="return lhinst.removeDialogTab('+i+',$(\'#tabs\'),true)" class="material-icons icon-close-chat">close</span></a></li>';"undefined"==typeof n||0==parseInt(n)?e.find("> ul").append(o):e.find("> ul > li:eq("+(n-1)+")").after(o),$("#chat-tab-link-"+i).click(function(){setTimeout(function(){$("#CSChatMessage-"+i).focus()},2);var e=$(this);setTimeout(function(){e.find(".msg-nm").remove(),e.removeClass("has-pm"),$("#messagesBlock-"+i).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+i).prop("scrollHeight")},500),ee.emitEvent("chatTabClicked",[i,e])},500)});var r=window.location.hash.replace("#/","#"),c=this;$.get(t,function(t){"undefined"==typeof a||a===!0||r=="#chat-id-"+i?(e.find("> ul > li.active").removeClass("active"),e.find("> ul > #chat-tab-li-"+i).addClass("active"),e.find("> div.tab-content > div.active").removeClass("active"),e.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active" id="chat-id-'+i+'"></div>'),window.location.hash="#/chat-id-"+i):e.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane" id="chat-id-'+i+'"></div>'),$("#chat-id-"+i).html(t),$("#CSChatMessage-"+i).focus(),0==c.disableremember&&c.rememberTab(i),c.addQuateHandler(i),c.loadMainData(i),ee.emitEvent("chatTabLoaded",[i])})}},this.rememberTab=function(e){if(localStorage)try{e=parseInt(e);var t=localStorage.getItem("achat_id"),s=new Array;if(null!==t)var s=t.split(",").map(Number);s.indexOf(e)===-1&&s.push(e),localStorage.setItem("achat_id",s.join(","))}catch(i){console.log(i)}},this.forgetChat=function(e){if(localStorage)try{e=parseInt(e);var t=localStorage.getItem("achat_id"),s=new Array;null!==t&&(s=t.split(",").map(Number)),s.indexOf(e)!==-1&&s.splice(s.indexOf(e),1),localStorage.setItem("achat_id",s.join(","))}catch(i){console.log(i)}},this.attachTabNavigator=function(){$("#tabs > ul.nav > li > a").click(function(){$(this).find(".msg-nm").remove(),$(this).removeClass("has-pm")})},this.holdAction=function(e,t){var s=this;$.postJSON(this.wwwDir+"chat/holdaction/"+e,function(i){0==i.error?(1==i.hold?t.addClass("btn-info"):t.removeClass("btn-info"),""!=i.msg&&($("#messagesBlock-"+e).append(i.msg),$("#messagesBlock-"+e).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+e).prop("scrollHeight")},500)),s.syncadmincall()):alert(i.msg)})},this.copyMessages=function(e){function t(t){e.tooltip("hide").attr("data-original-title",t).tooltip("show")}function s(){setTimeout(function(){e.tooltip("hide")},3e3)}return $("#chat-copy-messages").select(),document.execCommand("copy"),e.tooltip({trigger:"click",placement:"top"}),t(e.attr("data-success")),s(),!1},this.startChat=function(e,t,s,i,a){if(this.removeBackgroundChat(e),this.hideNotification(e),0==this.chatUnderSynchronization(e)){var n="undefined"==typeof i||i,o=0==this.disableremember?"/(remember)/true":"";this.addTab(t,this.wwwDir+"chat/adminchat/"+e+o,s,e,n,a);var r=this;setTimeout(function(){r.syncadmininterfacestatic()},1e3)}else t.find("> ul > li.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+e).addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content > #chat-id-"+e).addClass("active"),window.location.hash="#/chat-id-"+e;ee.emitEvent("chatStartTab",[e])},this.backgroundChats=[],this.startChatBackground=function(e,t,s){if(0==this.chatUnderSynchronization(e)){this.backgroundChats.push(parseInt(e));var i=0==this.disableremember?"/(remember)/true":"";return this.addTab(t,this.wwwDir+"chat/adminchat/"+e+i+"/(arg)/background",s,e,!1),ee.emitEvent("chatStartBackground",[e]),!0}return!1},this.protectCSFR=function(){$("a.csfr-required").click(function(){var e=$(this);e.attr("data-secured")||(e.attr("href",e.attr("href")+"/(csfr)/"+confLH.csrf_token),e.attr("data-secured",1))})},this.setChatHash=function(e){this.hash=e},this.addSynchroChat=function(e,t){this.chatsSynchronising.push(e),this.chatsSynchronisingMsg.push(e+","+t),LHCCallbacks.addSynchroChat&&LHCCallbacks.addSynchroChat(e,t)},this.removeSynchroChat=function(e){for(var t=0;t<this.chatsSynchronising.length;)this.chatsSynchronising[t]==e?(this.chatsSynchronising.splice(t,1),this.chatsSynchronisingMsg.splice(t,1)):t++;this.forgetChat(e),ee.emitEvent("removeSynchroChat",[e]),LHCCallbacks.removeSynchroChat&&LHCCallbacks.removeSynchroChat(e)},this.is_typing=!1,this.typing_timeout=null,this.operatorTypingCallback=function(e){var t=this.wwwDir,s=this;0==s.is_typing?(s.is_typing=!0,clearTimeout(s.typing_timeout),1==s.nodeJsMode?(s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(e)},3e3),ee.emitEvent("operatorTyping",[{chat_id:e,status:!0}])):$.getJSON(t+"chat/operatortyping/"+e+"/true",{},function(t){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(e)},3e3),LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(e,!0)}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(e)},3e3)})):(clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(e)},3e3))},this.initTypingMonitoringAdmin=function(e){var t=this;jQuery("#CSChatMessage-"+e).bind("keyup",function(s){t.operatorTypingCallback(e)})},this.remarksTimeout=null,this.saveRemarks=function(e){clearTimeout(this.remarksTimeout),$("#remarks-status-"+e).addClass("warning-color"),$("#main-user-info-remarks-"+e+" .alert").remove();var t=this;this.remarksTimeout=setTimeout(function(){$.postJSON(t.wwwDir+"chat/saveremarks/"+e,{data:$("#ChatRemarks-"+e).val()},function(t){"false"==t.error?$("#remarks-status-"+e).removeClass("warning-color"):$("#main-user-info-remarks-"+e).prepend(t.result)})},500)},this.saveNotes=function(e){clearTimeout(this.remarksTimeout),$("#remarks-status-online-"+e).addClass("warning-color");var t=this;this.remarksTimeout=setTimeout(function(){$.postJSON(t.wwwDir+"chat/saveonlinenotes/"+e,{data:$("#OnlineRemarks-"+e).val()},function(t){$("#remarks-status-online-"+e).removeClass("warning-color")})},500)},this.surveyShowed=!1,this.closeWindow=function(){null!==this.survey&&0==this.surveyShowed?(this.surveyShowed=!0,this.chatClosed()):(window.open("","_self",""),window.close())},this.typingStoppedOperator=function(e){var t=this;1==t.is_typing&&(1==lhinst.nodeJsMode?(t.is_typing=!1,ee.emitEvent("operatorTyping",[{chat_id:e,status:!1}])):$.getJSON(this.wwwDir+"chat/operatortyping/"+e+"/false",{},function(s){t.is_typing=!1,LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(e,!1)}).fail(function(){t.is_typing=!1}))},this.sendemail=function(){$.postJSON(this.wwwDir+"chat/sendchat/"+this.chat_id+"/"+this.hash,{csfr_token:confLH.csrf_token,email:$('input[name="UserEmail"]').val()},function(e){"false"==e.error?$("#myModal").modal("hide"):($("#user-action .alert-box").remove(),$("#user-action").prepend(e.result))})},this.reopenchat=function(e){$.postJSON(this.wwwDir+"chat/reopenchat/"+e.attr("data-id"),function(t){"true"==t.error?alert(t.result):($("#action-block-row-"+e.attr("data-id")+" .send-row").removeClass("hide"),$("#CSChatMessage-"+e.attr("data-id")).removeAttr("readonly").focus(),$("#chat-status-text-"+e.attr("data-id")).text(t.status),e.remove())})},this.initTypingMonitoringUser=function(e){var t=this.wwwDir,s=this;try{sessionStorage&&sessionStorage.getItem("lhc_ttxt")&&""!=sessionStorage.getItem("lhc_ttxt")&&jQuery("#CSChatMessage").val(sessionStorage.getItem("lhc_ttxt"))}catch(i){}jQuery("#CSChatMessage").bind("keyup",function(i){if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",$(this).val())}catch(a){}if(0==s.is_typing)clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringUserInform?(s.typing_timeout=setTimeout(function(){ee.emitEvent("visitorTypingStopped",[{chat_id:e,hash:s.hash}])},3e3),ee.emitEvent("visitorTyping",[{chat_id:e,hash:s.hash,status:!0,msg:$(this).val()}])):(s.is_typing=!0,$.postJSON(t+"chat/usertyping/"+e+"/"+s.hash+"/true",{msg:$(this).val()},function(t){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(e)},3e3),LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!0])}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(e)},3e3)}));else{clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedUser(e)},3e3);var n=$(this).val();s.currentMessageText!=n&&Math.abs(s.currentMessageText.length-n.length)>6&&(s.currentMessageText=n,LHCCallbacks.initTypingMonitoringUserInform?ee.emitEvent("visitorTyping",[{chat_id:e,hash:s.hash,status:!0,msg:$(this).val()}]):$.postJSON(t+"chat/usertyping/"+e+"/"+s.hash+"/true",{msg:n},function(t){LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!0])}))}})},this.typingStoppedUser=function(e){var t=this;1==t.is_typing&&(LHCCallbacks.typingStoppedUserInform?(t.is_typing=!1,ee.emitEvent("visitorTypingStopped",[{chat_id:e,hash:this.hash,status:!1}])):$.getJSON(this.wwwDir+"chat/usertyping/"+e+"/"+this.hash+"/false",{},function(s){t.is_typing=!1,LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!1])}).fail(function(){t.is_typing=!1}))},this.refreshFootPrint=function(e){e.addClass("disabled"),$.get(this.wwwDir+"chat/chatfootprint/"+e.attr("rel"),{},function(t){$("#footprint-"+e.attr("rel")).html(t),e.removeClass("disabled")})},this.makeAbstractRequest=function(e,t){return $.get(t.attr("href"),function(t){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedSurvey&&LHCCallbacks.userRedirectedSurvey(e)}),!1},this.refreshOnlineUserInfo=function(e){e.addClass("disabled"),$.get(this.wwwDir+"chat/refreshonlineinfo/"+e.attr("rel"),{},function(t){$("#online-user-info-"+e.attr("rel")).html(t),e.removeClass("disabled")})},this.processCollapse=function(e){if("chevron_right"==$("#chat-main-column-"+e+" .collapse-right").text()){$("#chat-right-column-"+e).hide(),$("#chat-main-column-"+e).removeClass("col-sm-7").addClass("col-sm-12"),$("#chat-main-column-"+e+" .collapse-right").text("chevron_left");try{localStorage&&localStorage.setItem("lhc_rch",1)}catch(t){}}else{$("#chat-right-column-"+e).show(),$("#chat-main-column-"+e).removeClass("col-sm-12").addClass("col-sm-7"),$("#chat-main-column-"+e+" .collapse-right").text("chevron_right");try{localStorage&&localStorage.removeItem("lhc_rch")}catch(t){}}},this.chatUnderSynchronization=function(e){for(var t=0;t<this.chatsSynchronising.length;){if(this.chatsSynchronising[t]==e)return!0;t++}return!1},this.getChatIndex=function(e){for(var t=0;t<this.chatsSynchronising.length;){if(this.chatsSynchronising[t]==e)return t;t++}return!1},this.updateUserSyncInterface=function(e,t){try{if("false"==t.error)if("true"!=t.blocked){if("false"!=t.result&&"true"==t.status){var s=$("#messagesBlock"),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.append(t.result),s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),(a<20||1==e.forceBottomScroll)&&(e.forceBottomScroll=!1,s.stop(!0,!1).animate({scrollTop:i+2e3},500)),1==confLH.new_message_sound_user_enabled&&"false"==t.uw&&e.playNewMessageSound(),e.last_message_id>0&&($("#msg-"+e.last_message_id).attr("data-op-id")==t.msop&&$("#msg-"+e.last_message_id+" > .usr-tit").text()===$("#msg-"+t.message_id+" > .usr-tit").text()||$("#msg-"+e.last_message_id).next().addClass("operator-changes")),e.last_message_id=t.message_id,"false"==t.uw&&e.isWidgetMode&&"undefined"!=typeof parent&&parent.postMessage("lhc_newopmsg","*")}else"true"!=t.status&&$("#status-chat").html(t.status);if(e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval),"t"==t.cs&&e.chatsyncuserpending(),""!=t.ott&&"f"!=t.ott){var n=$("#id-operator-typing");n.text(t.ott),n.css("visibility","visible"),e.operatorTyping=!0}else"f"==t.ott&&(e.operatorTyping=!1,$("#id-operator-typing").css("visibility","hidden"));""!=t.op&&e.executeRemoteCommands(t.op)}else $("#status-chat").html(t.status),$("#ChatMessageContainer").remove(),$("#ChatSendButtonContainer").remove(),$("#id-operator-typing").css("visibility","hidden"),e.operatorTyping=!1,"undefined"!=typeof t.op&&""!=t.op&&e.executeRemoteCommands(t.op),t.closed&&1==t.closed&&(ee.emitEvent("chatClosedSyncUser",[e.chat_id]),e.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed"+("undefined"!=typeof t.closed_arg?":"+t.closed_arg:""),"*"):("undefined"!=typeof t.closed_arg&&e.parseCloseArgs(t.closed_arg.split(":")),e.chatClosed()))}catch(o){e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}e.syncroRequestSend=!1},this.parseCloseArgs=function(e){var t=e.length/2;for(i=0;i<t;i++){var s=e[2*i],a=e[2*i+1];"survey_id"==s&&(this.survey=a)}},this.chatClosed=function(){if(null!==this.survey){var e=1==this.isWidgetMode?"/(mode)/widget":"",t=1==this.operatorTyping?"/(ot)/t":"",s=null!==this.theme?"/(theme)/"+this.theme:"",i=1==this.isEmbedMode?"/(modeembed)/embed":"",a=1==this.isWidgetMode?"fillwidget":"fill",n=1==this.explicitClose?"/(eclose)/t":"";return document.location.replace(this.wwwDir+"survey/"+a+"/(survey)/"+this.survey+"/(chatid)/"+this.chat_id+"/(hash)/"+this.hash+e+t+s+i+n),!0}return!1},this.executeRemoteCommands=function(operations){var inst=this;$.each(operations,function(i,item){item.indexOf("lhinst.")!=-1?eval(item):inst.isWidgetMode?parent.postMessage(item,"*"):window.opener&&window.opener.postMessage(item,"*")})},this.syncusercall=function(){var e=this;if(0==this.syncroRequestSend){clearTimeout(this.userTimeout),this.syncroRequestSend=!0;var t=1==this.isWidgetMode?"/(mode)/widget":"",s=1==this.operatorTyping?"/(ot)/t":"",i=null!==this.theme?"/(theme)/"+this.theme:"",a=1==this.isEmbedMode?"/(modeembed)/embed":"";$.getJSON(this.wwwDir+this.syncuser+this.chat_id+"/"+this.last_message_id+"/"+this.hash+t+s+i+a,{},function(t){e.updateUserSyncInterface(e,t),LHCCallbacks.syncusercall&&LHCCallbacks.syncusercall(e,t),ee.emitEvent("syncUserCall",[e,t])}).fail(function(){e.syncroRequestSend=!1,e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)})}},this.scheduleSync=function(){this.syncroRequestSend=!1,clearTimeout(this.userTimeout),this.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)},this.closeActiveChatDialog=function(e,t,s){var i=this;$.postJSON(this.wwwDir+this.closechatadmin+e,function(a){if(0==a.error){if(0!=$("#CSChatMessage-"+e).length&&($("#CSChatMessage-"+e).unbind("keydown",function(){}),$("#CSChatMessage-"+e).unbind("keyup",function(){})),window.postMessage&&window.opener&&window.opener.postMessage("lhc_ch:chatclosed:"+e,"*"),1==s){var n=i.smartTabFocus(t,e);setTimeout(function(){window.location.hash=n},500),1==i.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatClosedCallback&&LHCCallbacks.chatClosedCallback(e),i.removeSynchroChat(e),i.syncadmininterfacestatic()}else alert(a.result)}).fail(function(e,t,s){console.dir(e),alert("postJSON request failed! "+t+":"+s+":"+e.responseText)})},this.smartTabFocus=function(e,t){var s=e.find("> ul > #chat-tab-li-"+t).index();e.find("> ul > #chat-tab-li-"+t).remove(),e.find("#chat-id-"+t).remove();var i=e.find("> ul > li:eq("+(s-1)+")");if(void 0!==i.attr("id"))var a=i.find("> a");else if(linkTabRight=e.find("> ul > li:eq("+s+")"),linkTabRight.size()>0)var a=linkTabRight.find("> a");else var a=i.find("> a");if(!e.find("> ul > li.active").length&&(a.tab("show"),void 0!==a.attr("id"))){var n=a.attr("href").replace("#chat-id-","");this.removeBackgroundChat(n),this.hideNotification(n),ee.emitEvent("chatTabFocused",[n])}return void 0!==a.attr("href")?a.attr("href").replace("#","#/"):"#"},this.startChatCloseTabNewWindow=function(e,t,s){return window.open(this.wwwDir+"chat/single/"+e,"chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650"),this.smartTabFocus(t,e),1==this.closeWindowOnChatCloseDelete&&window.close(),this.removeSynchroChat(e),this.syncadmininterfacestatic(),!1},this.removeDialogTab=function(e,t,s){if(0!=$("#CSChatMessage-"+e).length&&($("#CSChatMessage-"+e).unbind("keydown",function(){}),$("#CSChatMessage-"+e).unbind("keyup",function(){})),this.removeSynchroChat(e),1==s){var i=this.smartTabFocus(t,e);setTimeout(function(){window.location.hash=i},500),1==this.closeWindowOnChatCloseDelete&&window.close()}this.syncadmininterfacestatic()},this.removeActiveDialogTag=function(e){1==this.closeWindowOnChatCloseDelete&&window.close()},this.deleteChat=function(e,t,s){if(confirm(confLH.transLation.delete_confirm)){var i=this;$.postJSON(this.wwwDir+this.deletechatadmin+e,function(a){if(1==a.error)alert(a.result);else{if(0!=$("#CSChatMessage-"+e).length&&($("#CSChatMessage-"+e).unbind("keydown",function(){}),$("#CSChatMessage-"+e).unbind("keyup",function(){})),1==s){var n=i.smartTabFocus(t,e);setTimeout(function(){window.location.hash=n},500),1==i.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatDeletedCallback&&LHCCallbacks.chatDeletedCallback(e),i.syncadmininterfacestatic(),i.removeSynchroChat(e)}}).fail(function(e,t,s){console.dir(e),alert("getJSON request failed! "+t+":"+s+":"+e.responseText)})}},this.rejectPendingChat=function(e,t){var s=this;$.postJSON(this.wwwDir+this.deletechatadmin+e,{},function(e){s.syncadmininterfacestatic()}).fail(function(e,t,s){console.dir(e),alert("getJSON request failed! "+t+":"+s+":"+e.responseText)})},this.startChatNewWindow=function(e,t){window.open(this.wwwDir+"chat/single/"+e,"chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650").focus();var s=this;setTimeout(function(){s.syncadmininterfacestatic()},1e3),ee.emitEvent("chatStartOpenWindow",[e])},this.startChatNewWindowArchive=function(e,t,s){window.open(this.wwwDir+"chatarchive/viewarchivedchat/"+e+"/"+t+"/(mode)/popup","chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus(),ee.emitEvent("chatStartOpenWindowArchive",[e,t])},this.startCoBrowse=function(e){return window.open(this.wwwDir+"cobrowse/browse/"+e,"chatwindow-cobrowse-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650").focus(),!1},this.speechToText=function(e){0==this.speechHandler&&(this.speechHandler=new LHCSpeechToText),this.speechHandler.listen({chat_id:e})},this.startChatTransfer=function(e,t,s,i){var a=this;$.getJSON(this.wwwDir+this.accepttransfer+i,{},function(i){a.startChat(e,t,s),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(e)}).fail(function(){a.startChat(e,t,s)})},this.startChatNewWindowTransfer=function(e,t,s){return $.getJSON(this.wwwDir+this.accepttransfer+s,{},function(t){LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(e)}),this.startChatNewWindow(e,t)},this.startChatNewWindowTransferByTransfer=function(e,t){var s=this;return $.ajax({type:"GET",url:this.wwwDir+this.accepttransfer+e+"/(mode)/chat",cache:!1,dataType:"json"}).done(function(e){$("#tabs").size()>0?(window.focus(),s.startChat(e.chat_id,$("#tabs"),t)):s.startChatNewWindow(e.chat_id,""),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(e.chat_id)}),this.syncadmininterfacestatic(),!1},this.blockUser=function(e,t){("undefined"==typeof t||confirm(t))&&$.postJSON(this.wwwDir+"chat/blockuser/"+e,{},function(e){alert(e.msg)})},this.switchLang=function(e,t){var s='<input type="hidden" value="'+t+'" name="switchLang" />';return e.append(s),e.submit(),!1},this.sendLinkToMail=function(e,t){var s=window.parent.$("#MailMessage").val();window.parent.$("#MailMessage").val((""!=s?s+"\n":s)+e),$("#embed-button-"+t).addClass("success")},this.sendLinkToEditor=function(e,t,s){var i=window.parent.$("#CSChatMessage-"+e).val();window.parent.$("#CSChatMessage-"+e).val((""!=i?i+"\n":i)+t),$("#embed-button-"+s).addClass("success")},this.hideTransferModal=function(e){var t=this;setTimeout(function(){$("#myModal").modal("hide"),$("#tabs").size()>0&&t.removeDialogTab(e,$("#tabs"),!0)},1e3)},this.transferChat=function(e){var t=this,s=$("[name=TransferTo"+e+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+e+"/"+s,{type:"user"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),t.hideTransferModal(e))})},this.changeOwner=function(e){var t=this,s=$("#id_new_user_id").val();$.postJSON(this.wwwDir+this.trasnsferuser+e+"/"+s,{type:"change_owner"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),t.hideTransferModal(e))})},this.chooseSurvey=function(e){var t=$("[name=SurveyItem"+e+"]:checked").val();$.postJSON(this.wwwDir+"survey/choosesurvey/"+e+"/"+t,function(e){"false"==e.error&&$("#survey-block-"+e.chat_id).html(e.result)})},this.redirectContact=function(e,t){("undefined"==typeof t||confirm(t))&&$.postJSON(this.wwwDir+"chat/redirectcontact/"+e,function(t){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedContact&&LHCCallbacks.userRedirectedContact(e)})},this.redirectToURL=function(e,t){var s=prompt(t,"");null!=s&&lhinst.addRemoteCommand(e,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__"))},this.redirectToURLOnline=function(e,t){var s=prompt(t,"");null!=s&&(lhinst.addRemoteOnlineCommand(e,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")),lhinst.addExecutionCommand(e,"lhc_cobrowse_multi_command__lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")))},this.transferChatDep=function(e){var t=this,s=$("[name=DepartamentID"+e+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+e+"/"+s,{type:"dep"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),t.hideTransferModal(e))})},this.chatTabsOpen=function(){return window.open(this.wwwDir+"chat/chattabs/","chatwindows","menubar=1,resizable=1,width=800,height=650"),!1},this.userclosedchat=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.ajax({type:"GET",url:this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash,cache:!1})},this.userclosedchatembed=function(){window.postMessage&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},this.continueChatFromSurvey=function(e){return this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?$.postJSON(this.wwwDir+"survey/backtochat/"+this.chat_id+"/"+this.hash+"/"+e,function(e){parent.postMessage("lhc_continue_chat","*")}):this.chatClosed(),!1},this.explicitClose=!1,this.explicitChatCloseByUser=function(){return this.explicitClose=!0,this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close(),!1},this.restoreWidget=function(e){window.postMessage&&window.opener&&(window.opener.postMessage("lhc_ch:hash:"+e,"*"),window.opener.postMessage("lhc_ch:hash_resume:"+e,"*"),window.opener.postMessage("lhc_open_restore","*"),window.close())},this.userclosedchatandbrowser=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.get(this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash+"/(eclose)/t",function(e){lhinst.closeWindow()})},this.sendCannedMessage=function(e,t){if($("#id_CannedMessage-"+e).val()>0){t.addClass("secondary");var s=1e3*parseInt($("#id_CannedMessage-"+e).find(":selected").attr("data-delay")),i=this.wwwDir,a=this;if(0==a.is_typing?(a.is_typing=!0,clearTimeout(a.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform&&LHCCallbacks.initTypingMonitoringAdminInform({chat_id:e,status:!0}),$.getJSON(i+"chat/operatortyping/"+e+"/true",{},function(i){LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(e,!0),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(e),t.removeClass("secondary")},s>3e3?s:3e3)}).fail(function(){a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(e)},3e3)})):(clearTimeout(a.typing_timeout),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(e)},3e3),t.removeClass("secondary")),s>0)setTimeout(function(){var t={msg:$("#id_CannedMessage-"+e).find(":selected").attr("data-msg")};$("#CSChatMessage-"+e).val(""),$.postJSON(i+a.addmsgurl+e,t,function(t){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e),ee.emitEvent("chatAddMsgAdmin",[e]),lhinst.syncadmincall(),!0})},s);else{var n={msg:$("#id_CannedMessage-"+e).find(":selected").attr("data-msg")};$("#CSChatMessage-"+e).val(""),$.postJSON(this.wwwDir+this.addmsgurl+e,n,function(t){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e),ee.emitEvent("chatAddMsgAdmin",[e]),lhinst.syncadmincall(),!0})}}return!1},this.voteAction=function(e){var t=this.chat_id;$.postJSON(this.wwwDir+"chat/voteaction/"+this.chat_id+"/"+this.hash+"/"+e.attr("data-id"),{},function(e){"false"==e.error&&(LHCCallbacks.uservoted&&LHCCallbacks.uservoted(t),0==e.status?($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):1==e.status?($(".up-vote-action").addClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):2==e.status&&($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").addClass("down-voted")))})},this.theme=null,this.chatsyncuserpending=function(){var e=1==this.isWidgetMode?"/(mode)/widget":"",t=null!==this.theme?"/(theme)/"+this.theme:"",s=this;$.getJSON(this.wwwDir+this.checkchatstatus+this.chat_id+"/"+this.hash+e+t,{},function(e){ee.emitEvent("checkChatStatus",[s.chat_id,e]),"false"==e.error&&("false"==e.activated?("false"!=e.result&&$("#status-chat").html(e.result),""!=e.ru&&document.location.replace(e.ru),setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)):($("#status-chat").html(e.result),e.closed&&1==e.closed&&(ee.emitEvent("chatClosedCheckStatus",[s.chat_id]),s.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed","*"):s.chatClosed())))}).fail(function(){setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)})},this.setTheme=function(e){this.theme=e},this.survey=null,this.setSurvey=function(e){this.survey=e},this.isBlinking=!1,this.startBlinking=function(){if(0==this.isBlinking){var e=this,t=function(){var t,s=document.title,i="!!! "+document.title,a=function(){document.title=document.title==i?" ":i},n=function(){clearInterval(t),document.title=s,window.onmousemove=null,t=null,e.isBlinking=!1};return function(){t||(t=setInterval(a,1e3),window.onmousemove=n)}}();t(),this.isBlinking=!0}},this.playNewMessageSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_message.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_message.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_message.wav",
this.audio.load()),$("textarea[name=ChatMessage]").is(":focus")||this.startBlinking()},this.playInvitationSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/invitation.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/invitation.mp3":WWW_DIR_JAVASCRIPT_FILES+"/invitation.wav",this.audio.load())},this.playPreloadSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/silence.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/silence.mp3":WWW_DIR_JAVASCRIPT_FILES+"/silence.wav",this.audio.load())},this.loadPreviousMessages=function(e){$.getJSON(this.wwwDir+"chat/loadpreviousmessages/"+e.attr("chat-id")+"/"+e.attr("message-id")+"/(initial)/"+e.attr("data-initial"),function(t){if(0==t.error){e.attr("data-initial",0);var s=$("#messagesBlock-"+e.attr("chat-original-id"));s.prepend(t.result),1==e.attr("auto-scroll")&&(e.attr("auto-scroll",0),s.stop(!0,!1).animate({scrollTop:s.prop("scrollHeight")},500)),1==t.has_messages?(e.attr("message-id",t.message_id),e.attr("chat-id",t.chat_id)):e.remove()}})},this.hidenicknamesstatus=null,this.syncadmincall=function(){this.chatsSynchronising.length>0?0==this.underMessageAdd&&0==this.syncroRequestSend?(this.syncroRequestSend=!0,$.postJSON(this.wwwDir+this.syncadmin,{"chats[]":this.chatsSynchronisingMsg},function(data){"undefined"!=typeof data.error_url&&document.location.replace(data.error_url);try{if("false"==data.error){if("false"!=data.result){var playSound=!1;$.each(data.result,function(e,t){var s=$("#messagesBlock-"+t.chat_id),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));s.find(".pending-storage").remove(),s.append(t.content),lhinst.addQuateHandler(t.chat_id),a<20&&s.stop(!0,!1).animate({scrollTop:i},500),lhinst.updateChatLastMessageID(t.chat_id,t.message_id);var n=$("#chat-tab-link-"+t.chat_id);if(!n.parent().hasClass("active"))if(n.find("span.msg-nm").length>0){var o=parseInt(n.find("span.msg-nm").attr("rel"))+t.mn;n.find("span.msg-nm").html(" ("+o+")").attr("rel",o)}else n.append('<span rel="'+t.mn+'" class="msg-nm"> ('+t.mn+")</span>"),n.addClass("has-pm");0!=playSound||"false"!=data.uw||"undefined"!=typeof t.ignore&&typeof t.ignore!==!1||(playSound=!0),1!=confLH.new_message_browser_notification||"false"!=data.uw||"undefined"!=typeof t.ignore&&typeof t.ignore!==!1||lhinst.showNewMessageNotification(t.chat_id,t.msg,t.nck),t.msfrom>0&&$("#msg-"+t.msfrom).attr("data-op-id")!=t.msop&&$("#msg-"+t.msfrom).next().addClass("operator-changes"),ee.emitEvent("eventSyncAdmin",[t,e])}),1==confLH.new_message_sound_admin_enabled&&"false"==data.uw&&1==playSound&&lhinst.playNewMessageSound()}if("false"!=data.result_status){var groupTabs=$("#group-chats-status").hasClass("chat-active");$.each(data.result_status,function(i,item){"true"==item.tp?$("#user-is-typing-"+item.chat_id).html(item.tx).css("visibility","visible"):0==lhinst.nodeJsMode&&$("#user-is-typing-"+item.chat_id).css("visibility","hidden"),$("#last-msg-chat-"+item.chat_id).text(item.lmsg);var userChatStatus=$("#user-chat-status-"+item.chat_id),wasOnline=userChatStatus.hasClass("icon-user-online");$("#chat-duration-"+item.chat_id).text(item.cdur),userChatStatus.removeClass("icon-user-online icon-user-away icon-user-pageview"),$("#msg-send-status-"+item.chat_id).removeClass("icon-user-online icon-user-offline"),0==item.us?userChatStatus.addClass("icon-user-online"):2==item.us?userChatStatus.addClass("icon-user-away"):3==item.us&&userChatStatus.addClass("icon-user-pageview"),1==groupTabs?1==wasOnline&&0!=item.us||lhinst.hidenicknamesstatus!=groupTabs&&0!=item.us?$("#ntab-chat-"+item.chat_id).hide():(0==wasOnline&&0==item.us||lhinst.hidenicknamesstatus!=groupTabs&&0==item.us)&&$("#ntab-chat-"+item.chat_id).show():lhinst.hidenicknamesstatus!=groupTabs&&$("#ntab-chat-"+item.chat_id).show();var statusel=$("#chat-id-"+item.chat_id+"-mds");statusel.attr("data-chat-status")==item.cs&&statusel.attr("data-chat-user")==item.co||lhinst.updateVoteStatus(item.chat_id),1==item.um?(statusel.removeClass("chat-active"),statusel.addClass("chat-unread"),$("#msg-send-status-"+item.chat_id).addClass("icon-user-offline")):($("#msg-send-status-"+item.chat_id).addClass("icon-user-online"),statusel.removeClass("chat-unread"),statusel.addClass("chat-active")),item.lp!==!1?statusel.attr("title",item.lp+" s."):statusel.attr("title",""),"undefined"!=typeof item.oad&&eval(item.oad)})}lhinst.hidenicknamesstatus=groupTabs,clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}}catch(err){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}lhinst.setSynchronizationRequestSend(!1),LHCCallbacks.syncadmincall&&LHCCallbacks.syncadmincall(lhinst,data)}).fail(function(){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),lhinst.setSynchronizationRequestSend(!1)})):(clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)):this.isSinchronizing=!1},this.updateVoteStatus=function(e){$.getJSON(this.wwwDir+"chat/updatechatstatus/"+e,{},function(t){$("#main-user-info-tab-"+e).html(t.result),ee.emitEvent("chatTabInfoReload",[e])})},this.updateChatLastMessageID=function(e,t){this.chatsSynchronisingMsg[this.getChatIndex(e)]=e+","+t},this.requestNotificationPermission=function(){window.webkitNotifications?window.webkitNotifications.requestPermission():window.Notification?Notification.requestPermission(function(e){}):alert("Notification API in your browser is not supported.")},this.playNewChatAudio=function(){if(clearTimeout(this.soundIsPlaying),this.soundPlayedTimes++,Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_chat.wav",this.audio.load(),confLH.repeat_sound>this.soundPlayedTimes)){var e=this;this.soundIsPlaying=setTimeout(function(){e.playNewChatAudio()},1e3*confLH.repeat_sound_delay)}},this.focusChanged=function(e){if(1==confLH.new_message_browser_notification&&1==e&&(window.webkitNotifications||window.Notification)){var t=this;$.each(this.chatsSynchronising,function(e,s){"undefined"!=typeof t.notificationsArrayMessages[s]&&(window.webkitNotifications?t.notificationsArrayMessages[s].cancel():t.notificationsArrayMessages[s].close(),delete t.notificationsArrayMessages[s])})}parseInt(this.chat_id)>0&&this.scheduleSync()},this.notificationsArrayMessages=[],this.showNewMessageNotification=function(e,t,s){try{if(window.Notification&&0==focused&&"granted"==window.Notification.permission){"undefined"!=typeof this.notificationsArrayMessages[e]&&(this.notificationsArrayMessages[e].close(),delete this.notificationsArrayMessages[e]);var i=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:t}),a=this;i.onclick=function(){window.focus(),i.close(),delete a.notificationsArrayMessages[e]},i.onclose=function(){"undefined"!=typeof a.notificationsArrayMessages[e]&&delete a.notificationsArrayMessages[e]},this.notificationsArrayMessages[e]=i,this.scheduleNewMessageClose(i,e)}}catch(n){console.log(n)}},this.scheduleNewMessageClose=function(e,t){var s=this;setTimeout(function(){window.webkitNotifications?e.cancel():e.close(),"undefined"!=typeof s.notificationsArrayMessages[t]&&delete s.notificationsArrayMessages[t]},1e4)},this.playSoundNewAction=function(e,t,s,i,a){if(this.backgroundChats.indexOf(parseInt(t))==-1){1!=confLH.new_chat_sound_enabled||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=e&&"transfer_chat"!=e&&"unread_chat"!=e&&"pending_transfered"!=e||(this.soundPlayedTimes=0,this.playNewChatAudio()),$("textarea[name=ChatMessage]").is(":focus")||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=e&&"transfer_chat"!=e&&"unread_chat"!=e&&"pending_transfered"!=e||this.startBlinking();var n=this;if(("pending_chat"==e||"transfer_chat"==e||"unread_chat"==e||"pending_transfered"==e)&&(1==confLH.sn_off||"flash_on"==$("#online-offline-user").text())&&window.Notification&&"granted"==window.Notification.permission){var o=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:i,requireInteraction:!0});o.onclick=function(){"pending_chat"==e||"unread_chat"==e||"pending_transfered"==e?$("#tabs").size()>0?(window.focus(),n.startChat(t,$("#tabs"),a)):n.startChatNewWindow(t,"ChatRequest"):n.startChatNewWindowTransferByTransfer(t,a),o.close()},"pending_transfered"!=e&&("undefined"!==this.notificationsArray[t]&&o.close(),this.notificationsArray[t]=o)}"transfer_chat"==e&&1==confLH.show_alert_transfer&&confirm(confLH.transLation.transfered+"\n\n"+i)&&n.startChatNewWindowTransferByTransfer(t,a),1==confLH.show_alert&&confirm(confLH.transLation.new_chat+"\n\n"+i)&&("pending_chat"==e||"unread_chat"==e||"pending_transfered"==e?$("#tabs").size()>0?(window.focus(),n.startChat(t,$("#tabs"),a)):n.startChatNewWindow(t,"ChatRequest"):n.startChatNewWindowTransferByTransfer(t,a))}},this.syncadmininterfacestatic=function(){try{var e=angular.element("body").scope();e.loadChatList()}catch(t){}},this.addingUserMessage=!1,this.addUserMessageQueue=[],this.addDelayedTimeout=null,this.addmsgadmin=function(e){var t=$("#CSChatMessage-"+e);if(!t.is("[readonly]")){var s={msg:t.val()};if(this.speechHandler!==!1&&this.speechHandler.messageSend(),t.val(""),t.hasClass("edit-mode"))s.msgid=t.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsg/"+e,s,function(i){if("f"==i.error)return t.removeClass("edit-mode"),t.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(i.msg),LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e),ee.emitEvent("chatAddMsgAdmin",[e]),!0});else{var i=this,a=$("#messagesBlock-"+e);jQuery("<div/>",{"class":"message-row pending-storage",text:s.msg}).appendTo(a),a.stop(!0,!1).animate({scrollTop:a.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurl+e,s,function(t){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e),ee.emitEvent("chatAddMsgAdmin",[e]),""!=t.r&&($("#messagesBlock-"+e).append(t.r),$("#messagesBlock-"+e).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+e).prop("scrollHeight")},500)),t.hold_removed===!0?$("#hold-action-"+e).removeClass("btn-info"):t.hold_added===!0&&$("#hold-action-"+e).addClass("btn-info"),lhinst.syncadmincall(),i.addingUserMessage=!1,!0}).fail(function(t){var a='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("Invalid response - "+t.responseText).html()+"</div>";$("#messagesBlock-"+e).append(a),i.addUserMessageQueue.push({pdata:s,url:i.wwwDir+i.addmsgurl+e,chat_id:e,retries:0}),clearTimeout(i.addDelayedTimeout),i.addDelayedTimeout=setTimeout(function(){i.addDelayedMessageAdmin()},50),i.addingUserMessage=!1})):(this.addUserMessageQueue.push({pdata:s,url:this.wwwDir+this.addmsgurl+e,chat_id:e,retries:0}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){i.addDelayedMessageAdmin()},50))}}},this.addDelayedMessageAdmin=function(){var e=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var t=this.addUserMessageQueue.shift();this.addingUserMessage=!0,t.retries=t.retries+1,$.postJSON(t.url,t.pdata,function(s){LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t.chat_id),ee.emitEvent("chatAddMsgAdmin",[t.chat_id]),""!=s.r&&($("#messagesBlock-"+t.chat_id).append(s.r),$("#messagesBlock-"+t.chat_id).animate({scrollTop:$("#messagesBlock-"+t.chat_id).prop("scrollHeight")},500)),lhinst.syncadmincall(),e.addingUserMessage=!1,e.addUserMessageQueue.length>0&&(clearTimeout(e.addDelayedTimeout),e.addDelayedMessageAdmin())}).fail(function(s){var i='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("Invalid response - "+s.responseText).html()+"</div>";$("#messagesBlock-"+t.chat_id).append(i),t.retries<2&&(e.addUserMessageQueue.unshift(t),e.addingUserMessage=!1,clearTimeout(e.addDelayedTimeout),e.addDelayedTimeout=setTimeout(function(){e.addDelayedMessageAdmin()},500))})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){e.addDelayedMessageAdmin()},50)},this.editPrevious=function(e){var t=$("#CSChatMessage-"+e);""==t.val()&&$.getJSON(this.wwwDir+"chat/editprevious/"+e,function(s){"f"==s.error&&(t.val(s.msg),t.attr("data-msgid",s.id),t.addClass("edit-mode"),$("#msg-"+s.id).addClass("edit-mode"),LHCCallbacks.editPrevious&&LHCCallbacks.editPrevious(e,s))})},this.editPreviousUser=function(){var e=$("#CSChatMessage");""==e.val()&&$.getJSON(this.wwwDir+"chat/editprevioususer/"+this.chat_id+"/"+this.hash,function(t){"f"==t.error&&(e.val(t.msg),e.attr("data-msgid",t.id),e.addClass("edit-mode"),$("#msg-"+t.id).addClass("edit-mode"),LHCCallbacks.editPreviousUser&&LHCCallbacks.editPreviousUser(t))})},this.afterAdminChatInit=function(e){LHCCallbacks.afterAdminChatInit&&LHCCallbacks.afterAdminChatInit(e)},this.afterUserChatInit=function(){LHCCallbacks.afterUserChatInit&&LHCCallbacks.afterUserChatInit()},this.afterChatWidgetInit=function(){LHCCallbacks.afterChatWidgetInit&&LHCCallbacks.afterChatWidgetInit()},this.addAdminChatFinished=function(e,t,s){var i=this,a=jQuery("#CSChatMessage-"+e);new LHCCannedMessageAutoSuggest({chat_id:e,uppercase_enabled:confLH.auto_uppercase});a.bind("keydown","return",function(t){return i.addmsgadmin(e),ee.emitEvent("afterAdminMessageSent",[e]),a[0].rows=2,!1}),a.bind("keyup","up",function(t){i.editPrevious(e)}),a.bind("keyup",function(e){var t=a[0],s=30;for(t.clientHeight/t.rows;t.scrollHeight>t.clientHeight&&!window.opera&&t.rows<s;)t.style.overflow="hidden",t.rows+=1;t.scrollHeight>t.clientHeight&&(t.style.overflow="auto")}),$messageBlock=$("#messagesBlock-"+e),$messageBlock.css("height",this.getLocalValue("lhc_mheight",confLH.defaultm_hegiht)),$messageBlock.data("resized",!1),$messageBlock.data("y",$messageBlock.outerHeight()),$messageBlock.bind("mouseup mousemove",function(e){var t=jQuery(this);t.outerHeight()!=t.data("y")&&(0==t.data("resized")&&(t.css("height","1px"),t.data("resized",!0)),this.resize_timeout&&clearTimeout(this.resize_timeout),this.resize_timeout=setTimeout(function(){i.setLocalValue("lhc_mheight",t.outerHeight()),t.data("y",t.outerHeight())},100))}),this.initTypingMonitoringAdmin(e),this.afterAdminChatInit(e),this.addSynchroChat(e,t),$("#messagesBlock-"+e).animate({scrollTop:$("#messagesBlock-"+e).prop("scrollHeight")},1e3),this.startSyncAdmin(),jQuery("#id_CannedMessageSearch-"+e).keyup(function(t){""!=$(this).val()?jQuery("#id_CannedMessage-"+e).attr("size",10):jQuery("#id_CannedMessage-"+e).removeAttr("size");var s=$(this).val();$.getJSON(i.wwwDir+"chat/getcannedfiltered/"+e,{q:s},function(t){if(0==t.error&&($("#id_CannedMessage-"+e).html(t.result),""!=s)){var i=$("#id_CannedMessage-"+e).find("option");i.size()>1&&$(i[1]).attr("selected","selected")}})}),null===s||"object"!=typeof s||s.indexOf("background")===-1?this.hideNotification(e):$("#chat-tab-link-"+e).click(function(){i.removeBackgroundChat(parseInt(e)),i.hideNotification(parseInt(e))});try{localStorage&&1==localStorage.getItem("lhc_rch")&&this.processCollapse(e)}catch(n){}$("#chat-tab-items-"+e+" > li > a").click(function(){ee.emitEvent("adminChatTabSubtabClicked",[e,$(this)])}),ee.emitEvent("adminChatLoaded",[e,t,s])},this.removeBackgroundChat=function(e){var t=this.backgroundChats.indexOf(parseInt(e));t!==-1&&delete this.backgroundChats[t]},this.getLocalValue=function(e,t){try{if(localStorage){var s=localStorage.getItem(e);return null!==s?s:t}}catch(i){}return t},this.setLocalValue=function(e,t){try{localStorage&&localStorage.setItem(e,t)}catch(s){}},this.hideNotification=function(e){e=parseInt(e),"undefined"!=typeof this.notificationsArray[e]&&this.backgroundChats.indexOf(e)==-1&&(this.notificationsArray[e].close(),delete this.notificationsArray[e]),clearTimeout(this.soundIsPlaying)},this.showMyPermissions=function(e){$.get(this.wwwDir+"permission/getpermissionsummary/"+e,function(e){$("#permissions-summary").html(e)})},this.addmsguserchatbox=function(e){var t=!1,s={msg:$("#CSChatMessage").val(),nick:$("#CSChatNick").val()},i=1==this.isWidgetMode?"/(mode)/widget":"";$("#CSChatMessage").val("");var a=this;$.postJSON(this.wwwDir+this.addmsgurluserchatbox+this.chat_id+"/"+this.hash+i+this.appendSyncArgument,s,function(e){"f"==e.error?(LHCCallbacks.addmsguserchatbox&&LHCCallbacks.addmsguserchatbox(a,{chat_id:a.chat_id,data:e}),a.syncusercall()):alert(e.or)}),t!=$("#CSChatNick").val()&&window.postMessage&&parent&&(parent.postMessage("lhc_chb:nick:"+$("#CSChatNick").val(),"*"),t=$("#CSChatNick").val())},this.updateMessageRow=function(e){var t=1==this.isWidgetMode?"/(mode)/widget":"";$.getJSON(this.wwwDir+"chat/getmessage/"+this.chat_id+"/"+this.hash+"/"+e+t,function(t){"f"==t.error&&($("#msg-"+e).replaceWith(t.msg),$("#msg-"+e).addClass("edit-mode-done"),setTimeout(function(){$("#msg-"+e).removeClass("edit-mode-done")},2e3))})},this.updateMessageRowAdmin=function(e,t){$.getJSON(this.wwwDir+"chat/getmessageadmin/"+e+"/"+t,function(e){"f"==e.error&&($("#msg-"+t).replaceWith(e.msg),$("#msg-"+t).addClass("edit-mode-done"),setTimeout(function(){$("#msg-"+t).removeClass("edit-mode-done")},2e3))})},this.addmsguser=function(e){LHCCallbacks.addmsguserbefore&&LHCCallbacks.addmsguserbefore(this);var t=$("#CSChatMessage"),s={msg:t.val()},i=1==this.isWidgetMode?"/(mode)/widget":"";t.val("");var a=this;if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt","")}catch(n){}if(t.hasClass("edit-mode"))s.msgid=t.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsguser/"+this.chat_id+"/"+this.hash+i,s,function(e){if("f"==e.error)return t.removeClass("edit-mode"),t.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(e.msg),!0});else{var o=$("#messagesBlock");jQuery("<div/>",{"class":"message-row pending-storage",text:s.msg}).appendTo(o),o.stop(!0,!1).animate({scrollTop:o.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i,s,function(e){if("f"==e.error)LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(a,e),a.syncusercall();else{$("#CSChatMessage").val(s.msg);var t=$("#id-operator-typing");t.html(e.r),t.css("visibility","visible"),setTimeout(function(){0==a.operatorTyping&&$("#id-operator-typing").css("visibility","hidden")},3e3)}a.addingUserMessage=!1})):(this.addUserMessageQueue.push({retries:0,pdata:s,url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){a.addDelayedMessage()},50))}"undefined"!=typeof e&&1==e&&t.focus()},this.addMessagesToStore=function(e){for(var t=1==this.isWidgetMode?"/(mode)/widget":"",s=e.length,i=0;i<s;i++)this.addUserMessageQueue.push({retries:0,pdata:{msg:e[i]},url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+t});this.addDelayedMessage()},this.addDelayedMessage=function(){var e=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var t=this.addUserMessageQueue.shift();this.addingUserMessage=!0;var s=[];s.push(t.pdata.msg);for(var i=this.addUserMessageQueue.length,a=0;a<i;a++)s.push(this.addUserMessageQueue[a].pdata.msg);this.addUserMessageQueue=[],$.postJSON(t.url,{msg:s.join("[[msgitm]]")},function(t){"f"==t.error&&(LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(e,t),e.syncusercall()),e.addingUserMessage=!1,e.addUserMessageQueue.length>0&&(clearTimeout(e.addDelayedTimeout),e.addDelayedMessage())})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){e.addDelayedMessage()},50)},this.startSyncAdmin=function(){0==this.isSinchronizing&&(this.isSinchronizing=!0,this.syncadmincall())},this.disableChatSoundAdmin=function(e){return"volume_off"==e.text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_admin_enabled=1,e.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_admin_enabled=0,e.text("volume_off")),!1},this.disableNewChatSoundAdmin=function(e){return"volume_off"==e.text()?($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/1"),confLH.new_chat_sound_enabled=1,e.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/0"),confLH.new_chat_sound_enabled=0,e.text("volume_off")),!1},this.changeUserSettings=function(e,t){$.get(this.wwwDir+"user/setsettingajax/"+e+"/"+t)},this.changeUserSettingsIndifferent=function(e,t){$.get(this.wwwDir+"user/setsettingajax/"+e+"/"+encodeURIComponent(t)+"/(indifferent)/true")},this.switchToOfflineForm=function(){var e=$("#form-start-chat");return e.attr("action",$("#form-start-chat").attr("action")+"/(switchform)/true/(offline)/true/(leaveamessage)/true/(department)/"+$("#id_DepartamentID").val()),e.submit(),!1},this.changeStatusAction=function(e,t){var s=this;return $.postJSON(e.attr("action"),e.serialize(),function(e){"false"==e.error?($("#myModal").modal("hide"),s.updateVoteStatus(t),e.is_owner===!0&&($("#CSChatMessage-"+t).attr("placeholder",""),$("#CSChatMessage-"+t).focus())):alert(e.result)}),!1},this.submitModalForm=function(e){return $.post(e.attr("action"),e.serialize(),function(e){$("#myModal").html(e)}),!1},this.disableChatSoundUser=function(e){return"volume_off"==e.find("> i").text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_user_enabled=1,e.find("> i").text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_user_enabled=0,e.find("> i").text("volume_off")),window.postMessage&&parent&&("volume_off"==e.find("> i").text()?parent.postMessage("lhc_ch:s:0","*"):parent.postMessage("lhc_ch:s:1","*")),!1},this.pendingMessagesToStore=[],this.prestartChat=function(e,t){if(0==t.find(".form-protected").size()){if(1!=t.attr("lhc-captcha-submitted")){t.attr("lhc-captcha-submitted",1),t.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,function(s){t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),t.submit()});var s=1==t.attr("key-up-started");1==s&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val(""))}else $("#messagesBlock").size()>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1}if(1==t.find("#hasFormExtraField").size())return!0;if(1!=t.attr("lhc-form-submitted")){t.attr("lhc-form-submitted",1);var i=this,s=1==t.attr("key-up-started");1==s&&t.append('<input type="hidden" value="1" name="keyUpStarted" />'),$.post(t.attr("action"),t.serialize(),function(e){var t=$("#id_Question").val();if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",t)}catch(s){}var a=($("head > script"),$("head")),n=[];$("head > script").each(function(){var e=$(this);void 0!==e.attr("src")&&n.push(e.attr("src"))}),$("<div>").html(e).find("> script").each(function(){var e=$(this);void 0===e.attr("src")?a.append(e):n.indexOf(e.attr("src"))==-1&&a.append('<script src="'+e.attr("src")+'"></script>')}),paramsDocument="<script>lhinst.addMessagesToStore("+JSON.stringify(i.pendingMessagesToStore)+")</script>",$("#widget-layout").html($("<div>").html(e).find("#widget-layout").html()),$("#widget-layout-js").html($("<div>").html(e).find("#widget-layout-js").html()+paramsDocument)}),0==s&&$("#id_Question").val("")}else $("#messagesBlock").size()>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1},this.addCaptcha=function(e,t){return 0!=t.find(".form-protected").size()||(t.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,function(s){t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),t.submit()}),!1)},this.setSubject=function(e,t){$("#subject-message-"+t).text("..."),$.postJSON(this.wwwDir+"chat/subject/"+t+"/(subject)/"+e.val()+"/(status)/"+e.is(":checked"),{update:!0},function(e){lhinst.updateVoteStatus(t),$("#subject-message-"+t).text(e.message)})},this.addCaptchaSubmit=function(e,t){return 0==t.find(".form-protected").size()&&(t.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,function(s){if(t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),window.FormData)try{var i=new FormData(t[0]),a=new XMLHttpRequest;a.addEventListener("readystatechange",function(e){var t,s,i;try{i=e.target.readyState,s=e.target.responseText,t=e.target.status}catch(n){return}if(4==i&&"200"==t&&e.target.responseText){var o=a.getResponseHeader("Content-Type");o.indexOf("application/json")==-1?$("#widget-content-body").html(e.target.responseText):location.replace(jQuery.parseJSON(e.target.responseText).location)}},!1);var n=t.attr("action");""!=n?a.open("POST",n+"/(ajaxmode)/true",!0):a.open("POST",document.location+"&ajaxmode=true",!0),a.send(i)}catch(o){return!1}else t.submit()}),!1)},this.deleteChatfile=function(e){$.postJSON(this.wwwDir+"file/deletechatfile/"+e,function(t){"false"==t.error?$("#file-id-"+e).remove():alert(t.result)})},this.addFileUserUpload=function(e){$("#fileupload").fileupload({url:this.wwwDir+"file/uploadfile/"+e.chat_id+"/"+e.hash,dataType:"json",add:function(t,s){var i=[],a=e.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(t,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg&&alert(i.result.error_msg),LHCCallbacks.addFileUserUpload&&LHCCallbacks.addFileUserUpload(e.chat_id)},progressall:function(e,t){var s=parseInt(t.loaded/t.total*100,10);$("#id-operator-typing").css("visibility","visible"),$("#id-operator-typing").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUserUploadOnline=function(e,t){var s=this;$("#fileuploadonline").fileupload({url:this.wwwDir+"file/uploadfileonline/"+e.online_user_vid,dataType:"json",add:function(t,s){var i=[],a=e.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){s.updateOnlineFilesUser(e.online_user_vid),t&&t(e.online_user_vid)},progressall:function(e,t){var s=parseInt(t.loaded/t.total*100,10);$("#upload-status-user-online").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.updateChatFiles=function(e){$.postJSON(this.wwwDir+"file/chatfileslist/"+e,function(t){$("#chat-files-list-"+e).html(t.result)})},this.updateOnlineFiles=function(e){$.postJSON(this.wwwDir+"file/onlinefileslist/"+e,function(t){$("#online-user-files-list-"+e).html(t.result)})},this.updateOnlineFilesUser=function(e){$.postJSON(this.wwwDir+"file/useronlinefileslist/"+e,function(e){$("#user-online-files-list").html(e.result)})},this.addFileUpload=function(e){$("#fileupload-"+e.chat_id).fileupload({url:this.wwwDir+"file/uploadfileadmin/"+e.chat_id,dataType:"json",add:function(t,s){var i=[],a=e.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(t,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg?alert(i.result.error_msg):lhinst.updateChatFiles(e.chat_id),LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(e.chat_id)},dropZone:$("#drop-zone-"+e.chat_id),pasteZone:$("#CSChatMessage-"+e.chat_id),progressall:function(t,s){var i=parseInt(s.loaded/s.total*100,10);$("#user-is-typing-"+e.chat_id).css("visibility","visible"),$("#user-is-typing-"+e.chat_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUploadOnlineUser=function(e,t){var s=this;$("#fileupload-online-user-"+e.online_user_id).fileupload({url:this.wwwDir+"file/uploadfileadminonlineuser/"+e.online_user_id,dataType:"json",add:function(t,s){var i=[],a=e.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){t&&t(e.online_user_id),s.updateOnlineFiles(e.online_user_id)},dropZone:$("#drop-zone-online-user-"+e.online_user_id),progressall:function(t,s){var i=parseInt(s.loaded/s.total*100,10);$("#upload-status-admin-"+e.online_user_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addExecutionCommand=function(e,t){if($.postJSON(this.wwwDir+"chat/addonlineoperation/"+e,{operation:t},function(t){LHCCallbacks.addExecutionCommand&&LHCCallbacks.addExecutionCommand(e)}),"lhc_screenshot"==t){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshotOnline(e)},15e3)}},this.addRemoteCommand=function(e,t){if($.postJSON(this.wwwDir+"chat/addoperation/"+e,{operation:t},function(t){LHCCallbacks.addRemoteCommand&&LHCCallbacks.addRemoteCommand(e),"true"==t.error&&null!=t.errors&&alert(t.errors.join("\n"))}),"lhc_screenshot"==t){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshot(e)},5e3)}},this.addRemoteOnlineCommand=function(e,t){$.postJSON(this.wwwDir+"chat/addonlineoperationiframe/"+e,{operation:t},function(t){LHCCallbacks.addRemoteOnlineCommand&&LHCCallbacks.addRemoteOnlineCommand(e)})},this.updateScreenshot=function(e){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshot/"+e,function(e){$("#user-screenshot-container").html(e),$("#user-screenshot-container").removeClass("screenshot-pending")})},this.updateScreenshotOnline=function(e){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshotonline/"+e,function(e){$("#user-screenshot-container").html(e),$("#user-screenshot-container").removeClass("screenshot-pending")})},this.eNick=function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/editnick/"+this.chat_id+"/"+this.hash})},this.enableVisitorEditor=function(){$("#CSChatMessage").prop("readonly",!1)},this.disableVisitorEditor=function(){setTimeout(function(){$("#CSChatMessage").prop("readonly",!0)},300)},this.buttonClicked=function(e,t,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),
s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash,{payload:e,id:t,processed:"undefined"==typeof i||0==i},function(e){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.editGenericStep=function(e,t){var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/editgenericstep",{payload:e,id:t},function(e){var t=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:t},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.updateTriggerClicked=function(e,t,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/triggerclicked",{payload:e,id:t,processed:"undefined"==typeof i||0==i},function(e){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.updateChatClicked=function(e,t,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),lhinst.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/updatebuttonclicked/"+this.chat_id+"/"+this.hash,{payload:e,id:t,processed:"undefined"==typeof i||0==i},function(e){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.dropdownClicked=function(e,t){void 0==t.attr("data-no-change")&&(t.attr("disabled","disabled"),t.prepend('<i class="material-icons lhc-spin">loop</i>'));var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),""!=$("#generic_list-"+e).val()?(this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/valueclicked",{payload:$("#id_generic_list-"+e).val(),id:e},function(t){$(".meta-message-"+e).remove();var i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()):alert("Please choose!")},this.focusUserText=function(){$("#CSChatMessage").focus()},this.delayQueue=[],this.delayed=!1,this.setDelay=function(e,t){$("#msg-"+e).addClass("meta-hider message-row-typing").nextUntil("meta-hider").addClass("hide"),0==lhinst.delayed?(lhinst.delayed=!0,setTimeout(function(){lhinst.unhideDelayed(e)},1e3*t),$("#msg-"+e).removeClass("hide"),$("#msg-"+e+" .msg-body").removeClass("hide")):lhinst.delayQueue.push({id:e,delay:t})},this.unhideDelayed=function(e){var t=$("#messagesBlock > #msg-"+e);t.nextUntil(".meta-hider").removeClass("hide"),t.remove();var s=$("#messagesBlock"),i=s.prop("scrollHeight");if(s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.stop(!0,!1).animate({scrollTop:i+2e3},500),this.delayQueue.length>0){var a=lhinst.delayQueue.pop();setTimeout(function(){lhinst.unhideDelayed(a.id)},1e3*a.delay),$("#msg-"+a.id).removeClass("hide"),$("#msg-"+a.id+" .msg-body").removeClass("hide")}else lhinst.delayed=!1},this.gmaps_loading=!1,this.queue_render=[],this.showMessageLocation=function(e,t,s){var i={lat:t,lng:s};if(1==this.gmaps_loaded){var a=new google.maps.Map(document.getElementById("msg-location-"+e),{zoom:13,center:i});new google.maps.Marker({position:i,map:a,title:t+","+s})}else if(0==this.gmaps_loading){this.gmaps_loading=!0;var n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://maps.googleapis.com/maps/api/js?key="+confLH.gmaps_api_key+"&callback=chatMapLoaded";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(n,o),lhinst.queue_render.push({id:e,lat:t,lon:s})}else lhinst.queue_render.push({id:e,lat:t,lon:s})}}function chatMapLoaded(){if(lhinst.queue_render.length>0){lhinst.gmaps_loaded=!0;var e=lhinst.queue_render.pop(),t={lat:e.lat,lng:e.lon},s=new google.maps.Map(document.getElementById("msg-location-"+e.id),{zoom:13,center:t});new google.maps.Marker({position:t,map:s,title:e.lat+","+e.lon});lhinst.queue_render.length>0&&chatMapLoaded()}}function preloadSound(){lhinst.playPreloadSound(),jQuery(document).off("click",preloadSound),jQuery(document).off("touchstart",preloadSound)}function gMapsCallback(){function e(){0==n?c.hasClass("active")?(n=!0,$.ajax({url:WWW_DIR_JAVASCRIPT+"chat/jsononlineusers"+(parseInt($("#id_department_map_id").val())>0?"/(department)/"+parseInt($("#id_department_map_id").val()):"")+(parseInt($("#maxRows").val())>0?"/(maxrows)/"+parseInt($("#maxRows").val()):"")+(parseInt($("#userTimeout").val())>0?"/(timeout)/"+parseInt($("#userTimeout").val()):""),dataType:"json",error:function(){clearTimeout(r),r=setTimeout(function(){e()},1e4)},success:function(s){t(s),n=!1,clearTimeout(r),1==o?(o=!1,e()):r=setTimeout(function(){e()},1e4)}})):r=setTimeout(function(){e()},1e4):o=!0}function t(e){$(e.result).each(function(e,t){if($.inArray(t.Id,d)==-1){var s=new google.maps.LatLng(t.Latitude,t.Longitude),a=new google.maps.Marker({position:s,icon:t.icon,map:i});google.maps.event.addListener(a,"click",function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/getonlineuserinfo/"+t.Id})}),a.setVisible(!0),a.setAnimation(google.maps.Animation.DROP),l[t.Id]=a,d.push(t.Id),clearTimeout(l[t.Id].timeOutMarker),l[t.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(t.Id,d),1),google.maps.event.clearInstanceListeners(l[t.Id]),l[t.Id].setMap(null),l[t.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))}else l[t.Id].setIcon(t.icon),clearTimeout(l[t.Id].timeOutMarker),l[t.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(t.Id,d),1),google.maps.event.clearInstanceListeners(l[t.Id]),l[t.Id].setMap(null),l[t.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))})}lhinst.gmaps_loaded=!0;var s=$("#map_canvas"),i=new google.maps.Map(s[0],{zoom:GeoLocationData.zoom,center:new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,options:{zoomControl:!0,scrollwheel:!0,streetViewControl:!0}}),a=!1,n=!1,o=!1,r=!1;google.maps.event.addListener(i,"idle",e);var c=$("#map-activator").parent(),d=[],l=[];new google.maps.InfoWindow({content:"Loading..."});$("#id_department_map_id").change(function(){e(),lhinst.changeUserSettingsIndifferent("omap_depid",$(this).val())}),$("#markerTimeout").change(function(){e(),lhinst.changeUserSettingsIndifferent("omap_mtimeout",$(this).val())}),$("#map-activator").click(function(){setTimeout(function(){google.maps.event.trigger(i,"resize"),0==a&&(a=!0,i.setCenter(new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng)))},500),e()})}function chatsyncuser(){lhinst.syncusercall()}function chatsyncuserpending(){lhinst.chatsyncuserpending()}function chatsyncadmin(){lhinst.syncadmincall()}$.ajaxSetup({crossDomain:!1,cache:!1,beforeSend:function(e,t){csrfSafeMethod(t.type)||e.setRequestHeader("X-CSRFToken",confLH.csrf_token)}}),$.postJSON=function(e,t,s){return $.post(e,t,s,"json")};var LHCCallbacks={},lhinst=new lh;lhinst.playPreloadSound(),jQuery(document).on("click",preloadSound),jQuery(document).on("click",function(){lhinst.hidePopover()}),jQuery(document).on("touchstart",preloadSound),$.fn.makeDropdown=function(){var e=this.find(".btn-block-department-filter > input");this.click(function(){setTimeout(function(){e.focus()},50)}),this.on("click","[data-stopPropagation]",function(t){t.stopPropagation(),e.focus()}),e.keyup(function(){var e=$(this).val();$(this).parent().parent().children("li").each(function(t){t>0&&($(this).text().toLowerCase().includes(e)||""==e?$(this).show():$(this).hide())})})};var focused=!0;window.onfocus=window.onblur=function(e){focused="focus"===(e||event).type,lhinst.focusChanged(focused)};