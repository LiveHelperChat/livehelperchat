function csrfSafeMethod(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}function lh(){this.wwwDir=WWW_DIR_JAVASCRIPT,this.addmsgurl="chat/addmsgadmin/",this.addmsgurluser="chat/addmsguser/",this.addmsgurluserchatbox="chatbox/addmsguser/",this.syncuser="chat/syncuser/",this.syncadmin="chat/syncadmin/",this.closechatadmin="chat/closechatadmin/",this.deletechatadmin="chat/deletechatadmin/",this.checkchatstatus="chat/checkchatstatus/",this.syncadmininterfaceurl="chat/syncadmininterface/",this.accepttransfer="chat/accepttransfer/",this.trasnsferuser="chat/transferuser/",this.userclosechaturl="chat/userclosechat/",this.disableremember=!1,this.operatorTyping=!1,this.appendSyncArgument="",this.chat_id=null,this.hash=null,this.soundIsPlaying=!1,this.soundPlayedTimes=0,this.last_message_id=0,this.isSinchronizing=!1,this.isWidgetMode=!1,this.isEmbedMode=!1,this.syncroRequestSend=!1,this.currentMessageText="",this.setWidgetMode=function(t){this.isWidgetMode=t},this.setEmbedMode=function(t){this.isEmbedMode=t},this.setSynchronizationRequestSend=function(t){this.syncroRequestSend=t},this.setSyncUserURL=function(t){this.syncuser=t},this.trackLastIDS={},this.trackLastIDSUser={},this.chatsSynchronising=[],this.chatsSynchronisingMsg=[],this.notificationsArray=[],this.notificationsArrayMap=[],this.speechHandler=!1,this.underMessageAdd=!1,this.closeWindowOnChatCloseDelete=!1,this.userTimeout=!1,this.lastOnlineSyncTimeout=!1,this.setLastUserMessageID=function(t){this.last_message_id=t},this.setChatID=function(t){this.chat_id=t},this.setwwwDir=function(t){this.wwwDir=t},this.setCloseWindowOnEvent=function(t){this.closeWindowOnChatCloseDelete=t},this.setDisableRemember=function(t){this.disableremember=t},this.setSynchronizationStatus=function(t){this.underMessageAdd=t},this.tabIconContent="face",this.tabIconClass="icon-user-status material-icons icon-user-online",this.addTab=function(t,e,s,i,a){t.find("> ul").append('<li role="presentation" id="chat-tab-li-'+i+'" ><a href="#chat-id-'+i+'" id="chat-tab-link-'+i+'" aria-controls="chat-id-'+i+'" role="tab" data-toggle="tab"><i id="user-chat-status-'+i+'" class="'+this.tabIconClass+'">'+this.tabIconContent+"</i>"+s.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'<span onclick="return lhinst.removeDialogTab('+i+',$(\'#tabs\'),true)" class="material-icons icon-close-chat">close</span></a></li>'),$("#chat-tab-link-"+i).click(function(){var t=$(this);setTimeout(function(){t.find(".msg-nm").remove(),t.removeClass("has-pm"),$("#messagesBlock-"+i).animate({scrollTop:$("#messagesBlock-"+i).prop("scrollHeight")},1e3),$("#CSChatMessage-"+i).focus()},500)});var n=window.location.hash.replace("#/","#");$.get(e,function(e){"undefined"==typeof a||a===!0||n=="#chat-id-"+i?(t.find("> ul > li.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+i).addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active" id="chat-id-'+i+'"></div>'),window.location.hash="#/chat-id-"+i):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane" id="chat-id-'+i+'"></div>'),$("#chat-id-"+i).html(e),$("#CSChatMessage-"+i).focus(),ee.emitEvent("chatTabLoaded",[i])})},this.attachTabNavigator=function(){$("#tabs > ul.nav > li > a").click(function(){$(this).find(".msg-nm").remove(),$(this).removeClass("has-pm")})},this.startChat=function(t,e,s,i){if(0==this.chatUnderSynchronization(t)){var a="undefined"!=typeof i?i:!0,n=0==this.disableremember?"/(remember)/true":"";this.addTab(e,this.wwwDir+"chat/adminchat/"+t+n,s,t,a);var o=this;setTimeout(function(){o.syncadmininterfacestatic()},1e3)}else e.find("> ul > li.active").removeClass("active"),e.find("> ul > #chat-tab-li-"+t).addClass("active"),e.find("> div.tab-content > div.active").removeClass("active"),e.find("> div.tab-content > #chat-id-"+t).addClass("active"),window.location.hash="#/chat-id-"+t},this.startChatBackground=function(t,e,s){if(0==this.chatUnderSynchronization(t)){var i=0==this.disableremember?"/(remember)/true":"";return this.addTab(e,this.wwwDir+"chat/adminchat/"+t+i,s,t,!1),!0}return!1},this.protectCSFR=function(){$("a.csfr-required").click(function(){var t=$(this);t.attr("data-secured")||(t.attr("href",t.attr("href")+"/(csfr)/"+confLH.csrf_token),t.attr("data-secured",1))})},this.setChatHash=function(t){this.hash=t},this.addSynchroChat=function(t,e){this.chatsSynchronising.push(t),this.chatsSynchronisingMsg.push(t+","+e),LHCCallbacks.addSynchroChat&&LHCCallbacks.addSynchroChat(t,e)},this.removeSynchroChat=function(t){for(var e=0;e<this.chatsSynchronising.length;)this.chatsSynchronising[e]==t?(this.chatsSynchronising.splice(e,1),this.chatsSynchronisingMsg.splice(e,1)):e++;LHCCallbacks.removeSynchroChat&&LHCCallbacks.removeSynchroChat(t)},this.is_typing=!1,this.typing_timeout=null,this.operatorTypingCallback=function(t){var e=this.wwwDir,s=this;0==s.is_typing?(s.is_typing=!0,clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform?(s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3),LHCCallbacks.initTypingMonitoringAdminInform({chat_id:t,status:!0})):$.getJSON(e+"chat/operatortyping/"+t+"/true",{},function(){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3),LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0)}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3)})):(clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3))},this.initTypingMonitoringAdmin=function(t){var e=this;jQuery("#CSChatMessage-"+t).bind("keyup",function(){e.operatorTypingCallback(t)})},this.remarksTimeout=null,this.saveRemarks=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-"+t).addClass("warning-color"),$("#main-user-info-remarks-"+t+" .alert").remove();var e=this;this.remarksTimeout=setTimeout(function(){$.postJSON(e.wwwDir+"chat/saveremarks/"+t,{data:$("#ChatRemarks-"+t).val()},function(e){"false"==e.error?$("#remarks-status-"+t).removeClass("warning-color"):$("#main-user-info-remarks-"+t).prepend(e.result)})},500)},this.saveNotes=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-online-"+t).addClass("warning-color");var e=this;this.remarksTimeout=setTimeout(function(){$.postJSON(e.wwwDir+"chat/saveonlinenotes/"+t,{data:$("#OnlineRemarks-"+t).val()},function(){$("#remarks-status-online-"+t).removeClass("warning-color")})},500)},this.surveyShowed=!1,this.closeWindow=function(){null!==this.survey&&0==this.surveyShowed?(this.surveyShowed=!0,this.chatClosed()):(window.open("","_self",""),window.close())},this.typingStoppedOperator=function(t){var e=this;1==e.is_typing&&(LHCCallbacks.typingStoppedOperatorInform?(e.is_typing=!1,LHCCallbacks.typingStoppedOperatorInform({chat_id:t,status:!1})):$.getJSON(this.wwwDir+"chat/operatortyping/"+t+"/false",{},function(){e.is_typing=!1,LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!1)}).fail(function(){e.is_typing=!1}))},this.sendemail=function(){$.postJSON(this.wwwDir+"chat/sendchat/"+this.chat_id+"/"+this.hash,{csfr_token:confLH.csrf_token,email:$('input[name="UserEmail"]').val()},function(t){"false"==t.error?$("#myModal").modal("hide"):($("#user-action .alert-box").remove(),$("#user-action").prepend(t.result))})},this.reopenchat=function(t){$.postJSON(this.wwwDir+"chat/reopenchat/"+t.attr("data-id"),function(e){"true"==e.error?alert(e.result):($("#action-block-row-"+t.attr("data-id")+" .send-row").removeClass("hide"),$("#CSChatMessage-"+t.attr("data-id")).removeAttr("readonly").focus(),$("#chat-status-text-"+t.attr("data-id")).text(e.status),t.remove())})},this.initTypingMonitoringUser=function(t){var e=this.wwwDir,s=this;try{sessionStorage&&sessionStorage.getItem("lhc_ttxt")&&""!=sessionStorage.getItem("lhc_ttxt")&&jQuery("#CSChatMessage").val(sessionStorage.getItem("lhc_ttxt"))}catch(i){}jQuery("#CSChatMessage").bind("keyup",function(){if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",$(this).val())}catch(i){}if(0==s.is_typing)s.is_typing=!0,clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringUserInform?(s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3),LHCCallbacks.initTypingMonitoringUserInform({chat_id:t,hash:s.hash,status:!0,msg:$(this).val()})):$.postJSON(e+"chat/usertyping/"+t+"/"+s.hash+"/true",{msg:$(this).val()},function(){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3),LHCCallbacks.initTypingMonitoringUser&&LHCCallbacks.initTypingMonitoringUser(t,!0)}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3)});else{clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3);var a=$(this).val();s.currentMessageText!=a&&Math.abs(s.currentMessageText.length-a.length)>6&&(s.currentMessageText=a,LHCCallbacks.initTypingMonitoringUserInform?LHCCallbacks.initTypingMonitoringUserInform({chat_id:t,hash:s.hash,status:!0,msg:a}):$.postJSON(e+"chat/usertyping/"+t+"/"+s.hash+"/true",{msg:a},function(){LHCCallbacks.initTypingMonitoringUser&&LHCCallbacks.initTypingMonitoringUser(t,!0)}))}})},this.typingStoppedUser=function(t){var e=this;1==e.is_typing&&(LHCCallbacks.typingStoppedUserInform?(e.is_typing=!1,LHCCallbacks.typingStoppedUserInform({chat_id:t,hash:this.hash,status:!1})):$.getJSON(this.wwwDir+"chat/usertyping/"+t+"/"+this.hash+"/false",{},function(){e.is_typing=!1,LHCCallbacks.initTypingMonitoringUser&&LHCCallbacks.initTypingMonitoringUser(t,!1)}).fail(function(){e.is_typing=!1}))},this.refreshFootPrint=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/chatfootprint/"+t.attr("rel"),{},function(e){$("#footprint-"+t.attr("rel")).html(e),t.removeClass("disabled")})},this.makeAbstractRequest=function(t,e){return $.get(e.attr("href"),function(){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedSurvey&&LHCCallbacks.userRedirectedSurvey(t)}),!1},this.refreshOnlineUserInfo=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/refreshonlineinfo/"+t.attr("rel"),{},function(e){$("#online-user-info-"+t.attr("rel")).html(e),t.removeClass("disabled")})},this.processCollapse=function(t){"chevron_right"==$("#chat-main-column-"+t+" .collapse-right").text()?($("#chat-right-column-"+t).hide(),$("#chat-main-column-"+t).removeClass("col-sm-7").addClass("col-sm-12"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_left")):($("#chat-right-column-"+t).show(),$("#chat-main-column-"+t).removeClass("col-sm-12").addClass("col-sm-7"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_right"))},this.chatUnderSynchronization=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return!0;e++}return!1},this.getChatIndex=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return e;e++}return!1},this.updateUserSyncInterface=function(t,e){try{if("false"==e.error)if("true"!=e.blocked){if("false"!=e.result&&"true"==e.status){var s=$("#messagesBlock");s.find(".pending-storage").remove(),s.append(e.result),s.animate({scrollTop:s.prop("scrollHeight")},1e3),1==confLH.new_message_sound_user_enabled&&"false"==e.uw&&t.playNewMessageSound(),t.last_message_id>0&&$("#msg-"+t.last_message_id).attr("data-op-id")!=e.msop&&$("#msg-"+t.last_message_id).next().addClass("operator-changes"),t.last_message_id=e.message_id}else"true"!=e.status&&$("#status-chat").html(e.status);if(t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval),"t"==e.cs&&t.chatsyncuserpending(),""!=e.ott&&"f"!=e.ott){var i=$("#id-operator-typing");i.text(e.ott),i.css("visibility","visible"),t.operatorTyping=!0}else"f"==e.ott&&(t.operatorTyping=!1,$("#id-operator-typing").css("visibility","hidden"));""!=e.op&&t.executeRemoteCommands(e.op)}else $("#status-chat").html(e.status),$("#ChatMessageContainer").remove(),$("#ChatSendButtonContainer").remove(),$("#id-operator-typing").css("visibility","hidden"),t.operatorTyping=!1,"undefined"!=typeof e.op&&""!=e.op&&t.executeRemoteCommands(e.op),e.closed&&1==e.closed&&(t.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed"+("undefined"!=typeof e.closed_arg?":"+e.closed_arg:""),"*"):t.chatClosed())}catch(a){t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}t.syncroRequestSend=!1},this.chatClosed=function(){if(null!==this.survey){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=1==this.operatorTyping?"/(ot)/t":"",s=null!==this.theme?"/(theme)/"+this.theme:"",i=1==this.isEmbedMode?"/(modeembed)/embed":"",a=1==this.isWidgetMode?"fillwidget":"fill",n=1==this.explicitClose?"/(eclose)/t":"";return document.location=this.wwwDir+"survey/"+a+"/(survey)/"+this.survey+"/(chatid)/"+this.chat_id+"/(hash)/"+this.hash+t+e+s+i+n,!0}return!1},this.executeRemoteCommands=function(operations){var inst=this;$.each(operations,function(i,item){-1!=item.indexOf("lhinst.")?eval(item):inst.isWidgetMode?parent.postMessage(item,"*"):window.opener&&window.opener.postMessage(item,"*")})},this.syncusercall=function(){var t=this;if(0==this.syncroRequestSend){clearTimeout(t.userTimeout),this.syncroRequestSend=!0;var e=1==this.isWidgetMode?"/(mode)/widget":"",s=1==this.operatorTyping?"/(ot)/t":"",i=null!==this.theme?"/(theme)/"+this.theme:"",a=1==this.isEmbedMode?"/(modeembed)/embed":"";$.getJSON(this.wwwDir+this.syncuser+this.chat_id+"/"+this.last_message_id+"/"+this.hash+e+s+i+a,{},function(e){t.updateUserSyncInterface(t,e),LHCCallbacks.syncusercall&&LHCCallbacks.syncusercall(t,e)}).fail(function(){t.syncroRequestSend=!1,t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)})}},this.scheduleSync=function(){this.syncroRequestSend=!1,this.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)},this.closeActiveChatDialog=function(t,e,s){if($.ajax({type:"POST",url:this.wwwDir+this.closechatadmin+t,async:!1}),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),1==s){var i=e.find("> ul > #chat-tab-li-"+t).index();e.find("> ul > #chat-tab-li-"+t).remove(),e.find("#chat-id-"+t).remove();var a=e.find("> ul > li:eq("+(i-1)+") > a");a.tab("show"),setTimeout(function(){window.location.hash=a.attr("href").replace("#","#/")},500),1==this.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatClosedCallback&&LHCCallbacks.chatClosedCallback(t),this.removeSynchroChat(t),this.syncadmininterfacestatic()},this.startChatCloseTabNewWindow=function(t,e){window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650"),$.ajax({type:"GET",url:this.wwwDir+"chat/adminleftchat/"+t,async:!0});var s=e.find("> ul > #chat-tab-li-"+t).index();return e.find("> ul > #chat-tab-li-"+t).remove(),e.find("#chat-id-"+t).remove(),e.find("> ul > li:eq("+(s-1)+")").addClass("active"),e.find("> div.tab-content > div:eq("+(s-1)+")").addClass("active"),1==this.closeWindowOnChatCloseDelete&&window.close(),this.removeSynchroChat(t),this.syncadmininterfacestatic(),!1},this.removeDialogTab=function(t,e,s){if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),this.removeSynchroChat(t),1==s){$.ajax({type:"GET",url:this.wwwDir+"chat/adminleftchat/"+t,async:!0});var i=e.find("> ul > #chat-tab-li-"+t).index();e.find("> ul > #chat-tab-li-"+t).remove(),e.find("#chat-id-"+t).remove(),e.find("> ul > li.active").length||e.find("> ul > li:eq("+(i-1)+") > a").tab("show"),setTimeout(function(){window.location.hash=e.find("> ul > li:eq("+(i-1)+") > a").attr("href").replace("#","#/")},500),1==this.closeWindowOnChatCloseDelete&&window.close()}this.syncadmininterfacestatic()},this.removeActiveDialogTag=function(){1==this.closeWindowOnChatCloseDelete&&window.close()},this.deleteChat=function(t,e,s){if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),$.ajax({type:"POST",url:this.wwwDir+this.deletechatadmin+t,cache:!1,dataType:"json",async:!1}).done(function(t){"true"==t.error&&alert(t.result)}),1==s){var i=e.find("> ul > #chat-tab-li-"+t).index();e.find("> ul > #chat-tab-li-"+t).remove(),e.find("#chat-id-"+t).remove();var a=e.find("> ul > li:eq("+(i-1)+") > a");a.tab("show"),setTimeout(function(){window.location.hash=a.attr("href").replace("#","#/")},500),1==this.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatDeletedCallback&&LHCCallbacks.chatDeletedCallback(t),this.syncadmininterfacestatic(),this.removeSynchroChat(t)},this.rejectPendingChat=function(t){$.postJSON(this.wwwDir+this.deletechatadmin+t,{},function(){}),this.syncadmininterfacestatic()},this.startChatNewWindow=function(t){window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus();var e=this;return setTimeout(function(){e.syncadmininterfacestatic()},1e3),!1},this.startCoBrowse=function(t){return window.open(this.wwwDir+"cobrowse/browse/"+t,"chatwindow-cobrowse-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus(),!1},this.speechToText=function(t){0==this.speechHandler&&(this.speechHandler=new LHCSpeechToText),this.speechHandler.listen({chat_id:t})},this.startChatTransfer=function(t,e,s,i){var a=this;$.getJSON(this.wwwDir+this.accepttransfer+i,{},function(){a.startChat(t,e,s),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)}).fail(function(){a.startChat(t,e,s)})},this.startChatNewWindowTransfer=function(t,e,s){return $.getJSON(this.wwwDir+this.accepttransfer+s,{},function(){LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)}),this.startChatNewWindow(t,e)},this.startChatNewWindowTransferByTransfer=function(t){var e=this;return $.ajax({type:"GET",url:this.wwwDir+this.accepttransfer+t,cache:!1,dataType:"json",async:!1}).done(function(t){e.startChatNewWindow(t.chat_id,""),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t.chat_id)}),this.syncadmininterfacestatic(),!1},this.blockUser=function(t,e){("undefined"==typeof e||confirm(e))&&$.postJSON(this.wwwDir+"chat/blockuser/"+t,{},function(t){alert(t.msg)})},this.switchLang=function(t,e){var s='<input type="hidden" value="'+e+'" name="switchLang" />';return t.append(s),t.submit(),!1},this.sendLinkToMail=function(t,e){var s=window.parent.$("#MailMessage").val();window.parent.$("#MailMessage").val((""!=s?s+"\n":s)+t),$("#embed-button-"+e).addClass("success")},this.sendLinkToEditor=function(t,e,s){var i=window.parent.$("#CSChatMessage-"+t).val();window.parent.$("#CSChatMessage-"+t).val((""!=i?i+"\n":i)+e),$("#embed-button-"+s).addClass("success")},this.transferChat=function(t){var e=$("[name=TransferTo"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+e,{type:"user"},function(t){"false"==t.error&&$("#transfer-block-"+t.chat_id).html(t.result)})},this.chooseSurvey=function(t){var e=$("[name=SurveyItem"+t+"]:checked").val();$.postJSON(this.wwwDir+"survey/choosesurvey/"+t+"/"+e,function(t){"false"==t.error&&$("#survey-block-"+t.chat_id).html(t.result)})},this.redirectContact=function(t,e){("undefined"==typeof e||confirm(e))&&$.postJSON(this.wwwDir+"chat/redirectcontact/"+t,function(){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedContact&&LHCCallbacks.userRedirectedContact(t)})},this.redirectToURL=function(t,e){var s=prompt(e,"");null!=s&&lhinst.addRemoteCommand(t,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__"))},this.redirectToURLOnline=function(t,e){var s=prompt(e,"");null!=s&&(lhinst.addRemoteOnlineCommand(t,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")),lhinst.addExecutionCommand(t,"lhc_cobrowse_multi_command__lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")))},this.transferChatDep=function(t){var e=$("[name=DepartamentID"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+e,{type:"dep"},function(t){"false"==t.error&&$("#transfer-block-"+t.chat_id).html(t.result)})},this.chatTabsOpen=function(){return window.open(this.wwwDir+"chat/chattabs/","chatwindows","menubar=1,resizable=1,width=800,height=650"),!1},this.userclosedchat=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.ajax({type:"GET",url:this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash,cache:!1,async:!1})},this.userclosedchatembed=function(){window.postMessage&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},this.continueChatFromSurvey=function(t){return this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?$.postJSON(this.wwwDir+"survey/backtochat/"+this.chat_id+"/"+this.hash+"/"+t,function(){parent.postMessage("lhc_continue_chat","*")}):this.chatClosed(),!1},this.explicitClose=!1,this.explicitChatCloseByUser=function(){this.explicitClose=!0,this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},this.restoreWidget=function(t){window.postMessage&&window.opener&&(window.opener.postMessage("lhc_ch:hash:"+t,"*"),window.opener.postMessage("lhc_ch:hash_resume:"+t,"*"),window.opener.postMessage("lhc_open_restore","*"),window.close())},this.userclosedchatandbrowser=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.get(this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash+"/(eclose)/t",function(){lhinst.closeWindow()})},this.sendCannedMessage=function(t,e){if($("#id_CannedMessage-"+t).val()>0){e.addClass("secondary");var s=1e3*parseInt($("#id_CannedMessage-"+t).find(":selected").attr("data-delay")),i=this.wwwDir,a=this;if(0==a.is_typing?(a.is_typing=!0,clearTimeout(a.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform&&LHCCallbacks.initTypingMonitoringAdminInform({chat_id:t,status:!0}),$.getJSON(i+"chat/operatortyping/"+t+"/true",{},function(){LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t),e.removeClass("secondary")},s>3e3?s:3e3)}).fail(function(){a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t)},3e3)})):(clearTimeout(a.typing_timeout),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t)},3e3),e.removeClass("secondary")),s>0)setTimeout(function(){var e={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(i+a.addmsgurl+t,e,function(){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),lhinst.syncadmincall(),!0})},s);else{var n={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(this.wwwDir+this.addmsgurl+t,n,function(){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),lhinst.syncadmincall(),!0})}}return!1},this.voteAction=function(t){var e=this.chat_id;$.postJSON(this.wwwDir+"chat/voteaction/"+this.chat_id+"/"+this.hash+"/"+t.attr("data-id"),{},function(t){"false"==t.error&&(LHCCallbacks.uservoted&&LHCCallbacks.uservoted(e),0==t.status?($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):1==t.status?($(".up-vote-action").addClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):2==t.status&&($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").addClass("down-voted")))})},this.theme=null,this.chatsyncuserpending=function(){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=null!==this.theme?"/(theme)/"+this.theme:"",s=this;$.getJSON(this.wwwDir+this.checkchatstatus+this.chat_id+"/"+this.hash+t+e,{},function(t){"false"==t.error&&("false"==t.activated?("false"!=t.result&&$("#status-chat").html(t.result),""!=t.ru&&(document.location=t.ru),setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)):($("#status-chat").html(t.result),t.closed&&1==t.closed&&(s.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed","*"):s.chatClosed())))}).fail(function(){setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)})},this.setTheme=function(t){this.theme=t},this.survey=null,this.setSurvey=function(t){this.survey=t},this.isBlinking=!1,this.startBlinking=function(){if(0==this.isBlinking){var t=this,e=function(){var e,s=document.title,i="!!! "+document.title,a=function(){document.title=document.title==i?" ":i},n=function(){clearInterval(e),document.title=s,window.onmousemove=null,e=null,t.isBlinking=!1};return function(){e||(e=setInterval(a,1e3),window.onmousemove=n)}}();e(),this.isBlinking=!0}},this.playNewMessageSound=function(){if(Modernizr.audio){var t=new Audio;t.autoplay="autoplay",t.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_message.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_message.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_message.wav",t.load()}$("textarea[name=ChatMessage]").is(":focus")||this.startBlinking()},this.playInvitationSound=function(){if(Modernizr.audio){var t=new Audio;t.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/invitation.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/invitation.mp3":WWW_DIR_JAVASCRIPT_FILES+"/invitation.wav",t.load(),setTimeout(function(){t.play()},500)}},this.playPreloadSound=function(){if(Modernizr.audio){var t=new Audio;t.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/silence.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/silence.mp3":WWW_DIR_JAVASCRIPT_FILES+"/silence.wav",t.load(),setTimeout(function(){t.play()},500)}},this.syncadmincall=function(){this.chatsSynchronising.length>0?0==this.underMessageAdd&&0==this.syncroRequestSend?(this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.postJSON(this.wwwDir+this.syncadmin,{"chats[]":this.chatsSynchronisingMsg},function(data){try{"false"==data.error&&("false"!=data.result&&($.each(data.result,function(t,e){var s=$("#messagesBlock-"+e.chat_id),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));s.find(".pending-storage").remove(),s.append(e.content),20>a&&s.animate({scrollTop:i},1e3),lhinst.updateChatLastMessageID(e.chat_id,e.message_id);var n=$("#chat-tab-link-"+e.chat_id);if(!n.parent().hasClass("active"))if(n.find("span.msg-nm").length>0){var o=parseInt(n.find("span.msg-nm").attr("rel"))+e.mn;n.find("span.msg-nm").html(" ("+o+")").attr("rel",o)}else n.append('<span rel="'+e.mn+'" class="msg-nm"> ('+e.mn+")</span>"),n.addClass("has-pm");1==confLH.new_message_browser_notification&&"false"==data.uw&&lhinst.showNewMessageNotification(e.chat_id,e.msg,e.nck),e.msfrom>0&&$("#msg-"+e.msfrom).attr("data-op-id")!=e.msop&&$("#msg-"+e.msfrom).next().addClass("operator-changes"),ee.emitEvent("eventSyncAdmin",[e,t])}),1==confLH.new_message_sound_admin_enabled&&"false"==data.uw&&lhinst.playNewMessageSound()),"false"!=data.result_status&&$.each(data.result_status,function(i,item){"true"==item.tp?$("#user-is-typing-"+item.chat_id).html(item.tx).css("visibility","visible"):$("#user-is-typing-"+item.chat_id).css("visibility","hidden"),$("#user-chat-status-"+item.chat_id).removeClass("icon-user-online icon-user-away icon-user-pageview"),0==item.us?$("#user-chat-status-"+item.chat_id).addClass("icon-user-online"):2==item.us?$("#user-chat-status-"+item.chat_id).addClass("icon-user-away"):3==item.us&&$("#user-chat-status-"+item.chat_id).addClass("icon-user-pageview"),"undefined"!=typeof item.uc&&"true"==item.uc&&$("#user-chat-status-"+item.chat_id).addClass("icon-user-closed-chat"),"undefined"!=typeof item.oad&&eval(item.oad)}),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval))}catch(err){lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}lhinst.setSynchronizationRequestSend(!1),LHCCallbacks.syncadmincall&&LHCCallbacks.syncadmincall(lhinst,data)}).fail(function(){lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),lhinst.setSynchronizationRequestSend(!1)})):lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval):this.isSinchronizing=!1},this.updateVoteStatus=function(t){$.getJSON(this.wwwDir+"chat/updatechatstatus/"+t,{},function(e){$("#main-user-info-tab-"+t).html(e.result)})},this.updateChatLastMessageID=function(t,e){this.chatsSynchronisingMsg[this.getChatIndex(t)]=t+","+e},this.requestNotificationPermission=function(){window.webkitNotifications?window.webkitNotifications.requestPermission():window.Notification?Notification.requestPermission(function(){}):alert("Notification API in your browser is not supported.")},this.playNewChatAudio=function(){if(clearTimeout(this.soundIsPlaying),this.soundPlayedTimes++,Modernizr.audio){var t=new Audio;if(t.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_chat.wav",t.load(),setTimeout(function(){t.play()},500),confLH.repeat_sound>this.soundPlayedTimes){var e=this;this.soundIsPlaying=setTimeout(function(){e.playNewChatAudio()},1e3*confLH.repeat_sound_delay)}}},this.focusChanged=function(t){if(1==confLH.new_message_browser_notification&&1==t&&(window.webkitNotifications||window.Notification)){var e=this;$.each(this.chatsSynchronising,function(t,s){"undefined"!=typeof e.notificationsArrayMessages[s]&&(window.webkitNotifications?e.notificationsArrayMessages[s].cancel():e.notificationsArrayMessages[s].close())})}},this.notificationsArrayMessages=[],this.showNewMessageNotification=function(t,e,s){try{if(window.Notification&&0==focused&&"granted"==window.Notification.permission){"undefined"!=typeof this.notificationsArrayMessages[t]&&this.notificationsArrayMessages[t].close();var i=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:e});i.onclick=function(){window.focus(),i.close()},this.notificationsArrayMessages[t]=i,this.scheduleNewMessageClose(i,t)}}catch(a){console.log(a)}},this.scheduleNewMessageClose=function(t){setTimeout(function(){window.webkitNotifications?t.cancel():t.close()},1e4)},this.playSoundNewAction=function(t,e,s,i,a,n){1!=confLH.new_chat_sound_enabled||0!=n&&confLH.user_id!=n||"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||(this.soundPlayedTimes=0,this.playNewChatAudio()),$("textarea[name=ChatMessage]").is(":focus")||0!=n&&confLH.user_id!=n||"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||this.startBlinking();var o=this;if(("pending_chat"==t||"transfer_chat"==t||"unread_chat"==t||"pending_transfered"==t)&&(0==n||confLH.user_id==n)&&"flash_on"==$("#online-offline-user").text()&&window.Notification&&"granted"==window.Notification.permission){var r=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:i});r.onclick=function(){"pending_chat"==t||"unread_chat"==t||"pending_transfered"==t?$("#tabs").size()>0?(window.focus(),o.startChat(e,$("#tabs"),a)):o.startChatNewWindow(e,"ChatRequest"):o.startChatNewWindowTransferByTransfer(e),r.close()},"pending_transfered"!=t&&("undefined"!==this.notificationsArray[e]&&r.close(),this.notificationsArray[e]=r,this.notificationsArrayMap.push(this.notificationsArray[e]))}1==confLH.show_alert&&setTimeout(function(){$("#right-pending-chats ul").size()>0&&confirm(confLH.transLation.new_chat)&&("pending_chat"==t?o.startChatNewWindow(e,"ChatRequest"):o.startChatNewWindowTransferByTransfer(e))},5e3)},this.hideNotifications=function(){clearTimeout(this.soundIsPlaying),$.each(this.notificationsArrayMap,function(t,e){try{e.close()}catch(s){console.log(s)}}),this.notificationsArray=[],this.notificationsArrayMap=[]
},this.syncadmininterfacestatic=function(){try{var t=angular.element("body").scope();t.loadChatList()}catch(e){}},this.addingUserMessage=!1,this.addUserMessageQueue=[],this.addDelayedTimeout=null,this.addmsgadmin=function(t){var e=$("#CSChatMessage-"+t);if(!e.is("[readonly]")){var s={msg:e.val()};if(this.speechHandler!==!1&&this.speechHandler.messageSend(),e.val(""),e.hasClass("edit-mode"))s.msgid=e.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsg/"+t,s,function(i){return"f"==i.error?(e.removeClass("edit-mode"),e.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(i.msg),LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),!0):void 0});else{var i=this,a=$("#messagesBlock-"+t);jQuery("<div/>",{"class":"message-row pending-storage",text:s.msg}).appendTo(a),a.animate({scrollTop:a.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurl+t,s,function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),""!=e.r&&($("#messagesBlock-"+t).append(e.r),$("#messagesBlock-"+t).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},1e3)),lhinst.syncadmincall(),i.addingUserMessage=!1,!0})):(this.addUserMessageQueue.push({pdata:s,url:this.wwwDir+this.addmsgurl+t,chat_id:t}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){i.addDelayedMessageAdmin()},50))}}},this.addDelayedMessageAdmin=function(){var t=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var e=this.addUserMessageQueue.shift();this.addingUserMessage=!0,$.postJSON(e.url,e.pdata,function(s){LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e.chat_id),""!=s.r&&($("#messagesBlock-"+e.chat_id).append(s.r),$("#messagesBlock-"+e.chat_id).animate({scrollTop:$("#messagesBlock-"+e.chat_id).prop("scrollHeight")},1e3)),lhinst.syncadmincall(),t.addingUserMessage=!1,t.addUserMessageQueue.length>0&&(clearTimeout(t.addDelayedTimeout),t.addDelayedMessageAdmin())})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){t.addDelayedMessageAdmin()},50)},this.editPrevious=function(t){var e=$("#CSChatMessage-"+t);""==e.val()&&$.getJSON(this.wwwDir+"chat/editprevious/"+t,function(s){"f"==s.error&&(e.val(s.msg),e.attr("data-msgid",s.id),e.addClass("edit-mode"),$("#msg-"+s.id).addClass("edit-mode"),LHCCallbacks.editPrevious&&LHCCallbacks.editPrevious(t,s))})},this.editPreviousUser=function(){var t=$("#CSChatMessage");""==t.val()&&$.getJSON(this.wwwDir+"chat/editprevioususer/"+this.chat_id+"/"+this.hash,function(e){"f"==e.error&&(t.val(e.msg),t.attr("data-msgid",e.id),t.addClass("edit-mode"),$("#msg-"+e.id).addClass("edit-mode"),LHCCallbacks.editPreviousUser&&LHCCallbacks.editPreviousUser(e))})},this.afterAdminChatInit=function(t){LHCCallbacks.afterAdminChatInit&&LHCCallbacks.afterAdminChatInit(t)},this.afterUserChatInit=function(){LHCCallbacks.afterUserChatInit&&LHCCallbacks.afterUserChatInit()},this.afterChatWidgetInit=function(){LHCCallbacks.afterChatWidgetInit&&LHCCallbacks.afterChatWidgetInit()},this.showMyPermissions=function(t){$.get(this.wwwDir+"permission/getpermissionsummary/"+t,function(t){$("#permissions-summary").html(t)})},this.addmsguserchatbox=function(){var t=!1,e={msg:$("#CSChatMessage").val(),nick:$("#CSChatNick").val()},s=1==this.isWidgetMode?"/(mode)/widget":"";$("#CSChatMessage").val("");var i=this;$.postJSON(this.wwwDir+this.addmsgurluserchatbox+this.chat_id+"/"+this.hash+s+this.appendSyncArgument,e,function(t){"f"==t.error?(LHCCallbacks.addmsguserchatbox&&LHCCallbacks.addmsguserchatbox(i,{chat_id:i.chat_id,data:t}),i.syncusercall()):alert(t.or)}),t!=$("#CSChatNick").val()&&window.postMessage&&parent&&(parent.postMessage("lhc_chb:nick:"+$("#CSChatNick").val(),"*"),t=$("#CSChatNick").val())},this.updateMessageRow=function(t){var e=1==this.isWidgetMode?"/(mode)/widget":"";$.getJSON(this.wwwDir+"chat/getmessage/"+this.chat_id+"/"+this.hash+"/"+t+e,function(e){"f"==e.error&&($("#msg-"+t).replaceWith(e.msg),$("#msg-"+t).addClass("edit-mode-done"),setTimeout(function(){$("#msg-"+t).removeClass("edit-mode-done")},2e3))})},this.updateMessageRowAdmin=function(t,e){$.getJSON(this.wwwDir+"chat/getmessageadmin/"+t+"/"+e,function(t){"f"==t.error&&($("#msg-"+e).replaceWith(t.msg),$("#msg-"+e).addClass("edit-mode-done"),setTimeout(function(){$("#msg-"+e).removeClass("edit-mode-done")},2e3))})},this.addmsguser=function(){LHCCallbacks.addmsguserbefore&&LHCCallbacks.addmsguserbefore(this);var t=$("#CSChatMessage"),e={msg:t.val()},s=1==this.isWidgetMode?"/(mode)/widget":"";t.val("");var i=this;if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt","")}catch(a){}if(t.hasClass("edit-mode"))e.msgid=t.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsguser/"+this.chat_id+"/"+this.hash+s,e,function(s){return"f"==s.error?(t.removeClass("edit-mode"),t.removeAttr("data-msgid"),$("#msg-"+e.msgid).replaceWith(s.msg),!0):void 0});else{var n=$("#messagesBlock");jQuery("<div/>",{"class":"message-row pending-storage",text:e.msg}).appendTo(n),n.animate({scrollTop:n.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+s,e,function(t){if("f"==t.error)LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(i,t),i.syncusercall();else{$("#CSChatMessage").val(e.msg);var s=$("#id-operator-typing");s.html(t.r),s.css("visibility","visible"),setTimeout(function(){0==i.operatorTyping&&$("#id-operator-typing").css("visibility","hidden")},3e3)}i.addingUserMessage=!1})):(this.addUserMessageQueue.push({pdata:e,url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+s}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){i.addDelayedMessage()},50))}},this.addMessagesToStore=function(t){for(var e=1==this.isWidgetMode?"/(mode)/widget":"",s=t.length,i=0;s>i;i++)this.addUserMessageQueue.push({pdata:{msg:t[i]},url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+e});this.addDelayedMessage()},this.addDelayedMessage=function(){var t=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var e=this.addUserMessageQueue.shift();this.addingUserMessage=!0;var s=[];s.push(e.pdata.msg);for(var i=this.addUserMessageQueue.length,a=0;i>a;a++)s.push(this.addUserMessageQueue[a].pdata.msg);this.addUserMessageQueue=[],$.postJSON(e.url,{msg:s.join("[[msgitm]]")},function(e){"f"==e.error&&(LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(t,e),t.syncusercall()),t.addingUserMessage=!1,t.addUserMessageQueue.length>0&&(clearTimeout(t.addDelayedTimeout),t.addDelayedMessage())})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){t.addDelayedMessage()},50)},this.startSyncAdmin=function(){0==this.isSinchronizing&&(this.isSinchronizing=!0,this.syncadmincall())},this.disableChatSoundAdmin=function(t){return"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_admin_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_admin_enabled=0,t.text("volume_off")),!1},this.disableNewChatSoundAdmin=function(t){return"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/1"),confLH.new_chat_sound_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/0"),confLH.new_chat_sound_enabled=0,t.text("volume_off")),!1},this.changeUserSettings=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+e)},this.changeUserSettingsIndifferent=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+e+"/(indifferent)/true")},this.disableUserAsOnline=function(t){return"flash_off"==t.text()?($.get(this.wwwDir+"user/setoffline/false"),t.text("flash_on")):($.get(this.wwwDir+"user/setoffline/true"),t.text("flash_off")),!1},this.switchToOfflineForm=function(){var t=$("#form-start-chat");return t.attr("action",$("#form-start-chat").attr("action")+"/(switchform)/true/(offline)/true/(leaveamessage)/true/(department)/"+$("#id_DepartamentID").val()),t.submit(),!1},this.changeStatusAction=function(t,e){var s=this;return $.postJSON(t.attr("action"),t.serialize(),function(t){"false"==t.error?($("#myModal").modal("hide"),s.updateVoteStatus(e)):alert(t.result)}),!1},this.submitModalForm=function(t){return $.post(t.attr("action"),t.serialize(),function(t){$("#myModal").html(t)}),!1},this.changeVisibility=function(t){return"visibility_off"==t.text()?($.get(this.wwwDir+"user/setinvisible/false"),t.text("visibility")):($.get(this.wwwDir+"user/setinvisible/true"),t.text("visibility_off")),!1},this.disableChatSoundUser=function(t){return"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_user_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_user_enabled=0,t.text("volume_off")),window.postMessage&&parent&&("volume_off"==t.text()?parent.postMessage("lhc_ch:s:0","*"):parent.postMessage("lhc_ch:s:1","*")),!1},this.pendingMessagesToStore=[],this.prestartChat=function(t,e){if(0==e.find(".form-protected").size()){if(1!=e.attr("lhc-captcha-submitted")){e.attr("lhc-captcha-submitted",1),e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,function(s){e.append('<input type="hidden" value="'+t+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()});var s=1==e.attr("key-up-started");1==s&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},1e3),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val(""))}else $("#messagesBlock").size()>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},1e3)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1}if(1==e.find("#hasFormExtraField").size())return!0;if(1!=e.attr("lhc-form-submitted")){e.attr("lhc-form-submitted",1);var i=this,s=1==e.attr("key-up-started");1==s&&e.append('<input type="hidden" value="1" name="keyUpStarted" />'),$.post(e.attr("action"),e.serialize(),function(t){var e=$("#id_Question").val();if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",e)}catch(s){}var a=($("head > script"),$("head")),n=[];$("head > script").each(function(){var t=$(this);void 0!==t.attr("src")&&n.push(t.attr("src"))}),$("<div>").html(t).find("> script").each(function(){var t=$(this);void 0===t.attr("src")?a.append(t):-1==n.indexOf(t.attr("src"))&&a.append('<script src="'+t.attr("src")+'"></script>')}),paramsDocument="<script>lhinst.addMessagesToStore("+JSON.stringify(i.pendingMessagesToStore)+")</script>",$("#widget-layout").html($("<div>").html(t).find("#widget-layout").html()),$("#widget-layout-js").html($("<div>").html(t).find("#widget-layout-js").html()+paramsDocument)}),0==s&&$("#id_Question").val("")}else $("#messagesBlock").size()>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},1e3)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1},this.addCaptcha=function(t,e){return 0==e.find(".form-protected").size()?(e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,function(s){e.append('<input type="hidden" value="'+t+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()}),!1):!0},this.deleteChatfile=function(t){$.postJSON(this.wwwDir+"file/deletechatfile/"+t,function(e){"false"==e.error?$("#file-id-"+t).remove():alert(e.result)})},this.addFileUserUpload=function(t){$("#fileupload").fileupload({url:this.wwwDir+"file/uploadfile/"+t.chat_id+"/"+t.hash,dataType:"json",add:function(e,s){var i=[],a=t.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(e,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg&&alert(i.result.error_msg),LHCCallbacks.addFileUserUpload&&LHCCallbacks.addFileUserUpload(t.chat_id)},progressall:function(t,e){var s=parseInt(e.loaded/e.total*100,10);$("#id-operator-typing").css("visibility","visible"),$("#id-operator-typing").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUserUploadOnline=function(t,e){var s=this;$("#fileuploadonline").fileupload({url:this.wwwDir+"file/uploadfileonline/"+t.online_user_vid,dataType:"json",add:function(e,s){var i=[],a=t.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(){s.updateOnlineFilesUser(t.online_user_vid),e&&e(t.online_user_vid)},progressall:function(t,e){var s=parseInt(e.loaded/e.total*100,10);$("#upload-status-user-online").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.updateChatFiles=function(t){$.postJSON(this.wwwDir+"file/chatfileslist/"+t,function(e){$("#chat-files-list-"+t).html(e.result)})},this.updateOnlineFiles=function(t){$.postJSON(this.wwwDir+"file/onlinefileslist/"+t,function(e){$("#online-user-files-list-"+t).html(e.result)})},this.updateOnlineFilesUser=function(t){$.postJSON(this.wwwDir+"file/useronlinefileslist/"+t,function(t){$("#user-online-files-list").html(t.result)})},this.addFileUpload=function(t){$("#fileupload-"+t.chat_id).fileupload({url:this.wwwDir+"file/uploadfileadmin/"+t.chat_id,dataType:"json",add:function(e,s){var i=[],a=t.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(e,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg?alert(i.result.error_msg):lhinst.updateChatFiles(t.chat_id),LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(t.chat_id)},dropZone:$("#drop-zone-"+t.chat_id),pasteZone:$("#CSChatMessage-"+t.chat_id),progressall:function(e,s){var i=parseInt(s.loaded/s.total*100,10);$("#user-is-typing-"+t.chat_id).css("visibility","visible"),$("#user-is-typing-"+t.chat_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUploadOnlineUser=function(t,e){var s=this;$("#fileupload-online-user-"+t.online_user_id).fileupload({url:this.wwwDir+"file/uploadfileadminonlineuser/"+t.online_user_id,dataType:"json",add:function(e,s){var i=[],a=t.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(){e&&e(t.online_user_id),s.updateOnlineFiles(t.online_user_id)},dropZone:$("#drop-zone-online-user-"+t.online_user_id),progressall:function(e,s){var i=parseInt(s.loaded/s.total*100,10);$("#upload-status-admin-"+t.online_user_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addExecutionCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addonlineoperation/"+t,{operation:e},function(){LHCCallbacks.addExecutionCommand&&LHCCallbacks.addExecutionCommand(t)}),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshotOnline(t)},15e3)}},this.addRemoteCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addoperation/"+t,{operation:e},function(e){LHCCallbacks.addRemoteCommand&&LHCCallbacks.addRemoteCommand(t),"true"==e.error&&null!=e.errors&&alert(e.errors.join("\n"))}),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshot(t)},5e3)}},this.addRemoteOnlineCommand=function(t,e){$.postJSON(this.wwwDir+"chat/addonlineoperationiframe/"+t,{operation:e},function(){LHCCallbacks.addRemoteOnlineCommand&&LHCCallbacks.addRemoteOnlineCommand(t)})},this.updateScreenshot=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshot/"+t,function(t){$("#user-screenshot-container").html(t),$("#user-screenshot-container").removeClass("screenshot-pending")})},this.updateScreenshotOnline=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshotonline/"+t,function(t){$("#user-screenshot-container").html(t),$("#user-screenshot-container").removeClass("screenshot-pending")})},this.eNick=function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/editnick/"+this.chat_id+"/"+this.hash})}}function gMapsCallback(){function t(){0==n?c.hasClass("active")?(n=!0,$.ajax({url:WWW_DIR_JAVASCRIPT+"chat/jsononlineusers"+(parseInt($("#id_department_map_id").val())>0?"/(department)/"+parseInt($("#id_department_map_id").val()):"")+(parseInt($("#maxRows").val())>0?"/(maxrows)/"+parseInt($("#maxRows").val()):"")+(parseInt($("#userTimeout").val())>0?"/(timeout)/"+parseInt($("#userTimeout").val()):""),dataType:"json",error:function(){clearTimeout(r),r=setTimeout(function(){t()},1e4)},success:function(s){e(s),n=!1,clearTimeout(r),1==o?(o=!1,t()):r=setTimeout(function(){t()},1e4)}})):r=setTimeout(function(){t()},1e4):o=!0}function e(t){$(t.result).each(function(t,e){if(-1==$.inArray(e.Id,d)){var s=new google.maps.LatLng(e.Latitude,e.Longitude),a=new google.maps.Marker({position:s,icon:e.icon,map:i});google.maps.event.addListener(a,"click",function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/getonlineuserinfo/"+e.Id})}),a.setVisible(!0),a.setAnimation(google.maps.Animation.DROP),l[e.Id]=a,d.push(e.Id),clearTimeout(l[e.Id].timeOutMarker),l[e.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(e.Id,d),1),google.maps.event.clearInstanceListeners(l[e.Id]),l[e.Id].setMap(null),l[e.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))}else l[e.Id].setIcon(e.icon),clearTimeout(l[e.Id].timeOutMarker),l[e.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(e.Id,d),1),google.maps.event.clearInstanceListeners(l[e.Id]),l[e.Id].setMap(null),l[e.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))})}var s=$("#map_canvas"),i=new google.maps.Map(s[0],{zoom:GeoLocationData.zoom,center:new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,options:{zoomControl:!0,scrollwheel:!0,streetViewControl:!0}}),a=!1,n=!1,o=!1,r=!1;google.maps.event.addListener(i,"idle",t);{var c=$("#map-activator").parent(),d=[],l=[];new google.maps.InfoWindow({content:"Loading..."})}$("#id_department_map_id").change(function(){t(),lhinst.changeUserSettingsIndifferent("omap_depid",$(this).val())}),$("#markerTimeout").change(function(){t(),lhinst.changeUserSettingsIndifferent("omap_mtimeout",$(this).val())}),$("#map-activator").click(function(){setTimeout(function(){google.maps.event.trigger(i,"resize"),0==a&&(a=!0,i.setCenter(new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng)))},500),t()})}function chatsyncuser(){lhinst.syncusercall()}function chatsyncuserpending(){lhinst.chatsyncuserpending()}function chatsyncadmin(){lhinst.syncadmincall()}$.ajaxSetup({crossDomain:!1,cache:!1,beforeSend:function(t,e){csrfSafeMethod(e.type)||t.setRequestHeader("X-CSRFToken",confLH.csrf_token)}}),$.postJSON=function(t,e,s){return $.post(t,e,s,"json")};var LHCCallbacks={},lhinst=new lh;lhinst.playPreloadSound();var focused=!0;window.onfocus=window.onblur=function(t){focused="focus"===(t||event).type,lhinst.focusChanged(focused)};