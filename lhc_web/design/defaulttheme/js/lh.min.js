function csrfSafeMethod(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}$.ajaxSetup({crossDomain:!1,cache:!1,beforeSend:function(t,e){csrfSafeMethod(e.type)||t.setRequestHeader("X-CSRFToken",confLH.csrf_token)}}),$.postJSON=function(t,e,i){return $.post(t,e,i,"json")};var LHCCallbacks={};function lh(){this.wwwDir=WWW_DIR_JAVASCRIPT,this.addmsgurl="chat/addmsgadmin/",this.addmsgurluser="chat/addmsguser/",this.addmsgurluserchatbox="chatbox/addmsguser/",this.syncuser="chat/syncuser/",this.syncadmin="chat/syncadmin/",this.closechatadmin="chat/closechatadmin/",this.deletechatadmin="chat/deletechatadmin/",this.checkchatstatus="chat/checkchatstatus/",this.syncadmininterfaceurl="chat/syncadmininterface/",this.accepttransfer="chat/accepttransfer/",this.trasnsferuser="chat/transferuser/",this.userclosechaturl="chat/userclosechat/",this.disableremember=!1,this.operatorTyping=!1,this.forceBottomScroll=!1,this.appendSyncArgument="",this.nodeJsMode=!1,this.gmaps_loaded=!1,this.disableSync=!1,this.chat_id=null,this.hash=null,this.soundIsPlaying=!1,this.soundPlayedTimes=0,this.last_message_id=0,this.isSinchronizing=!1,this.isWidgetMode=!1,this.isEmbedMode=!1,this.syncroRequestSend=!1,this.currentMessageText="",this.setWidgetMode=function(t){this.isWidgetMode=t},this.setEmbedMode=function(t){this.isEmbedMode=t},this.setSynchronizationRequestSend=function(t){this.syncroRequestSend=t},this.setSyncUserURL=function(t){this.syncuser=t},this.chatsSynchronising=[],this.chatsSynchronisingMsg=[],this.notificationsArray=[],this.speechHandler=!1,this.underMessageAdd=!1,this.closeWindowOnChatCloseDelete=!1,this.userTimeout=!1,this.lastOnlineSyncTimeout=!1,this.setLastUserMessageID=function(t){this.last_message_id=t},this.setChatID=function(t){this.chat_id=t},this.setwwwDir=function(t){this.wwwDir=t},this.setCloseWindowOnEvent=function(t){this.closeWindowOnChatCloseDelete=t},this.setDisableRemember=function(t){this.disableremember=t},this.setSynchronizationStatus=function(t){this.underMessageAdd=t},this.tabIconContent="face",this.tabIconClass="icon-user-status material-icons icon-user-online",this.audio=new Audio,this.audio.autoplay="autoplay",this.reloadTab=function(t,e,i){$("#ntab-chat-"+t).text(i),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),this.removeSynchroChat(t),this.removeBackgroundChat(t),this.hideNotification(t);var s=this;$.get(this.wwwDir+"chat/adminchat/"+t+"/(remember)/true",(function(e){$("#chat-id-"+t).html(e),$("#CSChatMessage-"+t).focus(),s.rememberTab(t),s.addQuateHandler(t),s.loadMainData(t),ee.emitEvent("chatTabLoaded",[t])}))},this.loadMainData=function(t){$.getJSON(this.wwwDir+"chat/loadmaindata/"+t,{},(function(t){$.each(t.items,(function(t,e){var i=$(e.selector);void 0!==e.attr&&$.each(e.attr,(function(t,e){"text"==t?i.text(e):i.attr(t,e)})),void 0!==e.action&&("hide"==e.action?i.hide():"show"==e.action?i.show():"remove"==e.action?i.remove():"event"==e.action?ee.emitEvent(e.event_name,e.event_value):"click"==e.action&&(i.attr("auto-scroll",1),i.click()))}))})).fail((function(){}))},this.getSelectedText=function(){var t,e="";return window.getSelection?e=(t=window.getSelection()).toString():document.selection&&"Control"!==document.selection.type&&(e=(t=document.selection.createRange()).text),{selection:t,text:e}},this.popoverShown=!1,this.popoverShownNow=!1,this.selection=null,this.mouseContextMenu=function(t){if(3==t.which&&void 0!==$(this).attr("id")){$(".popover-copy").popover("dispose");var e=t.data.that.getSelectedText(),i=!1;!e.text.length||null!==t.data.that.selection&&t.data.that.selection.text===e.text||(i=!0,t.data.that.selection=e);var s=$(this).attr("id").replace("msg-",""),a={placement:"right",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+t.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body"></div></div>',content:function(){return'<a href="#" id="copy-popover-'+t.data.chat_id+'" ><i class="material-icons">&#xE244;</i>Quote</a>'+(i?'<br/><a href="#" id="copy-text-popover-'+t.data.chat_id+'" ><i class="material-icons">content_copy</i>Copy (Ctrl+C)</a>':"")}};return ee.emitEvent("quoteActionRight",[a,t.data.chat_id,s]),$("#msg-"+s+" > .msg-body").popover(a).popover("show").addClass("popover-copy"),$("#copy-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault(),$.getJSON(t.data.that.wwwDir+"chat/quotemessage/"+s,(function(e){e.msg&&t.data.that.insertTextToMessageArea(t.data.chat_id,e.msg),t.data.that.hidePopover()}))})),i&&$("#copy-text-popover-"+t.data.chat_id).click((function(e){e.stopPropagation(),e.preventDefault();var i=t.data.that.getSelectedTextPlain(),s=$("#CSChatMessage-"+t.data.chat_id),a=s.val();s.val(i),s.select(),document.execCommand("copy"),s.val(a),t.data.that.hidePopover()})),t.data.that.popoverShown=!0,t.data.that.popoverShownNow=!1,!1}},this.insertTextToMessageArea=function(t,e){var i=$("#CSChatMessage-"+t),s=i.val().replace(/^\s*\n/g,"");i.val((""!=s?s+"[quote]"+e+"[/quote]":"[quote]"+e+"[/quote]")+"\n").focus();var a=i[0];for(a.clientHeight,a.rows;a.scrollHeight>a.clientHeight&&!window.opera&&a.rows<30;)a.style.overflow="hidden",a.rows+=1;a.scrollHeight>a.clientHeight&&(a.style.overflow="auto")},this.mouseClicked=function(t){if(selected=t.data.that.getSelectedText(),$(".popover-copy").popover("dispose"),!selected.text.length||null!==t.data.that.selection&&t.data.that.selection.text===selected.text)t.data.that.selection=null;else{t.data.that.selection=selected;var e={placement:"right",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+t.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body"></div></div>',content:function(){return'<a href="#" id="copy-popover-'+t.data.chat_id+'" ><i class="material-icons">&#xE244;</i>Quote</a>'}};ee.emitEvent("quoteAction",[e,t.data.chat_id]);var i=void 0!==$(this).attr("id")?"#msg-"+$(this).attr("id").replace("msg-","")+" > .msg-body":this;$(i).popover(e).popover("show").addClass("popover-copy"),$("#copy-popover-"+t.data.chat_id).click((function(){lhinst.quateSelection(t.data.chat_id)})),t.data.that.popoverShown=!0,t.data.that.popoverShownNow=!0}},this.addQuateHandler=function(t){this.popoverShown=!1,$("#messagesBlock-"+t+" .message-row").off("mouseup",lhinst.mouseClicked),$("#messagesBlock-"+t+" .message-row").off("contextmenu",lhinst.mouseContextMenu),$("#messagesBlock-"+t+" .message-row").on("mouseup",{chat_id:t,that:this},lhinst.mouseClicked),$("#messagesBlock-"+t+" .message-row").on("contextmenu",{chat_id:t,that:this},lhinst.mouseContextMenu)},this.getSelectedTextPlain=function(){var t=this.selection.text.replace(/[\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA]/g,"");return t=(t=(t=(t=t.replace(/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,"")).replace(/^[0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,"")).replace(/^\s*\n/gm,"")).replace(/^ /gm,"")},this.quateSelection=function(t){$(".popover-copy").popover("dispose");var e=this.getSelectedTextPlain();window.textreplace=e,this.insertTextToMessageArea(t,e),this.popoverShown=!1},this.hidePopover=function(){!0===this.popoverShownNow?this.popoverShownNow=!1:!0===this.popoverShown&&(this.popoverShown=!1,$(".popover-copy").popover("dispose"))},this.addTab=function(t,e,i,s,a,n){if(!(t.find("#chat-tab-link-"+s).length>0)){var o='<li role="presentation" id="chat-tab-li-'+s+'" class="nav-item"><a class="nav-link" href="#chat-id-'+s+'" id="chat-tab-link-'+s+'" aria-controls="chat-id-'+s+'" role="tab" data-toggle="tab"><i id="msg-send-status-'+s+'" class="material-icons send-status-icon icon-user-online">send</i><i id="user-chat-status-'+s+'" class="'+this.tabIconClass+'">'+this.tabIconContent+'</i><span class="ntab" id="ntab-chat-'+s+'">'+i.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</span><span onclick="return lhinst.removeDialogTab('+s+',$(\'#tabs\'),true)" class="material-icons icon-close-chat">close</span></a></li>';void 0===n||0==parseInt(n)?t.find("> ul").append(o):t.find("> ul > li:eq("+(n-1)+")").after(o),$("#chat-tab-link-"+s).click((function(){setTimeout((function(){$("#CSChatMessage-"+s).focus()}),2);var t=$(this);setTimeout((function(){t.find(".msg-nm").remove();var e=!1;t.hasClass("has-pm")&&(e=!0,t.removeClass("has-pm")),/*!inst.attr('lhc-scrolled') || */1==e&&$("#messagesBlock-"+s).prop("scrollTop",$("#messagesBlock-"+s).prop("scrollHeight")),ee.emitEvent("chatTabClicked",[s,t])}),500)}));var r=window.location.hash.replace("#/","#"),c=this;$.get(e,(function(e){""!=e?(void 0===a||!0===a||r=="#chat-id-"+s?(t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+s+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active" id="chat-id-'+s+'"></div>'),window.location.hash="#/chat-id-"+s):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane" id="chat-id-'+s+'"></div>'),$("#chat-id-"+s).html(e),$("#CSChatMessage-"+s).focus(),0==c.disableremember&&c.rememberTab(s),c.addQuateHandler(s),c.loadMainData(s),ee.emitEvent("chatTabLoaded",[s])):c.removeDialogTab(s,t,!0)}))}},this.rememberTab=function(t){if(localStorage)try{t=parseInt(t);var e=localStorage.getItem("achat_id"),i=new Array;if(null!==e)i=e.split(",").map(Number);-1===i.indexOf(t)&&i.push(t),localStorage.setItem("achat_id",i.join(","))}catch(t){console.log(t)}},this.forgetChat=function(t,e){if(localStorage)try{t=parseInt(t);var i=localStorage.getItem(e),s=new Array;null!==i&&(s=i.split(",").map(Number)),-1!==s.indexOf(t)&&s.splice(s.indexOf(t),1),localStorage.setItem(e,s.join(","))}catch(t){console.log(t)}},this.attachTabNavigator=function(){$("#tabs > ul.nav > li > a").click((function(){$(this).find(".msg-nm").remove(),$(this).removeClass("has-pm")}))},this.holdAction=function(t,e){var i=this;$.postJSON(this.wwwDir+"chat/holdaction/"+t,(function(s){0==s.error?(1==s.hold?e.addClass("btn-outline-info"):e.removeClass("btn-outline-info"),""!=s.msg&&($("#messagesBlock-"+t).append(s.msg),$("#messagesBlock-"+t).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500)),i.syncadmincall()):alert(s.msg)}))},this.copyContent=function(t){var e,i=document.createElement("textarea");i.value=t.attr("data-copy"),i.style.top="0",i.style.left="0",i.style.position="fixed",document.body.appendChild(i),i.focus(),i.select();try{document.execCommand("copy")}catch(t){alert("Oops, unable to copy")}document.body.removeChild(i),t.tooltip({trigger:"click",placement:"top"}),e=t.attr("data-success"),t.tooltip("hide").attr("data-original-title",e).tooltip("show"),setTimeout((function(){t.tooltip("hide")}),1e3)},this.copyMessages=function(t){var e;return $("#chat-copy-messages").select(),document.execCommand("copy"),t.tooltip({trigger:"click",placement:"top"}),e=t.attr("data-success"),t.tooltip("hide").attr("data-original-title",e).tooltip("show"),setTimeout((function(){t.tooltip("hide")}),3e3),!1},this.removeDialogTabGroup=function(t,e){ee.emitEvent("unloadGroupChat",[t]);this.smartTabFocus(e,t)},this.addGroupTab=function(t,e,i,s){if(t.find("#chat-tab-link-"+i).length>0)return t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > li#chat-tab-li-"+i+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content > #chat-id-"+i).addClass("active"),void ee.emitEvent("groupChatTabClicked",[i]);var a='<li role="presentation" id="chat-tab-li-'+i+'" class="nav-item"><a class="nav-link" href="#chat-id-'+i+'" id="chat-tab-link-'+i+'" aria-controls="chat-id-'+i+'" role="tab" data-toggle="tab"><i id="msg-send-status-'+i+'" class="material-icons send-status-icon icon-user-online">send</i><i class="whatshot blink-ani d-none text-warning material-icons">whatshot</i><i id="user-chat-status-'+i+'" class="'+this.tabIconClass+'">group</i><span class="ntab" id="ntab-chat-'+i+'">'+e.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</span><span onclick=\"return lhinst.removeDialogTabGroup('"+i+"',$('#tabs'),true)\" class=\"material-icons icon-close-chat\">close</span></a></li>";t.find("> ul").append(a);window.location.hash.replace("#/","#");!0!==s?(t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+i+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active" id="chat-id-'+i+'"></div>')):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane" id="chat-id-'+i+'"></div>'),ee.emitEvent("groupChatTabLoaded",[i]),$("#chat-tab-link-"+i).click((function(){ee.emitEvent("groupChatTabClicked",[i.replace("gc","")])}))},this.startGroupChat=function(t,e,i,s){this.addGroupTab(e,i,"gc"+t,s)},this.hideShowAction=function(t){var e=$("#messagesBlock-"+t.chat_id),i=e.prop("scrollTop")+e.height()+30>e.prop("scrollHeight"),s=$("#message-more-"+t.id);s.hasClass("hide")?(s.removeClass("hide"),0==t.hide_show?$("#hide-show-action-"+t.id).remove():$("#hide-show-action-"+t.id).text(t.hide_text)):(s.addClass("hide"),1==t.hide_show&&$("#hide-show-action-"+t.id).text(t.show_text)),i&&e.stop(!0,!1).animate({scrollTop:e.prop("scrollHeight")},500)},this.buttonAction=function(t,e){var i=t.closest(".message-row");$.getJSON(this.wwwDir+"chat/abstractclick/"+i.attr("id").replace("msg-","")+"/"+e,(function(t){if(t.error)alert(t.error);else if(t.replace_id&&t.html){var e=$("#messagesBlock-"+t.chat_id),i=e.prop("scrollTop")+e.height()+30>e.prop("scrollHeight");$(t.replace_id).html(t.html),i&&e.stop(!0,!1).animate({scrollTop:e.prop("scrollHeight")},500)}}))},this.startChat=function(t,e,i,s,a){if(this.removeBackgroundChat(t),this.hideNotification(t),0==this.chatUnderSynchronization(t)){var n=void 0===s||s,o=0==this.disableremember?"/(remember)/true":"";this.addTab(e,this.wwwDir+"chat/adminchat/"+t+o,i,t,n,a);var r=this;setTimeout((function(){r.syncadmininterfacestatic()}),1e3)}else e.find("> ul > li > a.active").removeClass("active"),e.find("> ul > li#chat-tab-li-"+t+" > a").addClass("active"),e.find("> div.tab-content > div.active").removeClass("active"),e.find("> div.tab-content > #chat-id-"+t).addClass("active"),window.location.hash="#/chat-id-"+t;ee.emitEvent("chatStartTab",[t])},this.backgroundChats=[],this.startChatBackground=function(t,e,i,s){if(0==this.chatUnderSynchronization(t)){this.backgroundChats.push(parseInt(t));var a=0==this.disableremember?"/(remember)/true":"";return s||(s="background"),this.addTab(e,this.wwwDir+"chat/adminchat/"+t+a+"/(arg)/"+s,i,t,!1),ee.emitEvent("chatStartBackground",[t]),!0}return!1},this.protectCSFR=function(){$("a.csfr-required").click((function(){var t=$(this);t.attr("data-secured")||(t.attr("href",t.attr("href")+"/(csfr)/"+confLH.csrf_token),t.attr("data-secured",1))}))},this.setChatHash=function(t){this.hash=t},this.addSynchroChat=function(t,e){this.chatsSynchronising.push(t),this.chatsSynchronisingMsg.push(t+","+e),LHCCallbacks.addSynchroChat&&LHCCallbacks.addSynchroChat(t,e)},this.removeSynchroChat=function(t){for(var e=0;e<this.chatsSynchronising.length;)this.chatsSynchronising[e]==t?(this.chatsSynchronising.splice(e,1),this.chatsSynchronisingMsg.splice(e,1)):e++;this.forgetChat(t,"achat_id"),ee.emitEvent("removeSynchroChat",[t]),LHCCallbacks.removeSynchroChat&&LHCCallbacks.removeSynchroChat(t)},this.is_typing=!1,this.typing_timeout=null,this.operatorTypingCallback=function(t){var e=this.wwwDir,i=this;0==i.is_typing?(i.is_typing=!0,clearTimeout(i.typing_timeout),1==i.nodeJsMode?(i.typing_timeout=setTimeout((function(){i.typingStoppedOperator(t)}),3e3),ee.emitEvent("operatorTyping",[{chat_id:t,status:!0}])):$.getJSON(e+"chat/operatortyping/"+t+"/true",{},(function(e){i.typing_timeout=setTimeout((function(){i.typingStoppedOperator(t)}),3e3),LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0)})).fail((function(){i.typing_timeout=setTimeout((function(){i.typingStoppedOperator(t)}),3e3)}))):(clearTimeout(i.typing_timeout),i.typing_timeout=setTimeout((function(){i.typingStoppedOperator(t)}),3e3))},this.initTypingMonitoringAdmin=function(t){var e=this;jQuery("#CSChatMessage-"+t).bind("keyup",(function(i){e.operatorTypingCallback(t)}))},this.remarksTimeout=null,this.saveRemarks=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-"+t).addClass("text-warning"),$("#main-user-info-remarks-"+t+" .alert").remove();var e=this;this.remarksTimeout=setTimeout((function(){$.postJSON(e.wwwDir+"chat/saveremarks/"+t,{data:$("#ChatRemarks-"+t).val()},(function(e){"false"==e.error?$("#remarks-status-"+t).removeClass("text-warning"):$("#main-user-info-remarks-"+t).prepend(e.result)}))}),500)},this.saveNotes=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-online-"+t).addClass("text-warning");var e=this;this.remarksTimeout=setTimeout((function(){$.postJSON(e.wwwDir+"chat/saveonlinenotes/"+t,{data:$("#OnlineRemarks-"+t).val()},(function(e){$("#remarks-status-online-"+t).removeClass("text-warning")}))}),500)},this.surveyShowed=!1,this.closeWindow=function(){null!==this.survey&&0==this.surveyShowed?(this.surveyShowed=!0,this.chatClosed()):(window.open("","_self",""),window.close())},this.typingStoppedOperator=function(t){var e=this;1==e.is_typing&&(1==lhinst.nodeJsMode?(e.is_typing=!1,ee.emitEvent("operatorTyping",[{chat_id:t,status:!1}])):$.getJSON(this.wwwDir+"chat/operatortyping/"+t+"/false",{},(function(i){e.is_typing=!1,LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!1)})).fail((function(){e.is_typing=!1})))},this.sendemail=function(){$.postJSON(this.wwwDir+"chat/sendchat/"+this.chat_id+"/"+this.hash,{csfr_token:confLH.csrf_token,email:$('input[name="UserEmail"]').val()},(function(t){"false"==t.error?$("#myModal").modal("hide"):($("#user-action .alert-box").remove(),$("#user-action").prepend(t.result))}))},this.reopenchat=function(t){$.postJSON(this.wwwDir+"chat/reopenchat/"+t.attr("data-id"),(function(e){"true"==e.error?alert(e.result):($("#action-block-row-"+t.attr("data-id")).removeClass("hide"),$("#CSChatMessage-"+t.attr("data-id")).removeAttr("readonly").focus(),$("#chat-status-text-"+t.attr("data-id")).text(e.status),t.remove())}))},this.initTypingMonitoringUser=function(t){var e=this.wwwDir,i=this;try{sessionStorage&&sessionStorage.getItem("lhc_ttxt")&&""!=sessionStorage.getItem("lhc_ttxt")&&jQuery("#CSChatMessage").val(sessionStorage.getItem("lhc_ttxt"))}catch(t){}var s=!1;""!=jQuery("#CSChatMessage").val()?($("#lhc-send-icon").show(),$("#lhc-mic-icon").hide()):$("#lhc-mic-icon").length>0&&($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show(),s=!0),jQuery("#CSChatMessage").bind("keyup",(function(a){if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",$(this).val())}catch(t){}var n=$(this)[0];n.style.height="5px",1==s&&(""!=$(this).val()?($("#lhc-send-icon").show(),$("#lhc-mic-icon").hide(),$("#voice-control-message").hide()):($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show()));var o=n.scrollHeight+3;if(o>48&&(o+=10,n.style.overflowY=o>90?"auto":"hidden"),n.style.height=o+"px",0==i.is_typing)clearTimeout(i.typing_timeout),LHCCallbacks.initTypingMonitoringUserInform?(i.typing_timeout=setTimeout((function(){ee.emitEvent("visitorTypingStopped",[{chat_id:t,hash:i.hash}])}),3e3),ee.emitEvent("visitorTyping",[{chat_id:t,hash:i.hash,status:!0,msg:$(this).val()}])):(i.is_typing=!0,$.postJSON(e+"chat/usertyping/"+t+"/"+i.hash+"/true",{msg:$(this).val()},(function(e){i.typing_timeout=setTimeout((function(){i.typingStoppedUser(t)}),3e3),LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!0])})).fail((function(){i.typing_timeout=setTimeout((function(){i.typingStoppedUser(t)}),3e3)})));else{clearTimeout(i.typing_timeout),i.typing_timeout=setTimeout((function(){i.typingStoppedUser(t)}),3e3);var r=$(this).val();i.currentMessageText!=r&&Math.abs(i.currentMessageText.length-r.length)>6&&(i.currentMessageText=r,LHCCallbacks.initTypingMonitoringUserInform?ee.emitEvent("visitorTyping",[{chat_id:t,hash:i.hash,status:!0,msg:$(this).val()}]):$.postJSON(e+"chat/usertyping/"+t+"/"+i.hash+"/true",{msg:r},(function(e){LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!0])})))}}))},this.typingStoppedUser=function(t){var e=this;1==e.is_typing&&(LHCCallbacks.typingStoppedUserInform?(e.is_typing=!1,ee.emitEvent("visitorTypingStopped",[{chat_id:t,hash:this.hash,status:!1}])):$.getJSON(this.wwwDir+"chat/usertyping/"+t+"/"+this.hash+"/false",{},(function(i){e.is_typing=!1,LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!1])})).fail((function(){e.is_typing=!1})))},this.refreshFootPrint=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/chatfootprint/"+t.attr("rel"),{},(function(e){$("#footprint-"+t.attr("rel")).html(e),t.removeClass("disabled")}))},this.makeAbstractRequest=function(t,e){return $.get(e.attr("href"),(function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedSurvey&&LHCCallbacks.userRedirectedSurvey(t)})),!1},this.refreshOnlineUserInfo=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/refreshonlineinfo/"+t.attr("rel"),{},(function(e){$("#online-user-info-"+t.attr("rel")).html(e),t.removeClass("disabled")}))},this.processCollapse=function(t){if("chevron_right"==$("#chat-main-column-"+t+" .collapse-right").text()){$("#chat-right-column-"+t).hide(),$("#chat-main-column-"+t).removeClass("col-sm-7").addClass("col-sm-12"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_left");try{localStorage&&localStorage.setItem("lhc_rch",1)}catch(t){}}else{$("#chat-right-column-"+t).show(),$("#chat-main-column-"+t).removeClass("col-sm-12").addClass("col-sm-7"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_right");try{localStorage&&localStorage.removeItem("lhc_rch")}catch(t){}}},this.chatUnderSynchronization=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return!0;e++}return!1},this.getChatIndex=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return e;e++}return!1},this.updateUserSyncInterface=function(t,e){try{if("false"==e.error)if("true"!=e.blocked){if("false"!=e.result&&"true"==e.status){var i=$("#messagesBlock"),s=i.prop("scrollHeight"),a=Math.abs(s-i.prop("scrollTop")-i.prop("clientHeight"));s=i.prop("scrollHeight"),i.find(".pending-storage").remove(),i.append(e.result),i.find(".meta-auto-hide").hide(),i.find(".message-row").last().find(".meta-auto-hide").show(),(a<20||1==t.forceBottomScroll)&&(t.forceBottomScroll=!1,i.stop(!0,!1).animate({scrollTop:s+2e3},500)),1==confLH.new_message_sound_user_enabled&&"false"==e.uw&&t.playNewMessageSound(),t.last_message_id>0&&($("#msg-"+t.last_message_id).attr("data-op-id")==e.msop&&$("#msg-"+t.last_message_id+" > .usr-tit").text()===$("#msg-"+e.message_id+" > .usr-tit").text()||$("#msg-"+t.last_message_id).next().addClass("operator-changes")),t.last_message_id=e.message_id,"false"==e.uw&&t.isWidgetMode&&"undefined"!=typeof parent&&parent.postMessage("lhc_newopmsg","*")}else"true"!=e.status&&$("#status-chat").html(e.status);if(t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval),"t"==e.cs&&t.chatsyncuserpending(),""!=e.ott&&"f"!=e.ott){var n=$("#id-operator-typing");n.text(e.ott),n.css("visibility","visible"),t.operatorTyping=!0}else"f"==e.ott&&(t.operatorTyping=!1,$("#id-operator-typing").css("visibility","hidden"));""!=e.op&&t.executeRemoteCommands(e.op)}else $("#status-chat").html(e.status),$("#ChatMessageContainer").remove(),$("#ChatSendButtonContainer").remove(),$("#id-operator-typing").css("visibility","hidden"),t.operatorTyping=!1,void 0!==e.op&&""!=e.op&&t.executeRemoteCommands(e.op),e.closed&&1==e.closed&&(ee.emitEvent("chatClosedSyncUser",[t.chat_id]),t.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed"+(void 0!==e.closed_arg?":"+e.closed_arg:""),"*"):(void 0!==e.closed_arg&&t.parseCloseArgs(e.closed_arg.split(":")),t.chatClosed()))}catch(e){t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}t.syncroRequestSend=!1},this.parseCloseArgs=function(t){var e=t.length/2;for(i=0;i<e;i++){var s=t[2*i],a=t[2*i+1];"survey_id"==s&&(this.survey=a)}},this.chatClosed=function(){if(null!==this.survey){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=1==this.operatorTyping?"/(ot)/t":"",i=null!==this.theme?"/(theme)/"+this.theme:"",s=1==this.isEmbedMode?"/(modeembed)/embed":"",a=1==this.isWidgetMode?"fillwidget":"fill",n=1==this.explicitClose?"/(eclose)/t":"";return document.location.replace(this.wwwDir+"survey/"+a+"/(survey)/"+this.survey+"/(chatid)/"+this.chat_id+"/(hash)/"+this.hash+t+e+i+s+n),!0}return!1},this.executeRemoteCommands=function(operations){var inst=this;$.each(operations,(function(i,item){if(-1!=item.indexOf("lhinst."))eval(item);else if(-1!=item.indexOf("lhc_ui_refresh")){var option=item.split(":")[1];1==option?lhinst.enableFileUpload():lhinst.disableFileUpload()}else inst.isWidgetMode?parent.postMessage(item,"*"):window.opener&&window.opener.postMessage(item,"*")}))},this.disableFileUpload=function(){$("#fileupload").fileupload("destroy"),$("#ChatMessageContainer .dropdown-menu .flex-row .file-uploader").remove()},this.syncusercall=function(){var t=this;if(0==this.syncroRequestSend){clearTimeout(this.userTimeout),this.syncroRequestSend=!0;var e=1==this.isWidgetMode?"/(mode)/widget":"",i=1==this.operatorTyping?"/(ot)/t":"",s=null!==this.theme?"/(theme)/"+this.theme:"",a=1==this.isEmbedMode?"/(modeembed)/embed":"";$.getJSON(this.wwwDir+this.syncuser+this.chat_id+"/"+this.last_message_id+"/"+this.hash+e+i+s+a,{},(function(e){t.updateUserSyncInterface(t,e),LHCCallbacks.syncusercall&&LHCCallbacks.syncusercall(t,e),ee.emitEvent("syncUserCall",[t,e])})).fail((function(){t.syncroRequestSend=!1,t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}))}},this.scheduleSync=function(){this.syncroRequestSend=!1,clearTimeout(this.userTimeout),this.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)},this.closeActiveChatDialog=function(t,e,i){var s=angular.element("body").scope();if(s.syncDisabled(!0),$.postJSON(this.wwwDir+this.closechatadmin+t,(function(t){s.syncDisabled(!1),0==t.error?s.loadChatList():alert(t.result)})).fail((function(t,e,i){s.syncDisabled(!1),console.dir(t)})),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),window.postMessage&&window.opener&&window.opener.postMessage("lhc_ch:chatclosed:"+t,"*"),this.removeSynchroChat(t),1==i){var a=this.smartTabFocus(e,t);setTimeout((function(){window.location.hash=a}),500),1==this.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatClosedCallback&&LHCCallbacks.chatClosedCallback(t)},this.smartTabFocus=function(t,e){var i=t.find("> ul > #chat-tab-li-"+e).index();t.find("> ul > #chat-tab-li-"+e).remove(),t.find("#chat-id-"+e).remove();var s=t.find("> ul > li:eq("+(i-1)+")");if(void 0!==s.attr("id"))var a=s.find("> a");else if(linkTabRight=t.find("> ul > li:eq("+i+")"),linkTabRight.length>0)a=linkTabRight.find("> a");else a=s.find("> a");if(!t.find("> ul > li > a.active").length&&(a.tab("show"),void 0!==a.attr("id"))){var n=a.attr("href").replace("#chat-id-","");this.removeBackgroundChat(n),this.hideNotification(n),ee.emitEvent("chatTabFocused",[n])}return void 0!==a.attr("href")?a.attr("href").replace("#","#/"):"#"},this.startChatCloseTabNewWindow=function(t,e,i){return window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650"),this.smartTabFocus(e,t),1==this.closeWindowOnChatCloseDelete&&window.close(),this.removeSynchroChat(t),this.syncadmininterfacestatic(),!1},this.removeDialogTab=function(t,e,i){if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),this.removeSynchroChat(t),1==i){var s=this.smartTabFocus(e,t);setTimeout((function(){window.location.hash=s}),500),1==this.closeWindowOnChatCloseDelete&&window.close()}this.syncadmininterfacestatic()},this.removeActiveDialogTag=function(t){1==this.closeWindowOnChatCloseDelete&&window.close()},this.deleteChat=function(t,e,i){if(confirm(confLH.transLation.delete_confirm)){var s=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,(function(a){if(1==a.error)alert(a.result);else{if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",(function(){})),$("#CSChatMessage-"+t).unbind("keyup",(function(){}))),s.removeSynchroChat(t),1==i){var n=s.smartTabFocus(e,t);setTimeout((function(){window.location.hash=n}),500),1==s.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatDeletedCallback&&LHCCallbacks.chatDeletedCallback(t),s.syncadmininterfacestatic()}})).fail((function(t,e,i){console.dir(t),alert("getJSON request failed! "+e+":"+i+":"+t.responseText)}))}},this.rejectPendingChat=function(t,e){var i=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,{},(function(t){i.syncadmininterfacestatic()})).fail((function(t,e,i){console.dir(t),alert("getJSON request failed! "+e+":"+i+":"+t.responseText)}))},this.startChatNewWindow=function(t,e){window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus();var i=this;setTimeout((function(){i.syncadmininterfacestatic()}),1e3),ee.emitEvent("chatStartOpenWindow",[t])},this.startChatNewWindowArchive=function(t,e,i){window.open(this.wwwDir+"chatarchive/viewarchivedchat/"+t+"/"+e+"/(mode)/popup","chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650").focus(),ee.emitEvent("chatStartOpenWindowArchive",[t,e])},this.startCoBrowse=function(t){return window.open(this.wwwDir+"cobrowse/browse/"+t,"chatwindow-cobrowse-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus(),!1},this.speechToText=function(t){0==this.speechHandler&&(this.speechHandler=new LHCSpeechToText),this.speechHandler.listen({chat_id:t})},this.startChatTransfer=function(t,e,i,s){var a=this;$.getJSON(this.wwwDir+this.accepttransfer+s,{},(function(s){a.startChat(t,e,i),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)})).fail((function(){a.startChat(t,e,i)}))},this.startChatNewWindowTransfer=function(t,e,i){return $.getJSON(this.wwwDir+this.accepttransfer+i,{},(function(e){LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)})),this.startChatNewWindow(t,e)},this.startChatNewWindowTransferByTransfer=function(t,e){var i=this;return $.ajax({type:"GET",url:this.wwwDir+this.accepttransfer+t+"/(mode)/chat",cache:!1,dataType:"json"}).done((function(t){$("#tabs").length>0?(window.focus(),i.startChat(t.chat_id,$("#tabs"),e)):i.startChatNewWindow(t.chat_id,""),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t.chat_id)})),this.syncadmininterfacestatic(),!1},this.switchLang=function(t,e){var i='<input type="hidden" value="'+e+'" name="switchLang" />';return t.append(i),t.submit(),!1},this.sendLinkToMail=function(t,e){var i=window.parent.$("#MailMessage").val();window.parent.$("#MailMessage").val((""!=i?i+"\n":i)+t),$("#embed-button-"+e).addClass("btn-success")},this.sendLinkToEditor=function(t,e,i){var s=window.parent.$("#CSChatMessage-"+t).val();window.parent.$("#CSChatMessage-"+t).val((""!=s?s+"\n":s)+e),$("#embed-button-"+i).addClass("btn-success")},this.sendLinkToGeneralEditor=function(t,e){var i=window.parent.$(".embed-into"),s=i.val();i.val((""!=s?s+"\n":s)+t),$("#embed-button-"+e).addClass("btn-success")},this.hideTransferModal=function(t){var e=this;setTimeout((function(){$("#myModal").modal("hide"),$("#tabs").length>0&&e.removeDialogTab(t,$("#tabs"),!0)}),1e3)},this.transferChat=function(t){var e=this,i=$("[name=TransferTo"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+i,{type:"user"},(function(i){"false"==i.error&&($("#transfer-block-"+i.chat_id).html(i.result),e.hideTransferModal(t))}))},this.changeOwner=function(t){var e=this,i=$("#id_new_user_id").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+i,{type:"change_owner"},(function(i){"false"==i.error&&($("#transfer-block-"+i.chat_id).html(i.result),e.hideTransferModal(t))}))},this.chooseSurvey=function(t){var e=$("[name=SurveyItem"+t+"]:checked").val();$.postJSON(this.wwwDir+"survey/choosesurvey/"+t+"/"+e,(function(t){"false"==t.error&&$("#survey-block-"+t.chat_id).html(t.result)}))},this.redirectContact=function(t,e){(void 0===e||confirm(e))&&$.postJSON(this.wwwDir+"chat/redirectcontact/"+t,(function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedContact&&LHCCallbacks.userRedirectedContact(t)}))},this.redirectToURL=function(t,e){var i=prompt(e,"");null!=i&&lhinst.addRemoteCommand(t,"lhc_chat_redirect:"+i.replace(new RegExp(":","g"),"__SPLIT__"))},this.redirectToURLOnline=function(t,e){var i=prompt(e,"");null!=i&&(lhinst.addRemoteOnlineCommand(t,"lhc_chat_redirect:"+i.replace(new RegExp(":","g"),"__SPLIT__")),lhinst.addExecutionCommand(t,"lhc_cobrowse_multi_command__lhc_chat_redirect:"+i.replace(new RegExp(":","g"),"__SPLIT__")))},this.transferChatDep=function(t){var e=this,i=$("[name=DepartamentID"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+i,{type:"dep"},(function(i){"false"==i.error&&($("#transfer-block-"+i.chat_id).html(i.result),e.hideTransferModal(t))}))},this.chatTabsOpen=function(){return window.open(this.wwwDir+"chat/chattabs/","chatwindows","menubar=1,resizable=1,width=800,height=650"),!1},this.userclosedchat=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.ajax({type:"GET",url:this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash,cache:!1})},this.userclosedchatembed=function(){window.postMessage&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},this.continueChatFromSurvey=function(t){return this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?$.postJSON(this.wwwDir+"survey/backtochat/"+this.chat_id+"/"+this.hash+"/"+t,(function(t){parent.postMessage("lhc_continue_chat","*")})):this.chatClosed(),!1},this.explicitClose=!1,this.explicitChatCloseByUser=function(){return this.explicitClose=!0,this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close(),!1},this.restoreWidget=function(t){window.postMessage&&window.opener&&(window.opener.postMessage("lhc_ch:hash:"+t,"*"),window.opener.postMessage("lhc_ch:hash_resume:"+t,"*"),window.opener.postMessage("lhc_open_restore","*"),window.close())},this.userclosedchatandbrowser=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.get(this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash+"/(eclose)/t",(function(t){lhinst.closeWindow()}))},this.sendCannedMessage=function(t,e){if($("#id_CannedMessage-"+t).val()>0){e.addClass("secondary");var i=1e3*parseInt($("#id_CannedMessage-"+t).find(":selected").attr("data-delay")),s=this.wwwDir,a=this;if(0==a.is_typing?(a.is_typing=!0,clearTimeout(a.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform&&LHCCallbacks.initTypingMonitoringAdminInform({chat_id:t,status:!0}),$.getJSON(s+"chat/operatortyping/"+t+"/true",{},(function(s){LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0),a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t),e.removeClass("secondary")}),i>3e3?i:3e3)})).fail((function(){a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3)}))):(clearTimeout(a.typing_timeout),a.typing_timeout=setTimeout((function(){a.typingStoppedOperator(t)}),3e3),e.removeClass("secondary")),i>0)setTimeout((function(){var e={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(s+a.addmsgurl+t,e,(function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0}))}),i);else{var n={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(this.wwwDir+this.addmsgurl+t,n,(function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0}))}}return!1},this.voteAction=function(t){var e=this.chat_id;$.postJSON(this.wwwDir+"chat/voteaction/"+this.chat_id+"/"+this.hash+"/"+t.attr("data-id"),{},(function(t){"false"==t.error&&(LHCCallbacks.uservoted&&LHCCallbacks.uservoted(e),0==t.status?($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):1==t.status?($(".up-vote-action").addClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):2==t.status&&($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").addClass("down-voted")))}))},this.theme=null,this.checkChatStatusTimeout=null,this.chatStatus=null,this.chatsyncuserpending=function(){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=null!==this.theme?"/(theme)/"+this.theme:"";clearTimeout(this.checkChatStatusTimeout);var i=this;$.getJSON(this.wwwDir+this.checkchatstatus+this.chat_id+"/"+this.hash+t+e,{},(function(t){ee.emitEvent("checkChatStatus",[i.chat_id,t]),i.chatStatus=t.status,"false"==t.error&&("false"==t.activated?("false"!=t.result&&$("#status-chat").html(t.result),""!=t.ru&&document.location.replace(t.ru),i.checkChatStatusTimeout=setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)):($("#status-chat").html(t.result),t.closed&&1==t.closed&&(ee.emitEvent("chatClosedCheckStatus",[i.chat_id]),i.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed","*"):i.chatClosed())))})).fail((function(){setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)}))},this.setTheme=function(t){this.theme=t},this.survey=null,this.setSurvey=function(t){this.survey=t},this.isBlinking=!1,this.startBlinking=function(){if(0==this.isBlinking){var t=this;(i=document.title,s="!!! "+document.title,a=function(){document.title=document.title==s?" ":s},n=function(){clearInterval(e),document.title=i,window.onmousemove=null,e=null,t.isBlinking=!1},function(){e||(e=setInterval(a,1e3),window.onmousemove=n)})(),this.isBlinking=!0}var e,i,s,a,n},this.playNewMessageSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_message.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_message.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_message.wav",this.audio.load()),$("textarea[name=ChatMessage]").is(":focus")||this.startBlinking()},this.playInvitationSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/invitation.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/invitation.mp3":WWW_DIR_JAVASCRIPT_FILES+"/invitation.wav",this.audio.load())},this.playPreloadSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/silence.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/silence.mp3":WWW_DIR_JAVASCRIPT_FILES+"/silence.wav",this.audio.load())},this.loadPreviousMessages=function(t){$.getJSON(this.wwwDir+"chat/loadpreviousmessages/"+t.attr("chat-id")+"/"+t.attr("message-id")+"/(initial)/"+t.attr("data-initial"),(function(e){if(0==e.error){t.attr("data-initial",0);var i=$("#messagesBlock-"+t.attr("chat-original-id"));i.prepend(e.result),1==t.attr("auto-scroll")&&(t.attr("auto-scroll",0),i.stop(!0,!1).animate({scrollTop:i.prop("scrollHeight")},500)),1==e.has_messages?(t.attr("message-id",e.message_id),t.attr("chat-id",e.chat_id)):t.remove()}}))},this.hidenicknamesstatus=null,this.syncadmincall=function(){this.chatsSynchronising.length>0?0==this.underMessageAdd&&0==this.syncroRequestSend?(this.syncroRequestSend=!0,$.postJSON(this.wwwDir+this.syncadmin,{"chats[]":this.chatsSynchronisingMsg},(function(data){void 0!==data.error_url&&document.location.replace(data.error_url);try{if("false"==data.error){if("false"!=data.result){var playSound=!1;$.each(data.result,(function(t,e){var i=$("#messagesBlock-"+e.chat_id),s=i.prop("scrollHeight"),a=Math.abs(s-i.prop("scrollTop")-i.prop("clientHeight"));i.find(".pending-storage").slice(0,e.mn).remove(),i.append(e.content),i.find(".pending-storage").appendTo(i),lhinst.addQuateHandler(e.chat_id),a<20&&i.stop(!0,!1).animate({scrollTop:s},500),lhinst.updateChatLastMessageID(e.chat_id,e.message_id);var n=$("#chat-tab-link-"+e.chat_id);if(!n.hasClass("active"))if(n.find("span.msg-nm").length>0){var o=parseInt(n.find("span.msg-nm").attr("rel"))+e.mn;n.find("span.msg-nm").html(" ("+o+")").attr("rel",o)}else n.append('<span rel="'+e.mn+'" class="msg-nm"> ('+e.mn+")</span>"),n.addClass("has-pm");0!=playSound||"false"!=data.uw||void 0!==e.ignore&&!1!==typeof e.ignore||(playSound=!0),1!=confLH.new_message_browser_notification||"false"!=data.uw||void 0!==e.ignore&&!1!==typeof e.ignore||lhinst.showNewMessageNotification(e.chat_id,e.msg,e.nck),e.msfrom>0&&$("#msg-"+e.msfrom).attr("data-op-id")!=e.msop&&$("#msg-"+e.msfrom).next().addClass("operator-changes"),ee.emitEvent("eventSyncAdmin",[e,t])})),1==confLH.new_message_sound_admin_enabled&&"false"==data.uw&&1==playSound&&lhinst.playNewMessageSound()}if("false"!=data.result_status){var groupTabs=$("#group-chats-status").hasClass("chat-active");$.each(data.result_status,(function(i,item){"true"==item.tp?$("#user-is-typing-"+item.chat_id).html(item.tx).css("visibility","visible"):0==lhinst.nodeJsMode&&$("#user-is-typing-"+item.chat_id).css("visibility","hidden"),$("#last-msg-chat-"+item.chat_id).text(item.lmsg);var userChatStatus=$("#user-chat-status-"+item.chat_id),wasOnline=userChatStatus.hasClass("icon-user-online");$("#chat-duration-"+item.chat_id).text(item.cdur),userChatStatus.removeClass("icon-user-online icon-user-away icon-user-pageview"),$("#msg-send-status-"+item.chat_id).removeClass("icon-user-online icon-user-offline"),0==item.us?userChatStatus.addClass("icon-user-online"):2==item.us?userChatStatus.addClass("icon-user-away"):3==item.us&&userChatStatus.addClass("icon-user-pageview"),1==groupTabs?1==wasOnline&&0!=item.us||lhinst.hidenicknamesstatus!=groupTabs&&0!=item.us?$("#ntab-chat-"+item.chat_id).hide():(0==wasOnline&&0==item.us||lhinst.hidenicknamesstatus!=groupTabs&&0==item.us)&&$("#ntab-chat-"+item.chat_id).show():lhinst.hidenicknamesstatus!=groupTabs&&$("#ntab-chat-"+item.chat_id).show();var statusel=$("#chat-id-"+item.chat_id+"-mds");statusel.attr("data-chat-status")==item.cs&&statusel.attr("data-chat-user")==item.co||lhinst.updateVoteStatus(item.chat_id),1==item.um?(statusel.removeClass("chat-active"),statusel.addClass("chat-unread"),$("#msg-send-status-"+item.chat_id).addClass("icon-user-offline")):($("#msg-send-status-"+item.chat_id).addClass("icon-user-online"),statusel.removeClass("chat-unread"),statusel.addClass("chat-active")),!1!==item.lp?statusel.attr("title",item.lp+" s."):statusel.attr("title",""),void 0!==item.oad&&eval(item.oad)}))}data.cg&&$.each(data.cg,(function(t,e){return lhinst.removeDialogTab(e,$("#tabs"),!0)})),lhinst.hidenicknamesstatus=groupTabs,clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}}catch(t){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}lhinst.setSynchronizationRequestSend(!1),LHCCallbacks.syncadmincall&&LHCCallbacks.syncadmincall(lhinst,data)})).fail((function(){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),lhinst.setSynchronizationRequestSend(!1)}))):(clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)):this.isSinchronizing=!1},this.updateVoteStatus=function(t){$.getJSON(this.wwwDir+"chat/updatechatstatus/"+t,{},(function(e){$("#main-user-info-tab-"+t).html(e.result),$("#messagesBlock-"+t+" span.vis-tit").each((function(t){var i=$(this).children();$(this).text(" "+e.nick).prepend(i)})),$("#ntab-chat-"+t).text(e.nick),ee.emitEvent("chatTabInfoReload",[t])}))},this.updateChatLastMessageID=function(t,e){this.chatsSynchronisingMsg[this.getChatIndex(t)]=t+","+e},this.requestNotificationPermission=function(){window.webkitNotifications?window.webkitNotifications.requestPermission():window.Notification?Notification.requestPermission((function(t){})):alert("Notification API in your browser is not supported.")},this.playNewChatAudio=function(){if(clearTimeout(this.soundIsPlaying),this.soundPlayedTimes++,Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_chat.wav",this.audio.load(),confLH.repeat_sound>this.soundPlayedTimes)){var t=this;this.soundIsPlaying=setTimeout((function(){t.playNewChatAudio()}),1e3*confLH.repeat_sound_delay)}},this.focusChanged=function(t){if(1==confLH.new_message_browser_notification&&1==t&&(window.webkitNotifications||window.Notification)){var e=this;$.each(this.chatsSynchronising,(function(t,i){void 0!==e.notificationsArrayMessages[i]&&(window.webkitNotifications?e.notificationsArrayMessages[i].cancel():e.notificationsArrayMessages[i].close(),delete e.notificationsArrayMessages[i])}))}parseInt(this.chat_id)>0&&this.scheduleSync()},this.notificationsArrayMessages=[],this.showNewMessageNotification=function(t,e,i){try{if(window.Notification&&0==focused&&"granted"==window.Notification.permission){void 0!==this.notificationsArrayMessages[t]&&(this.notificationsArrayMessages[t].close(),delete this.notificationsArrayMessages[t]);var s=new Notification(i,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:e}),a=this;s.onclick=function(){window.focus(),s.close(),delete a.notificationsArrayMessages[t]},s.onclose=function(){void 0!==a.notificationsArrayMessages[t]&&delete a.notificationsArrayMessages[t]},this.notificationsArrayMessages[t]=s,this.scheduleNewMessageClose(s,t)}}catch(t){console.log(t)}},this.scheduleNewMessageClose=function(t,e){var i=this;setTimeout((function(){window.webkitNotifications?t.cancel():t.close(),void 0!==i.notificationsArrayMessages[e]&&delete i.notificationsArrayMessages[e]}),1e4)},this.playSoundNewAction=function(t,e,i,s,a){if(-1==this.backgroundChats.indexOf(parseInt(e))){1!=confLH.new_chat_sound_enabled||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"bot_chats"!=t&&"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||(this.soundPlayedTimes=0,this.playNewChatAudio()),$("textarea[name=ChatMessage]").is(":focus")||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"bot_chats"!=t&&"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||this.startBlinking();var n=this;if(("pending_chat"==t||"transfer_chat"==t||"unread_chat"==t||"bot_chats"==t||"pending_transfered"==t)&&(1==confLH.sn_off||"flash_on"==$("#online-offline-user").text())&&window.Notification&&"granted"==window.Notification.permission){var o=new Notification(i,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:s,requireInteraction:!0});o.onclick=function(){"pending_chat"==t||"unread_chat"==t||"pending_transfered"==t||"bot_chats"==t?$("#tabs").length>0?(window.focus(),n.startChat(e,$("#tabs"),a)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,a),o.close()},"pending_transfered"!=t&&("undefined"!==this.notificationsArray[e]&&o.close(),this.notificationsArray[e]=o)}"transfer_chat"==t&&1==confLH.show_alert_transfer&&confirm(confLH.transLation.transfered+"\n\n"+s)&&n.startChatNewWindowTransferByTransfer(e,a),1==confLH.show_alert&&confirm(confLH.transLation.new_chat+"\n\n"+s)&&("pending_chat"==t||"unread_chat"==t||"pending_transfered"==t||"bot_chats"==t?$("#tabs").length>0?(window.focus(),n.startChat(e,$("#tabs"),a)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,a))}},this.syncadmininterfacestatic=function(){try{angular.element("body").scope().loadChatList()}catch(t){}},this.addingUserMessage=!1,this.addUserMessageQueue=[],this.addDelayedTimeout=null,this.addmsgadmin=function(t,e){var i=$("#CSChatMessage-"+t);if(!i.is("[readonly]")){var s={msg:e||i.val()};if(""!=s.msg){!1!==this.speechHandler&&this.speechHandler.messageSend(),e||i.val("");var a=i.attr("placeholder");if(i.attr("placeholder",confLH.transLation.sending||"Sending..."),i.hasClass("edit-mode"))s.msgid=i.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsg/"+t,s,(function(e){if(i.attr("placeholder",a),"f"==e.error)return i.removeClass("edit-mode"),i.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(e.msg),LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),!0}));else{var n=this,o=$("#messagesBlock-"+t);e||o.append('<div class="message-row message-admin pending-storage"><div class="msg-body"><span class="material-icons lhc-spin">autorenew</span>'+$("<div>").text(s.msg).html()+"</div></div>"),o.stop(!0,!1).animate({scrollTop:o.prop("scrollHeight")},500),0==this.addingUserMessage?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurl+t,s,(function(e){if(i.removeAttr("readonly").attr("placeholder",a),"false"==e.error)LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),""!=e.r&&($("#messagesBlock-"+t).append(e.r),$("#messagesBlock-"+t).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500)),!0===e.hold_removed?$("#hold-action-"+t).removeClass("btn-outline-info"):!0===e.hold_added&&$("#hold-action-"+t).addClass("btn-outline-info"),lhinst.syncadmincall();else{i.attr("placeholder",a).val(i.val()+" "+s.msg),$(".pending-storage").first().remove();var o='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text(e.r).html()+"</div>";$("#messagesBlock-"+t).append(o),$("#messagesBlock-"+t).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500)}if(n.addingUserMessage=!1,n.addUserMessageQueue.length>0){var r=n.addUserMessageQueue.shift();n.addmsgadmin(r.chat_id,r.msg)}return!0})).fail((function(e){i.attr("placeholder",a).val(i.val()+" "+s.msg);var o='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("You have weak internet connection or the server has problems. Try to refresh the page or send the message again."+(void 0!==e.status?" Error code ["+e.status+"]":"")+(void 0!==e.responseText?e.responseText:"")).html()+"</div>";if($("#messagesBlock-"+t).append(o),$("#messagesBlock-"+t).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500),$(".pending-storage").first().remove(),n.addingUserMessage=!1,n.addUserMessageQueue.length>0){var r=n.addUserMessageQueue.shift();n.addmsgadmin(r.chat_id,r.msg)}}))):(i.attr("placeholder",a),this.addUserMessageQueue.push({chat_id:t,msg:s.msg}))}}}},this.editPrevious=function(t){var e=$("#CSChatMessage-"+t);""==e.val()&&$.getJSON(this.wwwDir+"chat/editprevious/"+t,(function(i){"f"==i.error&&(e.val(i.msg),e.attr("data-msgid",i.id),e.addClass("edit-mode"),$("#msg-"+i.id).addClass("edit-mode"),LHCCallbacks.editPrevious&&LHCCallbacks.editPrevious(t,i))}))},this.editPreviousUser=function(){var t=$("#CSChatMessage");""==t.val()&&$.getJSON(this.wwwDir+"chat/editprevioususer/"+this.chat_id+"/"+this.hash,(function(e){"f"==e.error&&(t.val(e.msg),t.attr("data-msgid",e.id),t.addClass("edit-mode"),$("#msg-"+e.id).addClass("edit-mode"),LHCCallbacks.editPreviousUser&&LHCCallbacks.editPreviousUser(e))}))},this.afterAdminChatInit=function(t){LHCCallbacks.afterAdminChatInit&&LHCCallbacks.afterAdminChatInit(t)},this.afterUserChatInit=function(){LHCCallbacks.afterUserChatInit&&LHCCallbacks.afterUserChatInit()},this.afterChatWidgetInit=function(){LHCCallbacks.afterChatWidgetInit&&LHCCallbacks.afterChatWidgetInit()},this.getInputSelection=function(t){return void 0!==t?(s=t[0].selectionStart,e=t[0].selectionEnd,t.val().substring(s,e)):""},this.handleBBCode=function(t){var e=$(t.attr("data-selector")).val(),i=this.getInputSelection($(t.attr("data-selector"))),s=void 0!==t.attr("data-bbcode-end")?t.attr("data-bbcode-end"):t.attr("data-bbcode");return i.length>0?$(t.attr("data-selector")).val(e.replace(i,"["+t.attr("data-bbcode")+"]"+i+"[/"+s+"]")):$(t.attr("data-selector")).val(e+"["+t.attr("data-bbcode")+"][/"+s+"]"),!1},this.addAdminChatFinished=function(t,e,i){var s=this,a=jQuery("#CSChatMessage-"+t);new LHCCannedMessageAutoSuggest({chat_id:t,uppercase_enabled:confLH.auto_uppercase});if(null!==document.getElementById("color-picker-chat-"+t)){var n=new ColorPicker({dom:document.getElementById("color-picker-chat-"+t),value:"#0F0"});n.addEventListener("change",(function(e){$("#color-apply-"+t).attr("data-bbcode","color="+n.getValue("hex"))})),$(".downdown-menu-color-"+t).on("click",(function(t){if($(this).parent().is(".show")){var e=$(t.target);return!e.hasClass("keepopen")&&!e.parents(".keepopen").length}})),$(".downdown-menu-color-"+t+" .color-item").on("click",(function(){n.setValue($(this).attr("data-color"))}))}a.bind("keydown","return",(function(e){return s.addmsgadmin(t),ee.emitEvent("afterAdminMessageSent",[t]),a[0].rows=2,!1})),a.bind("keyup","up",(function(e){s.editPrevious(t)})),a.bind("keyup",(function(t){var e=a[0];for(e.clientHeight,e.rows;e.scrollHeight>e.clientHeight&&!window.opera&&e.rows<30;)e.style.overflow="hidden",e.rows+=1;e.scrollHeight>e.clientHeight&&(e.style.overflow="auto")})),$messageBlock=$("#messagesBlock-"+t),$messageBlock.css("height",this.getLocalValue("lhc_mheight",confLH.defaultm_hegiht)),$messageBlock.data("resized",!1),$messageBlock.data("y",$messageBlock.outerHeight()),$messageBlock.bind("mouseup mousemove",(function(t){var e=jQuery(this);e.outerHeight()!=e.data("y")&&(0==e.data("resized")&&(e.css("height","1px"),e.data("resized",!0)),this.resize_timeout&&clearTimeout(this.resize_timeout),this.resize_timeout=setTimeout((function(){s.setLocalValue("lhc_mheight",e.outerHeight()),e.data("y",e.outerHeight())}),100))})),this.initTypingMonitoringAdmin(t),this.afterAdminChatInit(t),this.addSynchroChat(t,e),$messageBlock.prop("scrollTop",$messageBlock.prop("scrollHeight")),this.startSyncAdmin(),null===i||"object"!=typeof i||-1===i.indexOf("background")?this.hideNotification(t):$("#chat-tab-link-"+t).click((function(){s.removeBackgroundChat(parseInt(t)),s.hideNotification(parseInt(t))}));try{localStorage&&1==localStorage.getItem("lhc_rch")&&this.processCollapse(t)}catch(t){}$("#chat-tab-items-"+t+" > li > a").click((function(){ee.emitEvent("adminChatTabSubtabClicked",[t,$(this)])})),$("#chat-write-button-"+t).click((function(){$("#CSChatMessage-"+t).show().focus(),$(this).removeClass("btn-outline-secondary").addClass("btn-outline-primary"),$("#chat-preview-button-"+t).removeClass("btn-outline-primary").addClass("btn-outline-secondary"),$("#chat-preview-container-"+t).hide()})),$("#chat-preview-button-"+t).click((function(){$("#chat-preview-container-"+t).html("...").show(),$("#CSChatMessage-"+t).hide(),$(this).removeClass("btn-outline-secondary").addClass("btn-outline-primary"),$("#chat-write-button-"+t).removeClass("btn-outline-primary").addClass("btn-outline-secondary"),jQuery.post(WWW_DIR_JAVASCRIPT+"chat/previewmessage",{msg_body:!0,msg:$("#CSChatMessage-"+t).val()},(function(e){$("#chat-preview-container-"+t).html(e)}))})),ee.emitEvent("adminChatLoaded",[t,e,i])},this.removeBackgroundChat=function(t){var e=this.backgroundChats.indexOf(parseInt(t));-1!==e&&delete this.backgroundChats[e]},this.getLocalValue=function(t,e){try{if(localStorage){var i=localStorage.getItem(t);return null!==i?i:e}}catch(t){}return e},this.executeExtension=function(t,e){if(null===document.getElementById("ext-"+t)){var i=document.getElementsByTagName("head")[0],s=document.createElement("script"),a=new Date;s.setAttribute("type","text/javascript"),s.setAttribute("src",WWW_DIR_LHC_WEBPACK_ADMIN.replace("/design/defaulttheme/js/admin/dist/","")+"/extension/"+t+"/design/"+t+"theme/js/"+t+".legacy.js?v="+a.getFullYear()+a.getMonth()+a.getDate()),s.setAttribute("id","ext-"+t),i.appendChild(s),s.onreadystatechange=s.onload=function(){ee.emitEvent(t+".init",[e])}}else ee.emitEvent(t+".init",[e])},this.setLocalValue=function(t,e){try{localStorage&&localStorage.setItem(t,e)}catch(t){}},this.hideNotification=function(t){t=parseInt(t),void 0!==this.notificationsArray[t]&&-1==this.backgroundChats.indexOf(t)&&(this.notificationsArray[t].close(),delete this.notificationsArray[t]),clearTimeout(this.soundIsPlaying)},this.showMyPermissions=function(t){$.get(this.wwwDir+"permission/getpermissionsummary/"+t,(function(t){$("#permissions-summary").html(t)}))},this.addmsguserchatbox=function(t){var e=!1,i={msg:$("#CSChatMessage").val(),nick:$("#CSChatNick").val()},s=1==this.isWidgetMode?"/(mode)/widget":"";$("#CSChatMessage").val("");var a=this;$.postJSON(this.wwwDir+this.addmsgurluserchatbox+this.chat_id+"/"+this.hash+s+this.appendSyncArgument,i,(function(t){"f"==t.error?(LHCCallbacks.addmsguserchatbox&&LHCCallbacks.addmsguserchatbox(a,{chat_id:a.chat_id,data:t}),a.syncusercall()):alert(t.or)})),e!=$("#CSChatNick").val()&&window.postMessage&&parent&&(parent.postMessage("lhc_chb:nick:"+$("#CSChatNick").val(),"*"),e=$("#CSChatNick").val())},this.updateMessageRow=function(t){var e=1==this.isWidgetMode?"/(mode)/widget":"";$.getJSON(this.wwwDir+"chat/getmessage/"+this.chat_id+"/"+this.hash+"/"+t+e,(function(e){"f"==e.error&&($("#msg-"+t).replaceWith(e.msg),$("#msg-"+t).addClass("bg-success"),setTimeout((function(){$("#msg-"+t).removeClass("bg-success")}),2e3))}))},this.updateMessageRowAdmin=function(t,e){$.getJSON(this.wwwDir+"chat/getmessageadmin/"+t+"/"+e,(function(i){if("f"==i.error){var s=$("#messagesBlock-"+t),a=s.prop("scrollTop")+s.height()+30>s.prop("scrollHeight");$("#msg-"+e).replaceWith(i.msg),lhinst.addQuateHandler(t),$("#msg-"+e).addClass("bg-success"),setTimeout((function(){$("#msg-"+e).removeClass("bg-success")}),2e3),a&&s.stop(!0,!1).animate({scrollTop:s.prop("scrollHeight")},500)}}))},this.addmsguser=function(t){LHCCallbacks.addmsguserbefore&&LHCCallbacks.addmsguserbefore(this);var e=$("#CSChatMessage"),i={msg:e.val()},s=1==this.isWidgetMode?"/(mode)/widget":"";e.val("");var a=this;if($("#lhc-mic-icon").length>0&&($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show(),$("#voice-control-message").hide()),sessionStorage)try{sessionStorage.setItem("lhc_ttxt","")}catch(t){}if(e.hasClass("edit-mode"))i.msgid=e.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsguser/"+this.chat_id+"/"+this.hash+s,i,(function(t){if("f"==t.error)return e.removeClass("edit-mode"),e.removeAttr("data-msgid"),$("#msg-"+i.msgid).replaceWith(t.msg),!0}));else{var n=$("#messagesBlock");n.append('<div class="message-row response pending-storage"><div class="msg-body">'+$("<div>").text(i.msg).html()+"</div></div>"),n.stop(!0,!1).animate({scrollTop:n.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+s,i,(function(t){if("f"==t.error)LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(a,t),a.syncusercall();else{$(".pending-storage").remove(),$("#CSChatMessage").val(i.msg);var e=$("#id-operator-typing");e.html(t.r),e.css("visibility","visible"),setTimeout((function(){0==a.operatorTyping&&$("#id-operator-typing").css("visibility","hidden")}),3e3)}a.addingUserMessage=!1}))):(this.addUserMessageQueue.push({retries:0,pdata:i,url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+s}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout((function(){a.addDelayedMessage()}),50))}},this.addMessagesToStore=function(t){for(var e=1==this.isWidgetMode?"/(mode)/widget":"",i=t.length,s=0;s<i;s++)this.addUserMessageQueue.push({retries:0,pdata:{msg:t[s]},url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+e});this.addDelayedMessage()},this.addDelayedMessage=function(){var t=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var e=this.addUserMessageQueue.shift();this.addingUserMessage=!0;var i=[];i.push(e.pdata.msg);for(var s=this.addUserMessageQueue.length,a=0;a<s;a++)i.push(this.addUserMessageQueue[a].pdata.msg);this.addUserMessageQueue=[],$.postJSON(e.url,{msg:i.join("[[msgitm]]")},(function(e){"f"==e.error&&(LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(t,e),t.syncusercall()),t.addingUserMessage=!1,t.addUserMessageQueue.length>0&&(clearTimeout(t.addDelayedTimeout),t.addDelayedMessage())}))}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout((function(){t.addDelayedMessage()}),50)},this.startSyncAdmin=function(){0==this.isSinchronizing&&(this.isSinchronizing=!0,this.syncadmincall())},this.disableChatSoundAdmin=function(t){return"I"!=t.prop("tagName")&&(t=t.find("> i.material-icons")),"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_admin_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_admin_enabled=0,t.text("volume_off")),!1},this.disableNewChatSoundAdmin=function(t){return"I"!=t.prop("tagName")&&(t=t.find("> i.material-icons")),"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/1"),confLH.new_chat_sound_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/0"),confLH.new_chat_sound_enabled=0,t.text("volume_off")),!1},this.changeUserSettings=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+e)},this.changeUserSettingsIndifferent=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+encodeURIComponent(e)+"/(indifferent)/true")},this.switchToOfflineForm=function(){var t=$("#form-start-chat");return t.attr("action",$("#form-start-chat").attr("action")+"/(switchform)/true/(offline)/true/(leaveamessage)/true/(department)/"+$("#id_DepartamentID").val()),t.submit(),!1},this.changeStatusAction=function(t,e){var i=this;return $.postJSON(t.attr("action"),t.serialize(),(function(t){"false"==t.error?($("#myModal").modal("hide"),i.updateVoteStatus(e),!0===t.is_owner&&($("#CSChatMessage-"+e).attr("placeholder",""),$("#CSChatMessage-"+e).focus())):alert(t.result)})),!1},this.submitModalForm=function(t){return $.post(t.attr("action"),t.serialize(),(function(t){$("#myModal").html(t)})),!1},this.disableChatSoundUser=function(t){return"volume_off"==t.find("> i").text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_user_enabled=1,t.find("> i").text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_user_enabled=0,t.find("> i").text("volume_off")),window.postMessage&&parent&&("volume_off"==t.find("> i").text()?parent.postMessage("lhc_ch:s:0","*"):parent.postMessage("lhc_ch:s:1","*")),!1},this.pendingMessagesToStore=[],this.prestartChat=function(t,e){if(0==e.find(".form-protected").length){if(1!=e.attr("lhc-captcha-submitted"))e.attr("lhc-captcha-submitted",1),e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,(function(i){e.append('<input type="hidden" value="'+t+'" name="captcha_'+i.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()})),1==(i=1==e.attr("key-up-started"))&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val(""));else $("#messagesBlock").length>0&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1}if(1==e.find("#hasFormExtraField").length)return!0;if(1!=e.attr("lhc-form-submitted")){e.attr("lhc-form-submitted",1);var i,s=this;1==(i=1==e.attr("key-up-started"))&&e.append('<input type="hidden" value="1" name="keyUpStarted" />'),$.post(e.attr("action"),e.serialize(),(function(t){var e=$("#id_Question").val();if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",e)}catch(t){}$("head > script");var i=$("head"),a=[];$("head > script").each((function(){var t=$(this);void 0!==t.attr("src")&&a.push(t.attr("src"))})),$("<div>").html(t).find("> script").each((function(){var t=$(this);void 0===t.attr("src")?i.append(t):-1==a.indexOf(t.attr("src"))&&i.append('<script src="'+t.attr("src")+'"><\/script>')})),paramsDocument="<script>lhinst.addMessagesToStore("+JSON.stringify(s.pendingMessagesToStore)+")<\/script>",$("#widget-layout").html($("<div>").html(t).find("#widget-layout").html()),$("#widget-layout-js").html($("<div>").html(t).find("#widget-layout-js").html()+paramsDocument)})),0==i&&$("#id_Question").val("")}else $("#messagesBlock").length>0&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1},this.addCaptcha=function(t,e){return 0!=e.find(".form-protected").length||(e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,(function(i){e.append('<input type="hidden" value="'+t+'" name="captcha_'+i.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()})),!1)},this.setSubject=function(t,e){$("#subject-message-"+e).text("..."),$.postJSON(this.wwwDir+"chat/subject/"+e+"/(subject)/"+t.val()+"/(status)/"+t.is(":checked"),{update:!0},(function(t){lhinst.updateVoteStatus(e),$("#subject-message-"+e).text(t.message)}))},this.addCaptchaSubmit=function(t,e){return 0==e.find(".form-protected").length&&(e.find('input[type="submit"]').attr("disabled","disabled"),e.find("#ChatSendButtonContainer").remove(),e.find("#id_Question").attr("readonly","readonly"),"undefined"!=typeof formSubmitted&&(formSubmitted=!0),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,(function(i){if(e.append('<input type="hidden" value="'+t+'" name="captcha_'+i.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),window.FormData)try{var s=new FormData(e[0]),a=new XMLHttpRequest;a.addEventListener("readystatechange",(function(t){var e,i;try{i=t.target.readyState,t.target.responseText,e=t.target.status}catch(t){return}4==i&&"200"==e&&t.target.responseText&&(-1==a.getResponseHeader("Content-Type").indexOf("application/json")?$("#widget-content-body").html(t.target.responseText):location.replace(jQuery.parseJSON(t.target.responseText).location))}),!1);var n=e.attr("action");""!=n?a.open("POST",n+"/(ajaxmode)/true",!0):a.open("POST",document.location+"&ajaxmode=true",!0),a.send(s)}catch(t){return!1}else e.submit()})),!1)},this.deleteChatfile=function(t){$.postJSON(this.wwwDir+"file/deletechatfile/"+t,(function(e){"false"==e.error?$("#file-id-"+t).remove():alert(e.result)}))},this.chooseFile=function(){document.getElementById("fileupload")&&document.getElementById("fileupload").click()},this.enableFileUpload=function(){$.getJSON(this.wwwDir+"file/fileoptions/"+this.chat_id+"/"+this.hash,(function(t){$("#ChatMessageContainer .dropdown-menu .flex-row").prepend(t.html),t.options.ft_us=new RegExp("(.|/)("+t.options.ft_us+")$","i"),lhinst.addFileUserUpload(t.options)}))},this.addFileUserUpload=function(t){$("#fileupload").fileupload({url:this.wwwDir+"file/uploadfile/"+t.chat_id+"/"+t.hash,dataType:"json",add:function(e,i){var s=[],a=t.ft_us;a.test(i.originalFiles[0].type)||a.test(i.originalFiles[0].name)||s.push(t.ft_msg),i.originalFiles[0].size>t.fs&&s.push(t.fs_msg),s.length>0?alert(s.join("\n")):i.submit()},done:function(e,i){var s=i.response();null!=s&&null!=s.result&&"true"==s.result.error&&null!=s.result.error_msg&&alert(s.result.error_msg),LHCCallbacks.addFileUserUpload&&LHCCallbacks.addFileUserUpload(t.chat_id)},progressall:function(t,e){var i=parseInt(e.loaded/e.total*100,10);$("#id-operator-typing").css("visibility","visible"),$("#id-operator-typing").html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUserUploadOnline=function(t,e){var i=this;$("#fileuploadonline").fileupload({url:this.wwwDir+"file/uploadfileonline/"+t.online_user_vid,dataType:"json",add:function(e,i){var s=[],a=t.ft_us;a.test(i.originalFiles[0].type)||a.test(i.originalFiles[0].name)||s.push(t.ft_msg),i.originalFiles[0].size>t.fs&&s.push(t.fs_msg),s.length>0?alert(s.join("\n")):i.submit()},done:function(s,a){i.updateOnlineFilesUser(t.online_user_vid),e&&e(t.online_user_vid)},progressall:function(t,e){var i=parseInt(e.loaded/e.total*100,10);$("#upload-status-user-online").html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.updateChatFiles=function(t){$.postJSON(this.wwwDir+"file/chatfileslist/"+t,(function(e){$("#chat-files-list-"+t).html(e.result)}))},this.updateOnlineFiles=function(t){$.postJSON(this.wwwDir+"file/onlinefileslist/"+t,(function(e){$("#online-user-files-list-"+t).html(e.result)}))},this.updateOnlineFilesUser=function(t){$.postJSON(this.wwwDir+"file/useronlinefileslist/"+t,(function(t){$("#user-online-files-list").html(t.result)}))},this.addFileUpload=function(t){$("#fileupload-"+t.chat_id).fileupload({url:this.wwwDir+"file/uploadfileadmin/"+t.chat_id,dataType:"json",add:function(e,i){var s=[],a=t.ft_op;a.test(i.originalFiles[0].type)||a.test(i.originalFiles[0].name)||s.push(t.ft_msg),i.originalFiles[0].size>t.fs&&s.push(t.fs_msg),s.length>0?alert(s.join("\n")):i.submit()},done:function(e,i){var s=i.response();if(null!=s&&null!=s.result&&"true"==s.result.error&&null!=s.result.error_msg)alert(s.result.error_msg);else{lhinst.updateChatFiles(t.chat_id);var a=$("#CSChatMessage-"+t.chat_id),n=jQuery.trim(a.val());a.val(n+(""!=n?"\n":"")+s.result.msg+"\n")}LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(t.chat_id)},dropZone:$("#drop-zone-"+t.chat_id),pasteZone:$("#CSChatMessage-"+t.chat_id),progressall:function(e,i){var s=parseInt(i.loaded/i.total*100,10);$("#user-is-typing-"+t.chat_id).css("visibility","visible"),$("#user-is-typing-"+t.chat_id).html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUploadOnlineUser=function(t,e){var i=this;$("#fileupload-online-user-"+t.online_user_id).fileupload({url:this.wwwDir+"file/uploadfileadminonlineuser/"+t.online_user_id,dataType:"json",add:function(e,i){var s=[],a=t.ft_op;a.test(i.originalFiles[0].type)||a.test(i.originalFiles[0].name)||s.push(t.ft_msg),i.originalFiles[0].size>t.fs&&s.push(t.fs_msg),s.length>0?alert(s.join("\n")):i.submit()},done:function(s,a){e&&e(t.online_user_id),i.updateOnlineFiles(t.online_user_id)},dropZone:$("#drop-zone-online-user-"+t.online_user_id),progressall:function(e,i){var s=parseInt(i.loaded/i.total*100,10);$("#upload-status-admin-"+t.online_user_id).html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addExecutionCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addonlineoperation/"+t,{operation:e},(function(e){LHCCallbacks.addExecutionCommand&&LHCCallbacks.addExecutionCommand(t)})),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var i=this;setTimeout((function(){i.updateScreenshotOnline(t)}),15e3)}},this.addRemoteCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addoperation/"+t,{operation:e},(function(e){LHCCallbacks.addRemoteCommand&&LHCCallbacks.addRemoteCommand(t),"true"==e.error&&null!=e.errors&&alert(e.errors.join("\n"))})),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var i=this;setTimeout((function(){i.updateScreenshot(t)}),5e3)}},this.addRemoteOnlineCommand=function(t,e){$.postJSON(this.wwwDir+"chat/addonlineoperationiframe/"+t,{operation:e},(function(e){LHCCallbacks.addRemoteOnlineCommand&&LHCCallbacks.addRemoteOnlineCommand(t)}))},this.updateScreenshot=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshot/"+t,(function(t){$("#user-screenshot-container").html(t),$("#user-screenshot-container").removeClass("screenshot-pending")}))},this.updateScreenshotOnline=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshotonline/"+t,(function(t){$("#user-screenshot-container").html(t),$("#user-screenshot-container").removeClass("screenshot-pending")}))},this.eNick=function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/editnick/"+this.chat_id+"/"+this.hash})},this.enableVisitorEditor=function(){$("#ChatMessageContainer").removeClass("hide"),$("#CSChatMessage").focus()},this.disableVisitorEditor=function(){$("#ChatMessageContainer").addClass("hide")},this.buttonClicked=function(t,e,i,s){null==i.attr("data-no-change")&&(i.attr("disabled","disabled"),i.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash,{payload:t,id:e,processed:void 0===s||0==s},(function(t){void 0!==s&&!1!==s||$(".meta-message-"+e).remove();var i=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:i},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},this.editGenericStep=function(t,e){var i=$("#messagesBlock"),s=i.prop("scrollHeight");i.stop(!0,!1).animate({scrollTop:s},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/editgenericstep",{payload:t,id:e},(function(t){var e=i.prop("scrollHeight");i.stop(!0,!1).animate({scrollTop:e},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},this.updateTriggerClicked=function(t,e,i,s){null==i.attr("data-no-change")&&(i.attr("disabled","disabled"),i.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/triggerclicked",{payload:t,id:e,processed:void 0===s||0==s},(function(t){void 0!==s&&!1!==s||$(".meta-message-"+e).remove();var i=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:i},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},this.updateChatClicked=function(t,e,i,s){null==i.attr("data-no-change")&&(i.attr("disabled","disabled"),i.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),lhinst.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/updatebuttonclicked/"+this.chat_id+"/"+this.hash,{payload:t,id:e,processed:void 0===s||0==s},(function(t){void 0!==s&&!1!==s||$(".meta-message-"+e).remove();var i=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:i},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},this.dropdownClicked=function(t,e){null==e.attr("data-no-change")&&(e.attr("disabled","disabled"),e.prepend('<i class="material-icons lhc-spin">loop</i>'));var i=$("#messagesBlock"),s=i.prop("scrollHeight");i.stop(!0,!1).animate({scrollTop:s},500),""!=$("#generic_list-"+t).val()?(this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/valueclicked",{payload:$("#id_generic_list-"+t).val(),id:t},(function(e){$(".meta-message-"+t).remove();var s=i.prop("scrollHeight");i.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()):alert("Please choose!")},this.focusUserText=function(){$("#CSChatMessage").focus()},this.delayQueue=[],this.delayed=!1,this.intervalPending=null,this.setDelay=function(t){var e=t.id,i=t.duration,s=t.delay,a=t.untill_message;s>0&&$("#msg-"+e).addClass("hide"),1==a&&$("#msg-"+e).nextUntil("message-admin").length>0||setTimeout((function(){if(0==lhinst.delayed){if(1==a)clearInterval(lhinst.intervalPending),lhinst.intervalPending=setInterval((function(){if($("#msg-"+e).nextUntil("message-admin").length>0)lhinst.unhideDelayed(e),$("#messagesBlock > #msg-"+e).remove(),clearInterval(lhinst.intervalPending);else if(!$("#msg-"+e).hasClass("meta-hider")){$("#msg-"+e).addClass("meta-hider message-row-typing"),$("#msg-"+e).removeClass("hide"),$("#msg-"+e+" .msg-body").removeClass("hide");var t=$("#messagesBlock"),i=t.prop("scrollHeight");t.find(".meta-auto-hide").hide(),t.find(".message-row").last().find(".meta-auto-hide").show(),i=t.prop("scrollHeight"),t.find(".pending-storage").remove(),t.stop(!0,!1).animate({scrollTop:i+2e3},500)}}),500);else if(lhinst.delayed=!0,$("#msg-"+e).addClass("meta-hider message-row-typing").nextUntil("meta-hider").addClass("hide"),setTimeout((function(){lhinst.unhideDelayed(e)}),1e3*i),$("#msg-"+e).removeClass("hide"),$("#msg-"+e+" .msg-body").removeClass("hide"),s>0){var t=$("#messagesBlock"),n=t.prop("scrollHeight");t.find(".meta-auto-hide").hide(),t.find(".message-row").last().find(".meta-auto-hide").show(),n=t.prop("scrollHeight"),t.find(".pending-storage").remove(),t.stop(!0,!1).animate({scrollTop:n+2e3},500)}}else lhinst.delayQueue.push({id:e,delay:i})}),1e3*s)},this.sendHTML=function(t,e){"undefined"!=typeof parent&&window.location!==window.parent.location&&parent.postMessage("lhc_html_snippet:"+t+":"+e.type+"_"+e.id,"*")},this.unhideDelayed=function(t){var e=$("#messagesBlock > #msg-"+t);e.nextUntil(".meta-hider").removeClass("hide"),e.remove();var i=$("#messagesBlock"),s=i.prop("scrollHeight");if(i.find(".meta-auto-hide").hide(),i.find(".message-row").last().find(".meta-auto-hide").show(),s=i.prop("scrollHeight"),i.find(".pending-storage").remove(),i.stop(!0,!1).animate({scrollTop:s+2e3},500),this.delayQueue.length>0){var a=lhinst.delayQueue.pop();setTimeout((function(){lhinst.unhideDelayed(a.id)}),1e3*a.delay),$("#msg-"+a.id).removeClass("hide"),$("#msg-"+a.id+" .msg-body").removeClass("hide")}else lhinst.delayed=!1},this.gmaps_loading=!1,this.queue_render=[],this.showMessageLocation=function(t,e,i){var s={lat:e,lng:i};if(1==this.gmaps_loaded){var a=new google.maps.Map(document.getElementById("msg-location-"+t),{zoom:13,center:s});new google.maps.Marker({position:s,map:a,title:e+","+i})}else if(0==this.gmaps_loading){this.gmaps_loading=!0;var n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://maps.googleapis.com/maps/api/js?key="+confLH.gmaps_api_key+"&callback=chatMapLoaded";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(n,o),lhinst.queue_render.push({id:t,lat:e,lon:i})}else lhinst.queue_render.push({id:t,lat:e,lon:i})}}function chatMapLoaded(){if(lhinst.queue_render.length>0){lhinst.gmaps_loaded=!0;var t=lhinst.queue_render.pop(),e={lat:t.lat,lng:t.lon},i=new google.maps.Map(document.getElementById("msg-location-"+t.id),{zoom:13,center:e});new google.maps.Marker({position:e,map:i,title:t.lat+","+t.lon});lhinst.queue_render.length>0&&chatMapLoaded()}}var lhinst=new lh;function preloadSound(){lhinst.playPreloadSound(),jQuery(document).off("click",preloadSound),jQuery(document).off("touchstart",preloadSound)}function gMapsCallback(){lhinst.gmaps_loaded=!0;var t=$("#map_canvas"),e=new google.maps.Map(t[0],{zoom:GeoLocationData.zoom,center:new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,options:{zoomControl:!0,scrollwheel:!0,streetViewControl:!0}}),i=!1,s=!1,a=!1,n=!1;google.maps.event.addListener(e,"idle",r);var o=$("#map-activator");function r(){0==s?o.hasClass("active")?(s=!0,$.ajax({url:WWW_DIR_JAVASCRIPT+"chat/jsononlineusers"+(parseInt($("#id_department_map_id").val())>0?"/(department)/"+parseInt($("#id_department_map_id").val()):"")+(parseInt($("#maxRows").val())>0?"/(maxrows)/"+parseInt($("#maxRows").val()):"")+(parseInt($("#userTimeout").val())>0?"/(timeout)/"+parseInt($("#userTimeout").val()):""),dataType:"json",error:function(){clearTimeout(n),n=setTimeout((function(){r()}),1e4)},success:function(t){$(t.result).each((function(t,i){if(-1==$.inArray(i.Id,c)){var s=new google.maps.LatLng(i.Latitude,i.Longitude),a=new google.maps.Marker({position:s,icon:i.icon,map:e});google.maps.event.addListener(a,"click",(function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/getonlineuserinfo/"+i.Id})})),a.setVisible(!0),a.setAnimation(google.maps.Animation.DROP),l[i.Id]=a,c.push(i.Id),clearTimeout(l[i.Id].timeOutMarker),l[i.Id].timeOutMarker=setTimeout((function(){c.splice($.inArray(i.Id,c),1),google.maps.event.clearInstanceListeners(l[i.Id]),l[i.Id].setMap(null),l[i.Id]=null}),1e3*parseInt($("#markerTimeout option:selected").val()))}else l[i.Id].setIcon(i.icon),clearTimeout(l[i.Id].timeOutMarker),l[i.Id].timeOutMarker=setTimeout((function(){c.splice($.inArray(i.Id,c),1),google.maps.event.clearInstanceListeners(l[i.Id]),l[i.Id].setMap(null),l[i.Id]=null}),1e3*parseInt($("#markerTimeout option:selected").val()))})),s=!1,clearTimeout(n),1==a?(a=!1,r()):n=setTimeout((function(){r()}),1e4)}})):n=setTimeout((function(){r()}),1e4):a=!0}var c=[],l=[];new google.maps.InfoWindow({content:"Loading..."});$("#id_department_map_id").change((function(){r(),lhinst.changeUserSettingsIndifferent("omap_depid",$(this).val())})),$("#markerTimeout").change((function(){r(),lhinst.changeUserSettingsIndifferent("omap_mtimeout",$(this).val())})),$("#map-activator").click((function(){setTimeout((function(){google.maps.event.trigger(e,"resize"),0==i&&(i=!0,e.setCenter(new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng)))}),500),r()}))}lhinst.playPreloadSound(),jQuery(document).on("click",preloadSound),jQuery(document).on("click",(function(){lhinst.hidePopover()})),jQuery(document).on("touchstart",preloadSound),$.fn.makeDropdown=function(){var t=this.find(".btn-block-department-filter > input");this.click((function(){setTimeout((function(){t.focus()}),50)})),this.on("click","[data-stopPropagation]",(function(t){t.stopPropagation()}));this.each((function(){var t=$(this).find(".selected-items-filter");t.html(""),$(this).find(".btn-department-dropdown").attr("data-text",$(this).find(".btn-department-dropdown").text());var e=0;$(this).find("li input:checked").each((function(){t.prepend('<div class="fs12"><a data-stoppropagation="true" class="delete-item" data-value="'+$(this).val()+'"><i class="material-icons chat-unread">delete</i>'+$(this).parent().text()+"</a></div>"),e++})),e>0&&$(this).find(".btn-department-dropdown").text("["+e+"] "+$(this).find(".btn-department-dropdown").attr("data-text"));var i=$(this);i.find("li input").change((function(){t.html("");var e=0;i.find("li input:checked").each((function(){t.prepend('<div class="fs12"><a data-stoppropagation="true" class="delete-item" data-value="'+$(this).val()+'"><i class="material-icons chat-unread">delete</i>'+$(this).parent().text()+"</a></div>"),e++})),e>0?i.find(".btn-department-dropdown").text("["+e+"] "+i.find(".btn-department-dropdown").attr("data-text")):i.find(".btn-department-dropdown").text(i.find(".btn-department-dropdown").attr("data-text"))})),$(this).on("click",".delete-item",(function(){i.find("input[value="+$(this).attr("data-value")+"]").prop("checked",!1),$(this).parent().remove();var t=i.find("li input:checked").length;t>0?i.find(".btn-department-dropdown").text("["+t+"] "+i.find(".btn-department-dropdown").attr("data-text")):i.find(".btn-department-dropdown").text(i.find(".btn-department-dropdown").attr("data-text"))}))})),t.keyup((function(){var t=$(this).val();$(this).parent().parent().children("li").each((function(e){e>0&&($(this).text().toLowerCase().includes(t)||""==t?$(this).show():$(this).hide())}))}))};var focused=!0;function chatsyncuser(){lhinst.syncusercall()}function chatsyncuserpending(){lhinst.chatsyncuserpending()}function chatsyncadmin(){lhinst.syncadmincall()}window.onfocus=window.onblur=function(t){focused="focus"===(t||event).type,lhinst.focusChanged(focused)},window.lhcSelector=null;