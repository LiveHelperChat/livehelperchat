function csrfSafeMethod(t){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(t)}function lh(){this.wwwDir=WWW_DIR_JAVASCRIPT,this.addmsgurl="chat/addmsgadmin/",this.addmsgurluser="chat/addmsguser/",this.addmsgurluserchatbox="chatbox/addmsguser/",this.syncuser="chat/syncuser/",this.syncadmin="chat/syncadmin/",this.closechatadmin="chat/closechatadmin/",this.deletechatadmin="chat/deletechatadmin/",this.checkchatstatus="chat/checkchatstatus/",this.syncadmininterfaceurl="chat/syncadmininterface/",this.accepttransfer="chat/accepttransfer/",this.trasnsferuser="chat/transferuser/",this.userclosechaturl="chat/userclosechat/",this.disableremember=!1,this.operatorTyping=!1,this.forceBottomScroll=!1,this.appendSyncArgument="",this.nodeJsMode=!1,this.gmaps_loaded=!1,this.disableSync=!1,this.chat_id=null,this.hash=null,this.soundIsPlaying=!1,this.soundPlayedTimes=0,this.last_message_id=0,this.isSinchronizing=!1,this.isWidgetMode=!1,this.isEmbedMode=!1,this.syncroRequestSend=!1,this.currentMessageText="",this.setWidgetMode=function(t){this.isWidgetMode=t},this.setEmbedMode=function(t){this.isEmbedMode=t},this.setSynchronizationRequestSend=function(t){this.syncroRequestSend=t},this.setSyncUserURL=function(t){this.syncuser=t},this.chatsSynchronising=[],this.chatsSynchronisingMsg=[],this.notificationsArray=[],this.speechHandler=!1,this.underMessageAdd=!1,this.closeWindowOnChatCloseDelete=!1,this.userTimeout=!1,this.lastOnlineSyncTimeout=!1,this.setLastUserMessageID=function(t){this.last_message_id=t},this.setChatID=function(t){this.chat_id=t},this.setwwwDir=function(t){this.wwwDir=t},this.setCloseWindowOnEvent=function(t){this.closeWindowOnChatCloseDelete=t},this.setDisableRemember=function(t){this.disableremember=t},this.setSynchronizationStatus=function(t){this.underMessageAdd=t},this.tabIconContent="face",this.tabIconClass="icon-user-status material-icons icon-user-online",this.audio=new Audio,this.audio.autoplay="autoplay",this.reloadTab=function(t,e,s){$("#ntab-chat-"+t).text(s),0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),this.removeSynchroChat(t),this.removeBackgroundChat(t),this.hideNotification(t);var i=this;$.get(this.wwwDir+"chat/adminchat/"+t+"/(remember)/true",function(e){$("#chat-id-"+t).html(e),$("#CSChatMessage-"+t).focus(),i.rememberTab(t),i.addQuateHandler(t),i.loadMainData(t),ee.emitEvent("chatTabLoaded",[t])})},this.loadMainData=function(t){$.getJSON(this.wwwDir+"chat/loadmaindata/"+t,{},function(t){$.each(t.items,function(t,e){var s=$(e.selector);"undefined"!=typeof e.attr&&$.each(e.attr,function(t,e){s.attr(t,e)}),"undefined"!=typeof e.action&&("hide"==e.action?s.hide():"show"==e.action?s.show():"remove"==e.action?s.remove():"click"==e.action&&(s.attr("auto-scroll",1),s.click()))})}).fail(function(){})},this.getSelectedText=function(){var t,e="";return window.getSelection?(t=window.getSelection(),e=t.toString()):document.selection&&"Control"!==document.selection.type&&(t=document.selection.createRange(),e=t.text),{selection:t,text:e}},this.popoverShown=!1,this.popoverShownNow=!1,this.selection=null,this.mouseClicked=function(t){if(selected=t.data.that.getSelectedText(),$(".popover-copy").popover("dispose"),!selected.text.length||null!==t.data.that.selection&&t.data.that.selection.text===selected.text)t.data.that.selection=null;else{t.data.that.selection=selected;var e={placement:"top",trigger:"manual",animation:!1,html:!0,container:"#chat-id-"+t.data.chat_id,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body"></div></div>',content:'<a href="#" onclick="lhinst.quateSelection('+t.data.chat_id+')"><i class="material-icons">&#xE244;</i>quote</a>'};ee.emitEvent("quoteAction",[e,t.data.chat_id]),$(this).popover(e).popover("show"),$(this).addClass("popover-copy"),t.data.that.popoverShown=!0,t.data.that.popoverShownNow=!0}},this.addQuateHandler=function(t){this.popoverShown=!1,$("#messagesBlock-"+t+" .message-row").off("mouseup",lhinst.mouseClicked),$("#messagesBlock-"+t+" .message-row").on("mouseup",{chat_id:t,that:this},lhinst.mouseClicked)},this.getSelectedTextPlain=function(){var t=this.selection.text.replace(/[\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA]/g,"");return t=t.replace(/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,""),t=t.replace(/^[0-9]{2}:[0-9]{2}:[0-9]{2}(.*)/gm,""),t=t.replace(/^\s*\n/gm,""),t=t.replace(/^ /gm,"")},this.quateSelection=function(t){$(".popover-copy").popover("dispose");var e=this.getSelectedTextPlain();window.textreplace=e;var s=$("#CSChatMessage-"+t),i=s.val().replace(/^\s*\n/g,"");s.val((""!=i?i+"[quote]"+e+"[/quote]":"[quote]"+e+"[/quote]")+"\n").focus();var a=s[0],n=30;for(a.clientHeight/a.rows;a.scrollHeight>a.clientHeight&&!window.opera&&a.rows<n;)a.style.overflow="hidden",a.rows+=1;a.scrollHeight>a.clientHeight&&(a.style.overflow="auto"),this.popoverShown=!1},this.hidePopover=function(){this.popoverShownNow===!0?this.popoverShownNow=!1:this.popoverShown===!0&&(this.popoverShown=!1,$(".popover-copy").popover("dispose"))},this.addTab=function(t,e,s,i,a,n){if(!(t.find("#chat-tab-link-"+i).length>0)){var o='<li role="presentation" id="chat-tab-li-'+i+'" class="nav-item"><a class="nav-link" href="#chat-id-'+i+'" id="chat-tab-link-'+i+'" aria-controls="chat-id-'+i+'" role="tab" data-toggle="tab"><i id="msg-send-status-'+i+'" class="material-icons send-status-icon icon-user-online">send</i><i id="user-chat-status-'+i+'" class="'+this.tabIconClass+'">'+this.tabIconContent+'</i><span class="ntab" id="ntab-chat-'+i+'">'+s.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</span><span onclick="return lhinst.removeDialogTab('+i+',$(\'#tabs\'),true)" class="material-icons icon-close-chat">close</span></a></li>';"undefined"==typeof n||0==parseInt(n)?t.find("> ul").append(o):t.find("> ul > li:eq("+(n-1)+")").after(o),$("#chat-tab-link-"+i).click(function(){setTimeout(function(){$("#CSChatMessage-"+i).focus()},2);var t=$(this);setTimeout(function(){t.find(".msg-nm").remove(),t.removeClass("has-pm"),$("#messagesBlock-"+i).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+i).prop("scrollHeight")},500),ee.emitEvent("chatTabClicked",[i,t])},500)});var r=window.location.hash.replace("#/","#"),c=this;$.get(e,function(e){"undefined"==typeof a||a===!0||r=="#chat-id-"+i?(t.find("> ul > li > a.active").removeClass("active"),t.find("> ul > #chat-tab-li-"+i+" > a").addClass("active"),t.find("> div.tab-content > div.active").removeClass("active"),t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane active" id="chat-id-'+i+'"></div>'),window.location.hash="#/chat-id-"+i):t.find("> div.tab-content").append('<div role="tabpanel" class="tab-pane" id="chat-id-'+i+'"></div>'),$("#chat-id-"+i).html(e),$("#CSChatMessage-"+i).focus(),0==c.disableremember&&c.rememberTab(i),c.addQuateHandler(i),c.loadMainData(i),ee.emitEvent("chatTabLoaded",[i])})}},this.rememberTab=function(t){if(localStorage)try{t=parseInt(t);var e=localStorage.getItem("achat_id"),s=new Array;if(null!==e)var s=e.split(",").map(Number);s.indexOf(t)===-1&&s.push(t),localStorage.setItem("achat_id",s.join(","))}catch(i){console.log(i)}},this.forgetChat=function(t){if(localStorage)try{t=parseInt(t);var e=localStorage.getItem("achat_id"),s=new Array;null!==e&&(s=e.split(",").map(Number)),s.indexOf(t)!==-1&&s.splice(s.indexOf(t),1),localStorage.setItem("achat_id",s.join(","))}catch(i){console.log(i)}},this.attachTabNavigator=function(){$("#tabs > ul.nav > li > a").click(function(){$(this).find(".msg-nm").remove(),$(this).removeClass("has-pm")})},this.holdAction=function(t,e){var s=this;$.postJSON(this.wwwDir+"chat/holdaction/"+t,function(i){0==i.error?(1==i.hold?e.addClass("btn-info"):e.removeClass("btn-info"),""!=i.msg&&($("#messagesBlock-"+t).append(i.msg),$("#messagesBlock-"+t).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500)),s.syncadmincall()):alert(i.msg)})},this.copyMessages=function(t){function e(e){t.tooltip("hide").attr("data-original-title",e).tooltip("show")}function s(){setTimeout(function(){t.tooltip("hide")},3e3)}return $("#chat-copy-messages").select(),document.execCommand("copy"),t.tooltip({trigger:"click",placement:"top"}),e(t.attr("data-success")),s(),!1},this.startChat=function(t,e,s,i,a){if(this.removeBackgroundChat(t),this.hideNotification(t),0==this.chatUnderSynchronization(t)){var n="undefined"==typeof i||i,o=0==this.disableremember?"/(remember)/true":"";this.addTab(e,this.wwwDir+"chat/adminchat/"+t+o,s,t,n,a);var r=this;setTimeout(function(){r.syncadmininterfacestatic()},1e3)}else e.find("> ul > li > a.active").removeClass("active"),e.find("> ul > li#chat-tab-li-"+t+" > a").addClass("active"),e.find("> div.tab-content > div.active").removeClass("active"),e.find("> div.tab-content > #chat-id-"+t).addClass("active"),window.location.hash="#/chat-id-"+t;ee.emitEvent("chatStartTab",[t])},this.backgroundChats=[],this.startChatBackground=function(t,e,s){if(0==this.chatUnderSynchronization(t)){this.backgroundChats.push(parseInt(t));var i=0==this.disableremember?"/(remember)/true":"";return this.addTab(e,this.wwwDir+"chat/adminchat/"+t+i+"/(arg)/background",s,t,!1),ee.emitEvent("chatStartBackground",[t]),!0}return!1},this.protectCSFR=function(){$("a.csfr-required").click(function(){var t=$(this);t.attr("data-secured")||(t.attr("href",t.attr("href")+"/(csfr)/"+confLH.csrf_token),t.attr("data-secured",1))})},this.setChatHash=function(t){this.hash=t},this.addSynchroChat=function(t,e){this.chatsSynchronising.push(t),this.chatsSynchronisingMsg.push(t+","+e),LHCCallbacks.addSynchroChat&&LHCCallbacks.addSynchroChat(t,e)},this.removeSynchroChat=function(t){for(var e=0;e<this.chatsSynchronising.length;)this.chatsSynchronising[e]==t?(this.chatsSynchronising.splice(e,1),this.chatsSynchronisingMsg.splice(e,1)):e++;this.forgetChat(t),ee.emitEvent("removeSynchroChat",[t]),LHCCallbacks.removeSynchroChat&&LHCCallbacks.removeSynchroChat(t)},this.is_typing=!1,this.typing_timeout=null,this.operatorTypingCallback=function(t){var e=this.wwwDir,s=this;0==s.is_typing?(s.is_typing=!0,clearTimeout(s.typing_timeout),1==s.nodeJsMode?(s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3),ee.emitEvent("operatorTyping",[{chat_id:t,status:!0}])):$.getJSON(e+"chat/operatortyping/"+t+"/true",{},function(e){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3),LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0)}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3)})):(clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedOperator(t)},3e3))},this.initTypingMonitoringAdmin=function(t){var e=this;jQuery("#CSChatMessage-"+t).bind("keyup",function(s){e.operatorTypingCallback(t)})},this.remarksTimeout=null,this.saveRemarks=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-"+t).addClass("text-warning"),$("#main-user-info-remarks-"+t+" .alert").remove();var e=this;this.remarksTimeout=setTimeout(function(){$.postJSON(e.wwwDir+"chat/saveremarks/"+t,{data:$("#ChatRemarks-"+t).val()},function(e){"false"==e.error?$("#remarks-status-"+t).removeClass("text-warning"):$("#main-user-info-remarks-"+t).prepend(e.result)})},500)},this.saveNotes=function(t){clearTimeout(this.remarksTimeout),$("#remarks-status-online-"+t).addClass("text-warning");var e=this;this.remarksTimeout=setTimeout(function(){$.postJSON(e.wwwDir+"chat/saveonlinenotes/"+t,{data:$("#OnlineRemarks-"+t).val()},function(e){$("#remarks-status-online-"+t).removeClass("text-warning")})},500)},this.surveyShowed=!1,this.closeWindow=function(){null!==this.survey&&0==this.surveyShowed?(this.surveyShowed=!0,this.chatClosed()):(window.open("","_self",""),window.close())},this.typingStoppedOperator=function(t){var e=this;1==e.is_typing&&(1==lhinst.nodeJsMode?(e.is_typing=!1,ee.emitEvent("operatorTyping",[{chat_id:t,status:!1}])):$.getJSON(this.wwwDir+"chat/operatortyping/"+t+"/false",{},function(s){e.is_typing=!1,LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!1)}).fail(function(){e.is_typing=!1}))},this.sendemail=function(){$.postJSON(this.wwwDir+"chat/sendchat/"+this.chat_id+"/"+this.hash,{csfr_token:confLH.csrf_token,email:$('input[name="UserEmail"]').val()},function(t){"false"==t.error?$("#myModal").modal("hide"):($("#user-action .alert-box").remove(),$("#user-action").prepend(t.result))})},this.reopenchat=function(t){$.postJSON(this.wwwDir+"chat/reopenchat/"+t.attr("data-id"),function(e){"true"==e.error?alert(e.result):($("#action-block-row-"+t.attr("data-id")+" .send-row").removeClass("hide"),$("#CSChatMessage-"+t.attr("data-id")).removeAttr("readonly").focus(),$("#chat-status-text-"+t.attr("data-id")).text(e.status),t.remove())})},this.initTypingMonitoringUser=function(t){var e=this.wwwDir,s=this;try{sessionStorage&&sessionStorage.getItem("lhc_ttxt")&&""!=sessionStorage.getItem("lhc_ttxt")&&jQuery("#CSChatMessage").val(sessionStorage.getItem("lhc_ttxt"))}catch(i){}jQuery("#CSChatMessage").bind("keyup",function(i){if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",$(this).val())}catch(a){}var n=$(this)[0];if(n.style.height="5px",n.style.height=n.scrollHeight+3+"px",0==s.is_typing)clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringUserInform?(s.typing_timeout=setTimeout(function(){ee.emitEvent("visitorTypingStopped",[{chat_id:t,hash:s.hash}])},3e3),ee.emitEvent("visitorTyping",[{chat_id:t,hash:s.hash,status:!0,msg:$(this).val()}])):(s.is_typing=!0,$.postJSON(e+"chat/usertyping/"+t+"/"+s.hash+"/true",{msg:$(this).val()},function(e){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3),LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!0])}).fail(function(){s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3)}));else{clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout(function(){s.typingStoppedUser(t)},3e3);var o=$(this).val();s.currentMessageText!=o&&Math.abs(s.currentMessageText.length-o.length)>6&&(s.currentMessageText=o,LHCCallbacks.initTypingMonitoringUserInform?ee.emitEvent("visitorTyping",[{chat_id:t,hash:s.hash,status:!0,msg:$(this).val()}]):$.postJSON(e+"chat/usertyping/"+t+"/"+s.hash+"/true",{msg:o},function(e){LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!0])}))}})},this.typingStoppedUser=function(t){var e=this;1==e.is_typing&&(LHCCallbacks.typingStoppedUserInform?(e.is_typing=!1,ee.emitEvent("visitorTypingStopped",[{chat_id:t,hash:this.hash,status:!1}])):$.getJSON(this.wwwDir+"chat/usertyping/"+t+"/"+this.hash+"/false",{},function(s){e.is_typing=!1,LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[t,!1])}).fail(function(){e.is_typing=!1}))},this.refreshFootPrint=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/chatfootprint/"+t.attr("rel"),{},function(e){$("#footprint-"+t.attr("rel")).html(e),t.removeClass("disabled")})},this.makeAbstractRequest=function(t,e){return $.get(e.attr("href"),function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedSurvey&&LHCCallbacks.userRedirectedSurvey(t)}),!1},this.refreshOnlineUserInfo=function(t){t.addClass("disabled"),$.get(this.wwwDir+"chat/refreshonlineinfo/"+t.attr("rel"),{},function(e){$("#online-user-info-"+t.attr("rel")).html(e),t.removeClass("disabled")})},this.processCollapse=function(t){if("chevron_right"==$("#chat-main-column-"+t+" .collapse-right").text()){$("#chat-right-column-"+t).hide(),$("#chat-main-column-"+t).removeClass("col-sm-7").addClass("col-sm-12"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_left");try{localStorage&&localStorage.setItem("lhc_rch",1)}catch(e){}}else{$("#chat-right-column-"+t).show(),$("#chat-main-column-"+t).removeClass("col-sm-12").addClass("col-sm-7"),$("#chat-main-column-"+t+" .collapse-right").text("chevron_right");try{localStorage&&localStorage.removeItem("lhc_rch")}catch(e){}}},this.chatUnderSynchronization=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return!0;e++}return!1},this.getChatIndex=function(t){for(var e=0;e<this.chatsSynchronising.length;){if(this.chatsSynchronising[e]==t)return e;e++}return!1},this.updateUserSyncInterface=function(t,e){try{if("false"==e.error)if("true"!=e.blocked){if("false"!=e.result&&"true"==e.status){var s=$("#messagesBlock"),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.append(e.result),s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),(a<20||1==t.forceBottomScroll)&&(t.forceBottomScroll=!1,s.stop(!0,!1).animate({scrollTop:i+2e3},500)),1==confLH.new_message_sound_user_enabled&&"false"==e.uw&&t.playNewMessageSound(),t.last_message_id>0&&($("#msg-"+t.last_message_id).attr("data-op-id")==e.msop&&$("#msg-"+t.last_message_id+" > .usr-tit").text()===$("#msg-"+e.message_id+" > .usr-tit").text()||$("#msg-"+t.last_message_id).next().addClass("operator-changes")),t.last_message_id=e.message_id,"false"==e.uw&&t.isWidgetMode&&"undefined"!=typeof parent&&parent.postMessage("lhc_newopmsg","*")}else"true"!=e.status&&$("#status-chat").html(e.status);if(t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval),"t"==e.cs&&t.chatsyncuserpending(),""!=e.ott&&"f"!=e.ott){var n=$("#id-operator-typing");n.text(e.ott),n.css("visibility","visible"),t.operatorTyping=!0}else"f"==e.ott&&(t.operatorTyping=!1,$("#id-operator-typing").css("visibility","hidden"));""!=e.op&&t.executeRemoteCommands(e.op)}else $("#status-chat").html(e.status),$("#ChatMessageContainer").remove(),$("#ChatSendButtonContainer").remove(),$("#id-operator-typing").css("visibility","hidden"),t.operatorTyping=!1,"undefined"!=typeof e.op&&""!=e.op&&t.executeRemoteCommands(e.op),e.closed&&1==e.closed&&(ee.emitEvent("chatClosedSyncUser",[t.chat_id]),t.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed"+("undefined"!=typeof e.closed_arg?":"+e.closed_arg:""),"*"):("undefined"!=typeof e.closed_arg&&t.parseCloseArgs(e.closed_arg.split(":")),t.chatClosed()))}catch(o){t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}t.syncroRequestSend=!1},this.parseCloseArgs=function(t){var e=t.length/2;for(i=0;i<e;i++){var s=t[2*i],a=t[2*i+1];"survey_id"==s&&(this.survey=a)}},this.chatClosed=function(){if(null!==this.survey){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=1==this.operatorTyping?"/(ot)/t":"",s=null!==this.theme?"/(theme)/"+this.theme:"",i=1==this.isEmbedMode?"/(modeembed)/embed":"",a=1==this.isWidgetMode?"fillwidget":"fill",n=1==this.explicitClose?"/(eclose)/t":"";return document.location.replace(this.wwwDir+"survey/"+a+"/(survey)/"+this.survey+"/(chatid)/"+this.chat_id+"/(hash)/"+this.hash+t+e+s+i+n),!0}return!1},this.executeRemoteCommands=function(operations){var inst=this;$.each(operations,function(i,item){item.indexOf("lhinst.")!=-1?eval(item):inst.isWidgetMode?parent.postMessage(item,"*"):window.opener&&window.opener.postMessage(item,"*")})},this.syncusercall=function(){var t=this;if(0==this.syncroRequestSend){clearTimeout(this.userTimeout),this.syncroRequestSend=!0;var e=1==this.isWidgetMode?"/(mode)/widget":"",s=1==this.operatorTyping?"/(ot)/t":"",i=null!==this.theme?"/(theme)/"+this.theme:"",a=1==this.isEmbedMode?"/(modeembed)/embed":"";$.getJSON(this.wwwDir+this.syncuser+this.chat_id+"/"+this.last_message_id+"/"+this.hash+e+s+i+a,{},function(e){t.updateUserSyncInterface(t,e),LHCCallbacks.syncusercall&&LHCCallbacks.syncusercall(t,e),ee.emitEvent("syncUserCall",[t,e])}).fail(function(){t.syncroRequestSend=!1,t.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)})}},this.scheduleSync=function(){this.syncroRequestSend=!1,clearTimeout(this.userTimeout),this.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)},this.closeActiveChatDialog=function(t,e,s){var i=this;$.postJSON(this.wwwDir+this.closechatadmin+t,function(a){if(0==a.error){if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),window.postMessage&&window.opener&&window.opener.postMessage("lhc_ch:chatclosed:"+t,"*"),1==s){var n=i.smartTabFocus(e,t);setTimeout(function(){window.location.hash=n},500),1==i.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatClosedCallback&&LHCCallbacks.chatClosedCallback(t),i.removeSynchroChat(t),i.syncadmininterfacestatic()}else alert(a.result)}).fail(function(t,e,s){console.dir(t),alert("postJSON request failed! "+e+":"+s+":"+t.responseText)})},this.smartTabFocus=function(t,e){var s=t.find("> ul > #chat-tab-li-"+e).index();t.find("> ul > #chat-tab-li-"+e).remove(),t.find("#chat-id-"+e).remove();var i=t.find("> ul > li:eq("+(s-1)+")");if(void 0!==i.attr("id"))var a=i.find("> a");else if(linkTabRight=t.find("> ul > li:eq("+s+")"),linkTabRight.length>0)var a=linkTabRight.find("> a");else var a=i.find("> a");if(!t.find("> ul > li > a.active").length&&(a.tab("show"),void 0!==a.attr("id"))){var n=a.attr("href").replace("#chat-id-","");this.removeBackgroundChat(n),this.hideNotification(n),ee.emitEvent("chatTabFocused",[n])}return void 0!==a.attr("href")?a.attr("href").replace("#","#/"):"#"},this.startChatCloseTabNewWindow=function(t,e,s){return window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650"),this.smartTabFocus(e,t),1==this.closeWindowOnChatCloseDelete&&window.close(),this.removeSynchroChat(t),this.syncadmininterfacestatic(),!1},this.removeDialogTab=function(t,e,s){if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),this.removeSynchroChat(t),1==s){var i=this.smartTabFocus(e,t);setTimeout(function(){window.location.hash=i},500),1==this.closeWindowOnChatCloseDelete&&window.close()}this.syncadmininterfacestatic()},this.removeActiveDialogTag=function(t){1==this.closeWindowOnChatCloseDelete&&window.close()},this.deleteChat=function(t,e,s){if(confirm(confLH.transLation.delete_confirm)){var i=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,function(a){if(1==a.error)alert(a.result);else{if(0!=$("#CSChatMessage-"+t).length&&($("#CSChatMessage-"+t).unbind("keydown",function(){}),$("#CSChatMessage-"+t).unbind("keyup",function(){})),1==s){var n=i.smartTabFocus(e,t);setTimeout(function(){window.location.hash=n},500),1==i.closeWindowOnChatCloseDelete&&window.close()}LHCCallbacks.chatDeletedCallback&&LHCCallbacks.chatDeletedCallback(t),i.syncadmininterfacestatic(),i.removeSynchroChat(t)}}).fail(function(t,e,s){console.dir(t),alert("getJSON request failed! "+e+":"+s+":"+t.responseText)})}},this.rejectPendingChat=function(t,e){var s=this;$.postJSON(this.wwwDir+this.deletechatadmin+t,{},function(t){s.syncadmininterfacestatic()}).fail(function(t,e,s){console.dir(t),alert("getJSON request failed! "+e+":"+s+":"+t.responseText)})},this.startChatNewWindow=function(t,e){window.open(this.wwwDir+"chat/single/"+t,"chatwindow-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus();var s=this;setTimeout(function(){s.syncadmininterfacestatic()},1e3),ee.emitEvent("chatStartOpenWindow",[t])},this.startChatNewWindowArchive=function(t,e,s){window.open(this.wwwDir+"chatarchive/viewarchivedchat/"+t+"/"+e+"/(mode)/popup","chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650").focus(),ee.emitEvent("chatStartOpenWindowArchive",[t,e])},this.startCoBrowse=function(t){return window.open(this.wwwDir+"cobrowse/browse/"+t,"chatwindow-cobrowse-chat-id-"+t,"menubar=1,resizable=1,width=800,height=650").focus(),!1},this.speechToText=function(t){0==this.speechHandler&&(this.speechHandler=new LHCSpeechToText),this.speechHandler.listen({chat_id:t})},this.startChatTransfer=function(t,e,s,i){var a=this;$.getJSON(this.wwwDir+this.accepttransfer+i,{},function(i){a.startChat(t,e,s),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)}).fail(function(){a.startChat(t,e,s)})},this.startChatNewWindowTransfer=function(t,e,s){return $.getJSON(this.wwwDir+this.accepttransfer+s,{},function(e){LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t)}),this.startChatNewWindow(t,e)},this.startChatNewWindowTransferByTransfer=function(t,e){var s=this;return $.ajax({type:"GET",url:this.wwwDir+this.accepttransfer+t+"/(mode)/chat",cache:!1,dataType:"json"}).done(function(t){$("#tabs").length>0?(window.focus(),s.startChat(t.chat_id,$("#tabs"),e)):s.startChatNewWindow(t.chat_id,""),LHCCallbacks.operatorAcceptedTransfer&&LHCCallbacks.operatorAcceptedTransfer(t.chat_id)}),this.syncadmininterfacestatic(),!1},this.blockUser=function(t,e){("undefined"==typeof e||confirm(e))&&$.postJSON(this.wwwDir+"chat/blockuser/"+t,{},function(t){alert(t.msg)})},this.switchLang=function(t,e){var s='<input type="hidden" value="'+e+'" name="switchLang" />';return t.append(s),t.submit(),!1},this.sendLinkToMail=function(t,e){var s=window.parent.$("#MailMessage").val();window.parent.$("#MailMessage").val((""!=s?s+"\n":s)+t),$("#embed-button-"+e).addClass("btn-success")},this.sendLinkToEditor=function(t,e,s){var i=window.parent.$("#CSChatMessage-"+t).val();window.parent.$("#CSChatMessage-"+t).val((""!=i?i+"\n":i)+e),$("#embed-button-"+s).addClass("btn-success")},this.sendLinkToGeneralEditor=function(t,e){var s=window.parent.$(".embed-into"),i=s.val();s.val((""!=i?i+"\n":i)+t),$("#embed-button-"+e).addClass("btn-success")},this.hideTransferModal=function(t){var e=this;setTimeout(function(){$("#myModal").modal("hide"),$("#tabs").length>0&&e.removeDialogTab(t,$("#tabs"),!0)},1e3)},this.transferChat=function(t){var e=this,s=$("[name=TransferTo"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+s,{type:"user"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),e.hideTransferModal(t))})},this.changeOwner=function(t){var e=this,s=$("#id_new_user_id").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+s,{type:"change_owner"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),e.hideTransferModal(t))})},this.chooseSurvey=function(t){var e=$("[name=SurveyItem"+t+"]:checked").val();$.postJSON(this.wwwDir+"survey/choosesurvey/"+t+"/"+e,function(t){"false"==t.error&&$("#survey-block-"+t.chat_id).html(t.result)})},this.redirectContact=function(t,e){("undefined"==typeof e||confirm(e))&&$.postJSON(this.wwwDir+"chat/redirectcontact/"+t,function(e){lhinst.syncadmininterfacestatic(),LHCCallbacks.userRedirectedContact&&LHCCallbacks.userRedirectedContact(t)})},this.redirectToURL=function(t,e){var s=prompt(e,"");null!=s&&lhinst.addRemoteCommand(t,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__"))},this.redirectToURLOnline=function(t,e){var s=prompt(e,"");null!=s&&(lhinst.addRemoteOnlineCommand(t,"lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")),lhinst.addExecutionCommand(t,"lhc_cobrowse_multi_command__lhc_chat_redirect:"+s.replace(new RegExp(":","g"),"__SPLIT__")))},this.transferChatDep=function(t){var e=this,s=$("[name=DepartamentID"+t+"]:checked").val();$.postJSON(this.wwwDir+this.trasnsferuser+t+"/"+s,{type:"dep"},function(s){"false"==s.error&&($("#transfer-block-"+s.chat_id).html(s.result),e.hideTransferModal(t))})},this.chatTabsOpen=function(){return window.open(this.wwwDir+"chat/chattabs/","chatwindows","menubar=1,resizable=1,width=800,height=650"),!1},this.userclosedchat=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.ajax({type:"GET",url:this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash,cache:!1})},this.userclosedchatembed=function(){window.postMessage&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},this.continueChatFromSurvey=function(t){return this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?$.postJSON(this.wwwDir+"survey/backtochat/"+this.chat_id+"/"+this.hash+"/"+t,function(t){parent.postMessage("lhc_continue_chat","*")}):this.chatClosed(),!1},this.explicitClose=!1,this.explicitChatCloseByUser=function(){return this.explicitClose=!0,this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close(),!1},this.restoreWidget=function(t){window.postMessage&&window.opener&&(window.opener.postMessage("lhc_ch:hash:"+t,"*"),window.opener.postMessage("lhc_ch:hash_resume:"+t,"*"),window.opener.postMessage("lhc_open_restore","*"),window.close())},this.userclosedchatandbrowser=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.get(this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash+"/(eclose)/t",function(t){lhinst.closeWindow()})},this.sendCannedMessage=function(t,e){if($("#id_CannedMessage-"+t).val()>0){e.addClass("secondary");var s=1e3*parseInt($("#id_CannedMessage-"+t).find(":selected").attr("data-delay")),i=this.wwwDir,a=this;if(0==a.is_typing?(a.is_typing=!0,clearTimeout(a.typing_timeout),LHCCallbacks.initTypingMonitoringAdminInform&&LHCCallbacks.initTypingMonitoringAdminInform({chat_id:t,status:!0}),$.getJSON(i+"chat/operatortyping/"+t+"/true",{},function(i){LHCCallbacks.initTypingMonitoringAdmin&&LHCCallbacks.initTypingMonitoringAdmin(t,!0),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t),e.removeClass("secondary")},s>3e3?s:3e3)}).fail(function(){a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t)},3e3)})):(clearTimeout(a.typing_timeout),a.typing_timeout=setTimeout(function(){a.typingStoppedOperator(t)},3e3),e.removeClass("secondary")),s>0)setTimeout(function(){var e={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(i+a.addmsgurl+t,e,function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0})},s);else{var n={msg:$("#id_CannedMessage-"+t).find(":selected").attr("data-msg")};$("#CSChatMessage-"+t).val(""),$.postJSON(this.wwwDir+this.addmsgurl+t,n,function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),lhinst.syncadmincall(),!0})}}return!1},this.voteAction=function(t){var e=this.chat_id;$.postJSON(this.wwwDir+"chat/voteaction/"+this.chat_id+"/"+this.hash+"/"+t.attr("data-id"),{},function(t){"false"==t.error&&(LHCCallbacks.uservoted&&LHCCallbacks.uservoted(e),0==t.status?($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):1==t.status?($(".up-vote-action").addClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):2==t.status&&($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").addClass("down-voted")))})},this.theme=null,this.chatsyncuserpending=function(){var t=1==this.isWidgetMode?"/(mode)/widget":"",e=null!==this.theme?"/(theme)/"+this.theme:"",s=this;$.getJSON(this.wwwDir+this.checkchatstatus+this.chat_id+"/"+this.hash+t+e,{},function(t){ee.emitEvent("checkChatStatus",[s.chat_id,t]),"false"==t.error&&("false"==t.activated?("false"!=t.result&&$("#status-chat").html(t.result),""!=t.ru&&document.location.replace(t.ru),setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)):($("#status-chat").html(t.result),t.closed&&1==t.closed&&(ee.emitEvent("chatClosedCheckStatus",[s.chat_id]),s.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed","*"):s.chatClosed())))}).fail(function(){setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)})},this.setTheme=function(t){this.theme=t},this.survey=null,this.setSurvey=function(t){this.survey=t},this.isBlinking=!1,
this.startBlinking=function(){if(0==this.isBlinking){var t=this,e=function(){var e,s=document.title,i="!!! "+document.title,a=function(){document.title=document.title==i?" ":i},n=function(){clearInterval(e),document.title=s,window.onmousemove=null,e=null,t.isBlinking=!1};return function(){e||(e=setInterval(a,1e3),window.onmousemove=n)}}();e(),this.isBlinking=!0}},this.playNewMessageSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_message.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_message.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_message.wav",this.audio.load()),$("textarea[name=ChatMessage]").is(":focus")||this.startBlinking()},this.playInvitationSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/invitation.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/invitation.mp3":WWW_DIR_JAVASCRIPT_FILES+"/invitation.wav",this.audio.load())},this.playPreloadSound=function(){Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/silence.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/silence.mp3":WWW_DIR_JAVASCRIPT_FILES+"/silence.wav",this.audio.load())},this.loadPreviousMessages=function(t){$.getJSON(this.wwwDir+"chat/loadpreviousmessages/"+t.attr("chat-id")+"/"+t.attr("message-id")+"/(initial)/"+t.attr("data-initial"),function(e){if(0==e.error){t.attr("data-initial",0);var s=$("#messagesBlock-"+t.attr("chat-original-id"));s.prepend(e.result),1==t.attr("auto-scroll")&&(t.attr("auto-scroll",0),s.stop(!0,!1).animate({scrollTop:s.prop("scrollHeight")},500)),1==e.has_messages?(t.attr("message-id",e.message_id),t.attr("chat-id",e.chat_id)):t.remove()}})},this.hidenicknamesstatus=null,this.syncadmincall=function(){this.chatsSynchronising.length>0?0==this.underMessageAdd&&0==this.syncroRequestSend?(this.syncroRequestSend=!0,$.postJSON(this.wwwDir+this.syncadmin,{"chats[]":this.chatsSynchronisingMsg},function(data){"undefined"!=typeof data.error_url&&document.location.replace(data.error_url);try{if("false"==data.error){if("false"!=data.result){var playSound=!1;$.each(data.result,function(t,e){var s=$("#messagesBlock-"+e.chat_id),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));s.find(".pending-storage").remove(),s.append(e.content),lhinst.addQuateHandler(e.chat_id),a<20&&s.stop(!0,!1).animate({scrollTop:i},500),lhinst.updateChatLastMessageID(e.chat_id,e.message_id);var n=$("#chat-tab-link-"+e.chat_id);if(!n.hasClass("active"))if(n.find("span.msg-nm").length>0){var o=parseInt(n.find("span.msg-nm").attr("rel"))+e.mn;n.find("span.msg-nm").html(" ("+o+")").attr("rel",o)}else n.append('<span rel="'+e.mn+'" class="msg-nm"> ('+e.mn+")</span>"),n.addClass("has-pm");0!=playSound||"false"!=data.uw||"undefined"!=typeof e.ignore&&typeof e.ignore!==!1||(playSound=!0),1!=confLH.new_message_browser_notification||"false"!=data.uw||"undefined"!=typeof e.ignore&&typeof e.ignore!==!1||lhinst.showNewMessageNotification(e.chat_id,e.msg,e.nck),e.msfrom>0&&$("#msg-"+e.msfrom).attr("data-op-id")!=e.msop&&$("#msg-"+e.msfrom).next().addClass("operator-changes"),ee.emitEvent("eventSyncAdmin",[e,t])}),1==confLH.new_message_sound_admin_enabled&&"false"==data.uw&&1==playSound&&lhinst.playNewMessageSound()}if("false"!=data.result_status){var groupTabs=$("#group-chats-status").hasClass("chat-active");$.each(data.result_status,function(i,item){"true"==item.tp?$("#user-is-typing-"+item.chat_id).html(item.tx).css("visibility","visible"):0==lhinst.nodeJsMode&&$("#user-is-typing-"+item.chat_id).css("visibility","hidden"),$("#last-msg-chat-"+item.chat_id).text(item.lmsg);var userChatStatus=$("#user-chat-status-"+item.chat_id),wasOnline=userChatStatus.hasClass("icon-user-online");$("#chat-duration-"+item.chat_id).text(item.cdur),userChatStatus.removeClass("icon-user-online icon-user-away icon-user-pageview"),$("#msg-send-status-"+item.chat_id).removeClass("icon-user-online icon-user-offline"),0==item.us?userChatStatus.addClass("icon-user-online"):2==item.us?userChatStatus.addClass("icon-user-away"):3==item.us&&userChatStatus.addClass("icon-user-pageview"),1==groupTabs?1==wasOnline&&0!=item.us||lhinst.hidenicknamesstatus!=groupTabs&&0!=item.us?$("#ntab-chat-"+item.chat_id).hide():(0==wasOnline&&0==item.us||lhinst.hidenicknamesstatus!=groupTabs&&0==item.us)&&$("#ntab-chat-"+item.chat_id).show():lhinst.hidenicknamesstatus!=groupTabs&&$("#ntab-chat-"+item.chat_id).show();var statusel=$("#chat-id-"+item.chat_id+"-mds");statusel.attr("data-chat-status")==item.cs&&statusel.attr("data-chat-user")==item.co||lhinst.updateVoteStatus(item.chat_id),1==item.um?(statusel.removeClass("chat-active"),statusel.addClass("chat-unread"),$("#msg-send-status-"+item.chat_id).addClass("icon-user-offline")):($("#msg-send-status-"+item.chat_id).addClass("icon-user-online"),statusel.removeClass("chat-unread"),statusel.addClass("chat-active")),item.lp!==!1?statusel.attr("title",item.lp+" s."):statusel.attr("title",""),"undefined"!=typeof item.oad&&eval(item.oad)})}lhinst.hidenicknamesstatus=groupTabs,clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}}catch(err){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)}lhinst.setSynchronizationRequestSend(!1),LHCCallbacks.syncadmincall&&LHCCallbacks.syncadmincall(lhinst,data)}).fail(function(){clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval),lhinst.setSynchronizationRequestSend(!1)})):(clearTimeout(lhinst.userTimeout),lhinst.userTimeout=setTimeout(chatsyncadmin,confLH.chat_message_sinterval)):this.isSinchronizing=!1},this.updateVoteStatus=function(t){$.getJSON(this.wwwDir+"chat/updatechatstatus/"+t,{},function(e){$("#main-user-info-tab-"+t).html(e.result),$("#messagesBlock-"+t+" span.vis-tit").each(function(t){var s=$(this).children();$(this).text(" "+e.nick).prepend(s)}),$("#ntab-chat-"+t).text(e.nick),ee.emitEvent("chatTabInfoReload",[t])})},this.updateChatLastMessageID=function(t,e){this.chatsSynchronisingMsg[this.getChatIndex(t)]=t+","+e},this.requestNotificationPermission=function(){window.webkitNotifications?window.webkitNotifications.requestPermission():window.Notification?Notification.requestPermission(function(t){}):alert("Notification API in your browser is not supported.")},this.playNewChatAudio=function(){if(clearTimeout(this.soundIsPlaying),this.soundPlayedTimes++,Modernizr.audio&&(this.audio.src=Modernizr.audio.ogg?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.ogg":Modernizr.audio.mp3?WWW_DIR_JAVASCRIPT_FILES+"/new_chat.mp3":WWW_DIR_JAVASCRIPT_FILES+"/new_chat.wav",this.audio.load(),confLH.repeat_sound>this.soundPlayedTimes)){var t=this;this.soundIsPlaying=setTimeout(function(){t.playNewChatAudio()},1e3*confLH.repeat_sound_delay)}},this.focusChanged=function(t){if(1==confLH.new_message_browser_notification&&1==t&&(window.webkitNotifications||window.Notification)){var e=this;$.each(this.chatsSynchronising,function(t,s){"undefined"!=typeof e.notificationsArrayMessages[s]&&(window.webkitNotifications?e.notificationsArrayMessages[s].cancel():e.notificationsArrayMessages[s].close(),delete e.notificationsArrayMessages[s])})}parseInt(this.chat_id)>0&&this.scheduleSync()},this.notificationsArrayMessages=[],this.showNewMessageNotification=function(t,e,s){try{if(window.Notification&&0==focused&&"granted"==window.Notification.permission){"undefined"!=typeof this.notificationsArrayMessages[t]&&(this.notificationsArrayMessages[t].close(),delete this.notificationsArrayMessages[t]);var i=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:e}),a=this;i.onclick=function(){window.focus(),i.close(),delete a.notificationsArrayMessages[t]},i.onclose=function(){"undefined"!=typeof a.notificationsArrayMessages[t]&&delete a.notificationsArrayMessages[t]},this.notificationsArrayMessages[t]=i,this.scheduleNewMessageClose(i,t)}}catch(n){console.log(n)}},this.scheduleNewMessageClose=function(t,e){var s=this;setTimeout(function(){window.webkitNotifications?t.cancel():t.close(),"undefined"!=typeof s.notificationsArrayMessages[e]&&delete s.notificationsArrayMessages[e]},1e4)},this.playSoundNewAction=function(t,e,s,i,a){if(this.backgroundChats.indexOf(parseInt(e))==-1){1!=confLH.new_chat_sound_enabled||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||(this.soundPlayedTimes=0,this.playNewChatAudio()),$("textarea[name=ChatMessage]").is(":focus")||1!=confLH.sn_off&&"flash_on"!=$("#online-offline-user").text()||"pending_chat"!=t&&"transfer_chat"!=t&&"unread_chat"!=t&&"pending_transfered"!=t||this.startBlinking();var n=this;if(("pending_chat"==t||"transfer_chat"==t||"unread_chat"==t||"pending_transfered"==t)&&(1==confLH.sn_off||"flash_on"==$("#online-offline-user").text())&&window.Notification&&"granted"==window.Notification.permission){var o=new Notification(s,{icon:WWW_DIR_JAVASCRIPT_FILES_NOTIFICATION+"/notification.png",body:i,requireInteraction:!0});o.onclick=function(){"pending_chat"==t||"unread_chat"==t||"pending_transfered"==t?$("#tabs").length>0?(window.focus(),n.startChat(e,$("#tabs"),a)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,a),o.close()},"pending_transfered"!=t&&("undefined"!==this.notificationsArray[e]&&o.close(),this.notificationsArray[e]=o)}"transfer_chat"==t&&1==confLH.show_alert_transfer&&confirm(confLH.transLation.transfered+"\n\n"+i)&&n.startChatNewWindowTransferByTransfer(e,a),1==confLH.show_alert&&confirm(confLH.transLation.new_chat+"\n\n"+i)&&("pending_chat"==t||"unread_chat"==t||"pending_transfered"==t?$("#tabs").length>0?(window.focus(),n.startChat(e,$("#tabs"),a)):n.startChatNewWindow(e,"ChatRequest"):n.startChatNewWindowTransferByTransfer(e,a))}},this.syncadmininterfacestatic=function(){try{var t=angular.element("body").scope();t.loadChatList()}catch(e){}},this.addingUserMessage=!1,this.addUserMessageQueue=[],this.addDelayedTimeout=null,this.addmsgadmin=function(t){var e=$("#CSChatMessage-"+t);if(!e.is("[readonly]")){var s={msg:e.val()};if(this.speechHandler!==!1&&this.speechHandler.messageSend(),e.val(""),e.hasClass("edit-mode"))s.msgid=e.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsg/"+t,s,function(i){if("f"==i.error)return e.removeClass("edit-mode"),e.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(i.msg),LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),!0});else{var i=this,a=$("#messagesBlock-"+t);jQuery("<div/>",{"class":"message-row pending-storage",text:s.msg}).appendTo(a),a.stop(!0,!1).animate({scrollTop:a.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurl+t,s,function(e){return LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(t),ee.emitEvent("chatAddMsgAdmin",[t]),""!=e.r&&($("#messagesBlock-"+t).append(e.r),$("#messagesBlock-"+t).stop(!0,!1).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},500)),e.hold_removed===!0?$("#hold-action-"+t).removeClass("btn-info"):e.hold_added===!0&&$("#hold-action-"+t).addClass("btn-info"),lhinst.syncadmincall(),i.addingUserMessage=!1,!0}).fail(function(e){var a='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("Invalid response - "+e.responseText).html()+"</div>";$("#messagesBlock-"+t).append(a),i.addUserMessageQueue.push({pdata:s,url:i.wwwDir+i.addmsgurl+t,chat_id:t,retries:0}),clearTimeout(i.addDelayedTimeout),i.addDelayedTimeout=setTimeout(function(){i.addDelayedMessageAdmin()},50),i.addingUserMessage=!1})):(this.addUserMessageQueue.push({pdata:s,url:this.wwwDir+this.addmsgurl+t,chat_id:t,retries:0}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){i.addDelayedMessageAdmin()},50))}}},this.addDelayedMessageAdmin=function(){var t=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var e=this.addUserMessageQueue.shift();this.addingUserMessage=!0,e.retries=e.retries+1,$.postJSON(e.url,e.pdata,function(s){LHCCallbacks.addmsgadmin&&LHCCallbacks.addmsgadmin(e.chat_id),ee.emitEvent("chatAddMsgAdmin",[e.chat_id]),""!=s.r&&($("#messagesBlock-"+e.chat_id).append(s.r),$("#messagesBlock-"+e.chat_id).animate({scrollTop:$("#messagesBlock-"+e.chat_id).prop("scrollHeight")},500)),lhinst.syncadmincall(),t.addingUserMessage=!1,t.addUserMessageQueue.length>0&&(clearTimeout(t.addDelayedTimeout),t.addDelayedMessageAdmin())}).fail(function(s){var i='<div style="margin:10px 10px 30px 10px;" class="alert alert-warning" role="alert">'+$("<div>").text("Invalid response - "+s.responseText).html()+"</div>";$("#messagesBlock-"+e.chat_id).append(i),e.retries<2&&(t.addUserMessageQueue.unshift(e),t.addingUserMessage=!1,clearTimeout(t.addDelayedTimeout),t.addDelayedTimeout=setTimeout(function(){t.addDelayedMessageAdmin()},500))})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){t.addDelayedMessageAdmin()},50)},this.editPrevious=function(t){var e=$("#CSChatMessage-"+t);""==e.val()&&$.getJSON(this.wwwDir+"chat/editprevious/"+t,function(s){"f"==s.error&&(e.val(s.msg),e.attr("data-msgid",s.id),e.addClass("edit-mode"),$("#msg-"+s.id).addClass("edit-mode"),LHCCallbacks.editPrevious&&LHCCallbacks.editPrevious(t,s))})},this.editPreviousUser=function(){var t=$("#CSChatMessage");""==t.val()&&$.getJSON(this.wwwDir+"chat/editprevioususer/"+this.chat_id+"/"+this.hash,function(e){"f"==e.error&&(t.val(e.msg),t.attr("data-msgid",e.id),t.addClass("edit-mode"),$("#msg-"+e.id).addClass("edit-mode"),LHCCallbacks.editPreviousUser&&LHCCallbacks.editPreviousUser(e))})},this.afterAdminChatInit=function(t){LHCCallbacks.afterAdminChatInit&&LHCCallbacks.afterAdminChatInit(t)},this.afterUserChatInit=function(){LHCCallbacks.afterUserChatInit&&LHCCallbacks.afterUserChatInit()},this.afterChatWidgetInit=function(){LHCCallbacks.afterChatWidgetInit&&LHCCallbacks.afterChatWidgetInit()},this.addAdminChatFinished=function(t,e,s){var i=this,a=jQuery("#CSChatMessage-"+t);new LHCCannedMessageAutoSuggest({chat_id:t,uppercase_enabled:confLH.auto_uppercase});a.bind("keydown","return",function(e){return i.addmsgadmin(t),ee.emitEvent("afterAdminMessageSent",[t]),a[0].rows=2,!1}),a.bind("keyup","up",function(e){i.editPrevious(t)}),a.bind("keyup",function(t){var e=a[0],s=30;for(e.clientHeight/e.rows;e.scrollHeight>e.clientHeight&&!window.opera&&e.rows<s;)e.style.overflow="hidden",e.rows+=1;e.scrollHeight>e.clientHeight&&(e.style.overflow="auto")}),$messageBlock=$("#messagesBlock-"+t),$messageBlock.css("height",this.getLocalValue("lhc_mheight",confLH.defaultm_hegiht)),$messageBlock.data("resized",!1),$messageBlock.data("y",$messageBlock.outerHeight()),$messageBlock.bind("mouseup mousemove",function(t){var e=jQuery(this);e.outerHeight()!=e.data("y")&&(0==e.data("resized")&&(e.css("height","1px"),e.data("resized",!0)),this.resize_timeout&&clearTimeout(this.resize_timeout),this.resize_timeout=setTimeout(function(){i.setLocalValue("lhc_mheight",e.outerHeight()),e.data("y",e.outerHeight())},100))}),this.initTypingMonitoringAdmin(t),this.afterAdminChatInit(t),this.addSynchroChat(t,e),$("#messagesBlock-"+t).animate({scrollTop:$("#messagesBlock-"+t).prop("scrollHeight")},1e3),this.startSyncAdmin(),jQuery("#id_CannedMessageSearch-"+t).keyup(function(e){""!=$(this).val()?jQuery("#id_CannedMessage-"+t).attr("size",10):jQuery("#id_CannedMessage-"+t).removeAttr("size");var s=$(this).val();$.getJSON(i.wwwDir+"chat/getcannedfiltered/"+t,{q:s},function(e){if(0==e.error&&($("#id_CannedMessage-"+t).html(e.result),""!=s)){var i=$("#id_CannedMessage-"+t).find("option");i.length>1&&$(i[1]).attr("selected","selected")}})}),null===s||"object"!=typeof s||s.indexOf("background")===-1?this.hideNotification(t):$("#chat-tab-link-"+t).click(function(){i.removeBackgroundChat(parseInt(t)),i.hideNotification(parseInt(t))});try{localStorage&&1==localStorage.getItem("lhc_rch")&&this.processCollapse(t)}catch(n){}$("#chat-tab-items-"+t+" > li > a").click(function(){ee.emitEvent("adminChatTabSubtabClicked",[t,$(this)])}),ee.emitEvent("adminChatLoaded",[t,e,s])},this.removeBackgroundChat=function(t){var e=this.backgroundChats.indexOf(parseInt(t));e!==-1&&delete this.backgroundChats[e]},this.getLocalValue=function(t,e){try{if(localStorage){var s=localStorage.getItem(t);return null!==s?s:e}}catch(i){}return e},this.setLocalValue=function(t,e){try{localStorage&&localStorage.setItem(t,e)}catch(s){}},this.hideNotification=function(t){t=parseInt(t),"undefined"!=typeof this.notificationsArray[t]&&this.backgroundChats.indexOf(t)==-1&&(this.notificationsArray[t].close(),delete this.notificationsArray[t]),clearTimeout(this.soundIsPlaying)},this.showMyPermissions=function(t){$.get(this.wwwDir+"permission/getpermissionsummary/"+t,function(t){$("#permissions-summary").html(t)})},this.addmsguserchatbox=function(t){var e=!1,s={msg:$("#CSChatMessage").val(),nick:$("#CSChatNick").val()},i=1==this.isWidgetMode?"/(mode)/widget":"";$("#CSChatMessage").val("");var a=this;$.postJSON(this.wwwDir+this.addmsgurluserchatbox+this.chat_id+"/"+this.hash+i+this.appendSyncArgument,s,function(t){"f"==t.error?(LHCCallbacks.addmsguserchatbox&&LHCCallbacks.addmsguserchatbox(a,{chat_id:a.chat_id,data:t}),a.syncusercall()):alert(t.or)}),e!=$("#CSChatNick").val()&&window.postMessage&&parent&&(parent.postMessage("lhc_chb:nick:"+$("#CSChatNick").val(),"*"),e=$("#CSChatNick").val())},this.updateMessageRow=function(t){var e=1==this.isWidgetMode?"/(mode)/widget":"";$.getJSON(this.wwwDir+"chat/getmessage/"+this.chat_id+"/"+this.hash+"/"+t+e,function(e){"f"==e.error&&($("#msg-"+t).replaceWith(e.msg),$("#msg-"+t).addClass("bg-success"),setTimeout(function(){$("#msg-"+t).removeClass("bg-success")},2e3))})},this.updateMessageRowAdmin=function(t,e){$.getJSON(this.wwwDir+"chat/getmessageadmin/"+t+"/"+e,function(t){"f"==t.error&&($("#msg-"+e).replaceWith(t.msg),$("#msg-"+e).addClass("bg-success"),setTimeout(function(){$("#msg-"+e).removeClass("bg-success")},2e3))})},this.addmsguser=function(t){LHCCallbacks.addmsguserbefore&&LHCCallbacks.addmsguserbefore(this);var e=$("#CSChatMessage"),s={msg:e.val()},i=1==this.isWidgetMode?"/(mode)/widget":"";e.val("");var a=this;if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt","")}catch(n){}if(e.hasClass("edit-mode"))s.msgid=e.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsguser/"+this.chat_id+"/"+this.hash+i,s,function(t){if("f"==t.error)return e.removeClass("edit-mode"),e.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(t.msg),!0});else{var o=$("#messagesBlock");jQuery("<div/>",{"class":"message-row pending-storage",text:s.msg}).appendTo(o),o.stop(!0,!1).animate({scrollTop:o.prop("scrollHeight")},500),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i,s,function(t){if("f"==t.error)LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(a,t),a.syncusercall();else{$("#CSChatMessage").val(s.msg);var e=$("#id-operator-typing");e.html(t.r),e.css("visibility","visible"),setTimeout(function(){0==a.operatorTyping&&$("#id-operator-typing").css("visibility","hidden")},3e3)}a.addingUserMessage=!1})):(this.addUserMessageQueue.push({retries:0,pdata:s,url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){a.addDelayedMessage()},50))}"undefined"!=typeof t&&1==t&&e.focus()},this.addMessagesToStore=function(t){for(var e=1==this.isWidgetMode?"/(mode)/widget":"",s=t.length,i=0;i<s;i++)this.addUserMessageQueue.push({retries:0,pdata:{msg:t[i]},url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+e});this.addDelayedMessage()},this.addDelayedMessage=function(){var t=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var e=this.addUserMessageQueue.shift();this.addingUserMessage=!0;var s=[];s.push(e.pdata.msg);for(var i=this.addUserMessageQueue.length,a=0;a<i;a++)s.push(this.addUserMessageQueue[a].pdata.msg);this.addUserMessageQueue=[],$.postJSON(e.url,{msg:s.join("[[msgitm]]")},function(e){"f"==e.error&&(LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(t,e),t.syncusercall()),t.addingUserMessage=!1,t.addUserMessageQueue.length>0&&(clearTimeout(t.addDelayedTimeout),t.addDelayedMessage())})}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout(function(){t.addDelayedMessage()},50)},this.startSyncAdmin=function(){0==this.isSinchronizing&&(this.isSinchronizing=!0,this.syncadmincall())},this.disableChatSoundAdmin=function(t){return"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_admin_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_admin_enabled=0,t.text("volume_off")),!1},this.disableNewChatSoundAdmin=function(t){return"volume_off"==t.text()?($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/1"),confLH.new_chat_sound_enabled=1,t.text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/new_chat_sound/0"),confLH.new_chat_sound_enabled=0,t.text("volume_off")),!1},this.changeUserSettings=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+e)},this.changeUserSettingsIndifferent=function(t,e){$.get(this.wwwDir+"user/setsettingajax/"+t+"/"+encodeURIComponent(e)+"/(indifferent)/true")},this.switchToOfflineForm=function(){var t=$("#form-start-chat");return t.attr("action",$("#form-start-chat").attr("action")+"/(switchform)/true/(offline)/true/(leaveamessage)/true/(department)/"+$("#id_DepartamentID").val()),t.submit(),!1},this.changeStatusAction=function(t,e){var s=this;return $.postJSON(t.attr("action"),t.serialize(),function(t){"false"==t.error?($("#myModal").modal("hide"),s.updateVoteStatus(e),t.is_owner===!0&&($("#CSChatMessage-"+e).attr("placeholder",""),$("#CSChatMessage-"+e).focus())):alert(t.result)}),!1},this.submitModalForm=function(t){return $.post(t.attr("action"),t.serialize(),function(t){$("#myModal").html(t)}),!1},this.disableChatSoundUser=function(t){return"volume_off"==t.find("> i").text()?($.get(this.wwwDir+"user/setsettingajax/chat_message/1"),confLH.new_message_sound_user_enabled=1,t.find("> i").text("volume_up")):($.get(this.wwwDir+"user/setsettingajax/chat_message/0"),confLH.new_message_sound_user_enabled=0,t.find("> i").text("volume_off")),window.postMessage&&parent&&("volume_off"==t.find("> i").text()?parent.postMessage("lhc_ch:s:0","*"):parent.postMessage("lhc_ch:s:1","*")),!1},this.pendingMessagesToStore=[],this.prestartChat=function(t,e){if(0==e.find(".form-protected").length){if(1!=e.attr("lhc-captcha-submitted")){e.attr("lhc-captcha-submitted",1),e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,function(s){e.append('<input type="hidden" value="'+t+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()});var s=1==e.attr("key-up-started");1==s&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val(""))}else $("#messagesBlock").length>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1}if(1==e.find("#hasFormExtraField").length)return!0;if(1!=e.attr("lhc-form-submitted")){e.attr("lhc-form-submitted",1);var i=this,s=1==e.attr("key-up-started");1==s&&e.append('<input type="hidden" value="1" name="keyUpStarted" />'),$.post(e.attr("action"),e.serialize(),function(t){var e=$("#id_Question").val();if(sessionStorage)try{sessionStorage.setItem("lhc_ttxt",e)}catch(s){}var a=($("head > script"),$("head")),n=[];$("head > script").each(function(){var t=$(this);void 0!==t.attr("src")&&n.push(t.attr("src"))}),$("<div>").html(t).find("> script").each(function(){var t=$(this);void 0===t.attr("src")?a.append(t):n.indexOf(t.attr("src"))==-1&&a.append('<script src="'+t.attr("src")+'"></script>')}),paramsDocument="<script>lhinst.addMessagesToStore("+JSON.stringify(i.pendingMessagesToStore)+")</script>",$("#widget-layout").html($("<div>").html(t).find("#widget-layout").html()),$("#widget-layout-js").html($("<div>").html(t).find("#widget-layout-js").html()+paramsDocument)}),0==s&&$("#id_Question").val("")}else $("#messagesBlock").length>0&&(jQuery("<div/>",{"class":"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").stop(!0,!1).animate({scrollTop:$("#messagesBlock").prop("scrollHeight")},500)),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1},this.addCaptcha=function(t,e){return 0!=e.find(".form-protected").length||(e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,function(s){e.append('<input type="hidden" value="'+t+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),e.submit()}),!1)},this.setSubject=function(t,e){$("#subject-message-"+e).text("..."),$.postJSON(this.wwwDir+"chat/subject/"+e+"/(subject)/"+t.val()+"/(status)/"+t.is(":checked"),{update:!0},function(t){lhinst.updateVoteStatus(e),$("#subject-message-"+e).text(t.message)})},this.addCaptchaSubmit=function(t,e){return 0==e.find(".form-protected").length&&(e.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+t,function(s){if(e.append('<input type="hidden" value="'+t+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+t+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),window.FormData)try{var i=new FormData(e[0]),a=new XMLHttpRequest;a.addEventListener("readystatechange",function(t){var e,s,i;try{i=t.target.readyState,s=t.target.responseText,e=t.target.status}catch(n){return}if(4==i&&"200"==e&&t.target.responseText){var o=a.getResponseHeader("Content-Type");o.indexOf("application/json")==-1?$("#widget-content-body").html(t.target.responseText):location.replace(jQuery.parseJSON(t.target.responseText).location)}},!1);var n=e.attr("action");""!=n?a.open("POST",n+"/(ajaxmode)/true",!0):a.open("POST",document.location+"&ajaxmode=true",!0),a.send(i)}catch(o){return!1}else e.submit()}),!1)},this.deleteChatfile=function(t){$.postJSON(this.wwwDir+"file/deletechatfile/"+t,function(e){"false"==e.error?$("#file-id-"+t).remove():alert(e.result)})},this.addFileUserUpload=function(t){$("#fileupload").fileupload({url:this.wwwDir+"file/uploadfile/"+t.chat_id+"/"+t.hash,dataType:"json",add:function(e,s){var i=[],a=t.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(e,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg&&alert(i.result.error_msg),LHCCallbacks.addFileUserUpload&&LHCCallbacks.addFileUserUpload(t.chat_id)},progressall:function(t,e){var s=parseInt(e.loaded/e.total*100,10);$("#id-operator-typing").css("visibility","visible"),$("#id-operator-typing").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUserUploadOnline=function(t,e){var s=this;$("#fileuploadonline").fileupload({url:this.wwwDir+"file/uploadfileonline/"+t.online_user_vid,dataType:"json",add:function(e,s){var i=[],a=t.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){s.updateOnlineFilesUser(t.online_user_vid),e&&e(t.online_user_vid)},progressall:function(t,e){var s=parseInt(e.loaded/e.total*100,10);$("#upload-status-user-online").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.updateChatFiles=function(t){$.postJSON(this.wwwDir+"file/chatfileslist/"+t,function(e){$("#chat-files-list-"+t).html(e.result)})},this.updateOnlineFiles=function(t){$.postJSON(this.wwwDir+"file/onlinefileslist/"+t,function(e){$("#online-user-files-list-"+t).html(e.result)})},this.updateOnlineFilesUser=function(t){$.postJSON(this.wwwDir+"file/useronlinefileslist/"+t,function(t){$("#user-online-files-list").html(t.result)})},this.addFileUpload=function(t){$("#fileupload-"+t.chat_id).fileupload({url:this.wwwDir+"file/uploadfileadmin/"+t.chat_id,dataType:"json",add:function(e,s){var i=[],a=t.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(e,s){var i=s.response();void 0!=i&&void 0!=i.result&&"true"==i.result.error&&void 0!=i.result.error_msg?alert(i.result.error_msg):lhinst.updateChatFiles(t.chat_id),LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(t.chat_id)},dropZone:$("#drop-zone-"+t.chat_id),pasteZone:$("#CSChatMessage-"+t.chat_id),progressall:function(e,s){var i=parseInt(s.loaded/s.total*100,10);$("#user-is-typing-"+t.chat_id).css("visibility","visible"),$("#user-is-typing-"+t.chat_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addFileUploadOnlineUser=function(t,e){var s=this;$("#fileupload-online-user-"+t.online_user_id).fileupload({url:this.wwwDir+"file/uploadfileadminonlineuser/"+t.online_user_id,dataType:"json",add:function(e,s){var i=[],a=t.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(t.ft_msg),s.originalFiles[0].size>t.fs&&i.push(t.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){e&&e(t.online_user_id),s.updateOnlineFiles(t.online_user_id)},dropZone:$("#drop-zone-online-user-"+t.online_user_id),progressall:function(e,s){var i=parseInt(s.loaded/s.total*100,10);$("#upload-status-admin-"+t.online_user_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},this.addExecutionCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addonlineoperation/"+t,{operation:e},function(e){LHCCallbacks.addExecutionCommand&&LHCCallbacks.addExecutionCommand(t)}),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshotOnline(t)},15e3)}},this.addRemoteCommand=function(t,e){if($.postJSON(this.wwwDir+"chat/addoperation/"+t,{operation:e},function(e){LHCCallbacks.addRemoteCommand&&LHCCallbacks.addRemoteCommand(t),"true"==e.error&&null!=e.errors&&alert(e.errors.join("\n"))}),"lhc_screenshot"==e){$("#user-screenshot-container").html("").addClass("screenshot-pending");var s=this;setTimeout(function(){s.updateScreenshot(t)},5e3)}},this.addRemoteOnlineCommand=function(t,e){$.postJSON(this.wwwDir+"chat/addonlineoperationiframe/"+t,{operation:e},function(e){LHCCallbacks.addRemoteOnlineCommand&&LHCCallbacks.addRemoteOnlineCommand(t)})},this.updateScreenshot=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshot/"+t,function(t){$("#user-screenshot-container").html(t),
$("#user-screenshot-container").removeClass("screenshot-pending")})},this.updateScreenshotOnline=function(t){$("#user-screenshot-container").html("").addClass("screenshot-pending"),$.get(this.wwwDir+"chat/checkscreenshotonline/"+t,function(t){$("#user-screenshot-container").html(t),$("#user-screenshot-container").removeClass("screenshot-pending")})},this.eNick=function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/editnick/"+this.chat_id+"/"+this.hash})},this.enableVisitorEditor=function(){$("#CSChatMessage").prop("readonly",!1)},this.disableVisitorEditor=function(){setTimeout(function(){$("#CSChatMessage").prop("readonly",!0)},300)},this.buttonClicked=function(t,e,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash,{payload:t,id:e,processed:"undefined"==typeof i||0==i},function(t){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+e).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.editGenericStep=function(t,e){var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/editgenericstep",{payload:t,id:e},function(t){var e=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:e},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.updateTriggerClicked=function(t,e,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/triggerclicked",{payload:t,id:e,processed:"undefined"==typeof i||0==i},function(t){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+e).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.updateChatClicked=function(t,e,s,i){void 0==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:n},500),lhinst.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/updatebuttonclicked/"+this.chat_id+"/"+this.hash,{payload:t,id:e,processed:"undefined"==typeof i||0==i},function(t){"undefined"!=typeof i&&i!==!1||$(".meta-message-"+e).remove();var s=a.prop("scrollHeight");a.stop(!0,!1).animate({scrollTop:s},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()},this.dropdownClicked=function(t,e){void 0==e.attr("data-no-change")&&(e.attr("disabled","disabled"),e.prepend('<i class="material-icons lhc-spin">loop</i>'));var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),""!=$("#generic_list-"+t).val()?(this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/valueclicked",{payload:$("#id_generic_list-"+t).val(),id:t},function(e){$(".meta-message-"+t).remove();var i=s.prop("scrollHeight");s.stop(!0,!1).animate({scrollTop:i},500),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}).fail(function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()}),lhinst.focusUserText()):alert("Please choose!")},this.focusUserText=function(){$("#CSChatMessage").focus()},this.delayQueue=[],this.delayed=!1,this.setDelay=function(t,e){$("#msg-"+t).addClass("meta-hider message-row-typing").nextUntil("meta-hider").addClass("hide"),0==lhinst.delayed?(lhinst.delayed=!0,setTimeout(function(){lhinst.unhideDelayed(t)},1e3*e),$("#msg-"+t).removeClass("hide"),$("#msg-"+t+" .msg-body").removeClass("hide")):lhinst.delayQueue.push({id:t,delay:e})},this.unhideDelayed=function(t){var e=$("#messagesBlock > #msg-"+t);e.nextUntil(".meta-hider").removeClass("hide"),e.remove();var s=$("#messagesBlock"),i=s.prop("scrollHeight");if(s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.stop(!0,!1).animate({scrollTop:i+2e3},500),this.delayQueue.length>0){var a=lhinst.delayQueue.pop();setTimeout(function(){lhinst.unhideDelayed(a.id)},1e3*a.delay),$("#msg-"+a.id).removeClass("hide"),$("#msg-"+a.id+" .msg-body").removeClass("hide")}else lhinst.delayed=!1},this.gmaps_loading=!1,this.queue_render=[],this.showMessageLocation=function(t,e,s){var i={lat:e,lng:s};if(1==this.gmaps_loaded){var a=new google.maps.Map(document.getElementById("msg-location-"+t),{zoom:13,center:i});new google.maps.Marker({position:i,map:a,title:e+","+s})}else if(0==this.gmaps_loading){this.gmaps_loading=!0;var n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://maps.googleapis.com/maps/api/js?key="+confLH.gmaps_api_key+"&callback=chatMapLoaded";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(n,o),lhinst.queue_render.push({id:t,lat:e,lon:s})}else lhinst.queue_render.push({id:t,lat:e,lon:s})}}function chatMapLoaded(){if(lhinst.queue_render.length>0){lhinst.gmaps_loaded=!0;var t=lhinst.queue_render.pop(),e={lat:t.lat,lng:t.lon},s=new google.maps.Map(document.getElementById("msg-location-"+t.id),{zoom:13,center:e});new google.maps.Marker({position:e,map:s,title:t.lat+","+t.lon});lhinst.queue_render.length>0&&chatMapLoaded()}}function preloadSound(){lhinst.playPreloadSound(),jQuery(document).off("click",preloadSound),jQuery(document).off("touchstart",preloadSound)}function gMapsCallback(){function t(){0==n?c.hasClass("active")?(n=!0,$.ajax({url:WWW_DIR_JAVASCRIPT+"chat/jsononlineusers"+(parseInt($("#id_department_map_id").val())>0?"/(department)/"+parseInt($("#id_department_map_id").val()):"")+(parseInt($("#maxRows").val())>0?"/(maxrows)/"+parseInt($("#maxRows").val()):"")+(parseInt($("#userTimeout").val())>0?"/(timeout)/"+parseInt($("#userTimeout").val()):""),dataType:"json",error:function(){clearTimeout(r),r=setTimeout(function(){t()},1e4)},success:function(s){e(s),n=!1,clearTimeout(r),1==o?(o=!1,t()):r=setTimeout(function(){t()},1e4)}})):r=setTimeout(function(){t()},1e4):o=!0}function e(t){$(t.result).each(function(t,e){if($.inArray(e.Id,d)==-1){var s=new google.maps.LatLng(e.Latitude,e.Longitude),a=new google.maps.Marker({position:s,icon:e.icon,map:i});google.maps.event.addListener(a,"click",function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/getonlineuserinfo/"+e.Id})}),a.setVisible(!0),a.setAnimation(google.maps.Animation.DROP),l[e.Id]=a,d.push(e.Id),clearTimeout(l[e.Id].timeOutMarker),l[e.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(e.Id,d),1),google.maps.event.clearInstanceListeners(l[e.Id]),l[e.Id].setMap(null),l[e.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))}else l[e.Id].setIcon(e.icon),clearTimeout(l[e.Id].timeOutMarker),l[e.Id].timeOutMarker=setTimeout(function(){d.splice($.inArray(e.Id,d),1),google.maps.event.clearInstanceListeners(l[e.Id]),l[e.Id].setMap(null),l[e.Id]=null},1e3*parseInt($("#markerTimeout option:selected").val()))})}lhinst.gmaps_loaded=!0;var s=$("#map_canvas"),i=new google.maps.Map(s[0],{zoom:GeoLocationData.zoom,center:new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,options:{zoomControl:!0,scrollwheel:!0,streetViewControl:!0}}),a=!1,n=!1,o=!1,r=!1;google.maps.event.addListener(i,"idle",t);var c=$("#map-activator"),d=[],l=[];new google.maps.InfoWindow({content:"Loading..."});$("#id_department_map_id").change(function(){t(),lhinst.changeUserSettingsIndifferent("omap_depid",$(this).val())}),$("#markerTimeout").change(function(){t(),lhinst.changeUserSettingsIndifferent("omap_mtimeout",$(this).val())}),$("#map-activator").click(function(){setTimeout(function(){google.maps.event.trigger(i,"resize"),0==a&&(a=!0,i.setCenter(new google.maps.LatLng(GeoLocationData.lat,GeoLocationData.lng)))},500),t()})}function chatsyncuser(){lhinst.syncusercall()}function chatsyncuserpending(){lhinst.chatsyncuserpending()}function chatsyncadmin(){lhinst.syncadmincall()}$.ajaxSetup({crossDomain:!1,cache:!1,beforeSend:function(t,e){csrfSafeMethod(e.type)||t.setRequestHeader("X-CSRFToken",confLH.csrf_token)}}),$.postJSON=function(t,e,s){return $.post(t,e,s,"json")};var LHCCallbacks={},lhinst=new lh;lhinst.playPreloadSound(),jQuery(document).on("click",preloadSound),jQuery(document).on("click",function(){lhinst.hidePopover()}),jQuery(document).on("touchstart",preloadSound),$.fn.makeDropdown=function(){var t=this.find(".btn-block-department-filter > input");this.click(function(){setTimeout(function(){t.focus()},50)}),this.on("click","[data-stopPropagation]",function(t){t.stopPropagation()}),t.keyup(function(){var t=$(this).val();$(this).parent().parent().children("li").each(function(e){e>0&&($(this).text().toLowerCase().includes(t)||""==t?$(this).show():$(this).hide())})})};var focused=!0;window.onfocus=window.onblur=function(t){focused="focus"===(t||event).type,lhinst.focusChanged(focused)},window.lhcSelector=null;