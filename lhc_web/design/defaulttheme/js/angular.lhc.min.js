$(document).ready(function(){var t=window.location.hash;""!=t&&$('ul[role="tablist"] a[href="'+t.replace("#/","#")+'"]').tab("show")});var phonecatApp=angular.module("lhcApp",["lhcAppServices","lhcAppControllers"]),services=angular.module("lhcAppServices",[]),lhcAppControllers=angular.module("lhcAppControllers",["checklist-model"]);angular.element(document).ready(function(){var t=angular.element(document.querySelector("form"));t.triggerHandler("$destroy")}),services.factory("LiveHelperChatFactory",["$http","$q",function(t,e){return this.loadChatList=function(a){var i=e.defer();return t.get(WWW_DIR_JAVASCRIPT+"chat/syncadmininterface"+a).success(function(t){"undefined"!=typeof t.error_url?document.location=t.error_url:i.resolve(t)}).error(function(){i.reject("error")}),i.promise},this.getNotificationsData=function(a){var i=e.defer();return t.get(WWW_DIR_JAVASCRIPT+"chat/getnotificationsdata/(id)"+a).success(function(t){"undefined"!=typeof t.error_url?document.location=t.error_url:i.resolve(t)}).error(function(){i.reject("error")}),i.promise},this.loadInitialData=function(){var a=e.defer();return t.get(WWW_DIR_JAVASCRIPT+"chat/loadinitialdata").success(function(t){"undefined"!=typeof t.error_url?document.location=t.error_url:a.resolve(t)}).error(function(){a.reject("error")}),a.promise},this.loadActiveChats=function(){var a=e.defer();return t.get(WWW_DIR_JAVASCRIPT+"chat/loadactivechats").success(function(t){"undefined"!=typeof t.error_url?document.location=t.error_url:a.resolve(t)}).error(function(){a.reject("error")}),a.promise},this.truncate=function(t,e,a){return isNaN(e)&&(e=10),void 0===a&&(a="..."),t.length<=e||t.length-a.length<=e?t:String(t).substring(0,e-a.length)+a},this}]),lhcAppControllers.controller("LiveHelperChatCtrl",["$scope","$http","$location","$rootScope","$log","$interval","LiveHelperChatFactory",function($scope,$http,$location,$rootScope,$log,$interval,LiveHelperChatFactory){$scope.predicate="last_visit",$scope.pending_chats={},$scope.pending_chats_expanded=!0,$scope.active_chats={},$scope.active_chats_expanded=!0,$scope.my_active_chats_expanded=!0,$scope.closed_chats={},$scope.closed_chats_expanded=!0,$scope.unread_chats={},$scope.unread_chats_expanded=!0,$scope.transfer_dep_chats={},$scope.transfer_chats={},$scope.timeoutControl=null,$scope.setTimeoutEnabled=!0,$scope.lmtoggle=!1,$scope.custom_list_1_expanded=!0,$scope.custom_list_2_expanded=!0,$scope.custom_list_3_expanded=!0,$scope.custom_list_4_expanded=!0;var _that=this;this.restoreLocalSetting=function(t,e,a){try{if(localStorage){var i=localStorage.getItem(t);return null!==i?1==a?i.split("/"):i:e}}catch(o){}return e},this.limita=this.restoreLocalSetting("limita",10,!1),this.limitu=this.restoreLocalSetting("limitu",10,!1),this.limitp=this.restoreLocalSetting("limitp",10,!1),this.limito=this.restoreLocalSetting("limito",10,!1),this.limitc=this.restoreLocalSetting("limitc",10,!1),this.limitd=this.restoreLocalSetting("limitd",10,!1),$scope.lmtoggle="false"!=this.restoreLocalSetting("lmtoggle","false",!1),this.lastidEvent=0,this.userDepartments=[],this.userProductNames=[],this.departmentd=this.restoreLocalSetting("departmentd",[],!0),this.departmentdNames=[],this.operatord=this.restoreLocalSetting("operatord",[],!0),this.operatordNames=[],this.actived=this.restoreLocalSetting("actived",[],!0),this.actived_products=this.restoreLocalSetting("actived_products",[],!0),this.activedNames=[],this.unreadd=this.restoreLocalSetting("unreadd",[],!0),this.unreadd_products=this.restoreLocalSetting("unreadd_products",[],!0),this.unreaddNames=[],this.pendingd=this.restoreLocalSetting("pendingd",[],!0),this.pendingd_products=this.restoreLocalSetting("pendingd_products",[],!0),this.pendingdNames=[],this.closedd=this.restoreLocalSetting("closedd",[],!0),this.closedd_products=this.restoreLocalSetting("closedd_products",[],!0),this.closeddNames=[],this.statusNotifications=[],this.isListLoaded=!1,this.widgetsItems=new Array,this.widgetsItems.push("actived"),this.widgetsItems.push("departmentd"),this.widgetsItems.push("unreadd"),this.widgetsItems.push("pendingd"),this.widgetsItems.push("operatord"),this.widgetsItems.push("closedd"),angular.forEach(this.widgetsItems,function(t){_that[t+"_all_departments"]="false"!=_that.restoreLocalSetting(t+"_all_departments","false",!1),_that[t+"_hide_hidden"]="false"!=_that.restoreLocalSetting(t+"_hide_hidden","false",!1),_that[t+"_hide_disabled"]="false"!=_that.restoreLocalSetting(t+"_hide_disabled","false",!1),_that[t+"_only_online"]="false"!=_that.restoreLocalSetting(t+"_only_online","false",!1),_that[t+"_only_explicit_online"]="false"!=_that.restoreLocalSetting(t+"_only_explicit_online","false",!1)}),this.storeLocalSetting=function(t,e){if(localStorage)try{var e=localStorage.setItem(t,e)}catch(a){}},this.removeLocalSetting=function(t){if(localStorage)try{localStorage.removeItem(t)}catch(e){}},this.toggleList=function(t){if($scope[t]=!$scope[t],localStorage)try{localStorage.setItem(t,$scope[t])}catch(e){}},this.toggleWidgetData=[],this.toggleWidget=function(t,e){if(_that.toggleWidgetData[t]="undefined"!=typeof _that.toggleWidgetData[t]?!_that.toggleWidgetData[t]:!0,localStorage)try{localStorage.setItem(t,_that.toggleWidgetData[t])}catch(a){}"undefined"!=typeof e&&1==e&&$scope.loadChatList()},this.getToggleWidget=function(t){this.toggleWidgetData[t]="false"==this.restoreLocalSetting(t,"false",!1)?!1:!0},$scope.getSyncFilter=function(){var t="/(limita)/"+parseInt(_that.limita);if(t+="/(limitu)/"+parseInt(_that.limitu),t+="/(limitp)/"+parseInt(_that.limitp),t+="/(limito)/"+parseInt(_that.limito),t+="/(limitc)/"+parseInt(_that.limitc),t+="/(limitd)/"+parseInt(_that.limitd),"object"==typeof _that.actived)if(_that.actived.length>0)t+="/(actived)/"+_that.actived.join("/");else{var e=_that.manualFilterByFilter("actived");e.length>0&&(t+="/(actived)/"+e.join("/"))}if("object"==typeof _that.unreadd)if(_that.unreadd.length>0)t+="/(unreadd)/"+_that.unreadd.join("/");else{var e=_that.manualFilterByFilter("unreadd");e.length>0&&(t+="/(unreadd)/"+e.join("/"))}if("object"==typeof _that.pendingd){if(_that.pendingd.length>0)t+="/(pendingd)/"+_that.pendingd.join("/");else{var e=_that.manualFilterByFilter("pendingd");e.length>0&&(t+="/(pendingd)/"+e.join("/"))}"undefined"!=typeof _that.toggleWidgetData.pending_chats_sort&&1==_that.toggleWidgetData.pending_chats_sort&&(t+="/(psort)/asc")}if("object"==typeof _that.operatord)if(_that.operatord.length>0)t+="/(operatord)/"+_that.operatord.join("/");else{var e=_that.manualFilterByFilter("operatord");e.length>0&&(t+="/(operatord)/"+e.join("/"))}if("object"==typeof _that.closedd&&_that.closedd.length>0&&(t+="/(closedd)/"+_that.closedd.join("/")),"object"==typeof _that.departmentd)if(_that.departmentd.length>0)t+="/(departmentd)/"+_that.departmentd.join("/");else{var e=_that.manualFilterByFilter("departmentd");e.length>0&&(t+="/(departmentd)/"+e.join("/"))}return"object"==typeof _that.actived_products&&_that.actived_products.length>0&&(t+="/(activedprod)/"+_that.actived_products.join("/")),"object"==typeof _that.unreadd_products&&_that.unreadd_products.length>0&&(t+="/(unreaddprod)/"+_that.unreadd_products.join("/")),"object"==typeof _that.pendingd_products&&_that.pendingd_products.length>0&&(t+="/(pendingdprod)/"+_that.pendingd_products.join("/")),"object"==typeof _that.closedd_products&&_that.closedd_products.length>0&&(t+="/(closeddprod)/"+_that.closedd_products.join("/")),"undefined"!=typeof _that.toggleWidgetData.track_open_chats&&1==_that.toggleWidgetData.track_open_chats&&(t+="/(topen)/true"),t},$scope.$watch("lhc.limita",function(t,e){t!=e&&(_that.storeLocalSetting("limita",t),$scope.loadChatList())}),this.manualFilterByFilter=function(t){if((1==_that[t+"_only_explicit_online"]||1==_that[t+"_hide_hidden"]||1==_that[t+"_hide_disabled"]||1==_that[t+"_only_online"])&&_that.userDepartments.length>0){var e=[];return angular.forEach(_that.userDepartments,function(a){(0==_that[t+"_only_explicit_online"]||1==_that[t+"_only_explicit_online"]&&1==a.oexp)&&(0==_that[t+"_hide_hidden"]||1==_that[t+"_hide_hidden"]&&0==a.hidden)&&(0==_that[t+"_hide_disabled"]||1==_that[t+"_hide_disabled"]&&0==a.disabled)&&(0==_that[t+"_only_online"]||1==_that[t+"_only_online"]&&1==a.ogen)&&e.push(a.id)}),0==e.length&&e.push(-1),e}return[]},this.setUpListNames=function(t){angular.forEach(t,function(t){_that[t+"Names"]=[],angular.forEach(_that[t],function(e){_that[t+"Names"].push(_that.userDepartmentsNames[e])})})},this.setDepartmentNames=function(t){_that[t+"Names"]=[],angular.forEach(_that[t],function(e){_that[t+"Names"].push(_that.userDepartmentsNames[e])})},this.departmentChanged=function(t){if(_that[t].length>0){_that[t+"_all_departments"]=!1,_that.allDepartmentsChanged(t,!1);var e=_that[t].join("/");""!=e&&(_that.storeLocalSetting(t,e),_that.setDepartmentNames(t))}else if(localStorage)try{localStorage.removeItem(t)}catch(a){}$scope.loadChatList()},this.productChanged=function(t){if(_that[t].length>0){var e=_that[t].join("/");""!=e&&_that.storeLocalSetting(t,e)}else if(localStorage)try{localStorage.removeItem(t)}catch(a){}$scope.loadChatList()},this.allDepartmentsChanged=function(t,e){1==_that[t+"_all_departments"]?_that.storeLocalSetting(t+"_all_departments",!0):_that.removeLocalSetting(t+"_all_departments"),1==_that[t+"_hide_hidden"]?_that.storeLocalSetting(t+"_hide_hidden",!0):_that.removeLocalSetting(t+"_hide_hidden"),1==_that[t+"_hide_disabled"]?_that.storeLocalSetting(t+"_hide_disabled",!0):_that.removeLocalSetting(t+"_hide_disabled"),1==_that[t+"_only_online"]?_that.storeLocalSetting(t+"_only_online",!0):_that.removeLocalSetting(t+"_only_online"),1==_that[t+"_all_departments"]?(_that[t]=[],angular.forEach(_that.userDepartments,function(e){(0==_that[t+"_only_explicit_online"]||1==_that[t+"_only_explicit_online"]&&1==e.oexp)&&(0==_that[t+"_hide_hidden"]||1==_that[t+"_hide_hidden"]&&0==e.hidden)&&(0==_that[t+"_hide_disabled"]||1==_that[t+"_hide_disabled"]&&0==e.disabled)&&(0==_that[t+"_only_online"]||1==_that[t+"_only_online"]&&1==e.ogen)&&_that[t].push(e.id)}),0==_that[t].length&&_that[t].push(-1)):1==e&&(_that[t]=[]),1==e&&$scope.loadChatList()},$scope.$watch("lhc.limitu",function(t,e){t!=e&&(_that.storeLocalSetting("limitu",t),$scope.loadChatList())}),$scope.$watch("lhc.limitc",function(t,e){t!=e&&(_that.storeLocalSetting("limitc",t),$scope.loadChatList())}),$scope.$watch("lhc.limitp",function(t,e){t!=e&&(_that.storeLocalSetting("limitp",t),$scope.loadChatList())}),$scope.$watch("lhc.limito",function(t,e){t!=e&&(_that.storeLocalSetting("limito",t),$scope.loadChatList())}),$scope.loadChatList=function(){if(localStorage)try{$scope.pending_chats_expanded="false"!=localStorage.getItem("pending_chats_expanded"),$scope.active_chats_expanded="false"!=localStorage.getItem("active_chats_expanded"),$scope.my_active_chats_expanded="false"!=localStorage.getItem("my_active_chats_expanded"),$scope.closed_chats_expanded="false"!=localStorage.getItem("closed_chats_expanded"),$scope.unread_chats_expanded="false"!=localStorage.getItem("unread_chats_expanded"),$scope.custom_list_1_expanded="false"!=localStorage.getItem("custom_list_1_expanded"),$scope.custom_list_2_expanded="false"!=localStorage.getItem("custom_list_2_expanded"),$scope.custom_list_3_expanded="false"!=localStorage.getItem("custom_list_3_expanded"),$scope.custom_list_4_expanded="false"!=localStorage.getItem("custom_list_4_expanded")}catch(err){}clearTimeout($scope.timeoutControl),LiveHelperChatFactory.loadChatList($scope.getSyncFilter()).then(function(data){var hasPendingItems=!1,lastNotifiedId=0;if(ee.emitEvent("eventLoadChatList",[data,$scope,_that]),"undefined"==typeof data.items_processed){var notifiedChatsIds=[],currentStatusNotifications=[],chatsToNotify=[],user_id_array="";angular.forEach(data.result,function(t,e){$scope[e]=t,t.last_id_identifier&&(user_id_array+="/"+t.last_id_identifier,chatsToNotify.push(t.last_id_identifier),currentStatusNotifications=[],angular.forEach(t.list,function(e){var a="undefined"!=typeof e.user_id?e.user_id:0,i=e.id+"_"+a;user_id_array+="/"+e.id,currentStatusNotifications.push(i),1==_that.isListLoaded&&"undefined"!=typeof _that.statusNotifications[t.last_id_identifier]&&(-1==_that.statusNotifications[t.last_id_identifier].indexOf(i)&&0==a||-1==_that.statusNotifications[t.last_id_identifier].indexOf(i)&&a==confLH.user_id)&&chatsToNotify.push(e.id)}),_that.statusNotifications[t.last_id_identifier]=currentStatusNotifications)}),/\d/.test(user_id_array)&&LiveHelperChatFactory.getNotificationsData(user_id_array).then(function(t){angular.forEach(t,function(t){lhinst.playSoundNewAction(t.last_id_identifier,parseInt(t.last_id),t.nick?t.nick:"Live Help",t.msg?t.msg:confLH.transLation.new_chat,t.nt,t.uid)})})}else hasPendingItems=data.items_processed_has_pending_items,lastNotifiedId=data.items_processed_last_notified_id;if(0==hasPendingItems&&lhinst.hideNotifications(),0==$scope.pending_chats.length&&clearTimeout(lhinst.soundIsPlaying),"undefined"!=typeof data.ou&&eval(data.ou),"undefined"!=typeof data.fs&&data.fs.length>0&&angular.forEach(data.fs,function(t){lhinst.playSoundNewAction("pending_transfered",parseInt(t.id),t.nick?t.nick:"Live Help",confLH.transLation.transfered,t.nt,t.uid)}),"undefined"!=typeof data.mac&&data.mac.length>0){var tabs=$("#tabs");angular.forEach(data.mac,function(t){lhinst.startChatBackground(t.id,tabs,LiveHelperChatFactory.truncate(t.nick,10),!1)})}1==$scope.setTimeoutEnabled&&($scope.timeoutControl=setTimeout(function(){$scope.loadChatList()},confLH.back_office_sinterval)),_that.isListLoaded=!0},function(t){console.log(t),$scope.timeoutControl=setTimeout(function(){$scope.loadChatList()},confLH.back_office_sinterval)})},this.appendActiveChats=function(){LiveHelperChatFactory.loadActiveChats().then(function(t){var e=$("#tabs");angular.forEach(t.result,function(t){lhinst.startChatBackground(t.id,e,LiveHelperChatFactory.truncate(t.nick,10))}),setTimeout(function(){lhinst.syncadmininterfacestatic()},1e3)})},this.previewChat=function(t){lhc.previewChat(t)},this.redirectContact=function(t,e){return lhinst.redirectContact(t,e)},this.startChatNewWindow=function(t,e){return lhinst.startChatNewWindow(t,e)},this.deleteChat=function(t,e,a){return lhinst.deleteChat(t,e,a)},this.startChat=function(t,e){return $("#tabs").size()>0?lhinst.startChat(t,$("#tabs"),LiveHelperChatFactory.truncate(e,10)):void lhinst.startChatNewWindow(t,e)},this.startChatNewWindowTransfer=function(t,e,a){return lhinst.startChatNewWindowTransfer(t,e,a)},this.startChatTransfer=function(t,e,a){return lhinst.startChatTransfer(t,$("#tabs"),e,a)},this.startChatOperator=function(t){window.open(WWW_DIR_JAVASCRIPT+"chat/startchatwithoperator/"+t,"operatorchatwindow-"+t,"menubar=1,resizable=1,width=780,height=450")},this.initLHCData=function(){LiveHelperChatFactory.loadInitialData().then(function(t){_that.userDepartmentsNames=t.dp_names,_that.userDepartments=t.dep_list,_that.userProductNames=t.pr_names,angular.forEach(_that.widgetsItems,function(t){_that.setDepartmentNames(t)}),$scope.loadChatList()})},this.initLHCData()}]);