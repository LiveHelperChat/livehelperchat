(window.webpackJsonp=window.webpackJsonp||[]).push([[1],[,,,function(t,e,i){var s={"./lhc.speak.js":5,"./lhc.translation.js":6,"./lhc.voice.js":7,"./lhc.voicevisitor.js":8};function n(t){var e=a(t);return i(e)}function a(t){if(!i.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}n.keys=function(){return Object.keys(s)},n.resolve=a,t.exports=n,n.id=3},function(t,e,i){"use strict";function s(t){return(t|=0)<10?`0${t}`:`${Math.min(t,99)}`}function n(){function t(t,e){return new Promise((i,s)=>{const n=new XMLHttpRequest;n.open("GET",t),n.responseType="arraybuffer",n.onload=()=>{i(WebAssembly.instantiate(n.response,e))},n.onerror=s,n.send()})}let e=null,i=5242880;function s(t){const e=i;return i+=t,e}function n(t){postMessage({type:"internal-error",data:t})}let a=null,o=null,r=null;onmessage=i=>{const c=i.data;switch(c.type){case"init":const{wasmURL:i,shimURL:l}=c.data;Promise.resolve().then(()=>(self.WebAssembly&&!function(){const t=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),e=new WebAssembly.Module(t);return 0!==new WebAssembly.Instance(e,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(l),e=new WebAssembly.Memory({initial:256,maximum:256}),{memory:e,pow:Math.pow,exit:n,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:s})).then(e=>function(e,i){if(!WebAssembly.instantiateStreaming)return t(e,i);const s=fetch(e,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(s,i).catch(s=>{if(s.message&&s.message.indexOf("Argument 0 must be provided and must be a Response")>0)return t(e,i);throw s})}(i,{env:e})).then(t=>{a=t.instance.exports,postMessage({type:"init",data:null})}).catch(t=>{postMessage({type:"init-error",data:t.toString()})});break;case"start":if(!function(t){if(o=a.vmsg_init(t),!o)return!1;const i=new Uint32Array(e.buffer,o,1)[0];return r=new Float32Array(e.buffer,i),!0}(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(h=c.data,r.set(h),!(a.vmsg_encode(o,h.length)>=0))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const d=function(){if(a.vmsg_flush(o)<0)return null;const t=new Uint32Array(e.buffer,o+4,1)[0],i=new Uint32Array(e.buffer,o+8,1)[0],s=new Uint8Array(e.buffer,t,i),n=new Blob([s],{type:"audio/mpeg"});return a.vmsg_free(o),o=null,r=null,n}();if(!d)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:d})}var h}}i.r(e),i.d(e,"Recorder",(function(){return a})),i.d(e,"Form",(function(){return o})),i.d(e,"record",(function(){return c}));class a{constructor(t={},e=null){this.wasmURL=new URL(t.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(t.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=e,this.pitch=t.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(t){return navigator.mediaDevices.getUserMedia(t)}:function(t){const e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(i,s){e.call(navigator,t,i,s)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then(t=>{this.stream=t;const e=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),i=e.createMediaStreamSource(t),s=this.gainNode=(e.createGain||e.createGainNode).call(e);s.gain.value=1,i.connect(s);const n=this.pitchFX=new l(e);n.setPitchOffset(this.pitch);const a=this.encNode=(e.createScriptProcessor||e.createJavaScriptNode).call(e,0,1,1);n.output.connect(a),s.connect(0===this.pitch?a:n.input)})}initWorker(){if(!this.stream)throw new Error("missing audio initialization");const t=new Blob(["(",n.toString(),")()"],{type:"application/javascript"}),e=this.workerURL=URL.createObjectURL(t),i=this.worker=new Worker(e),{wasmURL:s,shimURL:a}=this;return i.postMessage({type:"init",data:{wasmURL:s,shimURL:a}}),new Promise((t,e)=>{i.onmessage=i=>{const s=i.data;switch(s.type){case"init":t();break;case"init-error":e(new Error(s.data));break;case"error":case"internal-error":console.error("Worker error:",s.data),this.reject&&this.reject(s.data);break;case"stop":this.blob=s.data,this.blobURL=URL.createObjectURL(s.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}})}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:e})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.worker.postMessage({type:"stop",data:null}),new Promise((t,e)=>{this.resolve=t,this.reject=e})}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach(t=>t.stop())}}class o{constructor(t={},e,i){this.recorder=new a(t,this.onStop.bind(this)),this.resolve=e,this.reject=i,this.backdrop=null,this.popup=null,this.recordBtn=null,this.stopBtn=null,this.timer=null,this.audio=null,this.saveBtn=null,this.tid=0,this.start=0,Object.seal(this),this.recorder.initAudio().then(()=>this.drawInit()).then(()=>this.recorder.initWorker()).then(()=>this.drawAll()).catch(t=>this.drawError(t))}drawInit(){if(this.backdrop)return;const t=this.backdrop=document.createElement("div");t.className="vmsg-backdrop",t.addEventListener("click",()=>this.close(null));const e=this.popup=document.createElement("div");e.className="vmsg-popup",e.addEventListener("click",t=>t.stopPropagation());const i=document.createElement("div");i.className="vmsg-progress";for(let t=0;t<3;t++){const t=document.createElement("div");t.className="vmsg-progress-dot",i.appendChild(t)}e.appendChild(i),t.appendChild(e),document.body.appendChild(t)}drawTime(t){const e=Math.round(t/1e3);this.timer.textContent=s(e/60)+":"+s(e%60)}drawAll(){this.drawInit(),this.clearAll();const t=document.createElement("div");t.className="vmsg-record-row",this.popup.appendChild(t);const e=this.recordBtn=document.createElement("button");e.className="vmsg-button vmsg-record-button",e.textContent="●",e.addEventListener("click",()=>this.startRecording()),t.appendChild(e);const i=this.stopBtn=document.createElement("button");i.className="vmsg-button vmsg-stop-button",i.style.display="none",i.textContent="■",i.addEventListener("click",()=>this.stopRecording()),t.appendChild(i);const s=this.audio=new Audio;s.autoplay=!0;const n=this.timer=document.createElement("span");n.className="vmsg-timer",n.addEventListener("click",()=>{s.paused?this.recorder.blobURL&&(s.src=this.recorder.blobURL):s.pause()}),this.drawTime(0),t.appendChild(n);const a=this.saveBtn=document.createElement("button");a.className="vmsg-button vmsg-save-button",a.textContent="✓",a.disabled=!0,a.addEventListener("click",()=>this.close(this.recorder.blob)),t.appendChild(a);const o=document.createElement("div");o.className="vmsg-slider-wrapper vmsg-gain-slider-wrapper";const r=document.createElement("input");r.className="vmsg-slider vmsg-gain-slider",r.setAttribute("type","range"),r.min=0,r.max=2,r.step=.2,r.value=1,r.onchange=()=>{const t=+r.value;this.recorder.gainNode.gain.value=t},o.appendChild(r),this.popup.appendChild(o);const c=document.createElement("div");c.className="vmsg-slider-wrapper vmsg-pitch-slider-wrapper";const h=document.createElement("input");h.className="vmsg-slider vmsg-pitch-slider",h.setAttribute("type","range"),h.min=-1,h.max=1,h.step=.2,h.value=this.recorder.pitch,h.onchange=()=>{const t=+h.value;this.recorder.pitchFX.setPitchOffset(t),this.recorder.gainNode.disconnect(),this.recorder.gainNode.connect(0===t?this.recorder.encNode:this.recorder.pitchFX.input)},c.appendChild(h),this.popup.appendChild(c)}drawError(t){console.error(t),this.drawInit(),this.clearAll();const e=document.createElement("div");e.className="vmsg-error",e.textContent=t.toString(),this.popup.appendChild(e)}clearAll(){this.popup&&(this.popup.innerHTML="")}close(t){this.audio&&this.audio.pause(),this.tid&&clearTimeout(this.tid),this.recorder.close(),this.backdrop.remove(),t?this.resolve(t):this.reject(new Error("No record made"))}onStop(){this.recordBtn.style.display="",this.stopBtn.style.display="none",this.stopBtn.disabled=!1,this.saveBtn.disabled=!1}startRecording(){this.audio.pause(),this.start=Date.now(),this.updateTime(),this.recordBtn.style.display="none",this.stopBtn.style.display="",this.saveBtn.disabled=!0,this.recorder.startRecording()}stopRecording(){clearTimeout(this.tid),this.tid=0,this.stopBtn.disabled=!0,this.recorder.stopRecording()}updateTime(){this.drawTime(Date.now()-this.start),this.tid=setTimeout(()=>this.updateTime(),300)}}let r=!1;function c(t){return new Promise((e,i)=>{if(r)throw new Error("Record form is already opened");r=!0,new o(t,e,i)}).then(t=>(r=!1,t),t=>{throw r=!1,t})}e.default={Recorder:a,Form:o,record:c};function h(t,e,i,s){for(var n=e*t.sampleRate,a=n+(e-2*i)*t.sampleRate,o=t.createBuffer(1,a,t.sampleRate),r=o.getChannelData(0),c=0;c<n;++c)r[c]=s?(n-c)/a:c/n;for(c=n;c<a;++c)r[c]=0;return o}function l(t){this.context=t;var e=(t.createGain||t.createGainNode).call(t),i=(t.createGain||t.createGainNode).call(t);this.input=e,this.output=i;var s=t.createBufferSource(),n=t.createBufferSource(),a=t.createBufferSource(),o=t.createBufferSource();this.shiftDownBuffer=h(t,.1,.05,!1),this.shiftUpBuffer=h(t,.1,.05,!0),s.buffer=this.shiftDownBuffer,n.buffer=this.shiftDownBuffer,a.buffer=this.shiftUpBuffer,o.buffer=this.shiftUpBuffer,s.loop=!0,n.loop=!0,a.loop=!0,o.loop=!0;var r=(t.createGain||t.createGainNode).call(t),c=(t.createGain||t.createGainNode).call(t),l=(t.createGain||t.createGainNode).call(t);l.gain.value=0;var d=(t.createGain||t.createGainNode).call(t);d.gain.value=0,s.connect(r),n.connect(c),a.connect(l),o.connect(d);var u=(t.createGain||t.createGainNode).call(t),p=(t.createGain||t.createGainNode).call(t),g=(t.createDelay||t.createDelayNode).call(t),m=(t.createDelay||t.createDelayNode).call(t);r.connect(u),c.connect(p),l.connect(u),d.connect(p),u.connect(g.delayTime),p.connect(m.delayTime);var v=t.createBufferSource(),f=t.createBufferSource(),y=function(t,e,i){for(var s=e*t.sampleRate,n=s+(e-2*i)*t.sampleRate,a=t.createBuffer(1,n,t.sampleRate),o=a.getChannelData(0),r=i*t.sampleRate,c=r,h=s-r,l=0;l<s;++l){var d;d=l<c?Math.sqrt(l/r):l>=h?Math.sqrt(1-(l-h)/r):1,o[l]=d}for(l=s;l<n;++l)o[l]=0;return a}(t,.1,.05);v.buffer=y,f.buffer=y,v.loop=!0,f.loop=!0;var w=(t.createGain||t.createGainNode).call(t),b=(t.createGain||t.createGainNode).call(t);w.gain.value=0,b.gain.value=0,v.connect(w.gain),f.connect(b.gain),e.connect(g),e.connect(m),g.connect(w),m.connect(b),w.connect(i),b.connect(i);var _=t.currentTime+.05,R=_+.1-.05;s.start(_),n.start(R),a.start(_),o.start(R),v.start(_),f.start(R),this.mod1=s,this.mod2=n,this.mod1Gain=r,this.mod2Gain=c,this.mod3Gain=l,this.mod4Gain=d,this.modGain1=u,this.modGain2=p,this.fade1=v,this.fade2=f,this.mix1=w,this.mix2=b,this.delay1=g,this.delay2=m,this.setDelay(.1)}l.prototype.setDelay=function(t){this.modGain1.gain.setTargetAtTime(.5*t,0,.01),this.modGain2.gain.setTargetAtTime(.5*t,0,.01)},l.prototype.setPitchOffset=function(t){t>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(t))}},function(t,e){var i=function(){function t(t){this.recognizing=!1,this.startOnEnd=!1,this.final_transcript="",this.chat_id=t.chat_id,this.recognition=t.recognition,this.originText=""!=$("#CSChatMessage-"+this.chat_id).val()?$("#CSChatMessage-"+this.chat_id).val()+" ":""}return t.prototype.onstart=function(){$("#CSChatMessage-"+this.chat_id).addClass("admin-chat-mic"),$("#user-chat-status-"+this.chat_id).removeClass("icon-user").addClass("icon-mic"),$("#mic-chat-"+this.chat_id).addClass("text-danger").find(".mic-lang").text(this.recognition.lang),$("#user-is-typing-"+this.chat_id).html("Speak now.").css("visibility","visible")},t.prototype.onend=function(){$("#user-chat-status-"+this.chat_id).addClass("icon-user").removeClass("icon-mic"),$("#CSChatMessage-"+this.chat_id).removeClass("admin-chat-mic"),$("#mic-chat-"+this.chat_id).removeClass("text-danger").find(".mic-lang").text(""),$("#user-is-typing-"+this.chat_id).html(""),!0===this.startOnEnd&&(this.originText=$("#CSChatMessage-"+this.chat_id).val(),this.final_transcript="",this.startOnEnd=!1,this.recognition.start())},t.prototype.onerror=function(t){"no-speech"==t.error&&$("#user-is-typing-"+this.chat_id).html("No speech was detected.").css("visibility","visible"),"audio-capture"==t.error&&$("#user-is-typing-"+this.chat_id).html("No microphone was found.").css("visibility","visible"),"not-allowed"==t.error&&$("#user-is-typing-"+this.chat_id).html("Permission to use microphone was denied.").css("visibility","visible")},t.prototype.onresult=function(t){if(!1===this.startOnEnd){for(var e="",i=t.resultIndex;i<t.results.length;++i)t.results[i].isFinal?this.final_transcript+=t.results[i][0].transcript:e+=t.results[i][0].transcript;""!=e?$("#user-is-typing-"+this.chat_id).html(e).css("visibility","visible"):$("#user-is-typing-"+this.chat_id).html("").css("visibility","hidden"),$("#CSChatMessage-"+this.chat_id).val(this.originText+this.final_transcript+e).focus(),ee.emitEvent("afterSpeechToTextCallbackResult",[this.chat_id,this.originText+this.final_transcript+e]),lhinst.operatorTypingCallback(this.chat_id)}},t}();t.exports=function(){function t(){"webkitSpeechRecognition"in window?(this.recognizing=!1,this.browserSupported=!0,this.final_transcript="",this.chat_id=!1,this.chatDialect=[]):(alert("Sorry but only chrome is supported"),this.browserSupported=!1)}return t.prototype.stopSpeech=function(){!0===this.browserSupported&&!0===this.recognizing&&(this.recognizing=!1,this.recognition.stop())},t.prototype.messageSend=function(){!0===this.browserSupported&&(this.recognition.callbackHandler.startOnEnd=!0,this.recognition.stop())},t.prototype.setChatDialect=function(t,e){this.chatDialect[t]=e},t.prototype.getChatDialectAndStart=function(){var t=this;$.getJSON(WWW_DIR_JAVASCRIPT+"speech/getchatdialect/"+this.chat_id,(function(e){!1===e.error?(t.chatDialect[t.chat_id]=e.dialect,t.recognition.lang=t.chatDialect[t.chat_id],t.recognition.start()):alert(e.result)}))},t.prototype.getDialect=function(t){$.get(WWW_DIR_JAVASCRIPT+"speech/getdialect/"+t.val(),(function(t){$("#id_select_dialect").replaceWith(t)}))},t.prototype.setChatLanguageRecognition=function(t){return $.postJSON(WWW_DIR_JAVASCRIPT+"speech/setchatspeechlanguage/"+t.chat_id,{select_language:$("#id_select_language").val(),select_dialect:$("#id_select_dialect").val()},(function(e){"false"==e.error&&(!1!==t.lhinst.speechHandler&&t.lhinst.speechHandler.setChatDialect(t.chat_id,e.dialect),$("#myModal").modal("hide"))})),!1},t.prototype.listen=function(t){if(!0===this.browserSupported){var e=this;if(!1!==this.chat_id&&this.chat_id!=t.chat_id?($("#CSChatMessage-"+this.chat_id).unbind("input propertychange",(function(){})),this.stopSpeech()):$("#CSChatMessage-"+t.chat_id).bind("input propertychange",(function(){e.messageSend()})),this.chat_id=t.chat_id,!1===this.recognizing){this.recognition=new webkitSpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!0;var s=new i({chat_id:this.chat_id,recognition:this.recognition});this.recognition.onresult=function(t){s.onresult(t)},this.recognition.onstart=function(){s.onstart()},this.recognition.onend=function(){s.onend()},this.recognition.onerror=function(t){s.onerror(t)},this.recognition.callbackHandler=s,this.recognizing=!0,null!=this.chatDialect[this.chat_id]?(this.recognition.lang=this.chatDialect[this.chat_id],this.recognition.start()):this.getChatDialectAndStart(),!1===lhinst.speechHandler&&(lhinst.speechHandler=this)}else this.stopSpeech(),lhinst.speechHandler=!1}},new t}()},function(t,e){t.exports=function(){function t(){}return t.prototype.startTranslation=function(t){t.btn.prop("disabled","disabled"),t.btn.button("loading"),jQuery.getJSON(WWW_DIR_JAVASCRIPT+"translation/starttranslation/"+t.chat_id+"/"+jQuery("#id_chat_locale_"+t.chat_id).val()+"/"+jQuery("#id_chat_locale_to_"+t.chat_id).val(),(function(e){jQuery("#main-user-info-translation-"+t.chat_id+" > div.alert").remove(),jQuery("#main-user-info-translation-"+t.chat_id).prepend(e.result),!1===e.error?!0===e.translation_status?(jQuery("#id_chat_locale_"+t.chat_id+' option[value="'+e.chat_locale+'"]').prop("selected",!0),jQuery("#id_chat_locale_to_"+t.chat_id+' option[value="'+e.chat_locale_to+'"]').prop("selected",!0),jQuery("#messagesBlock-"+t.chat_id).html(""),lhinst.updateChatLastMessageID(t.chat_id,0),lhinst.syncadmincall(),jQuery(".translate-button-"+t.chat_id).addClass("btn-success")):(jQuery(".translate-button-"+t.chat_id).removeClass("btn-success"),jQuery("#id_chat_locale_"+t.chat_id+' option[value="0"]').prop("selected",!0),jQuery("#id_chat_locale_to_"+t.chat_id+' option[value="0"]').prop("selected",!0)):jQuery("#chat-tab-items-"+t.chat_id+' a[href="#main-user-info-translation-'+t.chat_id+'"]').tab("show"),t.btn.button("reset"),t.btn.prop("disabled","")}))},new t}()},function(t,e,i){t.exports=function(){const t=new(new i(4).Recorder)({wasmURL:window.WWW_DIR_LHC_WEBPACK+"/vmsg.8c4a15f2.wasm",shimURL:"https://unpkg.com/wasm-polyfill.js@0.2.0/wasm-polyfill.js"});function e(){this.recording=null,this.audio=null,this.chat_id=null,this.isRecording=!1,this.isPlaying=!1,this.isLoading=!1,this.audioDuration=0,this.currentTime=0,this.durationInterval=null,this.playInterval=null}return e.prototype.setStateElement=function(t,e){!0===e?$("#voice-chat-"+this.chat_id+" ."+t).show():$("#voice-chat-"+this.chat_id+" ."+t).hide()},e.prototype.updateUIByState=function(){this.setStateElement("voice-start-recording",!1===this.isRecording),this.setStateElement("voice-stop-recording",!0===this.isRecording),this.setStateElement("voice-play-recording",null!==this.recording&&!1===this.isPlaying),this.setStateElement("voice-stop-play",null!==this.recording&&!0===this.isPlaying),this.setStateElement("voice-send-message",null!==this.recording),!0===this.isRecording||null!==this.recording&&!1===this.isPlaying?$("#voice-chat-"+this.chat_id+" .voice-audio-status").text(this.audioDuration+"s."):!0===this.isPlaying&&$("#voice-chat-"+this.chat_id+" .voice-audio-status").text(this.currentTime+"s.")},e.prototype.startedRecording=function(){$("#CSChatMessage-"+this.chat_id).addClass("admin-chat-mic"),$("#user-chat-status-"+this.chat_id).removeClass("icon-user").addClass("icon-mic"),$("#user-is-typing-"+this.chat_id).html("Speak now.").css("visibility","visible")},e.prototype.stoppedRecording=function(){$("#user-chat-status-"+this.chat_id).addClass("icon-user").removeClass("icon-mic"),$("#CSChatMessage-"+this.chat_id).removeClass("admin-chat-mic"),$("#user-is-typing-"+this.chat_id).html("")},e.prototype.startRecording=async function(){this.stopPlayRecord(),this.audioDuration=0,this.recording=null,this.isPlaying=!1,this.currentTime=0;try{await t.initAudio(),await t.initWorker(),t.startRecording(),this.isRecording=!0,this.startedRecording(),this.durationInterval=setInterval(()=>{this.audioDuration++,this.updateUIByState()},1e3),this.updateUIByState()}catch(t){alert("Sorry but voice messages are not supported on your browser!")}},e.prototype.stopRecording=async function(){const e=await t.stopRecording();this.recording=e,this.audio=new Audio,this.audio.src=URL.createObjectURL(e),this.isRecording=!1,this.stoppedRecording(),clearInterval(this.durationInterval),this.updateUIByState()},e.prototype.playRecord=function(){this.audio.currentTime=0,this.audio.play(),this.isPlaying=!0,this.currentTime=0,this.playInterval=setInterval(()=>{this.currentTime=Math.round(this.audio.currentTime),(this.audio.ended||this.audio.paused)&&this.stopPlayRecord(),this.updateUIByState()},1e3),this.updateUIByState()},e.prototype.stopPlayRecord=function(){!0===this.isPlaying&&(clearInterval(this.playInterval),this.audio.currentTime=0,this.audio.pause(),this.isPlaying=!1),this.updateUIByState()},e.prototype.prepareUIForRecording=function(){this.recording=null,this.isRecording=!1,this.isPlaying=!1,this.isLoading=!1,$("#voice-chat-"+this.chat_id+" .go-to-voice").hide(),$("#voice-chat-"+this.chat_id+" .voice-ui").html('<i class="leave-recording-ui material-icons pointer text-danger mr-0 fs25" title="Cancel">close</i> | <i class="voice-start-recording material-icons fs25 pointer text-danger mr-0" title="Start recording">fiber_manual_record</i><i style="display: none" class="voice-stop-recording material-icons fs25 pointer text-danger mr-0" title="Stop recording">stop</i><i style="display: none" class="voice-play-recording material-icons pointer text-success mr-0 fs25" title="Play recorded audio">play_arrow</i><i style="display: none" class="voice-stop-play material-icons pointer text-success mr-0 fs25" title="Stop playing recorded">stop</i><span class="voice-audio-status mr-0 fs11">0s.</span><span style="display: none;" class="ml-1 voice-send-message" > | <i class="material-icons text-success mr-0" title="Send voice message">send</i></span>');var t=this;$("#voice-chat-"+this.chat_id+" .leave-recording-ui").click((function(e){t.leaveVoiceUI(),e.preventDefault(),e.stopPropagation()})),$("#voice-chat-"+this.chat_id+" .voice-start-recording").click((function(e){t.startRecording(),e.preventDefault(),e.stopPropagation()})),$("#voice-chat-"+this.chat_id+" .voice-stop-recording").click((function(e){t.stopRecording(),e.preventDefault(),e.stopPropagation()})),$("#voice-chat-"+this.chat_id+" .voice-play-recording").click((function(e){t.playRecord(),e.preventDefault(),e.stopPropagation()})),$("#voice-chat-"+this.chat_id+" .voice-stop-play").click((function(e){t.stopPlayRecord(),e.preventDefault(),e.stopPropagation()})),$("#voice-chat-"+this.chat_id+" .voice-send-message").click((function(e){t.sendVoiceMessage(),e.preventDefault(),e.stopPropagation()}))},e.prototype.sendVoiceMessage=function(){const t=new XMLHttpRequest,e=new FormData;e.append("files[]",this.recording,"record.mp3"),t.open("POST",WWW_DIR_JAVASCRIPT+"/file/uploadfileadmin/"+this.chat_id),t.upload.addEventListener("load",t=>{this.leaveVoiceUI(),lhinst.updateChatFiles(this.chat_id),lhinst.syncadmincall(),LHCCallbacks.addFileUpload&&LHCCallbacks.addFileUpload(this.chat_id)}),t.send(e)},e.prototype.leaveVoiceUI=function(){$("#voice-chat-"+this.chat_id+" .go-to-voice").show(),$("#voice-chat-"+this.chat_id+" .voice-ui").html(""),this.isRecording&&t.stopRecording(),this.stopPlayRecord(),this.stoppedRecording(),this.recording=null,this.audio=null},e.prototype.listen=function(t){this.chat_id=t.chat_id,this.prepareUIForRecording()},new e}()},function(t,e,i){t.exports=function(){const t=new(new i(4).Recorder)({wasmURL:window.WWW_DIR_LHC_WEBPACK+"/vmsg.8c4a15f2.wasm",shimURL:"https://unpkg.com/wasm-polyfill.js@0.2.0/wasm-polyfill.js"});function e(){this.recording=null,this.audio=null,this.chat_id=null,this.hash=null,this.isRecording=!1,this.isPlaying=!1,this.isLoading=!1,this.audioDuration=0,this.currentTime=0,this.durationInterval=null,this.playInterval=null,this.initialized=!1,this.length=30}return e.prototype.setStateElement=function(t,e){!0===e?$("#voice-control-message ."+t).show():$("#voice-control-message ."+t).hide()},e.prototype.updateUIByState=function(){this.setStateElement("voice-start-recording",!1===this.isRecording),this.setStateElement("voice-stop-recording",!0===this.isRecording),this.setStateElement("voice-play-recording",null!==this.recording&&!1===this.isPlaying),this.setStateElement("voice-stop-play",null!==this.recording&&!0===this.isPlaying),this.setStateElement("voice-send-message",null!==this.recording),!0===this.isRecording||null!==this.recording&&!1===this.isPlaying?$(".voice-audio-status").text((!0===this.isRecording?this.length-this.audioDuration:this.audioDuration)+"s."):!0===this.isPlaying?$(".voice-audio-status").text(this.currentTime+"s."):$(".voice-audio-status").text("0s.")},e.prototype.startRecording=async function(){this.stopPlayRecord(),this.audioDuration=0,this.recording=null,this.isPlaying=!1,this.currentTime=0;try{await t.initAudio(),await t.initWorker(),t.startRecording(),this.isRecording=!0,this.durationInterval=setInterval(()=>{this.audioDuration++,this.audioDuration>=this.length&&this.stopRecording(),this.updateUIByState()},1e3),this.updateUIByState()}catch(t){console.log(t),alert("Sorry but voice messages are not supported on your browser!")}},e.prototype.stopRecording=async function(){const e=await t.stopRecording();this.recording=e,this.audio=new Audio,this.audio.src=URL.createObjectURL(e),this.isRecording=!1,clearInterval(this.durationInterval),this.updateUIByState()},e.prototype.playRecord=function(){this.audio.currentTime=0,this.audio.play(),this.isPlaying=!0,this.currentTime=0,this.playInterval=setInterval(()=>{this.currentTime=Math.round(this.audio.currentTime),(this.audio.ended||this.audio.paused)&&this.stopPlayRecord(),this.updateUIByState()},1e3),this.updateUIByState()},e.prototype.stopPlayRecord=function(){!0===this.isPlaying&&(clearInterval(this.playInterval),this.audio.currentTime=0,this.audio.pause(),this.isPlaying=!1),this.updateUIByState()},e.prototype.prepareUIForRecording=function(){this.recording=null,this.isRecording=!1,this.isPlaying=!1,this.isLoading=!1,this.audioDuration=0,this.currentTime=0,$("#lhc-mic-icon").hide(),$("#voice-control-message").show(),this.updateUIByState();var t=this;!1===this.initialized&&(this.initialized=!0,$("#voice-control-message .leave-recording-ui").click((function(e){t.leaveVoiceUI(),e.preventDefault(),e.stopPropagation()})),$("#voice-control-message .voice-start-recording").click((function(e){t.startRecording(),e.preventDefault(),e.stopPropagation()})),$("#voice-control-message .voice-stop-recording").click((function(e){t.stopRecording(),e.preventDefault(),e.stopPropagation()})),$("#voice-control-message .voice-play-recording").click((function(e){t.playRecord(),e.preventDefault(),e.stopPropagation()})),$("#voice-control-message .voice-stop-play").click((function(e){t.stopPlayRecord(),e.preventDefault(),e.stopPropagation()})),$("#voice-control-message .voice-send-message").click((function(e){t.sendVoiceMessage(),e.preventDefault(),e.stopPropagation()})))},e.prototype.sendVoiceMessage=function(){const t=new XMLHttpRequest,e=new FormData;e.append("files",this.recording,"record.mp3"),t.open("POST",WWW_DIR_JAVASCRIPT+"/file/uploadfile/"+this.chat_id+"/"+this.hash),t.upload.addEventListener("load",t=>{this.leaveVoiceUI(),lhinst.syncusercall()}),t.send(e)},e.prototype.leaveVoiceUI=function(){$("#lhc-mic-icon").show(),$("#voice-control-message").hide(),this.isRecording&&t.stopRecording(),this.stopPlayRecord(),this.recording=null,this.audio=null},e.prototype.listen=function(t){this.chat_id=t.chat_id,this.hash=t.hash,this.length=t.length,this.prepareUIForRecording()},new e}()}]]);