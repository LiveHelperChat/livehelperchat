var LHCCannedMessageAutoSuggest=function(){function e(e){this.chat_id=e.chat_id,this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null,this.nextUppercase=!1,this.nextUppercasePos=0,this.nextUppercaseCallback=null,this.nextUppercaseEnabled=void 0===e.uppercase_enabled||1==e.uppercase_enabled,this.currentRequest=null,this.cacheCanned={},this.htmlPreviewTimeout=null;var t=this;this.textarea=jQuery("#CSChatMessage-"+this.chat_id),this.textarea.bind("keyup",function(e){if(1==t.nextUppercaseEnabled&&(1==t.nextUppercase?(clearTimeout(t.nextUppercaseCallback),t.nextUppercaseCallback=setTimeout(function(){t.capitalizeSentences(e)},50)):t.capitalizeSentences(e)),"#"==e.key||51==e.keyCode||222==e.keyCode)t.currentText=t.textarea.val(),t.showSuggester();else if(32==e.keyCode&&1==t.suggesting)t.stopSuggesting();else if(1==t.suggesting&&38!=e.keyCode&&40!=e.keyCode&&39!=e.keyCode&&37!=e.keyCode&&13!=e.keyCode)t.currentText!==t.textarea.val()&&(t.showSuggester(),t.currentText=t.textarea.val());else if(1!=t.suggesting||37!=e.keyCode&&39!=e.keyCode||!1!==t.cannedMode)0!=t.suggesting||39!=e.keyCode&&37!=e.keyCode&&8!=e.keyCode||null!==t.extractKeyword()&&t.showSuggester();else{t.currentKeword!==t.extractKeyword()&&t.showSuggester()}}),this.textarea.bind("keydown",function(e){if(1==t.suggesting)if(38==e.keyCode)t.moveAction("up"),e.preventDefault(),e.stopImmediatePropagation();else if(40==e.keyCode)t.moveAction("down"),e.preventDefault();else if(39!=e.keyCode&&37!=e.keyCode||!0!==t.cannedMode)39!=e.keyCode&&13!=e.keyCode||(!1===t.cannedMode?$("#canned-hash-"+t.chat_id+" > li.current-item a").trigger("click"):$("#canned-hash-current-"+t.chat_id+" li.current-item > span.canned-msg").trigger("click"),e.preventDefault(),e.stopImmediatePropagation());else{var r=$("#canned-hash-current-"+t.chat_id+" li.current-item").parent().parent().index();0==r&&37==e.keyCode&&($("#canned-hash-current-"+t.chat_id+" li.current-item > span.left-return").trigger("click"),e.preventDefault(),e.stopImmediatePropagation());var n=$("#canned-hash-current-"+t.chat_id+" .list-sub-items > li").length;if(0==n)$("#canned-hash-current-"+t.chat_id+" li.current-item > span.canned-msg").trigger("click");else{var a=$("#canned-hash-current-"+t.chat_id+" li.current-item").index();if($("#canned-hash-current-"+t.chat_id+" li.current-item").removeClass("current-item"),39==e.keyCode){var i=0;n-1>=r+1&&(i=r+1);var s=$("#canned-hash-current-"+t.chat_id+" > ul > li:eq("+i+") > ul"),c=0;s.find("> li").length-1>=a&&(c=a),t.renderPreview(s.find(" > li:eq("+c+")").addClass("current-item"))}else 37==e.keyCode&&t.renderPreview($("#canned-hash-current-"+t.chat_id+" > ul > li:eq("+(r-1)+") > ul > li:eq("+a+")").addClass("current-item"))}e.preventDefault(),e.stopImmediatePropagation()}})}return e.prototype.capitalizeSentences=function(e){var t=this.textarea.val(),r=t,n=this.textarea[0].selectionStart;if(8!=e.keyCode&&46!=e.keyCode){if(t.length<=3&&(r=r.replace(r.charAt(0),r.charAt(0).toUpperCase())),1==this.nextUppercase&&(r=r.substr(0,this.nextUppercasePos)+r.charAt(this.nextUppercasePos).toUpperCase()+r.substr(this.nextUppercasePos+1))," "!=t.charAt(n-1)||"."!=t.charAt(n-2)&&"?"!=t.charAt(n-2)&&"!"!=t.charAt(n-2)||t.length!=n?1==this.nextUppercase&&(this.nextUppercase=!1):(this.nextUppercase=!0,this.nextUppercasePos=n),"en"==confLH.content_language&&(r=r.replace(/\si\s/g," I ")),r!=t)if(this.textarea.val(r),"selectionStart"in this.textarea[0])this.textarea[0].selectionStart=n,this.textarea[0].selectionEnd=n;else if(this.textarea[0].setSelectionRange)this.textarea[0].setSelectionRange(n,n);else if(this.textarea[0].createTextRange){var a=this.textarea[0].createTextRange();a.collapse(!0),a.moveEnd("character",n),a.moveStart("character",n),a.select()}}else this.nextUppercase=!1},e.prototype.moveAction=function(e){if(!1===this.cannedMode)var t=$("#canned-hash-"+this.chat_id+" > li.current-item");else t=$("#canned-hash-current-"+this.chat_id+" li.current-item");if(0!=t.length){if("up"==e){var r=t.prev();r.is("li")?(t.removeClass("current-item"),t=r.addClass("current-item")):t=t.removeClass("current-item").parent().find(" > li").last().addClass("current-item")}else if("down"==e){var n=t.next();n.is("li")?(t.removeClass("current-item"),t=n.addClass("current-item")):t=t.removeClass("current-item").parent().find(" > li").first().addClass("current-item")}!0===this.cannedMode&&this.renderPreview(t)}},e.prototype.isVisible=function(e,t,r){return e.height()+e.offset().top>=t.offset().top+r.threshold&&t.offset().top>e.offset().top-r.threshold},e.prototype.renderPreview=function(e){var t=e.find("> .canned-msg").attr("data-msg");clearTimeout(this.htmlPreviewTimeout);var r=this;void 0!==t?(this.isVisible($("#canned-hash-current-"+this.chat_id),e,{threshold:10})||e[0].scrollIntoView(),0==(e=$("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview")).length&&($("#canned-hash-current-"+this.chat_id).parent().prepend('<div class="canned-msg-preview"></div>'),e=$("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview")),e.html(t),this.htmlPreviewTimeout=setTimeout(function(){$.post(WWW_DIR_JAVASCRIPT+"chat/previewmessage/"+r.chat_id,{msg_body:!0,msg:t},function(t){e.html(t)})},300)):$("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview").remove()},e.prototype.stopSuggesting=function(){this.textarea.parent().find(".canned-suggester").remove(),this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null},e.prototype.extractKeyword=function(){var e=this.textarea[0].selectionStart;currentValue=this.textarea.val();var t="";for(i=e;i>0;i--){if(char=currentValue.substring(i-1,i)," "==char)return this.currentKeword=null,null;if("#"==char)return this.currentKeword=t,t;t=char+t}return this.currentKeword=null,null},this.timeoutRequest=null,e.prototype.showSuggester=function(){var e=this;this.extractKeyword(),this.cannedMode=!1,clearTimeout(this.timeoutRequest),null!==this.currentKeword?(this.suggesting=!0,this.timeoutRequest=setTimeout(function(){null!=e.currentRequest&&(e.currentRequest.abort(),e.currentRequest=null);var t=!1,r=null;e.currentKeword.length<3&&(t=!0,void 0!==e.cacheCanned[e.currentKeword]&&(r=e.cacheCanned[e.currentKeword])),null!==r?(e.textarea.parent().find(".canned-suggester").remove(),e.textarea.before(r),e.initSuggester()):e.currentRequest=$.getJSON(WWW_DIR_JAVASCRIPT+"cannedmsg/showsuggester/"+e.chat_id,{keyword:e.currentKeword},function(r){e.textarea.parent().find(".canned-suggester").remove(),e.textarea.before(r.result),e.initSuggester(),1==t&&(e.cacheCanned[e.currentKeword]=r.result)})},130)):this.stopSuggesting()},e.prototype.initSuggester=function(){var e=this,t=$("#canned-hash-"+this.chat_id+" > li:last-child").addClass("current-item");$("#canned-hash-"+this.chat_id+" > li > a").click(function(){e.cannedMode=!0;var t=$("#canned-hash-current-"+e.chat_id);t.html("").show(),$(this).parent().find("ul.list-sub-items").clone().appendTo(t),e.renderPreview(t.find("ul > li:first-child > ul > li:first-child").addClass("current-item"));var r=$(this).parent().parent();r.hide(),t.find("span.canned-msg").mouseover(function(){e.renderPreview($(this).parent()),$("#canned-hash-current-"+e.chat_id+" li.current-item").removeClass("current-item"),$(this).parent().addClass("current-item")}),t.find("span.canned-msg").click(function(){var t=e.textarea[0].selectionStart,r=e.textarea.val(),n=$(this).attr("data-msg"),a=r.substring(0,t),i=a.lastIndexOf("#");if(a=a.substring(0,i)+n,e.textarea.val(a+r.substring(t)),"selectionStart"in e.textarea[0])e.textarea[0].selectionStart=a.length,e.textarea[0].selectionEnd=a.length;else if(e.textarea[0].setSelectionRange)e.textarea[0].setSelectionRange(a.length,a.length);else if(e.textarea[0].createTextRange){var s=e.textarea[0].createTextRange();s.collapse(!0),s.moveEnd("character",a.length),s.moveStart("character",a.length),s.select()}e.textarea[0].focus(),e.stopSuggesting()}),t.find("span.left-return").click(function(){r.show(),t.html("").hide(),t.parent().find(".canned-msg-preview").remove(),e.cannedMode=!1})}),1==$("#canned-hash-"+this.chat_id+" > li").length?$("#canned-hash-"+this.chat_id+" > li > a").trigger("click"):this.renderPreview(t)},e}();