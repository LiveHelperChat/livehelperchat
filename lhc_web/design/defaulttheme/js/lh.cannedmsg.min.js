var LHCCannedMessageAutoSuggest=function(){function e(e){this.chat_id=e.chat_id,this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null,this.nextUppercase=!1,this.nextUppercasePos=0,this.nextUppercaseCallback=null,this.nextUppercaseEnabled="undefined"==typeof e.uppercase_enabled||1==e.uppercase_enabled,this.currentRequest=null;var t=this;this.textarea=jQuery("#CSChatMessage-"+this.chat_id),this.textarea.bind("keyup",function(e){if(1==t.nextUppercaseEnabled&&(1==t.nextUppercase?(clearTimeout(t.nextUppercaseCallback),t.nextUppercaseCallback=setTimeout(function(){t.capitalizeSentences(e)},50)):t.capitalizeSentences(e)),"#"==e.key||51==e.keyCode||222==e.keyCode)t.currentText=t.textarea.val(),t.showSuggester();else if(32==e.keyCode&&1==t.suggesting)t.stopSuggesting();else if(1==t.suggesting&&38!=e.keyCode&&40!=e.keyCode&&39!=e.keyCode&&37!=e.keyCode&&13!=e.keyCode)t.currentText!==t.textarea.val()&&(t.showSuggester(),t.currentText=t.textarea.val());else if(1!=t.suggesting||37!=e.keyCode&&39!=e.keyCode||t.cannedMode!==!1)0!=t.suggesting||39!=e.keyCode&&37!=e.keyCode&&8!=e.keyCode||null!==t.extractKeyword()&&t.showSuggester();else{var n=t.currentKeword;n!==t.extractKeyword()&&t.showSuggester()}}),this.textarea.bind("keydown",function(e){1==t.suggesting&&(38==e.keyCode?(t.moveAction("up"),e.preventDefault(),e.stopImmediatePropagation()):40==e.keyCode?(t.moveAction("down"),e.preventDefault()):39==e.keyCode||13==e.keyCode?(t.cannedMode===!1?$("#canned-hash-"+t.chat_id+" > li.current-item a").trigger("click"):$("#canned-hash-current-"+t.chat_id+" > ul > li.current-item > span.canned-msg").trigger("click"),e.preventDefault(),e.stopImmediatePropagation()):37==e.keyCode&&t.cannedMode===!0&&($("#canned-hash-current-"+t.chat_id+" > ul > li.current-item > span.left-return").trigger("click"),e.preventDefault(),e.stopImmediatePropagation()))})}return e.prototype.capitalizeSentences=function(e){var t=this.textarea.val(),n=t,a=this.textarea[0].selectionStart;if(8==e.keyCode||46==e.keyCode)return void(this.nextUppercase=!1);if(t.length<=3&&(n=n.replace(n.charAt(0),n.charAt(0).toUpperCase())),1==this.nextUppercase&&(n=n.substr(0,this.nextUppercasePos)+n.charAt(this.nextUppercasePos).toUpperCase()+n.substr(this.nextUppercasePos+1))," "!=t.charAt(a-1)||"."!=t.charAt(a-2)&&"?"!=t.charAt(a-2)&&"!"!=t.charAt(a-2)||t.length!=a?1==this.nextUppercase&&(this.nextUppercase=!1):(this.nextUppercase=!0,this.nextUppercasePos=a),"en"==confLH.content_language&&(n=n.replace(/\si\s/g," I ")),n!=t)if(this.textarea.val(n),"selectionStart"in this.textarea[0])this.textarea[0].selectionStart=a,this.textarea[0].selectionEnd=a;else if(this.textarea[0].setSelectionRange)this.textarea[0].setSelectionRange(a,a);else if(this.textarea[0].createTextRange){var r=this.textarea[0].createTextRange();r.collapse(!0),r.moveEnd("character",a),r.moveStart("character",a),r.select()}},e.prototype.moveAction=function(e){if(this.cannedMode===!1)var t=$("#canned-hash-"+this.chat_id+" > li.current-item");else var t=$("#canned-hash-current-"+this.chat_id+" > ul > li.current-item");if(0!=t.length){if("up"==e){var n=t.prev();n.is("li")?(t.removeClass("current-item"),t=n.addClass("current-item")):t=t.removeClass("current-item").parent().find(" > li").last().addClass("current-item")}else if("down"==e){var a=t.next();a.is("li")?(t.removeClass("current-item"),t=a.addClass("current-item")):t=t.removeClass("current-item").parent().find(" > li").first().addClass("current-item")}this.cannedMode===!0&&this.renderPreview(t)}},e.prototype.renderPreview=function(e){var t=e.find("> .canned-msg").attr("data-msg");if("undefined"!=typeof t){var e=$("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview");0==e.size()&&($("#canned-hash-current-"+this.chat_id).parent().append('<div class="canned-msg-preview"></div>'),e=$("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview")),e.html(t)}else $("#canned-hash-current-"+this.chat_id).parent().find(".canned-msg-preview").remove()},e.prototype.stopSuggesting=function(){this.textarea.parent().find(".canned-suggester").remove(),this.suggesting=!1,this.cannedMode=!1,this.currentText=null,this.currentKeword=null},e.prototype.extractKeyword=function(){var e=this.textarea[0].selectionStart;currentValue=this.textarea.val();var t="";for(i=e;i>0;i--){if(char=currentValue.substring(i-1,i)," "==char)return this.currentKeword=null,null;if("#"==char)return this.currentKeword=t,t;t=char+t}return this.currentKeword=null,null},this.timeoutRequest=null,e.prototype.showSuggester=function(){var e=this;this.extractKeyword(),this.cannedMode=!1,clearTimeout(this.timeoutRequest),null!==this.currentKeword?(this.suggesting=!0,this.timeoutRequest=setTimeout(function(){null!=e.currentRequest&&(e.currentRequest.abort(),e.currentRequest=null),e.currentRequest=$.getJSON(WWW_DIR_JAVASCRIPT+"cannedmsg/showsuggester/"+e.chat_id,{keyword:e.currentKeword},function(t){e.textarea.parent().find(".canned-suggester").remove(),e.textarea.before(t.result),e.initSuggester()})},200)):this.stopSuggesting()},e.prototype.initSuggester=function(){var e=this,t=$("#canned-hash-"+this.chat_id+" > li:last-child").addClass("current-item");$("#canned-hash-"+this.chat_id+" > li > a").click(function(){e.cannedMode=!0;var t=$("#canned-hash-current-"+e.chat_id);t.html("").show(),$(this).parent().find("ul").clone().appendTo(t),e.renderPreview(t.find("ul > li:first-child").addClass("current-item"));var n=$(this).parent().parent();n.hide(),t.find("span.canned-msg").click(function(){var t=e.textarea[0].selectionStart,n=e.textarea.val(),a=$(this).attr("data-msg"),r=n.substring(0,t),i=r.lastIndexOf("#");if(r=r.substring(0,i)+a,e.textarea.val(r+n.substring(t)),"selectionStart"in e.textarea[0])e.textarea[0].selectionStart=r.length,e.textarea[0].selectionEnd=r.length;else if(e.textarea[0].setSelectionRange)e.textarea[0].setSelectionRange(r.length,r.length);else if(e.textarea[0].createTextRange){var s=e.textarea[0].createTextRange();s.collapse(!0),s.moveEnd("character",r.length),s.moveStart("character",r.length),s.select()}e.stopSuggesting()}),t.find("span.left-return").click(function(){n.show(),t.html("").hide(),t.parent().find(".canned-msg-preview").remove(),e.cannedMode=!1})}),1==$("#canned-hash-"+this.chat_id+" > li").size()?$("#canned-hash-"+this.chat_id+" > li > a").trigger("click"):this.renderPreview(t)},e}();