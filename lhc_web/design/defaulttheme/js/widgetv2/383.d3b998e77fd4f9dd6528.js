"use strict";(globalThis.webpackChunkLHCReactAPP=globalThis.webpackChunkLHCReactAPP||[]).push([[383],{1383:(t,e,i)=>{i.r(e),i.d(e,{default:()=>f});var s=i(4705),a=i(6540);function n(){function t(t,e){return new Promise(((i,s)=>{const a=new XMLHttpRequest;a.open("GET",t),a.responseType="arraybuffer",a.onload=()=>{i(WebAssembly.instantiate(a.response,e))},a.onerror=s,a.send()}))}let e=null,i=5242880;function s(t){const e=i;return i+=t,e}function a(t){postMessage({type:"internal-error",data:t})}let n=null,r=null,o=null;onmessage=i=>{const c=i.data;switch(c.type){case"init":const{wasmURL:i,shimURL:h}=c.data;Promise.resolve().then((()=>(self.WebAssembly&&!function(){const t=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),e=new WebAssembly.Module(t);return 0!==new WebAssembly.Instance(e,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(h),e=new WebAssembly.Memory({initial:256,maximum:256}),{memory:e,pow:Math.pow,exit:a,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:s}))).then((e=>function(e,i){if(!WebAssembly.instantiateStreaming)return t(e,i);const s=fetch(e,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(s,i).catch((s=>{if(s.message&&s.message.indexOf("Argument 0 must be provided and must be a Response")>0)return t(e,i);throw s}))}(i,{env:e}))).then((t=>{n=t.instance.exports,postMessage({type:"init",data:null})})).catch((t=>{postMessage({type:"init-error",data:t.toString()})}));break;case"start":if(!function(t){if(r=n.vmsg_init(t),!r)return!1;const i=new Uint32Array(e.buffer,r,1)[0];return o=new Float32Array(e.buffer,i),!0}(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(l=c.data,o.set(l),!(n.vmsg_encode(r,l.length)>=0))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const d=function(){if(n.vmsg_flush(r)<0)return null;const t=new Uint32Array(e.buffer,r+4,1)[0],i=new Uint32Array(e.buffer,r+8,1)[0],s=new Uint8Array(e.buffer,t,i),a=new Blob([s],{type:"audio/mpeg"});return n.vmsg_free(r),r=null,o=null,a}();if(!d)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:d})}var l}}const r=class{constructor(t={},e=null){this.wasmURL=new URL(t.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(t.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=e,this.pitch=t.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&(this.worker.terminate(),this.worker=null),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(t){return navigator.mediaDevices.getUserMedia(t)}:function(t){const e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(i,s){e.call(navigator,t,i,s)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then((t=>{this.stream=t;const e=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),i=e.createMediaStreamSource(t),s=this.gainNode=(e.createGain||e.createGainNode).call(e);s.gain.value=1,i.connect(s);const a=this.pitchFX=new d(e);a.setPitchOffset(this.pitch);const n=this.encNode=(e.createScriptProcessor||e.createJavaScriptNode).call(e,0,1,1);a.output.connect(n),s.connect(0===this.pitch?n:a.input)}))}initWorker(){if(this.worker)return Promise.resolve();const t=new Blob(["(",n.toString(),")()"],{type:"application/javascript"}),e=this.workerURL=URL.createObjectURL(t),i=this.worker=new Worker(e),{wasmURL:s,shimURL:a}=this;return i.postMessage({type:"init",data:{wasmURL:s,shimURL:a}}),new Promise(((t,e)=>{i.onmessage=i=>{const s=i.data;switch(s.type){case"init":t();break;case"init-error":this.close(),e(new Error(s.data));break;case"error":case"internal-error":this.close(),console.error("Worker error:",s.data),this.reject&&this.reject(s.data);break;case"stop":this.blob=s.data,this.blobURL=URL.createObjectURL(s.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}}))}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:e})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.audioCtx.close(),this.worker.postMessage({type:"stop",data:null}),new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach((t=>t.stop()))}},o=.1,c=.05,l=.1;function h(t,e,i,s){for(var a=e*t.sampleRate,n=a+(e-2*i)*t.sampleRate,r=t.createBuffer(1,n,t.sampleRate),o=r.getChannelData(0),c=0;c<a;++c)o[c]=s?(a-c)/n:c/a;for(c=a;c<n;++c)o[c]=0;return r}function d(t){this.context=t;var e=(t.createGain||t.createGainNode).call(t),i=(t.createGain||t.createGainNode).call(t);this.input=e,this.output=i;var s=t.createBufferSource(),a=t.createBufferSource(),n=t.createBufferSource(),r=t.createBufferSource();this.shiftDownBuffer=h(t,l,c,!1),this.shiftUpBuffer=h(t,l,c,!0),s.buffer=this.shiftDownBuffer,a.buffer=this.shiftDownBuffer,n.buffer=this.shiftUpBuffer,r.buffer=this.shiftUpBuffer,s.loop=!0,a.loop=!0,n.loop=!0,r.loop=!0;var d=(t.createGain||t.createGainNode).call(t),u=(t.createGain||t.createGainNode).call(t),p=(t.createGain||t.createGainNode).call(t);p.gain.value=0;var m=(t.createGain||t.createGainNode).call(t);m.gain.value=0,s.connect(d),a.connect(u),n.connect(p),r.connect(m);var f=(t.createGain||t.createGainNode).call(t),g=(t.createGain||t.createGainNode).call(t),b=(t.createDelay||t.createDelayNode).call(t),w=(t.createDelay||t.createDelayNode).call(t);d.connect(f),u.connect(g),p.connect(f),m.connect(g),f.connect(b.delayTime),g.connect(w.delayTime);var y=t.createBufferSource(),R=t.createBufferSource(),v=function(t,e,i){for(var s=e*t.sampleRate,a=s+(e-2*i)*t.sampleRate,n=t.createBuffer(1,a,t.sampleRate),r=n.getChannelData(0),o=i*t.sampleRate,c=o,l=s-o,h=0;h<s;++h){var d;d=h<c?Math.sqrt(h/o):h>=l?Math.sqrt(1-(h-l)/o):1,r[h]=d}for(h=s;h<a;++h)r[h]=0;return n}(t,l,c);y.buffer=v,R.buffer=v,y.loop=!0,R.loop=!0;var k=(t.createGain||t.createGainNode).call(t),U=(t.createGain||t.createGainNode).call(t);k.gain.value=0,U.gain.value=0,y.connect(k.gain),R.connect(U.gain),e.connect(b),e.connect(w),b.connect(k),w.connect(U),k.connect(i),U.connect(i);var L=t.currentTime+.05,G=L+l-c;s.start(L),a.start(G),n.start(L),r.start(G),y.start(L),R.start(G),this.mod1=s,this.mod2=a,this.mod1Gain=d,this.mod2Gain=u,this.mod3Gain=p,this.mod4Gain=m,this.modGain1=f,this.modGain2=g,this.fade1=y,this.fade2=R,this.mix1=k,this.mix2=U,this.delay1=b,this.delay2=w,this.setDelay(o)}d.prototype.setDelay=function(t){this.modGain1.gain.setTargetAtTime(.5*t,0,.01),this.modGain2.gain.setTargetAtTime(.5*t,0,.01)},d.prototype.setPitchOffset=function(t){t>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(o*Math.abs(t))};var u=i(9270);const p=new r({wasmURL:window.lhcChat.staticJS.chunk_js+"/vmsg.8c4a15f2.wasm",shimURL:"https://unpkg.com/wasm-polyfill.js@0.2.0/wasm-polyfill.js"});class m extends a.PureComponent{constructor(t){super(t),(0,s.A)(this,"state",{isLoading:!1,isRecording:!1,isPlaying:!1,recording:null,audioDuration:0,currentTime:0}),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this),this.playRecord=this.playRecord.bind(this),this.stopPlayRecord=this.stopPlayRecord.bind(this),this.sendRecord=this.sendRecord.bind(this),this.durationInterval=null,this.playInterval=null}async startRecording(){this.stopPlayRecord(),this.setState({isLoading:!0,audioDuration:0,recording:null,isPlaying:!1,currentTime:0});try{await p.initAudio(),await p.initWorker(),p.startRecording(),this.setState({isLoading:!1,isRecording:!0}),this.durationInterval=setInterval((()=>{this.setState({audioDuration:this.state.audioDuration+1}),this.state.audioDuration>=this.props.maxSeconds&&this.stopRecording()}),1e3)}catch(t){alert("Sorry but voice messages are not supported on your browser!"),this.setState({isLoading:!1})}}async stopRecording(){const t=await p.stopRecording();this.audio=new Audio,this.audio.src=URL.createObjectURL(t),this.setState({isLoading:!1,isRecording:!1,recording:t}),clearInterval(this.durationInterval)}playRecord(){this.audio.currentTime=0,this.audio.play(),this.setState({isPlaying:!0}),this.playInterval=setInterval((()=>{this.setState({currentTime:Math.round(this.audio.currentTime)}),(this.audio.ended||this.audio.paused)&&this.stopPlayRecord()}),1e3)}stopPlayRecord(){this.state.isPlaying&&(clearInterval(this.playInterval),this.audio.currentTime=0,this.audio.pause(),this.setState({isPlaying:!1,currentTime:0}))}sendRecord(){const{t}=this.props;this.props.progress(t("file.uploading"));const e=new XMLHttpRequest,i=new FormData;i.append("files",this.state.recording,"record.mp3"),e.open("POST",this.props.base_url+"/file/uploadfile/"+this.props.chat_id+"/"+this.props.hash),e.upload.addEventListener("load",(t=>{this.props.progress("100%"),this.props.onCompletion(),this.props.cancel()})),e.send(i)}componentDidMount(){}componentWillUnmount(){this.stopPlayRecord(),this.state.isRecording&&p.stopRecording()}pad(t){return t<10?"0"+t:t}render(){const{isLoading:t,isRecording:e,recording:i,isPlaying:s}=this.state,{t:n}=this.props;return a.createElement("div",{className:"text-nowrap voice-message-container"},a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-danger fs25",title:n("voice.cancel_voice_message"),onClick:()=>this.props.cancel()},""),!e&&a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button fs25 pointer text-danger me-0",title:n("voice.record_voice_message"),onClick:this.startRecording},""),e&&a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button fs25 pointer text-danger me-0",title:n("voice.stop_recording"),onClick:this.stopRecording},""),i&&!1===s&&a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:n("voice.play_recorded"),onClick:this.playRecord},""),i&&!0===s&&a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:n("voice.stop_playing_recorded"),onClick:this.stopPlayRecord},""),a.createElement("span",{className:"fs12 px-1 voice-message-length"},e?"":s?this.pad(this.state.currentTime)+":":"",e||!i?this.props.maxSeconds-this.state.audioDuration+" s.":this.pad(this.state.audioDuration)+(s?"":"s.")),i&&a.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:n("voice.send"),onClick:this.sendRecord},""))}}const f=(0,u.CI)()(m)}}]);
//# sourceMappingURL=383.d3b998e77fd4f9dd6528.js.map