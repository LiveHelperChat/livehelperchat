{"version":3,"sources":["webpack://LHCReactAPP/./src/extensions/nodejs/nodeJSChat.js"],"names":["nodeJSChat","this","socket","helperFunctions","eventEmitter","addListener","destroy","params","dispatch","getState","state","chatId","chatwidget","getIn","syncDefault","socketOptions","hostname","path","autoReconnectOptions","initialDelay","randomness","port","parseInt","secure","instance_id","socketCluster","require","connect","sampleChannel","visitorTypingListener","data","status","publish","msg","messageSend","messageSendError","disconnect","e","removeListener","sync_interval","connectVisitor","subscribe","on","err","console","error","watch","op","text","ttx","hasIn","fetchMessages","get","updateMessage","msid","checkChatStatus","chat_id","window","lhcAxios","post","lhcChat","headers","then","response","emit","hash","chanelName","log","isAuthenticated"],"mappings":"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","file":"7.4fb52e3a214f8fa4ec7f.js","sourcesContent":["import { helperFunctions } from \"../../lib/helperFunctions\";\nimport { fetchMessages, checkChatStatus, updateMessage } from \"../../actions/chatActions\"\n\nclass _nodeJSChat {\n    constructor() {\n        this.socket = null;\n\n        // On chat close event close connection\n        helperFunctions.eventEmitter.addListener('endedChat', () => {\n            if (this.socket !== null) {\n                this.socket.destroy();\n            }\n        });\n    }\n\n    bootstrap(params, dispatch, getState) {\n\n        const state = getState();\n        const chatId = state.chatwidget.getIn(['chatData','id']);\n        const chatHash = state.chatwidget.getIn(['chatData','hash']);\n        const syncDefault = state.chatwidget.getIn(['chat_ui','sync_interval']);\n\n        var socketOptions = {\n            hostname: params.hostname,\n            path: params.path,\n            autoReconnectOptions: {initialDelay: 5000, randomness: 5000}\n        }\n\n        if (params.port != '') {\n            socketOptions.port = parseInt(params.port);\n        }\n\n        if (params.secure == 1) {\n            socketOptions.secure = true;\n        }\n\n        var chanelName;\n\n        if (params.instance_id > 0) {\n            chanelName = ('chat_'+params.instance_id+'_'+chatId);\n        } else{\n            chanelName = ('chat_'+chatId);\n        }\n\n        var socketCluster = require('socketcluster-client');\n\n        var socket = this.socket = socketCluster.connect(socketOptions);\n        \n        var sampleChannel = null;\n        \n        socket.on('error', function (err) {\n            console.error(err);\n        });\n\n       function visitorTypingListener(data)\n       {\n            if (data.status == true){\n                if (params.instance_id > 0) {\n                    socket.publish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':data.msg});\n                } else {\n                    socket.publish('chat_'+chatId,{'op':'vt','msg':data.msg});\n                }\n            } else {\n                if (params.instance_id > 0) {\n                    socket.publish('chat_'+params.instance_id+'_'+chatId,{'op':'vts'});\n                } else {\n                    socket.publish('chat_'+chatId,{'op':'vts'});\n                }\n            }\n       }\n\n       function messageSend(data)\n       {\n            if (params.instance_id > 0) {\n                socket.publish('chat_'+params.instance_id+'_'+chatId, {'op':'vt','msg':'âœ‰ï¸ ' + data.msg});\n            } else {\n                socket.publish('chat_'+chatId,{'op':'vt', 'msg':'âœ‰ï¸ ' + data.msg});\n            }\n        }\n\n       function messageSendError(data)\n       {\n            if (params.instance_id > 0) {\n                socket.publish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':'ðŸ“•ï¸ error happened while sending visitor message, please inform your administrator!'});\n            } else {\n                socket.publish('chat_'+chatId, {'op':'vt','msg':'ðŸ“•ï¸ error happened while sending visitor message, please inform your administrator!'});\n            }\n        }\n\n        function disconnect() {\n            if (sampleChannel !== null) {\n                try {\n                    sampleChannel.destroy();\n                } catch (e) {\n\n                }\n            }\n\n            helperFunctions.eventEmitter.removeListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.removeListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.removeListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: syncDefault}\n            });\n\n            dispatch({\n                'type': 'CHAT_REMOVE_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        socket.on('close', function() {\n            disconnect();\n        });\n\n        function connectVisitor(){\n            if (params.instance_id > 0) {\n                sampleChannel = socket.subscribe('chat_'+params.instance_id+'_'+chatId);\n            } else {\n                sampleChannel = socket.subscribe('chat_' + chatId);\n            }\n\n            sampleChannel.on('subscribeFail', function (err) {\n                console.error('Failed to subscribe to the sample channel due to error: ' + err);\n            });\n\n            sampleChannel.on('subscribe', function () {\n                socket.publish((params.instance_id > 0 ? 'chat_'+params.instance_id+'_'+chatId : 'chat_'+chatId), {'op':'vi_online', status: true});\n            });\n\n            sampleChannel.watch(function (op) {\n                if (op.op == 'ot') { // Operator Typing Message\n                    if (op.data.status == true) {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: op.data.ttx}\n                        });\n                    } else {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: ''}\n                        });\n                    }\n                } else if (op.op == 'cmsg' || op.op == 'schange') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(fetchMessages({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'lmgsid' : state.chatwidget.getIn(['chatLiveData','lmsgid']),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                } else if (op.op == 'umsg') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])) {\n                        updateMessage({'msg_id' :  op.msid,'id' : state.chatwidget.getIn(['chatData','id']), 'hash' : state.chatwidget.getIn(['chatData','hash'])})(dispatch, getState);\n                    }\n                } else if (op.op == 'schange' || op.op == 'cclose') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(checkChatStatus({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'mode' : state.chatwidget.get('mode'),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                } else if (op.op == 'vo') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])) {\n                        socket.publish((params.instance_id > 0 ? 'chat_'+params.instance_id+'_'+state.chatwidget.getIn(['chatData','id']) : 'chat_'+state.chatwidget.getIn(['chatData','id'])) ,{'op':'vi_online', status: true});\n                    }\n                }\n            });\n\n            helperFunctions.eventEmitter.addListener('visitorTyping', visitorTypingListener);\n            helperFunctions.eventEmitter.addListener('messageSend', messageSend);\n            helperFunctions.eventEmitter.addListener('messageSendError', messageSendError);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: 10000}\n            });\n\n            dispatch({\n                'type': 'CHAT_ADD_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        socket.on('deauthenticate', function(){\n            const state = getState();\n            let chat_id = state.chatwidget.getIn(['chatData','id']);\n            window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then((response) => {\n                socket.emit('login', {hash:response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }, function (err) {\n                    if (err) {\n                        console.log(err);\n                        disconnect();\n                    }\n                });\n            });\n        });\n\n        socket.on('connect', function (status) {\n            if (status.isAuthenticated && chatId > 0) {\n                connectVisitor();\n            } else {\n                const state = getState();\n                let chat_id = state.chatwidget.getIn(['chatData','id']);\n                window.lhcAxios.post(window.lhcChat['base_url'] + \"nodejshelper/tokenvisitor/\"+chat_id+\"/\"+state.chatwidget.getIn(['chatData','hash']), null, {headers : {'Content-Type': 'application/x-www-form-urlencoded'}}).then((response) => {\n                    socket.emit('login', {hash: response.data, chanelName: (params.instance_id > 0 ? ('chat_'+params.instance_id+'_'+chat_id) : ('chat_'+chat_id)) }, function (err) {\n                        if (err) {\n                            console.log(err);\n                            socket.destroy();\n                        } else {\n                            connectVisitor();\n                        }\n                    });\n                });\n            }\n        });\n    }\n}\n\nconst nodeJSChat = new _nodeJSChat();\nexport { nodeJSChat };"],"sourceRoot":""}