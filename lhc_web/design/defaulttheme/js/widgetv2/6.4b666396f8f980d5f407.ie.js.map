{"version":3,"sources":["webpack://LHCReactAPP/./src/extensions/nodejs/nodeJSChat.js"],"names":["nodeJSChat","this","socket","helperFunctions","eventEmitter","addListener","destroy","params","dispatch","getState","chanelName","state","chatId","chatwidget","getIn","syncDefault","socketOptions","hostname","path","port","parseInt","secure","instance_id","socketCluster","require","connect","sampleChannel","visitorTypingListener","data","status","publish","msg","connectVisitor","subscribe","on","err","console","error","watch","op","text","ttx","hasIn","fetchMessages","get","checkChatStatus","sync_interval","removeListener","isAuthenticated","emit","hash","log"],"mappings":"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","file":"6.4b666396f8f980d5f407.ie.js","sourcesContent":["import { helperFunctions } from \"../../lib/helperFunctions\";\nimport { fetchMessages, checkChatStatus } from \"../../actions/chatActions\"\n\nclass _nodeJSChat {\n    constructor() {\n        this.socket = null;\n\n        // On chat close event close connection\n        helperFunctions.eventEmitter.addListener('endedChat', () => {\n            if (this.socket !== null) {\n                this.socket.destroy();\n            }\n        });\n    }\n\n    bootstrap(params, dispatch, getState) {\n\n        const state = getState();\n        const chatId = state.chatwidget.getIn(['chatData','id']);\n        const chatHash = state.chatwidget.getIn(['chatData','hash']);\n        const syncDefault = state.chatwidget.getIn(['chat_ui','sync_interval']);\n\n        var socketOptions = {\n            hostname: params.hostname,\n            path: params.path\n        }\n\n        if (params.port != '') {\n            socketOptions.port = parseInt(params.port);\n        }\n\n        if (params.secure == 1) {\n            socketOptions.secure = true;\n        }\n\n        var chanelName;\n\n        if (params.instance_id > 0) {\n            chanelName = ('chat_'+params.instance_id+'_'+chatId);\n        } else{\n            chanelName = ('chat_'+chatId);\n        }\n\n        var socketCluster = require('socketcluster-client');\n\n        var socket = this.socket = socketCluster.connect(socketOptions);\n        \n        var sampleChannel = null;\n        \n        socket.on('error', function (err) {\n            console.error(err);\n        });\n\n       function visitorTypingListener(data)\n        {\n            if (data.status == true){\n                if (params.instance_id > 0) {\n                    socket.publish('chat_'+params.instance_id+'_'+chatId,{'op':'vt','msg':data.msg});\n                } else {\n                    socket.publish('chat_'+chatId,{'op':'vt','msg':data.msg});\n                }\n            } else {\n                if (params.instance_id > 0) {\n                    socket.publish('chat_'+params.instance_id+'_'+chatId,{'op':'vts'});\n                } else {\n                    socket.publish('chat_'+chatId,{'op':'vts'});\n                }\n            }\n        }\n\n        socket.on('close', function() {\n\n            if (sampleChannel !== null) {\n                sampleChannel.destroy();\n            }\n\n            helperFunctions.eventEmitter.removeListener('visitorTyping', visitorTypingListener);\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: syncDefault}\n            });\n\n            dispatch({\n                'type': 'CHAT_REMOVE_OVERRIDE',\n                'data': \"typing\"\n            });\n\n        });\n\n        function connectVisitor(){\n            if (params.instance_id > 0) {\n                sampleChannel = socket.subscribe('chat_'+params.instance_id+'_'+chatId);\n            } else {\n                sampleChannel = socket.subscribe('chat_' + chatId);\n            }\n\n            sampleChannel.on('subscribeFail', function (err) {\n                console.error('Failed to subscribe to the sample channel due to error: ' + err);\n            });\n\n            sampleChannel.watch(function (op) {\n                if (op.op == 'ot') { // Operator Typing Message\n                    if (op.data.status == true) {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: op.data.ttx}\n                        });\n                    } else {\n                        dispatch({\n                            'type': 'chat_status_changed',\n                            'data': {text: ''}\n                        });\n                    }\n                } else if (op.op == 'cmsg' || op.op == 'schange') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(fetchMessages({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'lmgsid' : state.chatwidget.getIn(['chatLiveData','lmsgid']),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                } else if (op.op == 'schange') {\n                    const state = getState();\n                    if (state.chatwidget.hasIn(['chatData','id'])){\n                        dispatch(checkChatStatus({\n                            'chat_id': state.chatwidget.getIn(['chatData','id']),\n                            'hash' : state.chatwidget.getIn(['chatData','hash']),\n                            'mode' : state.chatwidget.get('mode'),\n                            'theme' : state.chatwidget.get('theme')\n                        }));\n                    }\n                }\n            });\n\n            helperFunctions.eventEmitter.addListener('visitorTyping', visitorTypingListener);\n\n\n            dispatch({\n                'type': 'CHAT_UI_UPDATE',\n                'data': {sync_interval: 10000}\n            });\n\n            dispatch({\n                'type': 'CHAT_ADD_OVERRIDE',\n                'data': \"typing\"\n            });\n        }\n\n        socket.on('connect', function (status) {\n            if (status.isAuthenticated && chatId > 0) {\n                connectVisitor();\n            } else {\n                socket.emit('login', {hash:params.hash, chanelName: chanelName}, function (err) {\n                    if (err) {\n                        console.log(err);\n                    } else {\n                        connectVisitor();\n                    }\n                });\n            }\n        });\n    }\n}\n\nconst nodeJSChat = new _nodeJSChat();\nexport { nodeJSChat };"],"sourceRoot":""}