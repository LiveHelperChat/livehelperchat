"use strict";(self.webpackChunkLHCReactAPP=self.webpackChunkLHCReactAPP||[]).push([[218],{2218:function(e,t,i){i.r(t),i.d(t,{default:function(){return A}});var n=i(8926),a=i.n(n),s=i(4575),r=i.n(s),o=i(3913),c=i.n(o),l=i(1506),u=i.n(l),d=i(2205),h=i.n(d),p=i(8585),m=i.n(p),f=i(9754),g=i.n(f),b=i(9713),v=i.n(b),y=i(7757),w=i.n(y),R=i(7294);function k(){function e(e,t){return new Promise(((i,n)=>{const a=new XMLHttpRequest;a.open("GET",e),a.responseType="arraybuffer",a.onload=()=>{i(WebAssembly.instantiate(a.response,t))},a.onerror=n,a.send()}))}let t=null,i=5242880;function n(e){const t=i;return i+=e,t}function a(e){postMessage({type:"internal-error",data:e})}let s=null,r=null,o=null;onmessage=i=>{const c=i.data;switch(c.type){case"init":const{wasmURL:i,shimURL:u}=c.data;Promise.resolve().then((()=>(self.WebAssembly&&!function(){const e=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),t=new WebAssembly.Module(e);return 0!==new WebAssembly.Instance(t,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(u),t=new WebAssembly.Memory({initial:256,maximum:256}),{memory:t,pow:Math.pow,exit:a,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:n}))).then((t=>function(t,i){if(!WebAssembly.instantiateStreaming)return e(t,i);const n=fetch(t,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(n,i).catch((n=>{if(n.message&&n.message.indexOf("Argument 0 must be provided and must be a Response")>0)return e(t,i);throw n}))}(i,{env:t}))).then((e=>{s=e.instance.exports,postMessage({type:"init",data:null})})).catch((e=>{postMessage({type:"init-error",data:e.toString()})}));break;case"start":if(!function(e){if(r=s.vmsg_init(e),!r)return!1;const i=new Uint32Array(t.buffer,r,1)[0];return o=new Float32Array(t.buffer,i),!0}(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(l=c.data,o.set(l),!(s.vmsg_encode(r,l.length)>=0))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const d=function(){if(s.vmsg_flush(r)<0)return null;const e=new Uint32Array(t.buffer,r+4,1)[0],i=new Uint32Array(t.buffer,r+8,1)[0],n=new Uint8Array(t.buffer,e,i),a=new Blob([n],{type:"audio/mpeg"});return s.vmsg_free(r),r=null,o=null,a}();if(!d)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:d})}var l}}var U=class{constructor(e={},t=null){this.wasmURL=new URL(e.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=t,this.pitch=e.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(e){return navigator.mediaDevices.getUserMedia(e)}:function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(i,n){t.call(navigator,e,i,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then((e=>{this.stream=e;const t=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),i=t.createMediaStreamSource(e),n=this.gainNode=(t.createGain||t.createGainNode).call(t);n.gain.value=1,i.connect(n);const a=this.pitchFX=new N(t);a.setPitchOffset(this.pitch);const s=this.encNode=(t.createScriptProcessor||t.createJavaScriptNode).call(t,0,1,1);a.output.connect(s),n.connect(0===this.pitch?s:a.input)}))}initWorker(){if(!this.stream)throw new Error("missing audio initialization");const e=new Blob(["(",k.toString(),")()"],{type:"application/javascript"}),t=this.workerURL=URL.createObjectURL(e),i=this.worker=new Worker(t),{wasmURL:n,shimURL:a}=this;return i.postMessage({type:"init",data:{wasmURL:n,shimURL:a}}),new Promise(((e,t)=>{i.onmessage=i=>{const n=i.data;switch(n.type){case"init":e();break;case"init-error":t(new Error(n.data));break;case"error":case"internal-error":console.error("Worker error:",n.data),this.reject&&this.reject(n.data);break;case"stop":this.blob=n.data,this.blobURL=URL.createObjectURL(n.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}}))}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:t})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.worker.postMessage({type:"stop",data:null}),new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}};const L=.05,x=.1;function G(e,t,i,n){for(var a=t*e.sampleRate,s=a+(t-2*i)*e.sampleRate,r=e.createBuffer(1,s,e.sampleRate),o=r.getChannelData(0),c=0;c<a;++c)o[c]=n?(a-c)/s:c/a;for(c=a;c<s;++c)o[c]=0;return r}function N(e){this.context=e;var t=(e.createGain||e.createGainNode).call(e),i=(e.createGain||e.createGainNode).call(e);this.input=t,this.output=i;var n=e.createBufferSource(),a=e.createBufferSource(),s=e.createBufferSource(),r=e.createBufferSource();this.shiftDownBuffer=G(e,x,L,!1),this.shiftUpBuffer=G(e,x,L,!0),n.buffer=this.shiftDownBuffer,a.buffer=this.shiftDownBuffer,s.buffer=this.shiftUpBuffer,r.buffer=this.shiftUpBuffer,n.loop=!0,a.loop=!0,s.loop=!0,r.loop=!0;var o=(e.createGain||e.createGainNode).call(e),c=(e.createGain||e.createGainNode).call(e),l=(e.createGain||e.createGainNode).call(e);l.gain.value=0;var u=(e.createGain||e.createGainNode).call(e);u.gain.value=0,n.connect(o),a.connect(c),s.connect(l),r.connect(u);var d=(e.createGain||e.createGainNode).call(e),h=(e.createGain||e.createGainNode).call(e),p=(e.createDelay||e.createDelayNode).call(e),m=(e.createDelay||e.createDelayNode).call(e);o.connect(d),c.connect(h),l.connect(d),u.connect(h),d.connect(p.delayTime),h.connect(m.delayTime);var f=e.createBufferSource(),g=e.createBufferSource(),b=function(e,t,i){for(var n=.1*e.sampleRate,a=n+0*e.sampleRate,s=e.createBuffer(1,a,e.sampleRate),r=s.getChannelData(0),o=.05*e.sampleRate,c=o,l=n-o,u=0;u<n;++u){var d;d=u<c?Math.sqrt(u/o):u>=l?Math.sqrt(1-(u-l)/o):1,r[u]=d}for(u=n;u<a;++u)r[u]=0;return s}(e);f.buffer=b,g.buffer=b,f.loop=!0,g.loop=!0;var v=(e.createGain||e.createGainNode).call(e),y=(e.createGain||e.createGainNode).call(e);v.gain.value=0,y.gain.value=0,f.connect(v.gain),g.connect(y.gain),t.connect(p),t.connect(m),p.connect(v),m.connect(y),v.connect(i),y.connect(i);var w=e.currentTime+.05,R=w+x-L;n.start(w),a.start(R),s.start(w),r.start(R),f.start(w),g.start(R),this.mod1=n,this.mod2=a,this.mod1Gain=o,this.mod2Gain=c,this.mod3Gain=l,this.mod4Gain=u,this.modGain1=d,this.modGain2=h,this.fade1=f,this.fade2=g,this.mix1=v,this.mix2=y,this.delay1=p,this.delay2=m,this.setDelay(.1)}N.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},N.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(e))};var M=i(7139);var S=new U({wasmURL:window.lhcChat.staticJS.chunk_js+"/vmsg.8c4a15f2.wasm",shimURL:"https://unpkg.com/wasm-polyfill.js@0.2.0/wasm-polyfill.js"}),P=function(e){h()(l,e);var t,i,n,s,o=(n=l,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=g()(n);if(s){var i=g()(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return m()(this,e)});function l(e){var t;return r()(this,l),t=o.call(this,e),v()(u()(t),"state",{isLoading:!1,isRecording:!1,isPlaying:!1,recording:null,audioDuration:0,currentTime:0}),t.startRecording=t.startRecording.bind(u()(t)),t.stopRecording=t.stopRecording.bind(u()(t)),t.playRecord=t.playRecord.bind(u()(t)),t.stopPlayRecord=t.stopPlayRecord.bind(u()(t)),t.sendRecord=t.sendRecord.bind(u()(t)),t.durationInterval=null,t.playInterval=null,t}return c()(l,[{key:"startRecording",value:(i=a()(w().mark((function e(){var t=this;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.stopPlayRecord(),this.setState({isLoading:!0,audioDuration:0,recording:null,isPlaying:!1,currentTime:0}),e.prev=2,e.next=5,S.initAudio();case 5:return e.next=7,S.initWorker();case 7:S.startRecording(),this.setState({isLoading:!1,isRecording:!0}),this.durationInterval=setInterval((function(){t.setState({audioDuration:t.state.audioDuration+1}),t.state.audioDuration>=t.props.maxSeconds&&t.stopRecording()}),1e3),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(2),alert("Sorry but voice messages are not supported on your browser!"),this.setState({isLoading:!1});case 16:case"end":return e.stop()}}),e,this,[[2,12]])}))),function(){return i.apply(this,arguments)})},{key:"stopRecording",value:(t=a()(w().mark((function e(){var t;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S.stopRecording();case 2:t=e.sent,this.audio=new Audio,this.audio.src=URL.createObjectURL(t),this.setState({isLoading:!1,isRecording:!1,recording:t}),clearInterval(this.durationInterval);case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"playRecord",value:function(){var e=this;this.audio.currentTime=0,this.audio.play(),this.setState({isPlaying:!0}),this.playInterval=setInterval((function(){e.setState({currentTime:Math.round(e.audio.currentTime)}),(e.audio.ended||e.audio.paused)&&e.stopPlayRecord()}),1e3)}},{key:"stopPlayRecord",value:function(){this.state.isPlaying&&(clearInterval(this.playInterval),this.audio.currentTime=0,this.audio.pause(),this.setState({isPlaying:!1,currentTime:0}))}},{key:"sendRecord",value:function(){var e=this,t=this.props.t;this.props.progress(t("file.uploading"));var i=new XMLHttpRequest,n=new FormData;n.append("files",this.state.recording,"record.mp3"),i.open("POST",this.props.base_url+"/file/uploadfile/"+this.props.chat_id+"/"+this.props.hash),i.upload.addEventListener("load",(function(t){e.props.progress("100%"),e.props.onCompletion(),e.props.cancel()})),i.send(n)}},{key:"componentDidMount",value:function(){}},{key:"componentWillUnmount",value:function(){this.stopPlayRecord(),this.state.isRecording&&S.stopRecording()}},{key:"pad",value:function(e){return e<10?"0"+e:e}},{key:"render",value:function(){var e=this,t=this.state,i=(t.isLoading,t.isRecording),n=t.recording,a=t.isPlaying,s=this.props.t;return R.createElement("div",{className:"text-nowrap voice-message-container"},R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-danger fs25",title:s("voice.cancel_voice_message"),onClick:function(){return e.props.cancel()}},""),!i&&R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button fs25 pointer text-danger me-0",title:s("voice.record_voice_message"),onClick:this.startRecording},""),i&&R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button fs25 pointer text-danger me-0",title:s("voice.stop_recording"),onClick:this.stopRecording},""),n&&!1===a&&R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:s("voice.play_recorded"),onClick:this.playRecord},""),n&&!0===a&&R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:s("voice.stop_playing_recorded"),onClick:this.stopPlayRecord},""),R.createElement("span",{className:"fs12 px-1 voice-message-length"},i?"":a?this.pad(this.state.currentTime)+":":"",i||!n?this.props.maxSeconds-this.state.audioDuration+" s.":this.pad(this.state.audioDuration)+(a?"":"s.")),n&&R.createElement("button",{type:"button",tabIndex:"0",className:"material-icons material-icons-button pointer text-success me-0 fs25",title:s("voice.send"),onClick:this.sendRecord},""))}}]),l}(R.PureComponent),A=(0,M.Z)()(P)}}]);
//# sourceMappingURL=218.d566c07cd9f9b4b70bcd.js.map